<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="João André Martins, Jisha Abubaker, Ray Tsang, Mike Eltsufin, Artem Bilan, Andreas Berger, Balint Pato, Chengyuan Zhao, Dmitry Solomakha, Elena Felder, Daniel Zou, Eddú Meléndez, Travis Tomsu">
<title>Spring Framework on Google Cloud</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}

</style>
<script type="text/javascript">
function addBlockSwitches() {
	for (var primary of document.querySelectorAll('.primary')) {
		var switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		var title = primary.querySelector('.title')
		title.remove();
	}
	for (var secondary of document.querySelectorAll('.secondary')) {
		var primary = findPrimary(secondary);
		if (primary === null) {
			console.error("Found secondary block with no primary sibling");
		}
		else {
			var switchItem = createSwitchItem(secondary, primary.querySelector('.switch'));
			switchItem.content.classList.add("hidden");
			primary.append(switchItem.content);
			secondary.remove();
		}
	}
}

function createElementFromHtml(html) {
	var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
}

function createBlockSwitch(primary) {
    var blockSwitch = createElementFromHtml('<div class="switch"></div>');
    primary.prepend(blockSwitch)
	return blockSwitch;
}

function findPrimary(secondary) {
	var candidate = secondary.previousElementSibling;
	while (candidate != null && !candidate.classList.contains('primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	var blockName = block.querySelector('.title').textContent;
	var content = block.querySelectorAll('.content').item(0);
	var colist = nextSibling(block, '.colist');
	if (colist != null) {
		content.append(colist);
	}
	var item = createElementFromHtml('<div class="switch--item">' + blockName + '</div>');
	item.dataset.blockName = blockName;
	content.dataset.blockName = blockName;
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function nextSibling(element, selector) {
	var sibling = element.nextElementSibling;
	while (sibling) {
		if (sibling.matches(selector)) {
			return sibling;
		}
		sibling = sibling.nextElementSibling;
	}
}

function globalSwitch() {
	document.querySelectorAll(".switch--item").forEach(function(item) {
		var blockId = blockIdForSwitchItem(item);
		var handler = function(event) {
			selectedText = event.target.textContent;
			window.localStorage.setItem(blockId, selectedText);
			for (var switchItem of document.querySelectorAll(".switch--item")) {
				if (blockIdForSwitchItem(switchItem) === blockId && switchItem.textContent === selectedText) {
					select(switchItem);
				}
			}
		}
		item.addEventListener("click", handler);
		if (item.textContent === window.localStorage.getItem(blockId)) {
			select(item);
		}
	});
}

function select(selected) {
	for (var child of selected.parentNode.children) {
		child.classList.remove("selected");
	}
	selected.classList.add("selected");
	for (var child of selected.parentNode.parentNode.children) {
		if (child.classList.contains("content")) {
			if (selected.dataset.blockName === child.dataset.blockName) {
				child.classList.remove("hidden");
			}
			else {
				child.classList.add("hidden");
			}
		}
	}	
}

function blockIdForSwitchItem(item) {
	idComponents = []
	for (var switchItem of item.parentNode.querySelectorAll(".switch--item")) {
		idComponents.push(switchItem.textContent.toLowerCase());
	}
	return idComponents.sort().join("-")
}

window.onload = function() {
	addBlockSwitches();
	globalSwitch();
};

</script>

</head>
<body id="spring-cloud-gcp-reference" class="book toc2 toc-left">
<div id="header">
<h1>Spring Framework on Google Cloud</h1>
<div class="details">
<span id="author" class="author">João André Martins</span><br>
<span id="author2" class="author">Jisha Abubaker</span><br>
<span id="author3" class="author">Ray Tsang</span><br>
<span id="author4" class="author">Mike Eltsufin</span><br>
<span id="author5" class="author">Artem Bilan</span><br>
<span id="author6" class="author">Andreas Berger</span><br>
<span id="author7" class="author">Balint Pato</span><br>
<span id="author8" class="author">Chengyuan Zhao</span><br>
<span id="author9" class="author">Dmitry Solomakha</span><br>
<span id="author10" class="author">Elena Felder</span><br>
<span id="author11" class="author">Daniel Zou</span><br>
<span id="author12" class="author">Eddú Meléndez</span><br>
<span id="author13" class="author">Travis Tomsu</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#getting-started">2. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#compatibility-with-spring-project-versions">2.1. Compatibility with Spring Project Versions</a></li>
<li><a href="#setting-up-dependencies">2.2. Setting up Dependencies</a></li>
<li><a href="#learning-spring-framework-on-google-cloud">2.3. Learning Spring Framework on Google Cloud</a></li>
</ul>
</li>
<li><a href="#spring-cloud-gcp-core">3. Spring Framework on Google Cloud Core</a>
<ul class="sectlevel2">
<li><a href="#configuration">3.1. Configuration</a></li>
<li><a href="#project-id">3.2. Project ID</a></li>
<li><a href="#credentials">3.3. Credentials</a></li>
<li><a href="#environment">3.4. Environment</a></li>
<li><a href="#customizing-bean-scope">3.5. Customizing bean scope</a></li>
<li><a href="#spring-initializr-2">3.6. Spring Initializr</a></li>
</ul>
</li>
<li><a href="#cloud-storage">4. Cloud Storage</a>
<ul class="sectlevel2">
<li><a href="#using-cloud-storage">4.1. Using Cloud Storage</a></li>
<li><a href="#cloud-storage-objects-as-spring-resources">4.2. Cloud Storage Objects As Spring Resources</a></li>
<li><a href="#configuration-2">4.3. Configuration</a></li>
<li><a href="#sample">4.4. Sample</a></li>
</ul>
</li>
<li><a href="#cloud-sql">5. Cloud SQL</a>
<ul class="sectlevel2">
<li><a href="#jdbc-support">5.1. JDBC Support</a></li>
<li><a href="#r2dbc-support">5.2. R2DBC Support</a></li>
<li><a href="#cloud-sql-iam-database-authentication">5.3. Cloud SQL IAM database authentication</a></li>
<li><a href="#cloud-sql-configuration-properties">5.4. Cloud SQL Configuration Properties</a></li>
<li><a href="#troubleshooting-tips">5.5. Troubleshooting tips</a></li>
<li><a href="#samples">5.6. Samples</a></li>
</ul>
</li>
<li><a href="#cloud-pubsub">6. Cloud Pub/Sub</a>
<ul class="sectlevel2">
<li><a href="#pubsub-configuration">6.1. Configuration</a></li>
<li><a href="#spring-boot-actuator-support">6.2. Spring Boot Actuator Support</a></li>
<li><a href="#pubsub-operations-template">6.3. Pub/Sub Operations &amp; Template</a></li>
<li><a href="#reactive-stream-subscriber">6.4. Reactive Stream Subscriber</a></li>
<li><a href="#pubsub-management">6.5. Pub/Sub management</a></li>
<li><a href="#sample-2">6.6. Sample</a></li>
<li><a href="#test">6.7. Test</a></li>
</ul>
</li>
<li><a href="#spring-integration">7. Spring Integration</a>
<ul class="sectlevel2">
<li><a href="#channel-adapters-for-cloud-pubsub">7.1. Channel Adapters for Cloud Pub/Sub</a></li>
<li><a href="#channel-adapters-for-google-cloud-storage">7.2. Channel Adapters for Google Cloud Storage</a></li>
</ul>
</li>
<li><a href="#spring-cloud-stream">8. Spring Cloud Stream</a>
<ul class="sectlevel2">
<li><a href="#overview">8.1. Overview</a></li>
<li><a href="#configuration-3">8.2. Configuration</a></li>
<li><a href="#binding-with-functions">8.3. Binding with Functions</a></li>
<li><a href="#binding-with-annotations">8.4. Binding with Annotations</a></li>
<li><a href="#streaming-vs-polled-input">8.5. Streaming vs. Polled Input</a></li>
<li><a href="#sample-4">8.6. Sample</a></li>
</ul>
</li>
<li><a href="#spring-cloud-bus">9. Spring Cloud Bus</a>
<ul class="sectlevel2">
<li><a href="#configuration-management-with-spring-cloud-config-and-spring-cloud-bus">9.1. Configuration Management with Spring Cloud Config and Spring Cloud Bus</a></li>
</ul>
</li>
<li><a href="#cloud-trace">10. Cloud Trace</a>
<ul class="sectlevel2">
<li><a href="#tracing">10.1. Tracing</a></li>
<li><a href="#spring-boot-starter-for-cloud-trace">10.2. Spring Boot Starter for Cloud Trace</a></li>
<li><a href="#overriding-the-auto-configuration">10.3. Overriding the auto-configuration</a></li>
<li><a href="#customizing-spans">10.4. Customizing spans</a></li>
<li><a href="#integration-with-logging">10.5. Integration with Logging</a></li>
<li><a href="#pubsub-trace-instrumentation-experimental">10.6. Pub/Sub Trace Instrumentation (Experimental)</a></li>
<li><a href="#sample-5">10.7. Sample</a></li>
</ul>
</li>
<li><a href="#cloud-logging">11. Cloud Logging</a>
<ul class="sectlevel2">
<li><a href="#web-mvc-interceptor">11.1. Web MVC Interceptor</a></li>
<li><a href="#logback-support">11.2. Logback Support</a></li>
<li><a href="#sample-6">11.3. Sample</a></li>
</ul>
</li>
<li><a href="#cloud-monitoring">12. Cloud Monitoring</a>
<ul class="sectlevel2">
<li><a href="#configuration-4">12.1. Configuration</a></li>
<li><a href="#sample-7">12.2. Sample</a></li>
</ul>
</li>
<li><a href="#spring-data-cloud-spanner">13. Spring Data Cloud Spanner</a>
<ul class="sectlevel2">
<li><a href="#configuration-5">13.1. Configuration</a></li>
<li><a href="#object-mapping">13.2. Object Mapping</a></li>
<li><a href="#spanner-operations-template">13.3. Spanner Operations &amp; Template</a></li>
<li><a href="#repositories">13.4. Repositories</a></li>
<li><a href="#query-methods">13.5. Query Methods</a></li>
<li><a href="#database-and-schema-admin">13.6. Database and Schema Admin</a></li>
<li><a href="#events">13.7. Events</a></li>
<li><a href="#auditing">13.8. Auditing</a></li>
<li><a href="#multi-instance-usage">13.9. Multi-Instance Usage</a></li>
<li><a href="#spring-boot-actuator-support-2">13.10. Spring Boot Actuator Support</a></li>
<li><a href="#cloud-spanner-emulator">13.11. Cloud Spanner Emulator</a></li>
<li><a href="#sample-8">13.12. Sample</a></li>
<li><a href="#test-2">13.13. Test</a></li>
</ul>
</li>
<li><a href="#spring-data-cloud-datastore">14. Spring Data Cloud Datastore</a>
<ul class="sectlevel2">
<li><a href="#configuration-6">14.1. Configuration</a></li>
<li><a href="#object-mapping-2">14.2. Object Mapping</a></li>
<li><a href="#relationships-2">14.3. Relationships</a></li>
<li><a href="#datastore-operations-template">14.4. Datastore Operations &amp; Template</a></li>
<li><a href="#repositories-2">14.5. Repositories</a></li>
<li><a href="#events-2">14.6. Events</a></li>
<li><a href="#auditing-2">14.7. Auditing</a></li>
<li><a href="#partitioning-data-by-namespace">14.8. Partitioning Data by Namespace</a></li>
<li><a href="#spring-boot-actuator-support-3">14.9. Spring Boot Actuator Support</a></li>
<li><a href="#sample-9">14.10. Sample</a></li>
<li><a href="#test-3">14.11. Test</a></li>
</ul>
</li>
<li><a href="#spring-data-cloud-firestore">15. Spring Data Cloud Firestore</a>
<ul class="sectlevel2">
<li><a href="#configuration-7">15.1. Configuration</a></li>
<li><a href="#object-mapping-3">15.2. Object Mapping</a></li>
<li><a href="#reactive-repositories">15.3. Reactive Repositories</a></li>
<li><a href="#firestore-operations-template">15.4. Firestore Operations &amp; Template</a></li>
<li><a href="#query-methods-by-convention-3">15.5. Query methods by convention</a></li>
<li><a href="#transactions-4">15.6. Transactions</a></li>
<li><a href="#subcollections">15.7. Subcollections</a></li>
<li><a href="#update-time-and-optimistic-locking">15.8. Update Time and Optimistic Locking</a></li>
<li><a href="#cloud-firestore-spring-boot-starter">15.9. Cloud Firestore Spring Boot Starter</a></li>
<li><a href="#emulator-usage">15.10. Emulator Usage</a></li>
<li><a href="#samples-3">15.11. Samples</a></li>
<li><a href="#test-4">15.12. Test</a></li>
</ul>
</li>
<li><a href="#cloud-memorystore-for-redis">16. Cloud Memorystore for Redis</a>
<ul class="sectlevel2">
<li><a href="#spring-caching">16.1. Spring Caching</a></li>
</ul>
</li>
<li><a href="#bigquery">17. BigQuery</a>
<ul class="sectlevel2">
<li><a href="#configuration-8">17.1. Configuration</a></li>
<li><a href="#spring-integration-2">17.2. Spring Integration</a></li>
<li><a href="#sample-10">17.3. Sample</a></li>
</ul>
</li>
<li><a href="#cloud-iap">18. Cloud IAP</a>
<ul class="sectlevel2">
<li><a href="#configuration-9">18.1. Configuration</a></li>
<li><a href="#sample-11">18.2. Sample</a></li>
</ul>
</li>
<li><a href="#cloud-vision">19. Cloud Vision</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup">19.1. Dependency Setup</a></li>
<li><a href="#configuration-10">19.2. Configuration</a></li>
<li><a href="#image-analysis">19.3. Image Analysis</a></li>
<li><a href="#file-analysis">19.4. File Analysis</a></li>
<li><a href="#document-ocr-template">19.5. Document OCR Template</a></li>
<li><a href="#sample-12">19.6. Sample</a></li>
</ul>
</li>
<li><a href="#secret-manager">20. Secret Manager</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-2">20.1. Dependency Setup</a></li>
<li><a href="#secret-manager-property-source">20.2. Secret Manager Property Source</a></li>
<li><a href="#secret-manager-template">20.3. Secret Manager Template</a></li>
<li><a href="#refresh-secrets-without-restarting-the-application">20.4. Refresh secrets without restarting the application</a></li>
<li><a href="#allow-default-secret">20.5. Allow default secret</a></li>
<li><a href="#sample-13">20.6. Sample</a></li>
</ul>
</li>
<li><a href="#google-cloud-key-management-service">21. Google Cloud Key Management Service</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-3">21.1. Dependency Setup</a></li>
<li><a href="#configuration-12">21.2. Configuration</a></li>
<li><a href="#basic-usage">21.3. Basic Usage</a></li>
<li><a href="#sample-14">21.4. Sample</a></li>
</ul>
</li>
<li><a href="#cloud-runtime-configuration-api">22. Cloud Runtime Configuration API</a>
<ul class="sectlevel2">
<li><a href="#configuration-13">22.1. Configuration</a></li>
<li><a href="#quick-start">22.2. Quick start</a></li>
<li><a href="#refreshing-the-configuration-at-runtime">22.3. Refreshing the configuration at runtime</a></li>
<li><a href="#sample-15">22.4. Sample</a></li>
</ul>
</li>
<li><a href="#cloud-foundry">23. Cloud Foundry</a>
<ul class="sectlevel2">
<li><a href="#user-provided-services">23.1. User-Provided Services</a></li>
</ul>
</li>
<li><a href="#kotlin-support">24. Kotlin Support</a>
<ul class="sectlevel2">
<li><a href="#prerequisites-3">24.1. Prerequisites</a></li>
<li><a href="#sample-16">24.2. Sample</a></li>
</ul>
</li>
<li><a href="#configuration-properties">25. Configuration properties</a></li>
<li><a href="#migration-guide-from-spring-framework-on-google-cloud-1-x-to-2-x">26. Migration Guide from Spring Framework on Google Cloud 1.x to 2.x</a>
<ul class="sectlevel2">
<li><a href="#maven-group-id-change">26.1. Maven Group ID Change</a></li>
<li><a href="#java-package-name-change">26.2. Java Package Name Change</a></li>
<li><a href="#deprecated-items-removed">26.3. Deprecated Items Removed</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><strong>3.4.1</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a><a class="link" href="#introduction">1. Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Spring Framework on Google Cloud project makes the Spring Framework a first-class citizen of Google Cloud .</p>
</div>
<div class="paragraph">
<p>Spring Framework on Google Cloud lets you leverage the power and simplicity of the Spring Framework to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Publish and subscribe to Google Cloud Pub/Sub topics</p>
</li>
<li>
<p>Configure Spring JDBC with a few properties to use Google Cloud SQL</p>
</li>
<li>
<p>Map objects, relationships, and collections with Spring Data Cloud Spanner, Spring Data Cloud Datastore and Spring Data Reactive Repositories for Cloud Firestore</p>
</li>
<li>
<p>Write and read from Spring Resources backed up by Google Cloud Storage</p>
</li>
<li>
<p>Exchange messages with Spring Integration using Google Cloud Pub/Sub on the background</p>
</li>
<li>
<p>Trace the execution of your app with Spring Cloud Sleuth and Google Cloud Trace</p>
</li>
<li>
<p>Configure your app with Spring Cloud Config, backed up by the Google Runtime Configuration API</p>
</li>
<li>
<p>Consume and produce Google Cloud Storage data via Spring Integration GCS Channel Adapters</p>
</li>
<li>
<p>Use Spring Security via Google Cloud IAP</p>
</li>
<li>
<p>Analyze your images for text, objects, and other content with Google Cloud Vision</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a><a class="link" href="#getting-started">2. Getting Started</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to get up to speed with Spring Framework on Google Cloud libraries.</p>
</div>
<div class="sect2">
<h3 id="compatibility-with-spring-project-versions"><a class="anchor" href="#compatibility-with-spring-project-versions"></a><a class="link" href="#compatibility-with-spring-project-versions">2.1. Compatibility with Spring Project Versions</a></h3>
<div class="paragraph">
<p>Spring Framework on Google Cloud has dependency and transitive dependencies on Spring Projects. The table below outlines the versions of Spring Cloud, Spring Boot and Spring Framework versions that are compatible with certain Spring Framework on Google Cloud version.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Spring Framework on Google Cloud</th>
<th class="tableblock halign-left valign-top">Spring Cloud</th>
<th class="tableblock halign-left valign-top">Spring Boot</th>
<th class="tableblock halign-left valign-top">Spring Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2020.0-Release-Notes">2020.0.x</a> (3.0/Illford)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.4.x, 2.5.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.3.x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2021.0-Release-Notes">2021.0.x</a> (3.1/Jubilee)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.6.x, 2.7.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.3.x</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="setting-up-dependencies"><a class="anchor" href="#setting-up-dependencies"></a><a class="link" href="#setting-up-dependencies">2.2. Setting up Dependencies</a></h3>
<div class="paragraph">
<p>All Spring Framework on Google Cloud artifacts are made available through Maven Central.
The following resources are provided to help you setup the libraries for your project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maven Bill of Materials for dependency management</p>
</li>
<li>
<p>Starter Dependencies for depending on Spring Framework on Google Cloud modules</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You may also consult our <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp">Github project</a> to examine the code or build directly from source.</p>
</div>
<div class="sect3">
<h4 id="bill-of-materials"><a class="anchor" href="#bill-of-materials"></a><a class="link" href="#bill-of-materials">2.2.1. Bill of Materials</a></h4>
<div class="paragraph">
<p>The Spring Framework on Google Cloud Bill of Materials (BOM) contains the versions of all the dependencies it uses.</p>
</div>
<div class="paragraph">
<p>If you’re a Maven user, adding the following to your pom.xml file will allow you omit any Spring Framework on Google Cloud dependency version numbers from your configuration.
Instead, the version of the BOM you’re using determines the versions of the used dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencyManagement&gt;
   &lt;dependencies&gt;
       &lt;dependency&gt;
           &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
           &lt;artifactId&gt;spring-cloud-gcp-dependencies&lt;/artifactId&gt;
           &lt;version&gt;3.4.1&lt;/version&gt;
           &lt;type&gt;pom&lt;/type&gt;
           &lt;scope&gt;import&lt;/scope&gt;
       &lt;/dependency&gt;
   &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if you&#8217;re a Gradle user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation platform("com.google.cloud:spring-cloud-gcp-dependencies:3.4.1")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the following sections, it will be assumed you are using the Spring Framework on Google Cloud BOM and the dependency snippets will not contain versions.</p>
</div>
</div>
<div class="sect3">
<h4 id="starter-dependencies"><a class="anchor" href="#starter-dependencies"></a><a class="link" href="#starter-dependencies">2.2.2. Starter Dependencies</a></h4>
<div class="paragraph">
<p>Spring Framework on Google Cloud offers <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-starters">starter dependencies</a> through Maven to easily depend on different modules of the library.
Each starter contains all the dependencies and transitive dependencies needed to begin using their corresponding Spring Framework on Google Cloud module.</p>
</div>
<div class="paragraph">
<p>For example, if you wish to write a Spring application with Cloud Pub/Sub, you would include the <code>spring-cloud-gcp-starter-pubsub</code> dependency in your project.
You do <strong>not</strong> need to include the underlying <code>spring-cloud-gcp-pubsub</code> dependency, because the <code>starter</code> dependency includes it.</p>
</div>
<div class="paragraph">
<p>A summary of these artifacts are provided below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Spring Framework on Google Cloud Starter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Maven Artifact Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Automatically configure authentication and Google project settings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#spring-cloud-gcp-core">com.google.cloud:spring-cloud-gcp-starter</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Spanner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with Google Cloud Spanner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#spring-data-cloud-spanner">com.google.cloud:spring-cloud-gcp-starter-data-spanner</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Datastore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with Google Cloud Datastore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#spring-data-cloud-datastore">com.google.cloud:spring-cloud-gcp-starter-data-datastore</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Pub/Sub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with Google Cloud Pub/Sub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloud-pubsub">com.google.cloud:spring-cloud-gcp-starter-pubsub</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables Cloud Logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloud-logging">com.google.cloud:spring-cloud-gcp-starter-logging</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL - MySQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud SQL integrations with MySQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloud-sql">com.google.cloud:spring-cloud-gcp-starter-sql-mysql</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL - PostgreSQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud SQL integrations with PostgreSQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloud-sql">com.google.cloud:spring-cloud-gcp-starter-sql-postgresql</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with Google Cloud Storage and Spring Resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloud-storage">com.google.cloud:spring-cloud-gcp-starter-storage</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Config</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables usage of Google Runtime Configuration API as a Spring Cloud Config server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloud-runtime-configuration-api">com.google.cloud:spring-cloud-gcp-starter-config</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables instrumentation with Google Cloud Trace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloud-trace">com.google.cloud:spring-cloud-gcp-starter-trace</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vision</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with Google Cloud Vision</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloud-vision">com.google.cloud:spring-cloud-gcp-starter-vision</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security - IAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides a security layer over applications deployed to Google Cloud</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloud-iap">com.google.cloud:spring-cloud-gcp-starter-security-iap</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security - Firebase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides a security layer over applications deployed to Firebase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="security-firebase.html#security-firebase">com.google.cloud:spring-cloud-gcp-starter-security-firebase</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="spring-initializr"><a class="anchor" href="#spring-initializr"></a><a class="link" href="#spring-initializr">2.2.3. Spring Initializr</a></h4>
<div class="paragraph">
<p><a href="https://start.spring.io/">Spring Initializr</a> is a tool which generates the scaffolding code for a new Spring Boot project.
It handles the work of generating the Maven or Gradle build file so you do not have to manually add the dependencies yourself.</p>
</div>
<div class="paragraph">
<p>Spring Initializr offers three modules from Spring Framework on Google Cloud that you can use to generate your project.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>GCP Support</strong>: The GCP Support module contains auto-configuration support for every Spring Framework on Google Cloud integration.
Most of the autoconfiguration code is only enabled if the required dependency is added to your project.</p>
</li>
<li>
<p><strong>GCP Messaging</strong>: Google Cloud Pub/Sub integrations work out of the box.</p>
</li>
<li>
<p><strong>GCP Storage</strong>: Google Cloud Storage integrations work out of the box.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="learning-spring-framework-on-google-cloud"><a class="anchor" href="#learning-spring-framework-on-google-cloud"></a><a class="link" href="#learning-spring-framework-on-google-cloud">2.3. Learning Spring Framework on Google Cloud</a></h3>
<div class="paragraph">
<p>There are a variety of resources to help you learn how to use Spring Framework on Google Cloud libraries.</p>
</div>
<div class="sect3">
<h4 id="sample-applications"><a class="anchor" href="#sample-applications"></a><a class="link" href="#sample-applications">2.3.1. Sample Applications</a></h4>
<div class="paragraph">
<p>The easiest way to learn how to use Spring Framework on Google Cloud is to consult the <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples">sample applications on Github</a>.
Spring Framework on Google Cloud provides sample applications which demonstrate how to use every integration in the library.
The table below highlights several samples of the most commonly used integrations in Spring Framework on Google Cloud.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Google Cloud Integration</th>
<th class="tableblock halign-left valign-top">Sample Application</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Pub/Sub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-pubsub-sample">spring-cloud-gcp-pubsub-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Spanner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-spanner-repository-sample">spring-cloud-gcp-data-spanner-repository-sample</a></p>
<p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-spanner-template-sample">spring-cloud-gcp-data-spanner-template-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datastore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-datastore-sample">spring-cloud-gcp-data-datastore-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud SQL (w/ MySQL)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-sql-mysql-sample">spring-cloud-gcp-sql-mysql-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-storage-resource-sample">spring-cloud-gcp-storage-resource-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-logging-sample">spring-cloud-gcp-logging-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-trace-sample">spring-cloud-gcp-trace-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Vision</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-vision-api-sample">spring-cloud-gcp-vision-api-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Security - IAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-security-iap-sample">spring-cloud-gcp-security-iap-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Security - Firebase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-security-firebase-sample">spring-cloud-gcp-security-firebase-sample</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each sample application demonstrates how to use Spring Framework on Google Cloud libraries in context and how to setup the dependencies for the project.
The applications are fully functional and can be deployed to Google Cloud as well.
If you are interested, you may consult guides for <a href="https://codelabs.developers.google.com/codelabs/cloud-app-engine-springboot/index.html">deploying an application to AppEngine</a> and <a href="https://codelabs.developers.google.com/codelabs/cloud-springboot-kubernetes/index.html">to Google Kubernetes Engine</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="codelabs"><a class="anchor" href="#codelabs"></a><a class="link" href="#codelabs">2.3.2. Codelabs</a></h4>
<div class="paragraph">
<p>For a more hands-on approach, there are several guides and codelabs to help you get up to speed.
These guides provide step-by-step instructions for building an application using Spring Framework on Google Cloud.</p>
</div>
<div class="paragraph">
<p>Some examples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://codelabs.developers.google.com/codelabs/cloud-app-engine-springboot/index.html">Deploy a Spring Boot app to App Engine</a></p>
</li>
<li>
<p><a href="https://codelabs.developers.google.com/codelabs/cloud-spring-cloud-gcp-kotlin/index.html">Build a Kotlin Spring Boot app with Cloud SQL and Cloud Pub/Sub</a></p>
</li>
<li>
<p><a href="https://codelabs.developers.google.com/codelabs/cloud-spring-datastore/index.html">Build a Spring Boot application with Datastore</a></p>
</li>
<li>
<p><a href="https://codelabs.developers.google.com/codelabs/cloud-spring-cloud-gcp-pubsub-integration/index.html">Messaging with Spring Integration and Cloud Pub/Sub</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The full collection of Spring codelabs can be found on the <a href="https://codelabs.developers.google.com/spring">Google Developer Codelabs page</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-gcp-core"><a class="anchor" href="#spring-cloud-gcp-core"></a><a class="link" href="#spring-cloud-gcp-core">3. Spring Framework on Google Cloud Core</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each Spring Framework on Google Cloud module uses <code>GcpProjectIdProvider</code> and <code>CredentialsProvider</code> to get the Google Cloud project ID and access credentials.</p>
</div>
<div class="paragraph">
<p>Spring Framework on Google Cloud provides a Spring Boot starter to auto-configure the core components.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter")
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="configuration"><a class="anchor" href="#configuration"></a><a class="link" href="#configuration">3.1. Configuration</a></h3>
<div class="paragraph">
<p>The following options may be configured with Spring Cloud core.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.core.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Google Cloud core auto configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="project-id"><a class="anchor" href="#project-id"></a><a class="link" href="#project-id">3.2. Project ID</a></h3>
<div class="paragraph">
<p><code>GcpProjectIdProvider</code> is a functional interface that returns a Google Cloud project ID string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface GcpProjectIdProvider {
    String getProjectId();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Spring Framework on Google Cloud starter auto-configures a <code>GcpProjectIdProvider</code>.
If a <code>spring.cloud.gcp.project-id</code> property is specified, the provided <code>GcpProjectIdProvider</code> returns that property value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">spring.cloud.gcp.project-id=my-gcp-project-id</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise, the project ID is discovered based on an
<a href="https://cloud.google.com/java/docs/reference/google-cloud-core/latest/com.google.cloud.ServiceOptions#com_google_cloud_ServiceOptions_getDefaultProjectId__">ordered list of rules</a>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The project ID specified by the <code>GOOGLE_CLOUD_PROJECT</code> environment variable</p>
</li>
<li>
<p>The Google App Engine project ID</p>
</li>
<li>
<p>The project ID specified in the JSON credentials file pointed by the <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable</p>
</li>
<li>
<p>The Google Cloud SDK project ID</p>
</li>
<li>
<p>The Google Compute Engine project ID, from the Google Compute Engine Metadata Server</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="credentials"><a class="anchor" href="#credentials"></a><a class="link" href="#credentials">3.3. Credentials</a></h3>
<div class="paragraph">
<p><code>CredentialsProvider</code> is a functional interface that returns the credentials to authenticate and authorize calls to Google Cloud Client Libraries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface CredentialsProvider {
  Credentials getCredentials() throws IOException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Spring Framework on Google Cloud starter auto-configures a <code>CredentialsProvider</code>.
It uses the <code>spring.cloud.gcp.credentials.location</code> property to locate the OAuth2 private key of a Google service account.
Keep in mind this property is a Spring Resource, so the credentials file can be obtained from a number of <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html#resources-implementations">different locations</a> such as the file system, classpath, URL, etc.
The next example specifies the credentials location property in the file system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.cloud.gcp.credentials.location=file:/usr/local/key.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can set the credentials by directly specifying the <code>spring.cloud.gcp.credentials.encoded-key</code> property.
The value should be the base64-encoded account private key in JSON format.</p>
</div>
<div class="paragraph">
<p>If that credentials aren&#8217;t specified through properties, the starter tries to discover credentials from a <a href="https://github.com/GoogleCloudPlatform/google-cloud-java#authentication">number of places</a>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Credentials file pointed to by the <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable</p>
</li>
<li>
<p>Credentials provided by the Google Cloud SDK <code>gcloud auth application-default login</code> command</p>
</li>
<li>
<p>Google App Engine built-in credentials</p>
</li>
<li>
<p>Google Cloud Shell built-in credentials</p>
</li>
<li>
<p>Google Compute Engine built-in credentials</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If your app is running on Google App Engine or Google Compute Engine, in most cases, you should omit the <code>spring.cloud.gcp.credentials.location</code> property and, instead, let the Spring Framework on Google Cloud Starter get the correct credentials for those environments.
On App Engine Standard, the <a href="https://cloud.google.com/appengine/docs/standard/java/appidentity/">App Identity service account credentials</a> are used, on App Engine Flexible, the <a href="https://cloud.google.com/appengine/docs/flexible/java/service-account">Flexible service account credential</a> are used and on Google Compute Engine, the <a href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances#using_the_compute_engine_default_service_account">Compute Engine Default Service Account</a> is used.</p>
</div>
<div class="sect3">
<h4 id="scopes"><a class="anchor" href="#scopes"></a><a class="link" href="#scopes">3.3.1. Scopes</a></h4>
<div class="paragraph">
<p>By default, the credentials provided by the Spring Framework on Google Cloud Starter contain scopes for every service supported by Spring Framework on Google Cloud.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scope</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spanner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/spanner.admin" class="bare">www.googleapis.com/auth/spanner.admin</a>, <a href="https://www.googleapis.com/auth/spanner.data" class="bare">www.googleapis.com/auth/spanner.data</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datastore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/datastore" class="bare">www.googleapis.com/auth/datastore</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pub/Sub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/pubsub" class="bare">www.googleapis.com/auth/pubsub</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage (Read Only)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/devstorage.read_only" class="bare">www.googleapis.com/auth/devstorage.read_only</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage (Read/Write)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/devstorage.read_write" class="bare">www.googleapis.com/auth/devstorage.read_write</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Runtime Config</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/cloudruntimeconfig" class="bare">www.googleapis.com/auth/cloudruntimeconfig</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trace (Append)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/trace.append" class="bare">www.googleapis.com/auth/trace.append</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Platform</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/cloud-platform" class="bare">www.googleapis.com/auth/cloud-platform</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vision</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/cloud-vision" class="bare">www.googleapis.com/auth/cloud-vision</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Spring Framework on Google Cloud starter allows you to configure a custom scope list for the provided credentials.
To do that, specify a comma-delimited list of <a href="https://developers.google.com/identity/protocols/googlescopes">Google OAuth2 scopes</a> in the <code>spring.cloud.gcp.credentials.scopes</code> property.</p>
</div>
<div class="paragraph">
<p><code>spring.cloud.gcp.credentials.scopes</code> is a comma-delimited list of <a href="https://developers.google.com/identity/protocols/googlescopes">Google OAuth2 scopes</a> for Google Cloud services that the credentials returned by the provided <code>CredentialsProvider</code> support.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.cloud.gcp.credentials.scopes=https://www.googleapis.com/auth/pubsub,https://www.googleapis.com/auth/sqlservice.admin</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <code>DEFAULT_SCOPES</code> placeholder as a scope to represent the starters default scopes, and append the additional scopes you need to add.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.cloud.gcp.credentials.scopes=DEFAULT_SCOPES,https://www.googleapis.com/auth/cloud-vision</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="environment"><a class="anchor" href="#environment"></a><a class="link" href="#environment">3.4. Environment</a></h3>
<div class="paragraph">
<p><code>GcpEnvironmentProvider</code> is a functional interface, auto-configured by the Spring Framework on Google Cloud starter, that returns a <code>GcpEnvironment</code> enum.
The provider can help determine programmatically in which Google Cloud environment (App Engine Flexible, App Engine Standard, Kubernetes Engine or Compute Engine) the application is deployed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface GcpEnvironmentProvider {
    GcpEnvironment getCurrentEnvironment();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customizing-bean-scope"><a class="anchor" href="#customizing-bean-scope"></a><a class="link" href="#customizing-bean-scope">3.5. Customizing bean scope</a></h3>
<div class="paragraph">
<p>Spring Framework on Google Cloud starters autoconfigure all necessary beans in the default singleton scope.
If you need a particular bean or set of beans to be recreated dynamically (for example, to rotate credentials), there are two options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Annotate custom beans of the necessary types with <code>@RefreshScope</code>.
This makes the most sense if your application is already redefining those beans.</p>
</li>
<li>
<p>Override the scope for autoconfigured beans by listing them in the Spring Cloud property <code>spring.cloud.refresh.extra-refreshable</code>.</p>
<div class="paragraph">
<p>For example, the beans involved in Cloud Pub/Sub subscription could be marked as refreshable as follows:</p>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.cloud.refresh.extra-refreshable=com.google.cloud.spring.pubsub.support.SubscriberFactory,\
  com.google.cloud.spring.pubsub.core.subscriber.PubSubSubscriberTemplate</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>SmartLifecycle</code> beans, such as Spring Integration adapters, do not currently support <code>@RefreshScope</code>.
If your application refreshes any beans used by such <code>SmartLifecycle</code> objects, it may also have to restart the beans manually when <code>RefreshScopeRefreshedEvent</code> is detected, such as in the Cloud Pub/Sub example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private PubSubInboundChannelAdapter pubSubAdapter;

@EventListener(RefreshScopeRefreshedEvent.class)
public void onRefreshScope(RefreshScopeRefreshedEvent event) {
  this.pubSubAdapter.stop();
  this.pubSubAdapter.start();
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="spring-initializr-2"><a class="anchor" href="#spring-initializr-2"></a><a class="link" href="#spring-initializr-2">3.6. Spring Initializr</a></h3>
<div class="paragraph">
<p>This starter is available from <a href="https://start.spring.io/">Spring Initializr</a> through the <code>GCP Support</code> entry.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-storage"><a class="anchor" href="#cloud-storage"></a><a class="link" href="#cloud-storage">4. Cloud Storage</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://cloud.google.com/storage/docs">Google Cloud Storage</a> allows storing any types of files in single or multiple regions.
A Spring Boot starter is provided to auto-configure the various Storage components.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-storage&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-storage")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This starter is also available from <a href="https://start.spring.io/">Spring Initializr</a> through the <code>GCP Storage</code> entry.</p>
</div>
<div class="sect2">
<h3 id="using-cloud-storage"><a class="anchor" href="#using-cloud-storage"></a><a class="link" href="#using-cloud-storage">4.1. Using Cloud Storage</a></h3>
<div class="paragraph">
<p>The starter automatically configures and registers a <code>Storage</code> bean in the Spring application context.
The <code>Storage</code> bean (<a href="https://googleapis.dev/java/google-cloud-storage/latest/com/google/cloud/storage/Storage.html">Javadoc</a>) can be used to list/create/update/delete buckets (a group of objects with similar permissions and resiliency requirements) and objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private Storage storage;

public void createFile() {
    Bucket bucket = storage.create(BucketInfo.of("my-app-storage-bucket"));

    storage.create(
        BlobInfo.newBuilder("my-app-storage-bucket", "subdirectory/my-file").build(),
            "file contents".getBytes()
    );
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloud-storage-objects-as-spring-resources"><a class="anchor" href="#cloud-storage-objects-as-spring-resources"></a><a class="link" href="#cloud-storage-objects-as-spring-resources">4.2. Cloud Storage Objects As Spring Resources</a></h3>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html">Spring Resources</a> are an abstraction for a number of low-level resources, such as file system files, classpath files, servlet context-relative files, etc.
Spring Framework on Google Cloud adds a new resource type: a Google Cloud Storage (GCS) object.</p>
</div>
<div class="paragraph">
<p>The Spring Resource Abstraction for Google Cloud Storage allows GCS objects to be accessed by their GCS URL using the <code>@Value</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("gs://[YOUR_GCS_BUCKET]/[GCS_FILE_NAME]")
private Resource gcsResource;</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;or the Spring application context</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">SpringApplication.run(...).getResource("gs://[YOUR_GCS_BUCKET]/[GCS_FILE_NAME]");</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a <code>Resource</code> object that can be used to read the object, among <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html#resources-resource">other possible operations</a>.</p>
</div>
<div class="paragraph">
<p>It is also possible to write to a <code>Resource</code>, although a <code>WriteableResource</code> is required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("gs://[YOUR_GCS_BUCKET]/[GCS_FILE_NAME]")
private Resource gcsResource;
...
try (OutputStream os = ((WritableResource) gcsResource).getOutputStream()) {
  os.write("foo".getBytes());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To work with the <code>Resource</code> as a Google Cloud Storage resource, cast it to <code>GoogleStorageResource</code>.</p>
</div>
<div class="paragraph">
<p>If the resource path refers to an object on Google Cloud Storage (as opposed to a bucket), then the <code>getBlob</code> method can be called to obtain a <a href="https://github.com/GoogleCloudPlatform/google-cloud-java/blob/main/google-cloud-storage/src/main/java/com/google/cloud/storage/Blob.java"><code>Blob</code></a>.
This type represents a GCS file, which has associated <a href="https://cloud.google.com/storage/docs/gsutil/addlhelp/WorkingWithObjectMetadata">metadata</a>, such as content-type, that can be set.
The <code>createSignedUrl</code> method can also be used to obtain <a href="https://cloud.google.com/storage/docs/access-control/signed-urls">signed URLs</a> for GCS objects.
However, creating signed URLs requires that the resource was created using service account credentials.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of v2.0.2+, the <code>GoogleStorageResource.getURL()</code> method returns the <code>Bucket</code> or <code>Blob</code> 's <code>selfLink</code> value, rather than attempting to convert the <code>URI</code> a <code>URL</code> object that nearly-always threw a <code>MalformedURLException</code>.
This value is notably different from <code>GoogleStorageResource.getURI()</code>, which returns the more commonly used <code>gs://my-bucket/my-object</code> identifier.
Returning a valid URL is necessary to support some features in the Spring ecosystem, such as <code>spring.resources.static-locations</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Spring Boot Starter for Google Cloud Storage auto-configures the <code>Storage</code> bean required by the <code>spring-cloud-gcp-storage</code> module, based on the <code>CredentialsProvider</code> provided by the Spring Framework on Google Cloud Starter.</p>
</div>
<div class="sect3">
<h4 id="setting-the-content-type"><a class="anchor" href="#setting-the-content-type"></a><a class="link" href="#setting-the-content-type">4.2.1. Setting the Content Type</a></h4>
<div class="paragraph">
<p>You can set the content-type of Google Cloud Storage files from their corresponding <code>Resource</code> objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">((GoogleStorageResource)gcsResource).getBlob().toBuilder().setContentType("text/html").build().update();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-2"><a class="anchor" href="#configuration-2"></a><a class="link" href="#configuration-2">4.3. Configuration</a></h3>
<div class="paragraph">
<p>The Spring Boot Starter for Google Cloud Storage provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.storage.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the Google Cloud storage APIs.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.storage.auto-create-files</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates files and buckets on Google Cloud Storage when writes are made to non-existent files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.storage.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2 credentials for authenticating with the Google Cloud Storage API, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.storage.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64-encoded contents of OAuth2 account private key for authenticating with the Google Cloud Storage API, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.storage.credentials.scopes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://developers.google.com/identity/protocols/googlescopes">OAuth2 scope</a> for Spring Framework on Google Cloud Storage credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/devstorage.read_write" class="bare">www.googleapis.com/auth/devstorage.read_write</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="sample"><a class="anchor" href="#sample"></a><a class="link" href="#sample">4.4. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-storage-resource-sample">sample application</a> and a <a href="https://codelabs.developers.google.com/codelabs/spring-cloud-gcp-gcs/index.html">codelab</a> are available.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-sql"><a class="anchor" href="#cloud-sql"></a><a class="link" href="#cloud-sql">5. Cloud SQL</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Framework on Google Cloud adds integrations with
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html">Spring JDBC</a> and <a href="https://docs.spring.io/spring-data/r2dbc/docs/current/reference/html/#r2dbc.core">Spring R2DBC</a>  so you can run your MySQL or PostgreSQL databases in <a href="https://cloud.google.com/sql">Google Cloud SQL</a> using Spring JDBC and other libraries that depend on it like Spring Data JPA or Spring Data R2DBC.</p>
</div>
<div class="paragraph">
<p>The Cloud SQL support is provided by Spring Framework on Google Cloud in the form of two Spring Boot starters, one for MySQL and another one for PostgreSQL.
The role of the starters is to read configuration from properties and assume default settings so that user experience connecting to MySQL and PostgreSQL is as simple as possible.</p>
</div>
<div class="sect2">
<h3 id="jdbc-support"><a class="anchor" href="#jdbc-support"></a><a class="link" href="#jdbc-support">5.1. JDBC Support</a></h3>
<div class="paragraph">
<p>Maven and Gradle coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="paragraph">
<p>To use MySQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-sql-mysql&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
implementation("com.google.cloud:spring-cloud-gcp-starter-sql-mysql")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use PostgreSQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
&lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
&lt;artifactId&gt;spring-cloud-gcp-starter-sql-postgresql&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-sql-postgresql")
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="prerequisites"><a class="anchor" href="#prerequisites"></a><a class="link" href="#prerequisites">5.1.1. Prerequisites</a></h4>
<div class="paragraph">
<p>In order to use the Spring Boot Starters for Google Cloud SQL, the Google Cloud SQL API must be enabled in your Google Cloud project.</p>
</div>
<div class="paragraph">
<p>To do that, go to the <a href="https://console.cloud.google.com/apis/library">API library page</a> of the Google Cloud Console, search for "Cloud SQL API" and enable the option that is called "Cloud SQL" .</p>
</div>
</div>
<div class="sect3">
<h4 id="spring-boot-starter-for-google-cloud-sql"><a class="anchor" href="#spring-boot-starter-for-google-cloud-sql"></a><a class="link" href="#spring-boot-starter-for-google-cloud-sql">5.1.2. Spring Boot Starter for Google Cloud SQL</a></h4>
<div class="paragraph">
<p>The Spring Boot Starters for Google Cloud SQL provide an auto-configured <a href="https://docs.oracle.com/javase/7/docs/api/javax/sql/DataSource.html"><code>DataSource</code></a> object.
Coupled with Spring JDBC, it provides a
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html#jdbc-JdbcTemplate"><code>JdbcTemplate</code></a> object bean that allows for operations such as querying and modifying a database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public List&lt;Map&lt;String, Object&gt;&gt; listUsers() {
    return jdbcTemplate.queryForList("SELECT * FROM user;");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can rely on
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html#boot-features-connect-to-production-database">Spring Boot data source auto-configuration</a> to configure a <code>DataSource</code> bean.
In other words, properties like the SQL username, <code>spring.datasource.username</code>, and password, <code>spring.datasource.password</code> can be used.
There is also some configuration specific to Google Cloud SQL (see "Cloud SQL Configuration Properties" section below).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.datasource.username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL: <code>root</code>; PostgreSQL: <code>postgres</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.datasource.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.datasource.driver-class-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBC driver to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL: <code>com.mysql.cj.jdbc.Driver</code>; PostgreSQL: <code>org.postgresql.Driver</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you provide your own <code>spring.datasource.url</code>, it will be ignored, unless you disable Cloud SQL auto configuration with <code>spring.cloud.gcp.sql.enabled=false</code> or <code>spring.cloud.gcp.sql.jdbc.enabled=false</code>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="datasource-creation-flow"><a class="anchor" href="#datasource-creation-flow"></a><a class="link" href="#datasource-creation-flow"><code>DataSource</code> creation flow</a></h5>
<div class="paragraph">
<p>Spring Boot starter for Google Cloud SQL registers a <code>CloudSqlEnvironmentPostProcessor</code> that provides a correctly formatted <code>spring.datasource.url</code> property to the environment based on the properties mentioned above.
It also provides defaults for <code>spring.datasource.username</code> and <code>spring.datasource.driver-class-name</code>, which can be overridden.
The starter also configures credentials for the JDBC connection based on the properties below.</p>
</div>
<div class="paragraph">
<p>The user properties and the properties provided by the <code>CloudSqlEnvironmentPostProcessor</code> are then used by <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html">Spring Boot</a> to create the <code>DataSource</code>.
You can select the type of connection pool (e.g., Tomcat, HikariCP, etc.) by <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html#boot-features-connect-to-production-database">adding their dependency to the classpath</a>.</p>
</div>
<div class="paragraph">
<p>Using the created <code>DataSource</code> in conjunction with Spring JDBC provides you with a fully configured and operational <code>JdbcTemplate</code> object that you can use to interact with your SQL database.
You can connect to your database with as little as a database and instance names.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="r2dbc-support"><a class="anchor" href="#r2dbc-support"></a><a class="link" href="#r2dbc-support">5.2. R2DBC Support</a></h3>
<div class="paragraph">
<p>Maven and Gradle coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="paragraph">
<p>To use MySQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-sql-mysql-r2dbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-sql-mysql-r2dbc")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use PostgreSQL with Spring Boot 2.6:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-sql-postgres-r2dbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-sql-postgres-r2dbc")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use PostgreSQL with Spring Boot 2.7 (the latest version of the Postgres R2DBC driver changed its Maven coordinates):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-sql-postgres-r2dbc&lt;/artifactId&gt;
    &lt;exclusions&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;io.r2dbc&lt;/groupId&gt;
            &lt;artifactId&gt;r2dbc-postgresql&lt;/artifactId&gt;
        &lt;/exclusion&gt;
    &lt;/exclusions&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
    &lt;artifactId&gt;r2dbc-postgresql&lt;/artifactId&gt;
    &lt;version&gt;0.9.1.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="prerequisites-2"><a class="anchor" href="#prerequisites-2"></a><a class="link" href="#prerequisites-2">5.2.1. Prerequisites</a></h4>
<div class="paragraph">
<p>In order to use the Spring Boot Starters for Google Cloud SQL, the Google Cloud SQL API must be enabled in your Google Cloud project.</p>
</div>
<div class="paragraph">
<p>To do that, go to the <a href="https://console.cloud.google.com/apis/library">API library page</a> of the Google Cloud Console, search for "Cloud SQL API" and enable the option that is called "Cloud SQL".</p>
</div>
</div>
<div class="sect3">
<h4 id="spring-boot-starter-for-google-cloud-sql-2"><a class="anchor" href="#spring-boot-starter-for-google-cloud-sql-2"></a><a class="link" href="#spring-boot-starter-for-google-cloud-sql-2">5.2.2. Spring Boot Starter for Google Cloud SQL</a></h4>
<div class="paragraph">
<p>The Cloud SQL R2DBC starter provides a customized <code>io.r2dbc.spi.ConnectionFactory</code> bean for connecting to Cloud SQL with the help of the <a href="https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory">Cloud SQL Socket Factory</a>.
Similar to the JDBC support, you can connect to your database with as little as a database and instance names.</p>
</div>
<div class="paragraph">
<p>A higher level convenience object
<a href="https://docs.spring.io/spring-data/r2dbc/docs/current/reference/html/#r2dbc.core"><code>R2dbcEntityTemplate</code></a> is also provided for operations such as querying and modifying a database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired R2dbcEntityTemplate template;

public Flux&lt;String&gt; listUsers() {
  return template.select(User.class).all().map(user -&gt; user.toString());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Standard R2DBC properties like the SQL username, <code>spring.r2dbc.username</code>, and password, <code>spring.r2dbc.password</code> can be used.
There is also some configuration specific to Google Cloud SQL (see "Cloud SQL Configuration Properties" section below).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.r2dbc.username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL: <code>root</code>; PostgreSQL: <code>postgres</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.r2dbc.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you provide your own <code>spring.r2dbc.url</code>, it will be ignored, unless you disable Cloud SQL auto-configuration for R2DBC with <code>spring.cloud.gcp.sql.enabled=false</code> or <code>spring.cloud.gcp.sql.r2dbc.enabled=false</code> .
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="connectionfactory-creation-flow"><a class="anchor" href="#connectionfactory-creation-flow"></a><a class="link" href="#connectionfactory-creation-flow"><code>ConnectionFactory</code> creation flow</a></h5>
<div class="paragraph">
<p>Spring Framework on Google Cloud starter for Google Cloud SQL registers a <code>R2dbcCloudSqlEnvironmentPostProcessor</code> that provides a correctly formatted <code>spring.r2dbc.url</code> property to the environment based on the properties mentioned above.
It also provides a default value for <code>spring.r2dbc.username</code>, which can be overridden.
The starter also configures credentials for the R2DBC connection based on the properties below.</p>
</div>
<div class="paragraph">
<p>The user properties and the properties provided by the <code>R2dbcCloudSqlEnvironmentPostProcessor</code> are then used by Spring Boot to create the <code>ConnectionFactory</code>.</p>
</div>
<div class="paragraph">
<p>The customized <code>ConnectionFactory</code> is then ready to connect to Cloud SQL. The rest of Spring Data R2DBC objects built on it ( <code>R2dbcEntityTemplate</code>,  <code>DatabaseClient</code>) are automatically configured and operational, ready to interact with your SQL database.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloud-sql-iam-database-authentication"><a class="anchor" href="#cloud-sql-iam-database-authentication"></a><a class="link" href="#cloud-sql-iam-database-authentication">5.3. Cloud SQL IAM database authentication</a></h3>
<div class="paragraph">
<p>Currently, Cloud SQL only supports <a href="https://cloud.google.com/sql/docs/postgres/authentication">IAM database authentication for PostgreSQL</a>.
It allows you to connect to the database using an IAM account, rather than a predefined database username and password.
You will need to do the following to enable it:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In your database instance settings, turn on the <code>cloudsql.iam_authentication</code> flag.</p>
</li>
<li>
<p>Add the IAM user or service account to the list of database users.</p>
</li>
<li>
<p>In the application settings, set <code>spring.cloud.gcp.sql.enableIamAuth</code> to <code>true</code>. Note that this will also set the database protocol <code>sslmode</code> to <code>disabled</code>, as it&#8217;s required for IAM authentication to work.
However, it doesn&#8217;t compromise the security of the communication because the connection is always encrypted.</p>
</li>
<li>
<p>Set <code>spring.datasource.username</code> to the IAM user or service account created in step 2. Note that IAM user or service account still needs to be <a href="https://www.postgresql.org/docs/current/sql-grant.html">granted permissions</a> before modifying or querying the database.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="cloud-sql-configuration-properties"><a class="anchor" href="#cloud-sql-configuration-properties"></a><a class="link" href="#cloud-sql-configuration-properties">5.4. Cloud SQL Configuration Properties</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.sql.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Cloud SQL auto configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.sql.jdbc.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Cloud SQL auto-configuration for JDBC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.sql.r2dbc.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Cloud SQL auto-configuration for R2DBC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.sql.database-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the database to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.sql.instance-connection-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string containing a Google Cloud SQL instance&#8217;s project ID, region and name, each separated by a colon.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For example, <code>my-project-id:my-region:my-instance-name</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.sql.ip-types</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows you to specify a comma delimited list of preferred IP types for connecting to a Cloud SQL instance. Left unconfigured Cloud SQL Socket Factory will default it to <code>PUBLIC,PRIVATE</code>. See <a href="https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory#specifying-ip-types">Cloud SQL Socket Factory - Specifying IP Types</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PUBLIC,PRIVATE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.sql.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File system path to the Google OAuth2 credentials private key file.
Used to authenticate and authorize new connections to a Google Cloud SQL instance.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default credentials provided by the Spring Framework on Google Cloud Core Starter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.sql.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64-encoded contents of OAuth2 account private key in JSON format.
Used to authenticate and authorize new connections to a Google Cloud SQL instance.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default credentials provided by the Spring Framework on Google Cloud Core Starter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.sql.enableIamAuth</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies whether to enable IAM database authentication (PostgreSQL only).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>False</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="troubleshooting-tips"><a class="anchor" href="#troubleshooting-tips"></a><a class="link" href="#troubleshooting-tips">5.5. Troubleshooting tips</a></h3>
<div class="sect3">
<h4 id="connection-issues"><a class="anchor" href="#connection-issues"></a><a class="link" href="#connection-issues">5.5.1. Connection issues</a></h4>
<div class="paragraph">
<p>If you&#8217;re not able to connect to a database and see an endless loop of <code>Connecting to Cloud SQL instance [&#8230;&#8203;] on IP [&#8230;&#8203;]</code>, it&#8217;s likely that exceptions are being thrown and logged at a level lower than your logger&#8217;s level.
This may be the case with HikariCP, if your logger is set to INFO or higher level.</p>
</div>
<div class="paragraph">
<p>To see what&#8217;s going on in the background, you should add a <code>logback.xml</code> file to your application resources folder, that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
  &lt;include resource="org/springframework/boot/logging/logback/base.xml"/&gt;
  &lt;logger name="com.zaxxer.hikari.pool" level="DEBUG"/&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="errors-like-c-g-cloud-sql-core-sslsocketfactory-re-throwing-cached-exception-due-to-attempt-to-refresh-instance-information-too-soon-after-error"><a class="anchor" href="#errors-like-c-g-cloud-sql-core-sslsocketfactory-re-throwing-cached-exception-due-to-attempt-to-refresh-instance-information-too-soon-after-error"></a><a class="link" href="#errors-like-c-g-cloud-sql-core-sslsocketfactory-re-throwing-cached-exception-due-to-attempt-to-refresh-instance-information-too-soon-after-error">5.5.2. Errors like <code>c.g.cloud.sql.core.SslSocketFactory : Re-throwing cached exception due to attempt to refresh instance information too soon after error</code></a></h4>
<div class="paragraph">
<p>If you see a lot of errors like this in a loop and can&#8217;t connect to your database, this is usually a symptom that something isn&#8217;t right with the permissions of your credentials or the Google Cloud SQL API is not enabled.
Verify that the Google Cloud SQL API is enabled in the Cloud Console and that your service account has the <a href="https://cloud.google.com/sql/docs/mysql/project-access-control#roles">necessary IAM roles</a>.</p>
</div>
<div class="paragraph">
<p>To find out what&#8217;s causing the issue, you can enable DEBUG logging level as mentioned <a href="#connection-issues">above</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="postgresql-java-net-socketexception-already-connected-issue"><a class="anchor" href="#postgresql-java-net-socketexception-already-connected-issue"></a><a class="link" href="#postgresql-java-net-socketexception-already-connected-issue">5.5.3. PostgreSQL: <code>java.net.SocketException: already connected</code> issue</a></h4>
<div class="paragraph">
<p>We found this exception to be common if your Maven project&#8217;s parent is <code>spring-boot</code> version <code>1.5.x</code>, or in any other circumstance that would cause the version of the <code>org.postgresql:postgresql</code> dependency to be an older one (e.g., <code>9.4.1212.jre7</code>).</p>
</div>
<div class="paragraph">
<p>To fix this, re-declare the dependency in its correct version.
For example, in Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
  &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
  &lt;version&gt;42.1.1&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples"><a class="anchor" href="#samples"></a><a class="link" href="#samples">5.6. Samples</a></h3>
<div class="paragraph">
<p>Available sample applications and codelabs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-sql-mysql-sample">Spring Framework on Google Cloud MySQL</a></p>
</li>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-sql-postgres-sample">Spring Framework on Google Cloud PostgreSQL</a></p>
</li>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-jpa-sample">Spring Data JPA with Spring Framework on Google Cloud SQL</a></p>
</li>
<li>
<p>Codelab: <a href="https://codelabs.developers.google.com/codelabs/cloud-spring-petclinic-cloudsql/index.html">Spring Pet Clinic using Cloud SQL</a></p>
</li>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-sql-mysql-r2dbc-sample">R2DBC: Spring Framework on Google Cloud MySQL</a></p>
</li>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-sql-postgres-r2dbc-sample">R2DBC: Spring Framework on Google Cloud PostgreSQL</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-pubsub"><a class="anchor" href="#cloud-pubsub"></a><a class="link" href="#cloud-pubsub">6. Cloud Pub/Sub</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Framework on Google Cloud provides an abstraction layer to publish to and subscribe from Google Cloud Pub/Sub topics and to create, list or delete Google Cloud Pub/Sub topics and subscriptions.</p>
</div>
<div class="paragraph">
<p>A Spring Boot starter is provided to auto-configure the various required Pub/Sub components.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-pubsub&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-pubsub")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This starter is also available from <a href="https://start.spring.io">Spring Initializr</a> through the <code>GCP Messaging</code> entry.</p>
</div>
<div class="sect2">
<h3 id="pubsub-configuration"><a class="anchor" href="#pubsub-configuration"></a><a class="link" href="#pubsub-configuration">6.1. Configuration</a></h3>
<div class="paragraph">
<p>The Spring Boot starter for Google Cloud Pub/Sub provides the following configuration options.</p>
</div>
<div class="sect3">
<h4 id="spring-framework-on-google-cloud-pubsub-api-configuration"><a class="anchor" href="#spring-framework-on-google-cloud-pubsub-api-configuration"></a><a class="link" href="#spring-framework-on-google-cloud-pubsub-api-configuration">6.1.1. Spring Framework on Google Cloud Pub/Sub API Configuration</a></h4>
<div class="paragraph">
<p>This section describes options for enabling the integration, specifying the Google Cloud project and credentials, and setting whether the APIs should connect to an emulator for local testing.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Pub/Sub auto-configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Cloud project ID where the Google Cloud Pub/Sub API is hosted, if different from the one in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2 credentials for authenticating with the
Google Cloud Pub/Sub API, if different from the ones in the
<a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.emulator-host</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The host and port of the local running emulator.
If provided, this will setup the client to connect against a running <a href="https://cloud.google.com/pubsub/docs/emulator">Google Cloud Pub/Sub Emulator</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64-encoded contents of OAuth2 account private key for authenticating with the
Google Cloud Pub/Sub API, if different from the ones in the
<a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.credentials.scopes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://developers.google.com/identity/protocols/googlescopes">OAuth2 scope</a> for Spring Framework on Google Cloud
Pub/Sub credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/pubsub" class="bare">www.googleapis.com/auth/pubsub</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="publishersubscriber-configuration"><a class="anchor" href="#publishersubscriber-configuration"></a><a class="link" href="#publishersubscriber-configuration">6.1.2. Publisher/Subscriber Configuration</a></h4>
<div class="paragraph">
<p>This section describes configuration options to customize the behavior of the application&#8217;s Pub/Sub publishers and subscribers.
Subscriber settings can be either global or subscription-specific.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A custom configuration (injected through a setter in <code>DefaultSubscriberFactory</code> or a custom bean) will take precedence over auto-configuration.
Hence, if one wishes to use per-subscription configuration for a Pub/Sub setting, there must not be a custom bean for that setting.
When using auto-configuration, if both global and per-subscription configurations are provided, then the per-subscription configuration will be used.
However, if a per-subscription configuration is not set then the global or default configuration will be used.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscriber.parallel-pull-count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of pull workers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscriber.max-ack-extension-period</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum period a message ack deadline will be extended, in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscriber.min-duration-per-ack-extension</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lower bound for a single mod ack extension period, in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscriber.max-duration-per-ack-extension</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The upper bound for a single mod ack extension period, in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscriber.pull-endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The endpoint for synchronous pulling messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pubsub.googleapis.com:443</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].executor-threads</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of threads used by <code>Subscriber</code> instances created by <code>SubscriberFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher.batching].flow-control.max-outstanding-element-count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of outstanding elements to keep in memory before enforcing flow control.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unlimited</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher.batching].flow-control.max-outstanding-request-bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of outstanding bytes to keep in memory before enforcing flow control.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unlimited</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher.batching].flow-control.limit-exceeded-behavior</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The behavior when the specified limits are exceeded.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.publisher.batching.element-count-threshold</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The element count threshold to use for batching.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 (batching off)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.publisher.batching.request-byte-threshold</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The request byte threshold to use for batching.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 byte (batching off)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.publisher.batching.delay-threshold-seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The delay threshold to use for batching.
After this amount of time has elapsed (counting from the first element added), the elements will be wrapped up in a batch and sent.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 ms (batching off)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.publisher.batching.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables batching.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.publisher.enable-message-ordering</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables message ordering.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.publisher.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The publisher endpoint.
Example: <code>"us-east1-pubsub.googleapis.com:443"</code>.
This is useful in conjunction with enabling message ordering because sending messages to the same region ensures they are received in order even when multiple publishers are used.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pubsub.googleapis.com:443</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="subscription-specific-configurations"><a class="anchor" href="#subscription-specific-configurations"></a><a class="link" href="#subscription-specific-configurations">Subscription-specific Configurations</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].fully-qualified-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The fully-qualified subscription name in the <code>projects/[PROJECT]/subscriptions/[SUBSCRIPTION]</code> format. When this property is present, the <code>[subscription-name]</code> key does not have to match any actual resources; it&#8217;s used only for logical grouping.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].parallel-pull-count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of pull workers.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].max-ack-extension-period</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum period a message ack deadline will be extended, in seconds.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].min-duration-per-ack-extension</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lower bound for a single mod ack extension period, in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].max-duration-per-ack-extension</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The upper bound for a single mod ack extension period, in seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].pull-endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The endpoint for synchronous pulling messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pubsub.googleapis.com:443</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].executor-threads</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of threads used by <code>Subscriber</code> instances created by <code>SubscriberFactory</code>. Note that configuring per-subscription <code>executor-threads</code> will result in the creation of thread pools for both global/default <strong>and</strong> per-subscription configurations.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].flow-control.max-outstanding-element-count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of outstanding elements to keep in memory before enforcing flow control.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unlimited</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].flow-control.max-outstanding-request-bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of outstanding bytes to keep in memory before enforcing flow control.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unlimited</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].flow-control.limit-exceeded-behavior</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The behavior when the specified limits are exceeded.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, subscription-specific threads are named after fully-qualified subscription name, ex: <code>gcp-pubsub-subscriber-projects/project-id/subscriptions/subscription-name</code>.
This can be customized, by registering a <code>SelectiveSchedulerThreadNameProvider</code> bean.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="grpc-connection-settings"><a class="anchor" href="#grpc-connection-settings"></a><a class="link" href="#grpc-connection-settings">6.1.3. GRPC Connection Settings</a></h4>
<div class="paragraph">
<p>The Pub/Sub API uses the <a href="https://cloud.google.com/pubsub/docs/reference/service_apis_overview#grpc_api">GRPC</a> protocol to send API requests to the Pub/Sub service.
This section describes configuration options for customizing the GRPC behavior.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The properties that refer to <code>retry</code> control the RPC retries for transient failures during the gRPC call to Cloud Pub/Sub server.
They do <strong>not</strong> control message redelivery; only message acknowledgement deadline can be used to extend or shorten the amount of time until Pub/Sub attempts redelivery.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.keepAliveIntervalMinutes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines frequency of keepalive gRPC ping</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5 minutes</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscriber.retryableCodes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RPC status codes that should be retried when pulling messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNKNOWN,ABORTED,UNAVAILABLE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].retry.total-timeout-seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TotalTimeout has ultimate control over how long the logic should keep trying the remote call until it gives up completely.
The higher the total timeout, the more retries can be attempted.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].retry.initial-retry-delay-second</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">InitialRetryDelay controls the delay before the first retry.
Subsequent retries will use this value adjusted according to the RetryDelayMultiplier.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].retry.retry-delay-multiplier</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RetryDelayMultiplier controls the change in retry delay.
The retry delay of the previous call is multiplied by the RetryDelayMultiplier to calculate the retry delay for the next call.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].retry.max-retry-delay-seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxRetryDelay puts a limit on the value of the retry delay, so that the RetryDelayMultiplier
can&#8217;t increase the retry delay higher than this amount.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].retry.max-attempts</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxAttempts defines the maximum number of attempts to perform.
If this value is greater than 0, and the number of attempts reaches this limit, the logic will give up retrying even if the total retry time is still lower than TotalTimeout.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].retry.jittered</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jitter determines if the delay time should be randomized.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].retry.initial-rpc-timeout-seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">InitialRpcTimeout controls the timeout for the initial RPC.
Subsequent calls will use this value adjusted according to the RpcTimeoutMultiplier.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].retry.rpc-timeout-multiplier</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RpcTimeoutMultiplier controls the change in RPC timeout.
The timeout of the previous call is multiplied by the RpcTimeoutMultiplier to calculate the timeout for the next call.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.[subscriber,publisher].retry.max-rpc-timeout-seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxRpcTimeout puts a limit on the value of the RPC timeout, so that the RpcTimeoutMultiplier
can&#8217;t increase the RPC timeout higher than this amount.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Subscription-specific Configuration</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retryableCodes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RPC status codes that should be retried when pulling messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNKNOWN,ABORTED,UNAVAILABLE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retry.total-timeout-seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TotalTimeout has ultimate control over how long the logic should keep trying the remote call until it gives up completely. The higher the total timeout, the more retries can be attempted.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retry.initial-retry-delay-second</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">InitialRetryDelay controls the delay before the first retry.
Subsequent retries will use this value adjusted according to the RetryDelayMultiplier.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retry.retry-delay-multiplier</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RetryDelayMultiplier controls the change in retry delay.
The retry delay of the previous call is multiplied by the RetryDelayMultiplier to calculate the retry delay for the next call.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retry.max-retry-delay-seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxRetryDelay puts a limit on the value of the retry delay, so that the RetryDelayMultiplier
can&#8217;t increase the retry delay higher than this amount.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retry.max-attempts</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxAttempts defines the maximum number of attempts to perform.
If this value is greater than 0, and the number of attempts reaches this limit, the logic will give up retrying even if the total retry time is still lower than TotalTimeout.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retry.jittered</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jitter determines if the delay time should be randomized.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retry.initial-rpc-timeout-seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">InitialRpcTimeout controls the timeout for the initial RPC.
Subsequent calls will use this value adjusted according to the RpcTimeoutMultiplier.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retry.rpc-timeout-multiplier</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RpcTimeoutMultiplier controls the change in RPC timeout.
The timeout of the previous call is multiplied by the RpcTimeoutMultiplier to calculate the timeout for the next call.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.subscription.[subscription-name].retry.max-rpc-timeout-seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxRpcTimeout puts a limit on the value of the RPC timeout, so that the RpcTimeoutMultiplier
can&#8217;t increase the RPC timeout higher than this amount.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="programmatic-configuration"><a class="anchor" href="#programmatic-configuration"></a><a class="link" href="#programmatic-configuration">6.1.4. Programmatic Configuration</a></h4>
<div class="paragraph">
<p>To apply publishing customizations not covered by the properties above, you may provide custom beans of type <code>PublisherCustomizer</code> to post-process the <code>Publisher.Builder</code> object right before it is built into a <code>Publisher</code>.
The <code>PublisherCustomizer</code> beans may be annotated with Spring Framework&#8217;s <code>@Order</code> annotation to ensure they are applied in a particular sequence.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-boot-actuator-support"><a class="anchor" href="#spring-boot-actuator-support"></a><a class="link" href="#spring-boot-actuator-support">6.2. Spring Boot Actuator Support</a></h3>
<div class="sect3">
<h4 id="cloud-pubsub-health-indicator"><a class="anchor" href="#cloud-pubsub-health-indicator"></a><a class="link" href="#cloud-pubsub-health-indicator">6.2.1. Cloud Pub/Sub Health Indicator</a></h4>
<div class="paragraph">
<p>If you are using Spring Boot Actuator, you can take advantage of the Cloud Pub/Sub health indicator called <code>pubsub</code>.
The health indicator will verify whether Cloud Pub/Sub is up and accessible by your application.
To enable it, all you need to do is add the <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready">Spring Boot Actuator</a> to your project.</p>
</div>
<div class="paragraph">
<p>The <code>pubsub</code> indicator will then roll up to the overall application status visible at <a href="http://localhost:8080/actuator/health" class="bare">localhost:8080/actuator/health</a> (use the <code>management.endpoint.health.show-details</code> property to view per-indicator details).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your application already has actuator and Cloud Pub/Sub starters, this health indicator is enabled by default.
To disable the Cloud Pub/Sub indicator, set <code>management.health.pubsub.enabled</code> to <code>false</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The health indicator validates the connection to Pub/Sub by pulling messages from a Pub/Sub subscription.</p>
</div>
<div class="paragraph">
<p>If no subscription has been specified via <code>spring.cloud.gcp.pubsub.health.subscription</code>, it will pull messages from a random subscription that is expected not to exist.
It will signal "up" if it is able to connect to Spring Framework on Google Cloud Pub/Sub APIs, i.e. the pull results in a response of <code>NOT_FOUND</code> or <code>PERMISSION_DENIED</code>.</p>
</div>
<div class="paragraph">
<p>If a custom subscription has been specified, this health indicator will signal "up" if messages are successfully pulled and (optionally) acknowledged, or when a successful pull is performed but no messages are returned from Pub/Sub.
Note that messages pulled from the subscription will not be acknowledged, unless you set the <code>spring.cloud.gcp.pubsub.health.acknowledge-messages</code> option to <code>true</code>.
So, take care not to configure a subscription that has a business impact, or instead leave the custom subscription out completely.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>management.health.pubsub.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable the Pub/Sub health indicator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> with Spring Boot Actuator, <code>false</code> otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.health.subscription</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subscription to health check against by pulling a message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Random non-existent</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.health.timeout-millis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Milliseconds to wait for response from Pub/Sub before timing out</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.health.acknowledge-messages</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to acknowledge messages pulled from the optionally specified subscription</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="cloud-pubsub-subscription-health-indicator"><a class="anchor" href="#cloud-pubsub-subscription-health-indicator"></a><a class="link" href="#cloud-pubsub-subscription-health-indicator">6.2.2. Cloud Pub/Sub Subscription Health Indicator</a></h4>
<div class="paragraph">
<p>If you are using Spring Boot Actuator, you can take advantage of the Cloud Pub/Sub subscription health indicator called <code>pubsub-subscriber</code>.
The subscription health indicator will verify whether Pub/Sub subscriptions are actively processing messages from the subscription&#8217;s backlog.
To enable it, you need to add the <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready">Spring Boot Actuator</a> to your project and the <a href="https://cloud.google.com/monitoring/docs/reference/libraries">Google Cloud Monitoring</a>.
Also you need to set the following properties <code>spring.cloud.gcp.pubsub.health.lagThreshold</code>, <code>spring.cloud.gcp.pubsub.health.backlogThreshold</code>.</p>
</div>
<div class="paragraph">
<p>The <code>pubsub-subscriber</code> indicator will then roll up to the overall application status visible at <a href="http://localhost:8080/actuator/health" class="bare">localhost:8080/actuator/health</a> (use the <code>management.endpoint.health.show-details</code> property to view per-indicator details).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;google-cloud-monitoring&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The health indicator validates a subscriber&#8217;s health by checking the subscription&#8217;s message backlog and the last processed message.
A subscription&#8217;s backlog is retrieved using Google Cloud&#8217;s Monitoring Metrics. The metric used is the <code>num_undelivered_messages</code> for a subscription.</p>
</div>
<div class="paragraph">
<p>If a message has been recently processed in a reasonable time threshold, then the subscriber is healthy.
If the backlog of messages for a subscription is big but the subscriber consumes messages then subscriber is still healthy.
If there hasn&#8217;t been any processing of recent messages but the backlog increases, then the subscriber is unhealthy.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The health indicator will not behave entirely as expected if Dead Letter Queueing is enabled on the subscription being checked, num_undelivered_messages will drop down by itself after DLQ threshold is reached.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>management.health.pubsub-subscriber.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable the Pub/Sub Subscription health indicator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> with Spring Boot Actuator, <code>false</code> otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.health.lagThreshold</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Threshold in seconds over message processing lag</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provided</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.health.backlogThreshold</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The threshold number of messages for a subscription backlog</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provided</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.health.lookUpInterval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The optional interval in seconds for subscription backlog lookup</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.pubsub.health.executorThreads</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of threads used for Health Check Executors</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>4</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="pubsub-operations-template"><a class="anchor" href="#pubsub-operations-template"></a><a class="link" href="#pubsub-operations-template">6.3. Pub/Sub Operations &amp; Template</a></h3>
<div class="paragraph">
<p><code>PubSubOperations</code> is an abstraction that allows Spring users to use Google Cloud Pub/Sub without depending on any Google Cloud Pub/Sub API semantics.
It provides the common set of operations needed to interact with Google Cloud Pub/Sub.
<code>PubSubTemplate</code> is the default implementation of <code>PubSubOperations</code> and it uses the <a href="https://github.com/GoogleCloudPlatform/google-cloud-java/tree/main/google-cloud-pubsub">Google Cloud Java Client for Pub/Sub</a> to interact with Google Cloud Pub/Sub.</p>
</div>
<div class="sect3">
<h4 id="publishing-to-a-topic"><a class="anchor" href="#publishing-to-a-topic"></a><a class="link" href="#publishing-to-a-topic">6.3.1. Publishing to a topic</a></h4>
<div class="paragraph">
<p><code>PubSubTemplate</code> provides asynchronous methods to publish messages to a Google Cloud Pub/Sub topic.
The <code>publish()</code> method takes in a topic name to post the message to, a payload of a generic type and, optionally, a map with the message headers.
The topic name could either be a short topic name within the current project, or the fully-qualified name referring to a topic in a different project using the <code>projects/[project_name]/topics/[topic_name]</code> format.</p>
</div>
<div class="paragraph">
<p>Here is an example of how to publish a message to a Google Cloud Pub/Sub topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Map&lt;String, String&gt; headers = Collections.singletonMap("key1", "val1");
pubSubTemplate.publish(topicName, "message", headers).get();</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>SimplePubSubMessageConverter</code> is used to convert payloads of type <code>byte[]</code>, <code>ByteString</code>, <code>ByteBuffer</code>, and <code>String</code> to Pub/Sub messages.</p>
</div>
<div class="sect4">
<h5 id="ordering-messages"><a class="anchor" href="#ordering-messages"></a><a class="link" href="#ordering-messages">Ordering messages</a></h5>
<div class="paragraph">
<p>If you are relying on message converters and would like to provide an ordering key, use the <code>GcpPubSubHeaders.ORDERING_KEY</code> header.
You will also need to make sure to enable message ordering on the publisher via the <code>spring.cloud.gcp.pubsub.publisher.enable-message-ordering</code> property.
Additionally, if you are using multiple publishers, you will want to set the <code>spring.cloud.gcp.pubsub.publisher.endpoint</code> to a regional endpoint such as <code>"us-east1-pubsub.googleapis.com:443"</code> so that messages are sent to the same region and received in order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Map&lt;String, String&gt; headers =
    Collections.singletonMap(GcpPubSubHeaders.ORDERING_KEY, "key1");
pubSubTemplate.publish(topicName, "message1", headers).get();
pubSubTemplate.publish(topicName, "message2", headers).get();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="subscribing-to-a-subscription"><a class="anchor" href="#subscribing-to-a-subscription"></a><a class="link" href="#subscribing-to-a-subscription">6.3.2. Subscribing to a subscription</a></h4>
<div class="paragraph">
<p>Google Cloud Pub/Sub allows many subscriptions to be associated to the same topic.
<code>PubSubTemplate</code> allows you to listen to subscriptions via the <code>subscribe()</code> method.
When listening to a subscription, messages will be pulled from Google Cloud Pub/Sub asynchronously and passed to a user provided message handler.
The subscription name could either be a short subscription name within the current project, or the fully-qualified name referring to a subscription in a different project using the <code>projects/[project_name]/subscriptions/[subscription_name]</code> format.</p>
</div>
<div class="sect4">
<h5 id="example"><a class="anchor" href="#example"></a><a class="link" href="#example">Example</a></h5>
<div class="paragraph">
<p>Subscribe to a subscription with a message handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Subscriber subscriber =
    pubSubTemplate.subscribe(
        subscriptionName,
        message -&gt; {
          logger.info(
              "Message received from "
                  + subscriptionName
                  + " subscription: "
                  + message.getPubsubMessage().getData().toStringUtf8());
          message.ack();
        });</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="subscribe-methods"><a class="anchor" href="#subscribe-methods"></a><a class="link" href="#subscribe-methods">Subscribe methods</a></h5>
<div class="paragraph">
<p><code>PubSubTemplate</code> provides the following subscribe methods:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">subscribe(String subscription, Consumer&lt;BasicAcknowledgeablePubsubMessage&gt; messageConsumer)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">asynchronously pulls messages and passes them to <code>messageConsumer</code></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">subscribeAndConvert(String subscription,
 			Consumer&lt;ConvertedBasicAcknowledgeablePubsubMessage&lt;T&gt;&gt; messageConsumer,
 			Class&lt;T&gt; payloadType)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as <code>pull</code>, but converts message payload to <code>payloadType</code> using the converter configured in the template</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As of version 1.2, subscribing by itself is not enough to keep an application running.
For a command-line application, you may want to provide your own <code>ThreadPoolTaskScheduler</code> bean named <code>pubsubSubscriberThreadPool</code>, which by default creates non-daemon threads that will keep an application from stopping.
This default behavior has been overridden in Spring Framework on Google Cloud for consistency with Cloud Pub/Sub client library, and to avoid holding up command-line applications that would like to shut down once their work is done.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pulling-messages-from-a-subscription"><a class="anchor" href="#pulling-messages-from-a-subscription"></a><a class="link" href="#pulling-messages-from-a-subscription">6.3.3. Pulling messages from a subscription</a></h4>
<div class="paragraph">
<p>Google Cloud Pub/Sub supports synchronous pulling of messages from a subscription.
This is different from subscribing to a subscription, in the sense that subscribing is an asynchronous task.</p>
</div>
<div class="sect4">
<h5 id="example-2"><a class="anchor" href="#example-2"></a><a class="link" href="#example-2">Example</a></h5>
<div class="paragraph">
<p>Pull up to 10 messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">int maxMessages = 10;
boolean returnImmediately = false;
List&lt;AcknowledgeablePubsubMessage&gt; messages =
    pubSubTemplate.pull(subscriptionName, maxMessages, returnImmediately);

// acknowledge the messages
pubSubTemplate.ack(messages);

messages.forEach(
    message -&gt;
        logger.info(message.getPubsubMessage().getData().toStringUtf8()));</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="pull-methods"><a class="anchor" href="#pull-methods"></a><a class="link" href="#pull-methods">Pull methods</a></h5>
<div class="paragraph">
<p><code>PubsubTemplate</code> provides the following pull methods:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">pull(String subscription, Integer maxMessages,
       			Boolean returnImmediately)</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pulls a number of messages from a subscription, allowing for the retry settings to be configured.
       			Any messages received by <code>pull()</code> are not automatically acknowledged. See <a href="#acknowledging-messages">Acknowledging messages</a>.</p>
<p class="tableblock">				The <code>maxMessages</code> parameter is the maximum limit of how many messages to pull from a subscription in a single call; this value <strong>must</strong> be greater than 0.
				You may omit this parameter by passing in <code>null</code>; this means there will be no limit on the number of messages pulled (<code>maxMessages</code> will be <code>Integer.MAX_INTEGER</code>).</p>
<p class="tableblock">       			If <code>returnImmediately</code> is <code>true</code>, the system will respond immediately even if it there are no messages available to return in the <code>Pull</code> response. Otherwise, the system may wait (for a bounded amount of time) until at least one message is available, rather than returning no messages.</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">pullAndAck</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Works the same as the <code>pull</code> method and, additionally, acknowledges all received messages.</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">pullNext</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for a single message to be pulled and automatically acknowledged from a subscription.</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">pullAndConvert</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Works the same as the <code>pull</code> method and, additionally, converts the Pub/Sub binary payload to an object of the desired type, using the converter configured in the template.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
We do not recommend setting <code>returnImmediately</code> to <code>true</code>, as it may result in delayed message delivery.
"Immediately" really means 1 second, and if Pub/Sub cannot retrieve any messages from the backend in that time, it will return 0 messages, despite having messages queue up on the topic.
Therefore, we recommend setting <code>returnImmediately</code> to <code>false</code>, or using <code>subscribe</code> methods from the previous section.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="acknowledging-messages"><a class="anchor" href="#acknowledging-messages"></a><a class="link" href="#acknowledging-messages">Acknowledging messages</a></h5>
<div class="paragraph">
<p>There are two ways to acknowledge messages.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To acknowledge multiple messages at once, you can use the <code>PubSubTemplate.ack()</code> method.
You can also use the <code>PubSubTemplate.nack()</code> for negatively acknowledging messages.
Using these methods for acknowledging messages in batches is more efficient than acknowledging messages individually, but they <strong>require</strong> the collection of messages to be from the same project.</p>
</li>
<li>
<p>To acknowledge messages individually you can use the <code>ack()</code> or <code>nack()</code> method on each of them (to acknowledge or negatively acknowledge, correspondingly).</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All <code>ack()</code>, <code>nack()</code>, and <code>modifyAckDeadline()</code> methods on messages, as well as <code>PubSubSubscriberTemplate</code>, are implemented asynchronously, returning a <code>ListenableFuture&lt;Void&gt;</code> to enable asynchronous processing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="dead-letter-topics"><a class="anchor" href="#dead-letter-topics"></a><a class="link" href="#dead-letter-topics">Dead Letter Topics</a></h5>
<div class="paragraph">
<p>Your application may occasionally receive a message it cannot process.
If you <a href="#creating-a-subscription">create your <code>Subscription</code></a> passing the <code>Subscription.Builder</code> argument, you can specify a <code>DeadLetterPolicy</code> that will forward all <code>nack()</code>-ed and non-<code>ack()</code>-ed messages after a configurable amount of redelivery attempts.
See <a href="https://cloud.google.com/pubsub/docs/dead-letter-topics">here</a> for more information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public Subscription newSubscription() {
    // Must use the fully-qualified topic name.
    String fullDeadLetterTopic = PubSubTopicUtils
                        .toTopicName(DEAD_LETTER_TOPIC, gcpProjectIdProvider.getProjectId())
                        .toString();
    return pubSubAdmin.createSubscription(Subscription.newBuilder()
            .setName(SUBSCRIPTION_NAME)
            .setTopic(TOPIC_NAME)
            .setDeadLetterPolicy(DeadLetterPolicy.newBuilder()
                    .setDeadLetterTopic(fullDeadLetterTopic)
                    .setMaxDeliveryAttempts(6)
                    .build()));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dead letter topics are no different than any other topic, though some <a href="https://cloud.google.com/pubsub/docs/dead-letter-topics#granting_forwarding_permissions">additional permissions</a> are necessary to ensure the Cloud Pub/Sub service can successfully <code>ack</code> the original message and re-<code>publish</code> it on the dead letter topic.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="json-support"><a class="anchor" href="#json-support"></a><a class="link" href="#json-support">6.3.4. JSON support</a></h4>
<div class="paragraph">
<p>For serialization and deserialization of POJOs using Jackson JSON, configure a <code>PubSubMessageConverter</code> bean, and the Spring Boot starter for Spring Framework on Google Cloud Pub/Sub will automatically wire it into the <code>PubSubTemplate</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// Note: The ObjectMapper is used to convert Java POJOs to and from JSON.
// You will have to configure your own instance if you are unable to depend
// on the ObjectMapper provided by Spring Boot starters.
@Bean
public PubSubMessageConverter pubSubMessageConverter() {
  return new JacksonPubSubMessageConverter(new ObjectMapper());
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Alternatively, you can set it directly by calling the <code>setMessageConverter()</code> method on the <code>PubSubTemplate</code>.
Other implementations of the <code>PubSubMessageConverter</code> can also be configured in the same manner.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assuming you have the following class defined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">static class TestUser {

  String username;

  String password;

  public String getUsername() {
    return this.username;
  }

  void setUsername(String username) {
    this.username = username;
  }

  public String getPassword() {
    return this.password;
  }

  void setPassword(String password) {
    this.password = password;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can serialize objects to JSON on publish automatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">TestUser user = new TestUser();
user.setUsername("John");
user.setPassword("password");
pubSubTemplate.publish(topicName, user);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s how you convert messages to objects on pull:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">int maxMessages = 1;
boolean returnImmediately = false;
List&lt;ConvertedAcknowledgeablePubsubMessage&lt;TestUser&gt;&gt; messages =
    pubSubTemplate.pullAndConvert(
        subscriptionName, maxMessages, returnImmediately, TestUser.class);

ConvertedAcknowledgeablePubsubMessage&lt;TestUser&gt; message = messages.get(0);

// acknowledge the message
message.ack();

TestUser receivedTestUser = message.getPayload();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please refer to our <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-integration-pubsub-json-sample">Pub/Sub JSON Payload Sample App</a> as a reference for using this functionality.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="reactive-stream-subscriber"><a class="anchor" href="#reactive-stream-subscriber"></a><a class="link" href="#reactive-stream-subscriber">6.4. Reactive Stream Subscriber</a></h3>
<div class="paragraph">
<p>It is also possible to acquire a reactive stream backed by a subscription.
To do so, a Project Reactor dependency (<code>io.projectreactor:reactor-core</code>) must be added to the project.
The combination of the Pub/Sub starter and the Project Reactor dependencies will then make a <code>PubSubReactiveFactory</code> bean available, which can then be used to get a <code>Publisher</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
PubSubReactiveFactory reactiveFactory;

// ...

Flux&lt;AcknowledgeablePubsubMessage&gt; flux
                = reactiveFactory.poll("exampleSubscription", 1000);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Flux</code> then represents an infinite stream of Spring Framework on Google Cloud Pub/Sub messages coming in through the specified subscription.
For unlimited demand, the Pub/Sub subscription will be polled regularly, at intervals determined by <code>pollingPeriodMs</code> parameter passed in when creating the <code>Flux</code>.
For bounded demand, the <code>pollingPeriodMs</code> parameter is unused.
Instead, as many messages as possible (up to the requested number) are delivered immediately, with the remaining messages delivered as they become available.</p>
</div>
<div class="paragraph">
<p>Any exceptions thrown by the underlying message retrieval logic will be passed as an error to the stream.
The error handling operators (<code>Flux#retry()</code>, <code>Flux#onErrorResume()</code> etc.) can be used to recover.</p>
</div>
<div class="paragraph">
<p>The full range of Project Reactor operations can be applied to the stream.
For example, if you only want to fetch 5 messages, you can use <code>limitRequest</code> operation to turn the infinite stream into a finite one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Flux&lt;AcknowledgeablePubsubMessage&gt; fiveMessageFlux = flux.limitRequest(5);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Messages flowing through the <code>Flux</code> should be manually acknowledged.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">flux.doOnNext(AcknowledgeablePubsubMessage::ack);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pubsub-management"><a class="anchor" href="#pubsub-management"></a><a class="link" href="#pubsub-management">6.5. Pub/Sub management</a></h3>
<div class="paragraph">
<p><code>PubSubAdmin</code> is the abstraction provided by Spring Framework on Google Cloud to manage Google Cloud Pub/Sub resources.
It allows for the creation, deletion and listing of topics and subscriptions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Generally when referring to topics and subscriptions, you can either use the short canonical name within the current project, or the fully-qualified name referring to a topic or subscription in a different project using the <code>projects/[project_name]/(topics|subscriptions)/&lt;name&gt;</code> format.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Spring Boot starter for Spring Framework on Google Cloud Pub/Sub auto-configures a <code>PubSubAdmin</code> object using the <code>GcpProjectIdProvider</code> and the <code>CredentialsProvider</code> auto-configured by the Spring Framework on Google Cloud Core Starter.</p>
</div>
<div class="sect3">
<h4 id="creating-a-topic"><a class="anchor" href="#creating-a-topic"></a><a class="link" href="#creating-a-topic">6.5.1. Creating a topic</a></h4>
<div class="paragraph">
<p><code>PubSubAdmin</code> implements a method to create topics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public Topic createTopic(String topicName)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to create a Google Cloud Pub/Sub topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public void newTopic() {
    pubSubAdmin.createTopic("topicName");
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deleting-a-topic"><a class="anchor" href="#deleting-a-topic"></a><a class="link" href="#deleting-a-topic">6.5.2. Deleting a topic</a></h4>
<div class="paragraph">
<p><code>PubSubAdmin</code> implements a method to delete topics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public void deleteTopic(String topicName)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to delete a Google Cloud Pub/Sub topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public void deleteTopic() {
    pubSubAdmin.deleteTopic("topicName");
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="listing-topics"><a class="anchor" href="#listing-topics"></a><a class="link" href="#listing-topics">6.5.3. Listing topics</a></h4>
<div class="paragraph">
<p><code>PubSubAdmin</code> implements a method to list topics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public List&lt;Topic&gt; listTopics</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to list every Google Cloud Pub/Sub topic name in a project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;String&gt; topics =
    pubSubAdmin.listTopics().stream().map(Topic::getName).collect(Collectors.toList());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="creating-a-subscription"><a class="anchor" href="#creating-a-subscription"></a><a class="link" href="#creating-a-subscription">6.5.4. Creating a subscription</a></h4>
<div class="paragraph">
<p><code>PubSubAdmin</code> implements several methods to create subscriptions to existing topics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public Subscription createSubscription(String subscriptionName, String topicName)

public Subscription createSubscription(String subscriptionName, String topicName, Integer ackDeadline)

public Subscription createSubscription(String subscriptionName, String topicName, Integer ackDeadline, String pushEndpoint)

public Subscription createSubscription(Subscriber.Builder builder)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default value for <code>ackDeadline</code> is 10 seconds.
If <code>pushEndpoint</code> isn’t specified, the subscription uses message pulling, instead.
You can also pass a <code>Subscription.Builder</code> for full control over any options or features available in the client library.</p>
</div>
<div class="paragraph">
<p>Here is an example of how to create a Google Cloud Pub/Sub subscription:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public Subscription newSubscription() {
    return pubSubAdmin.createSubscription("subscriptionName", "topicName", 15);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deleting-a-subscription"><a class="anchor" href="#deleting-a-subscription"></a><a class="link" href="#deleting-a-subscription">6.5.5. Deleting a subscription</a></h4>
<div class="paragraph">
<p><code>PubSubAdmin</code> implements a method to delete subscriptions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public void deleteSubscription(String subscriptionName)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to delete a Google Cloud Pub/Sub subscription:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public void deleteSubscription() {
    pubSubAdmin.deleteSubscription("subscriptionName");
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="listing-subscriptions"><a class="anchor" href="#listing-subscriptions"></a><a class="link" href="#listing-subscriptions">6.5.6. Listing subscriptions</a></h4>
<div class="paragraph">
<p><code>PubSubAdmin</code> implements a method to list subscriptions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public List&lt;Subscription&gt; listSubscriptions()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to list every subscription name in a project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;String&gt; subscriptions =
    pubSubAdmin.listSubscriptions().stream()
        .map(Subscription::getName)
        .collect(Collectors.toList());</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-2"><a class="anchor" href="#sample-2"></a><a class="link" href="#sample-2">6.6. Sample</a></h3>
<div class="paragraph">
<p>Sample applications for <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-pubsub-sample">using the template</a> and <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-pubsub-reactive-sample">using a subscription-backed reactive stream</a> are available.</p>
</div>
</div>
<div class="sect2">
<h3 id="test"><a class="anchor" href="#test"></a><a class="link" href="#test">6.7. Test</a></h3>
<div class="paragraph">
<p><code>Testcontainers</code> provides a <code>gcloud</code> module which offers <code>PubSubEmulatorContainer</code>. See more at the <a href="https://www.testcontainers.org/modules/gcloud/#pubsub">docs</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-integration"><a class="anchor" href="#spring-integration"></a><a class="link" href="#spring-integration">7. Spring Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Framework on Google Cloud provides Spring Integration adapters that allow your applications to use Enterprise Integration Patterns backed up by Google Cloud services.</p>
</div>
<div class="sect2">
<h3 id="channel-adapters-for-cloud-pubsub"><a class="anchor" href="#channel-adapters-for-cloud-pubsub"></a><a class="link" href="#channel-adapters-for-cloud-pubsub">7.1. Channel Adapters for Cloud Pub/Sub</a></h3>
<div class="paragraph">
<p>The channel adapters for Google Cloud Pub/Sub connect your Spring <a href="https://docs.spring.io/spring-integration/reference/html/channel.html"><code>MessageChannels</code></a> to Google Cloud Pub/Sub topics and subscriptions.
This enables messaging between different processes, applications or micro-services backed up by Google Cloud Pub/Sub.</p>
</div>
<div class="paragraph">
<p>The Spring Integration Channel Adapters for Google Cloud Pub/Sub are included in the <code>spring-cloud-gcp-pubsub</code> module and can be autoconfigured by using the <code>spring-cloud-gcp-starter-pubsub</code> module in combination with a Spring Integration dependency.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-pubsub&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.integration&lt;/groupId&gt;
    &lt;artifactId&gt;spring-integration-core&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-pubsub")
    implementation("org.springframework.integration:spring-integration-core")
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="inbound-channel-adapter-using-pubsub-streaming-pull"><a class="anchor" href="#inbound-channel-adapter-using-pubsub-streaming-pull"></a><a class="link" href="#inbound-channel-adapter-using-pubsub-streaming-pull">7.1.1. Inbound channel adapter (using Pub/Sub Streaming Pull)</a></h4>
<div class="paragraph">
<p><code>PubSubInboundChannelAdapter</code> is the inbound channel adapter for Spring Framework on Google Cloud Pub/Sub that listens to a Spring Framework on Google Cloud Pub/Sub subscription for new messages.
It converts new messages to an internal Spring <a href="https://docs.spring.io/spring-integration/reference/html/messaging-construction-chapter.html#message"><code>Message</code></a> and then sends it to the bound output channel.</p>
</div>
<div class="paragraph">
<p>Google Pub/Sub treats message payloads as byte arrays.
So, by default, the inbound channel adapter will construct the Spring <code>Message</code> with <code>byte[]</code> as the payload.
However, you can change the desired payload type by setting the <code>payloadType</code> property of the <code>PubSubInboundChannelAdapter</code>.
The <code>PubSubInboundChannelAdapter</code> delegates the conversion to the desired payload type to the <code>PubSubMessageConverter</code> configured in the <code>PubSubTemplate</code>.</p>
</div>
<div class="paragraph">
<p>To use the inbound channel adapter, a <code>PubSubInboundChannelAdapter</code> must be provided and configured on the user application side.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The subscription name could either be a short subscription name within the current project, or the fully-qualified name referring to a subscription in a different project using the <code>projects/[project_name]/subscriptions/[subscription_name]</code> format.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public MessageChannel pubsubInputChannel() {
    return new PublishSubscribeChannel();
}

@Bean
public PubSubInboundChannelAdapter messageChannelAdapter(
    @Qualifier("pubsubInputChannel") MessageChannel inputChannel,
    PubSubTemplate pubsubTemplate) {
    PubSubInboundChannelAdapter adapter =
        new PubSubInboundChannelAdapter(pubsubTemplate, "subscriptionName");
    adapter.setOutputChannel(inputChannel);
    adapter.setAckMode(AckMode.MANUAL);

    return adapter;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example, we first specify the <code>MessageChannel</code> where the adapter is going to write incoming messages to.
The <code>MessageChannel</code> implementation isn&#8217;t important here.
Depending on your use case, you might want to use a <code>MessageChannel</code> other than <code>PublishSubscribeChannel</code>.</p>
</div>
<div class="paragraph">
<p>Then, we declare a <code>PubSubInboundChannelAdapter</code> bean.
It requires the channel we just created and a <code>SubscriberFactory</code>, which creates <code>Subscriber</code> objects from the Google Cloud Java Client for Pub/Sub.
The Spring Boot starter for Spring Framework on Google Cloud Pub/Sub provides a configured <code>PubSubSubscriberOperations</code> object.</p>
</div>
<div class="sect4">
<h5 id="acknowledging-messages-and-handling-failures"><a class="anchor" href="#acknowledging-messages-and-handling-failures"></a><a class="link" href="#acknowledging-messages-and-handling-failures">Acknowledging messages and handling failures</a></h5>
<div class="paragraph">
<p>When working with Cloud Pub/Sub, it is important to understand the concept of <code>ackDeadline</code>&#8201;&#8212;&#8201;the amount of time Cloud Pub/Sub will wait until attempting redelivery of an outstanding message.
Each subscription has a default <code>ackDeadline</code> applied to all messages sent to it.
Additionally, the Cloud Pub/Sub client library can extend each streamed message&#8217;s <code>ackDeadline</code> until the message processing completes, fails or until the maximum extension period elapses.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the Pub/Sub client library, default maximum extension period is an hour. However, Spring Framework on Google Cloud disables this auto-extension behavior.
Use the <code>spring.cloud.gcp.pubsub.subscriber.max-ack-extension-period</code> property to re-enable it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Acknowledging (acking) a message removes it from Pub/Sub&#8217;s known outstanding messages. Nacking a message resets its acknowledgement deadline to 0, forcing immediate redelivery.
This could be useful in a load balanced architecture, where one of the subscribers is having issues but others are available to process messages.</p>
</div>
<div class="paragraph">
<p>The <code>PubSubInboundChannelAdapter</code> supports three acknowledgement modes: the default <code>AckMode.AUTO</code> (automatic acking on processing success and nacking on exception), as well as two modes for additional manual control: AckMode.AUTO_ACK (automatic acking on success but no action on exception) and AckMode.MANUAL (no automatic actions at all; both acking and nacking have to be done manually).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Acknowledgement mode behavior</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">AUTO</th>
<th class="tableblock halign-left valign-top">AUTO_ACK</th>
<th class="tableblock halign-left valign-top">MANUAL</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message processing completes successfully</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ack, no redelivery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ack, no redelivery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;no action&gt;*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message processing fails, but error handler completes successfully**</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ack, no redelivery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ack, no redelivery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;no action&gt;*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message processing fails; no error handler present</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">nack, immediate redelivery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;no action&gt;*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;no action&gt;*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message processing fails, and error handler throws an exception</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">nack, immediate redelivery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;no action&gt;*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;no action&gt;*</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>* &lt;no action&gt; means that the message will be neither acked nor nacked.
Cloud Pub/Sub will attempt redelivery according to subscription <code>ackDeadline</code> setting and the <code>max-ack-extension-period</code> client library setting.</p>
</div>
<div class="paragraph">
<p>** For the adapter, "success" means the Spring Integration flow processed without raising an exception, so successful message processing and the successful completion of an error handler both result in the same behavior (message will be acknowledged).
To trigger default error behavior (nacking in <code>AUTO</code> mode; neither acking nor nacking in <code>AUTO_ACK</code> mode), propagate the error back to the adapter by throwing an exception from the <a href="#error-handling">Error Handling flow</a>.</p>
</div>
<div class="sect5">
<h6 id="manual-ackingnacking"><a class="anchor" href="#manual-ackingnacking"></a><a class="link" href="#manual-ackingnacking">Manual acking/nacking</a></h6>
<div class="paragraph">
<p>The adapter attaches a <code>BasicAcknowledgeablePubsubMessage</code> object to the <code>Message</code> headers.
Users can extract the <code>BasicAcknowledgeablePubsubMessage</code> using the <code>GcpPubSubHeaders.ORIGINAL_MESSAGE</code> key and use it to ack (or nack) a message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
@ServiceActivator(inputChannel = "pubsubInputChannel")
public MessageHandler messageReceiver() {
    return message -&gt; {
        LOGGER.info("Message arrived! Payload: " + new String((byte[]) message.getPayload()));
        BasicAcknowledgeablePubsubMessage originalMessage =
              message.getHeaders().get(GcpPubSubHeaders.ORIGINAL_MESSAGE, BasicAcknowledgeablePubsubMessage.class);
        originalMessage.ack();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="error-handling"><a class="anchor" href="#error-handling"></a><a class="link" href="#error-handling">Error Handling</a></h6>
<div class="paragraph">
<p>If you want to have more control over message processing in case of an error, you need to associate the <code>PubSubInboundChannelAdapter</code> with a Spring Integration error channel and specify the behavior to be invoked with <code>@ServiceActivator</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In order to activate the default behavior (nacking in <code>AUTO</code> mode; neither acking nor nacking in <code>AUTO_ACK</code> mode), your error handler has to throw an exception.
Otherwise, the adapter will assume that processing completed successfully and will ack the message.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public MessageChannel pubsubInputChannel() {
    return new PublishSubscribeChannel();
}

@Bean
public PubSubInboundChannelAdapter messageChannelAdapter(
    @Qualifier("pubsubInputChannel") MessageChannel inputChannel,
    PubSubTemplate pubsubTemplate) {
    PubSubInboundChannelAdapter adapter =
        new PubSubInboundChannelAdapter(pubsubTemplate, "subscriptionName");
    adapter.setOutputChannel(inputChannel);
    adapter.setAckMode(AckMode.AUTO_ACK);
    adapter.setErrorChannelName("pubsubErrors");

    return adapter;
}

@ServiceActivator(inputChannel =  "pubsubErrors")
public void pubsubErrorHandler(Message&lt;MessagingException&gt; message) {
    LOGGER.warn("This message will be automatically acked because error handler completes successfully");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you would prefer to manually ack or nack the message, you can do it by retrieving the header of the exception payload:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@ServiceActivator(inputChannel =  "pubsubErrors")
public void pubsubErrorHandler(Message&lt;MessagingException&gt; exceptionMessage) {

    BasicAcknowledgeablePubsubMessage originalMessage =
      (BasicAcknowledgeablePubsubMessage)exceptionMessage.getPayload().getFailedMessage()
        .getHeaders().get(GcpPubSubHeaders.ORIGINAL_MESSAGE);

    originalMessage.nack();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pollable-message-source-using-pubsub-synchronous-pull"><a class="anchor" href="#pollable-message-source-using-pubsub-synchronous-pull"></a><a class="link" href="#pollable-message-source-using-pubsub-synchronous-pull">7.1.2. Pollable Message Source (using Pub/Sub Synchronous Pull)</a></h4>
<div class="paragraph">
<p>While <code>PubSubInboundChannelAdapter</code>, through the underlying Asynchronous Pull Pub/Sub mechanism, provides the best performance for high-volume applications that receive a steady flow of messages, it can create load balancing anomalies due to message caching.
This behavior is most obvious when publishing a large batch of small messages that take a long time to process individually.
It manifests as one subscriber taking up most messages, even if multiple subscribers are available to take on the work.
For a more detailed explanation of this scenario, see <a href="https://cloud.google.com/pubsub/docs/pull#streamingpull_dealing_with_large_backlogs_of_small_messages">Spring Framework on Google Cloud Pub/Sub documentation</a>.</p>
</div>
<div class="paragraph">
<p>In such a scenario, a <code>PubSubMessageSource</code> can help spread the load between different subscribers more evenly.</p>
</div>
<div class="paragraph">
<p>As with the Inbound Channel Adapter, the message source has a configurable acknowledgement mode, payload type, and header mapping.</p>
</div>
<div class="paragraph">
<p>The default behavior is to return from the synchronous pull operation immediately if no messages are present.
This can be overridden by using <code>setBlockOnPull()</code> method to wait for at least one message to arrive.</p>
</div>
<div class="paragraph">
<p>By default, <code>PubSubMessageSource</code> pulls from the subscription one message at a time.
To pull a batch of messages on each request, use the <code>setMaxFetchSize()</code> method to set the batch size.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The subscription name could either be a short subscription name within the current project, or the fully-qualified name referring to a subscription in a different project using the <code>projects/[project_name]/subscriptions/[subscription_name]</code> format.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
@InboundChannelAdapter(channel = "pubsubInputChannel", poller = @Poller(fixedDelay = "100"))
public MessageSource&lt;Object&gt; pubsubAdapter(PubSubTemplate pubSubTemplate) {
    PubSubMessageSource messageSource = new PubSubMessageSource(pubSubTemplate,  "exampleSubscription");
    messageSource.setAckMode(AckMode.MANUAL);
    messageSource.setPayloadType(String.class);
    messageSource.setBlockOnPull(true);
    messageSource.setMaxFetchSize(100);
    return messageSource;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@InboundChannelAdapter</code> annotation above ensures that the configured <code>MessageSource</code> is polled for messages, which are then available for manipulation with any Spring Integration mechanism on the <code>pubsubInputChannel</code> message channel.
For example, messages can be retrieved in a method annotated with <code>@ServiceActivator</code>, as seen below.</p>
</div>
<div class="paragraph">
<p>For additional flexibility, <code>PubSubMessageSource</code> attaches an <code>AcknowledgeablePubSubMessage</code> object to the <code>GcpPubSubHeaders.ORIGINAL_MESSAGE</code> message header.
The object can be used for manually (n)acking the message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@ServiceActivator(inputChannel = "pubsubInputChannel")
public void messageReceiver(String payload,
        @Header(GcpPubSubHeaders.ORIGINAL_MESSAGE) AcknowledgeablePubsubMessage message)
            throws InterruptedException {
    LOGGER.info("Message arrived by Synchronous Pull! Payload: " + payload);
    message.ack();
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>AcknowledgeablePubSubMessage</code> objects acquired by synchronous pull are aware of their own acknowledgement IDs.
Streaming pull does not expose this information due to limitations of the underlying API, and returns <code>BasicAcknowledgeablePubsubMessage</code> objects that allow acking/nacking individual messages, but not extracting acknowledgement IDs for future processing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="outbound-channel-adapter"><a class="anchor" href="#outbound-channel-adapter"></a><a class="link" href="#outbound-channel-adapter">7.1.3. Outbound channel adapter</a></h4>
<div class="paragraph">
<p><code>PubSubMessageHandler</code> is the outbound channel adapter for Spring Framework on Google Cloud Pub/Sub that listens for new messages on a Spring <code>MessageChannel</code>.
It uses <code>PubSubTemplate</code> to post them to a Spring Framework on Google Cloud Pub/Sub topic.</p>
</div>
<div class="paragraph">
<p>To construct a Pub/Sub representation of the message, the outbound channel adapter needs to convert the Spring <code>Message</code> payload to a byte array representation expected by Pub/Sub.
It delegates this conversion to the <code>PubSubTemplate</code>.
To customize the conversion, you can specify a <code>PubSubMessageConverter</code> in the <code>PubSubTemplate</code> that should convert the <code>Object</code> payload and headers of the Spring <code>Message</code> to a <code>PubsubMessage</code>.</p>
</div>
<div class="paragraph">
<p>To use the outbound channel adapter, a <code>PubSubMessageHandler</code> bean must be provided and configured on the user application side.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The topic name could either be a short topic name within the current project, or the fully-qualified name referring to a topic in a different project using the <code>projects/[project_name]/topics/[topic_name]</code> format.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
@ServiceActivator(inputChannel = "pubsubOutputChannel")
public MessageHandler messageSender(PubSubTemplate pubsubTemplate) {
    return new PubSubMessageHandler(pubsubTemplate, "topicName");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The provided <code>PubSubTemplate</code> contains all the necessary configuration to publish messages to a Spring Framework on Google Cloud Pub/Sub topic.</p>
</div>
<div class="paragraph">
<p><code>PubSubMessageHandler</code> publishes messages asynchronously by default.
A publish timeout can be configured for synchronous publishing.
If none is provided, the adapter waits indefinitely for a response.</p>
</div>
<div class="paragraph">
<p>It is possible to set user-defined callbacks for the <code>publish()</code> call in <code>PubSubMessageHandler</code> through the <code>setSuccessCallback()</code> and <code>setFailureCallback()</code> methods (either one or both may be set).
These give access to the Pub/Sub publish message ID in case of success, or the root cause exception in case of error.
Both callbacks include the original message as the second argument.
The old <code>setPublishCallback()</code> method that only gave access to message ID or root cause exception is deprecated and will be removed in a future release.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">adapter.setPublishCallback(
    new ListenableFutureCallback&lt;String&gt;() {
      @Override
      public void onFailure(Throwable ex) {}

      @Override
      public void onSuccess(String result) {}
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>To override the default topic you can use the <code>GcpPubSubHeaders.TOPIC</code> header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private MessageChannel pubsubOutputChannel;

public void handleMessage(Message&lt;?&gt; msg) throws MessagingException {
    final Message&lt;?&gt; message = MessageBuilder
        .withPayload(msg.getPayload())
        .setHeader(GcpPubSubHeaders.TOPIC, "customTopic").build();
    pubsubOutputChannel.send(message);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to set an SpEL expression for the topic with the <code>setTopicExpression()</code> or <code>setTopicExpressionString()</code> methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">PubSubMessageHandler adapter = new PubSubMessageHandler(pubSubTemplate, "myDefaultTopic");
adapter.setTopicExpressionString("headers['sendToTopic']");</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="header-mapping"><a class="anchor" href="#header-mapping"></a><a class="link" href="#header-mapping">7.1.4. Header mapping</a></h4>
<div class="paragraph">
<p>These channel adapters contain header mappers that allow you to map, or filter out, headers from Spring to Google Cloud Pub/Sub messages, and vice-versa.
By default, the inbound channel adapter maps every header on the Google Cloud Pub/Sub messages to the Spring messages produced by the adapter.
The outbound channel adapter maps every header from Spring messages into Google Cloud Pub/Sub ones, except the ones added by Spring and some special headers, like headers with key <code>"id"</code>, <code>"timestamp"</code>, <code>"gcp_pubsub_acknowledgement"</code>, and <code>"gcp_pubsub_ordering_key"</code>.
In the process, the outbound mapper also converts the value of the headers into string.</p>
</div>
<div class="paragraph">
<p>Note that you can provide the <code>GcpPubSubHeaders.ORDERING_KEY</code> (<code>"gcp_pubsub_ordering_key"</code>) header, which will be automatically mapped to <code>PubsubMessage.orderingKey</code> property, and excluded from the headers in the published message.
Remember to set <code>spring.cloud.gcp.pubsub.publisher.enable-message-ordering</code> to <code>true</code>, if you are publishing messages with this header.</p>
</div>
<div class="paragraph">
<p>Each adapter declares a <code>setHeaderMapper()</code> method to let you further customize which headers you want to map from Spring to Google Cloud Pub/Sub, and vice-versa.</p>
</div>
<div class="paragraph">
<p>For example, to filter out headers <code>"foo"</code>, <code>"bar"</code> and all headers starting with the prefix "prefix_", you can use <code>setHeaderMapper()</code> along with the <code>PubSubHeaderMapper</code> implementation provided by this module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">PubSubMessageHandler adapter = ...
...
PubSubHeaderMapper headerMapper = new PubSubHeaderMapper();
headerMapper.setOutboundHeaderPatterns("!foo", "!bar", "!prefix_*", "*");
adapter.setHeaderMapper(headerMapper);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The order in which the patterns are declared in <code>PubSubHeaderMapper.setOutboundHeaderPatterns()</code> and <code>PubSubHeaderMapper.setInboundHeaderPatterns()</code> matters.
The first patterns have precedence over the following ones.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the previous example, the <code>"*"</code> pattern means every header is mapped.
However, because it comes last in the list, <a href="https://docs.spring.io/spring-integration/api/org/springframework/integration/support/utils/PatternMatchUtils.html">the previous patterns take precedence</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="samples-2"><a class="anchor" href="#samples-2"></a><a class="link" href="#samples-2">7.1.5. Samples</a></h4>
<div class="paragraph">
<p>Available examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-integration-pubsub-sample">Sending/Receiving Messages with Channel Adapters</a></p>
</li>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-integration-pubsub-json-sample">Pub/Sub Channel Adapters with JSON payloads</a></p>
</li>
<li>
<p><a href="https://codelabs.developers.google.com/codelabs/cloud-spring-cloud-gcp-pubsub-integration/index.html">Spring Integration and Pub/Sub Codelab</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="channel-adapters-for-google-cloud-storage"><a class="anchor" href="#channel-adapters-for-google-cloud-storage"></a><a class="link" href="#channel-adapters-for-google-cloud-storage">7.2. Channel Adapters for Google Cloud Storage</a></h3>
<div class="paragraph">
<p>The channel adapters for Google Cloud Storage allow you to read and write files to Google Cloud Storage through <code>MessageChannels</code>.</p>
</div>
<div class="paragraph">
<p>Spring Framework on Google Cloud provides two inbound adapters, <code>GcsInboundFileSynchronizingMessageSource</code> and <code>GcsStreamingMessageSource</code>, and one outbound adapter, <code>GcsMessageHandler</code>.</p>
</div>
<div class="paragraph">
<p>The Spring Integration Channel Adapters for Google Cloud Storage are included in the <code>spring-cloud-gcp-storage</code> module.</p>
</div>
<div class="paragraph">
<p>To use the Storage portion of Spring Integration for Spring Framework on Google Cloud, you must also provide the <code>spring-integration-file</code> dependency, since it isn&#8217;t pulled transitively.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-storage&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.integration&lt;/groupId&gt;
    &lt;artifactId&gt;spring-integration-file&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-storage")
    implementation("org.springframework.integration:spring-integration-file")
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="inbound-channel-adapter"><a class="anchor" href="#inbound-channel-adapter"></a><a class="link" href="#inbound-channel-adapter">7.2.1. Inbound channel adapter</a></h4>
<div class="paragraph">
<p>The Google Cloud Storage inbound channel adapter polls a Google Cloud Storage bucket for new files and sends each of them in a <code>Message</code> payload to the <code>MessageChannel</code> specified in the <code>@InboundChannelAdapter</code> annotation.
The files are temporarily stored in a folder in the local file system.</p>
</div>
<div class="paragraph">
<p>Here is an example of how to configure a Google Cloud Storage inbound channel adapter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
@InboundChannelAdapter(channel = "new-file-channel", poller = @Poller(fixedDelay = "5000"))
public MessageSource&lt;File&gt; synchronizerAdapter(Storage gcs) {
  GcsInboundFileSynchronizer synchronizer = new GcsInboundFileSynchronizer(gcs);
  synchronizer.setRemoteDirectory("your-gcs-bucket");

  GcsInboundFileSynchronizingMessageSource synchAdapter =
          new GcsInboundFileSynchronizingMessageSource(synchronizer);
  synchAdapter.setLocalDirectory(new File("local-directory"));

  return synchAdapter;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="inbound-streaming-channel-adapter"><a class="anchor" href="#inbound-streaming-channel-adapter"></a><a class="link" href="#inbound-streaming-channel-adapter">7.2.2. Inbound streaming channel adapter</a></h4>
<div class="paragraph">
<p>The inbound streaming channel adapter is similar to the normal inbound channel adapter, except it does not require files to be stored in the file system.</p>
</div>
<div class="paragraph">
<p>Here is an example of how to configure a Google Cloud Storage inbound streaming channel adapter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
@InboundChannelAdapter(channel = "streaming-channel", poller = @Poller(fixedDelay = "5000"))
public MessageSource&lt;InputStream&gt; streamingAdapter(Storage gcs) {
  GcsStreamingMessageSource adapter =
          new GcsStreamingMessageSource(new GcsRemoteFileTemplate(new GcsSessionFactory(gcs)));
  adapter.setRemoteDirectory("your-gcs-bucket");
  return adapter;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you would like to process the files in your bucket in a specific order, you may pass in a <code>Comparator&lt;BlobInfo&gt;</code> to the constructor <code>GcsStreamingMessageSource</code> to sort the files being processed.</p>
</div>
</div>
<div class="sect3">
<h4 id="outbound-channel-adapter-2"><a class="anchor" href="#outbound-channel-adapter-2"></a><a class="link" href="#outbound-channel-adapter-2">7.2.3. Outbound channel adapter</a></h4>
<div class="paragraph">
<p>The outbound channel adapter allows files to be written to Google Cloud Storage.
When it receives a <code>Message</code> containing a payload of type <code>File</code>, it writes that file to the Google Cloud Storage bucket specified in the adapter.</p>
</div>
<div class="paragraph">
<p>Here is an example of how to configure a Google Cloud Storage outbound channel adapter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
@ServiceActivator(inputChannel = "writeFiles")
public MessageHandler outboundChannelAdapter(Storage gcs) {
  GcsMessageHandler outboundChannelAdapter = new GcsMessageHandler(new GcsSessionFactory(gcs));
  outboundChannelAdapter.setRemoteDirectoryExpression(new ValueExpression&lt;&gt;("your-gcs-bucket"));

  return outboundChannelAdapter;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sample-3"><a class="anchor" href="#sample-3"></a><a class="link" href="#sample-3">7.2.4. Sample</a></h4>
<div class="paragraph">
<p>See the <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-integration-storage-sample">Spring Integration with Google Cloud Storage Sample Code</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-stream"><a class="anchor" href="#spring-cloud-stream"></a><a class="link" href="#spring-cloud-stream">8. Spring Cloud Stream</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Framework on Google Cloud provides a <a href="https://cloud.spring.io/spring-cloud-stream/">Spring Cloud Stream</a> binder to Google Cloud Pub/Sub.</p>
</div>
<div class="paragraph">
<p>The provided binder relies on the <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-pubsub/src/main/java/com/google/cloud/spring/pubsub/integration">Spring Integration Channel Adapters for Google Cloud Pub/Sub</a>.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-pubsub-stream-binder&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-pubsub-stream-binder")
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="overview"><a class="anchor" href="#overview"></a><a class="link" href="#overview">8.1. Overview</a></h3>
<div class="paragraph">
<p>This binder binds producers to Google Cloud Pub/Sub topics and consumers to subscriptions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Partitioning is currently not supported by this binder.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuration-3"><a class="anchor" href="#configuration-3"></a><a class="link" href="#configuration-3">8.2. Configuration</a></h3>
<div class="paragraph">
<p>You can configure the Spring Cloud Stream Binder for Google Cloud Pub/Sub to automatically generate the underlying resources, like the Google Cloud Pub/Sub topics and subscriptions for producers and consumers.
For that, you can use the <code>spring.cloud.stream.gcp.pubsub.bindings.&lt;channelName&gt;.&lt;consumer|producer&gt;.auto-create-resources</code> property, which is turned ON by default.</p>
</div>
<div class="paragraph">
<p>Starting with version 1.1, these and other binder properties can be configured globally for all the bindings, e.g. <code>spring.cloud.stream.gcp.pubsub.default.consumer.auto-create-resources</code>.</p>
</div>
<div class="paragraph">
<p>If you are using Pub/Sub auto-configuration from the Spring Framework on Google Cloud Pub/Sub Starter, you should refer to the <a href="#pubsub-configuration">configuration</a> section for other Pub/Sub parameters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To use this binder with a <a href="https://cloud.google.com/pubsub/docs/emulator">running emulator</a>, configure its host and port via <code>spring.cloud.gcp.pubsub.emulator-host</code>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="producer-synchronous-sending-configuration"><a class="anchor" href="#producer-synchronous-sending-configuration"></a><a class="link" href="#producer-synchronous-sending-configuration">8.2.1. Producer Synchronous Sending Configuration</a></h4>
<div class="paragraph">
<p>By default, this binder will send messages to Cloud Pub/Sub asynchronously.
If synchronous sending is preferred (for example, to allow propagating errors back to the sender), set <code>spring.cloud.stream.gcp.pubsub.default.producer.sync</code> property to <code>true</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="producer-destination-configuration"><a class="anchor" href="#producer-destination-configuration"></a><a class="link" href="#producer-destination-configuration">8.2.2. Producer Destination Configuration</a></h4>
<div class="paragraph">
<p>If automatic resource creation is turned ON and the topic corresponding to the destination name does not exist, it will be created.</p>
</div>
<div class="paragraph">
<p>For example, for the following configuration, a topic called <code>myEvents</code> would be created.</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.cloud.stream.bindings.events.destination=myEvents
spring.cloud.stream.gcp.pubsub.bindings.events.producer.auto-create-resources=true</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="consumer-destination-configuration"><a class="anchor" href="#consumer-destination-configuration"></a><a class="link" href="#consumer-destination-configuration">8.2.3. Consumer Destination Configuration</a></h4>
<div class="paragraph">
<p>A <code>PubSubInboundChannelAdapter</code> will be configured for your consumer endpoint.
You may adjust the ack mode of the consumer endpoint using the <code>ack-mode</code> property.
The ack mode controls how messages will be acknowledged when they are successfully received.
The three possible options are: <code>AUTO</code> (default), <code>AUTO_ACK</code>, and <code>MANUAL</code>.
These options are described in detail in the <a href="#inbound-channel-adapter-using-pubsub-streaming-pull">Pub/Sub channel adapter documentation</a>.</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># How to set the ACK mode of the consumer endpoint.
spring.cloud.stream.gcp.pubsub.bindings.{CONSUMER_NAME}.consumer.ack-mode=AUTO_ACK</code></pre>
</div>
</div>
<div class="paragraph">
<p>With automatic resource creation turned ON for a consumer, the library creates a topic and/or a subscription if they do not exist.
The topic name becomes the same as the destination name, and the subscription name follows these rules (in order of precedence):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A user-defined, pre-existing subscription (use <code>spring.cloud.stream.gcp.pubsub.bindings.{CONSUMER_NAME}.consumer.subscriptionName</code>)</p>
</li>
<li>
<p>A consumer group using the topic name (use <code>spring.cloud.stream.bindings.events.group</code> to create a subscription named <code>&lt;topicName&gt;.&lt;group&gt;</code>)</p>
</li>
<li>
<p>If neither of the above are specified, the library creates an anonymous subscription with the name <code>anonymous.&lt;destinationName&gt;.&lt;randomUUID&gt;</code>.
Then when the binder shuts down, the library automatically cleans up all Pub/Sub subscriptions created for anonymous consumer groups.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, with this configuration:</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.cloud.stream.bindings.events.destination=myEvents
spring.cloud.stream.gcp.pubsub.bindings.events.consumer.auto-create-resources=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Only an anonymous subscription named <code>anonymous.myEvents.a6d83782-c5a3-4861-ac38-e6e2af15a7be</code> is created and later cleaned up.</p>
</div>
<div class="paragraph">
<p>In another example, with the following configuration:</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.cloud.stream.bindings.events.destination=myEvents
spring.cloud.stream.gcp.pubsub.bindings.events.consumer.auto-create-resources=true

# specify consumer group, and avoid anonymous consumer group generation
spring.cloud.stream.bindings.events.group=consumerGroup1</code></pre>
</div>
</div>
<div class="paragraph">
<p>These resources will be created:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A topic named <code>myEvents</code></p>
</li>
<li>
<p>A subscription named <code>myEvents.consumerGroup1</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="header-mapping-2"><a class="anchor" href="#header-mapping-2"></a><a class="link" href="#header-mapping-2">8.2.4. Header Mapping</a></h4>
<div class="paragraph">
<p>You can filter incoming and outgoing message headers with <code>allowHeaders</code> property.
For example, for a consumer to allow only two headers, provide a comma separated list like this:</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre>spring.cloud.stream.gcp.pubsub.bindings.&lt;consumerFunction&gt;-in-0.consumer.allowedHeaders=allowed1, allowed2</pre>
</div>
</div>
<div class="paragraph">
<p>Where &lt;consumerFunction&gt; should be replaced by the method which is consuming/reading messages from Cloud Pub/Sub and allowed1, allowed2 is the comma separated list of headers that the user wants to keep.</p>
</div>
<div class="paragraph">
<p>A similar style is applicable for producers as well. For example:</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre>spring.cloud.stream.gcp.pubsub.bindings.&lt;producerFunction&gt;-out-0.producer.allowedHeaders=allowed3,allowed4</pre>
</div>
</div>
<div class="paragraph">
<p>Where &lt;producerFunction&gt; should be replaced by the method which is producing/sending messages to Cloud Pub/Sub and allowed3, allowed4 is the comma separated list of headers that user wants to map. All other headers will be removed before the message is sent to Cloud Pub/Sub.</p>
</div>
</div>
<div class="sect3">
<h4 id="endpoint-customization"><a class="anchor" href="#endpoint-customization"></a><a class="link" href="#endpoint-customization">8.2.5. Endpoint Customization</a></h4>
<div class="paragraph">
<p>You may customize channel routing by defining a <code>ConsumerEndpointCustomizer</code> in your autoconfiguration. This is useful if you want to customize the default configurations provided by the Pub/Sub Spring Cloud Stream Binder.</p>
</div>
<div class="paragraph">
<p>The example below demonstrates how to use a <code>ConsumerEndpointCustomizer</code> to override the default error channel configured by the binder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public ConsumerEndpointCustomizer&lt;PubSubInboundChannelAdapter&gt; messageChannelAdapter() {
    return (endpoint, destinationName, group) -&gt; {
        NamedComponent namedComponent = (NamedComponent) endpoint.getOutputChannel();
        String channelName = namedComponent.getBeanName();
        endpoint.setErrorChannelName(channelName + ".errors");
    };
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="binding-with-functions"><a class="anchor" href="#binding-with-functions"></a><a class="link" href="#binding-with-functions">8.3. Binding with Functions</a></h3>
<div class="paragraph">
<p>Since version 3.0, Spring Cloud Stream supports a functional programming model natively.
This means that the only requirement for turning your application into a sink is presence of a <code>java.util.function.Consumer</code> bean in the application context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">@Bean
public Consumer&lt;UserMessage&gt; logUserMessage() {
  return userMessage -&gt; {
    // process message
  }
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>A source application is one where a <code>Supplier</code> bean is present.
It can return an object, in which case Spring Cloud Stream will invoke the supplier repeatedly.
Alternatively, the function can return a reactive stream, which will be used as is.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">@Bean
Supplier&lt;Flux&lt;UserMessage&gt;&gt; generateUserMessages() {
  return () -&gt; /* flux creation logic */;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A processor application works similarly to a source application, except it is triggered by presence of a <code>Function</code> bean.</p>
</div>
</div>
<div class="sect2">
<h3 id="binding-with-annotations"><a class="anchor" href="#binding-with-annotations"></a><a class="link" href="#binding-with-annotations">8.4. Binding with Annotations</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As of version 3.0, annotation binding is considered legacy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To set up a sink application in this style, you would associate a class with a binding interface, such as the built-in <code>Sink</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">@EnableBinding(Sink.class)
public class SinkExample {

    @StreamListener(Sink.INPUT)
    public void handleMessage(UserMessage userMessage) {
        // process message
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To set up a source application, you would similarly associate a class with a built-in <code>Source</code> interface, and inject an instance of it provided by Spring Cloud Stream.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">@EnableBinding(Source.class)
public class SourceExample {

    @Autowired
    private Source source;

    public void sendMessage() {
        this.source.output().send(new GenericMessage&lt;&gt;(/* your object here */));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="streaming-vs-polled-input"><a class="anchor" href="#streaming-vs-polled-input"></a><a class="link" href="#streaming-vs-polled-input">8.5. Streaming vs. Polled Input</a></h3>
<div class="paragraph">
<p>Many Spring Cloud Stream applications will use the built-in <code>Sink</code> binding, which triggers the <em>streaming</em> input binder creation.
Messages can then be consumed with an input handler marked by <code>@StreamListener(Sink.INPUT)</code> annotation, at whatever rate Pub/Sub sends them.</p>
</div>
<div class="paragraph">
<p>For more control over the rate of message arrival, a polled input binder can be set up by defining a custom binding interface with an <code>@Input</code>-annotated method returning <code>PollableMessageSource</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PollableSink {

    @Input("input")
    PollableMessageSource input();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>PollableMessageSource</code> can then be injected and queried, as needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@EnableBinding(PollableSink.class)
public class SinkExample {

    @Autowired
    PollableMessageSource destIn;

    @Bean
    public ApplicationRunner singlePollRunner() {
        return args -&gt; {
            // This will poll only once.
            // Add a loop or a scheduler to get more messages.
            destIn.poll(message -&gt; System.out.println("Message retrieved: " + message));
        };
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the polling will only get 1 message at a time.
Use the <code>spring.cloud.stream.gcp.pubsub.default.consumer.maxFetchSize</code> property to fetch additional messages per network roundtrip.</p>
</div>
</div>
<div class="sect2">
<h3 id="sample-4"><a class="anchor" href="#sample-4"></a><a class="link" href="#sample-4">8.6. Sample</a></h3>
<div class="paragraph">
<p>Sample applications are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-pubsub-stream-sample">streaming input, annotation-based</a>.</p>
</li>
<li>
<p>For <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-pubsub-stream-functional-sample">streaming input, functional style</a>.</p>
</li>
<li>
<p>For <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-pubsub-stream-polling-sample">polled input</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-bus"><a class="anchor" href="#spring-cloud-bus"></a><a class="link" href="#spring-cloud-bus">9. Spring Cloud Bus</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using <a href="https://cloud.google.com/pubsub/">Cloud Pub/Sub</a> as the <a href="https://spring.io/projects/spring-cloud-bus">Spring Cloud Bus</a> implementation is as simple as importing the <code>spring-cloud-gcp-starter-bus-pubsub</code> starter.</p>
</div>
<div class="paragraph">
<p>This starter brings in the <a href="#spring-cloud-stream">Spring Cloud Stream binder for Cloud Pub/Sub</a>, which is used to both publish and subscribe to the bus.
If the bus topic (named <code>springCloudBus</code> by default) does not exist, the binder automatically creates it.
The binder also creates anonymous subscriptions for each project using the <code>spring-cloud-gcp-starter-bus-pubsub</code> starter.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-starter-bus-pubsub&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-bus-pubsub")
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="configuration-management-with-spring-cloud-config-and-spring-cloud-bus"><a class="anchor" href="#configuration-management-with-spring-cloud-config-and-spring-cloud-bus"></a><a class="link" href="#configuration-management-with-spring-cloud-config-and-spring-cloud-bus">9.1. Configuration Management with Spring Cloud Config and Spring Cloud Bus</a></h3>
<div class="paragraph">
<p>Spring Cloud Bus can be used to push configuration changes from a Spring Cloud Config server to the clients listening on the same bus.</p>
</div>
<div class="paragraph">
<p>To use Spring Framework on Google Cloud Pub/Sub as the bus implementation, both the configuration server and the configuration client need the <code>spring-cloud-gcp-starter-bus-pubsub</code> dependency.</p>
</div>
<div class="paragraph">
<p>All other configuration is standard to <a href="https://spring.io/projects/spring-cloud-config">Spring Cloud Config</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/spring_cloud_bus_over_pubsub.png" alt="spring cloud bus over pubsub">
</div>
</div>
<div class="paragraph">
<p>Spring Cloud Config Server typically runs on port <code>8888</code>, and can read configuration from a <a href="https://cloud.spring.io/spring-cloud-config/spring-cloud-config.html#_environment_repository">variety of source control systems</a> such as GitHub, and even from the local filesystem.
When the server is notified that new configuration is available, it fetches the updated configuration and sends a notification (<code>RefreshRemoteApplicationEvent</code>) out via Spring Cloud Bus.</p>
</div>
<div class="paragraph">
<p>When configuration is stored locally, config server polls the parent directory for changes.
With configuration stored in source control repository, such as GitHub, the config server needs to be notified that a new version of configuration is available.
In a deployed server, this would be done automatically through a GitHub webhook, but in a local testing scenario, the <code>/monitor</code> HTTP endpoint needs to be invoked manually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -X POST http://localhost:8888/monitor -H "X-Github-Event: push" -H "Content-Type: application/json" -d '{"commits": [{"modified": ["application.properties"]}]}'</pre>
</div>
</div>
<div class="paragraph">
<p>By adding the <code>spring-cloud-gcp-starter-bus-pubsub</code> dependency, you instruct Spring Cloud Bus to use Cloud Pub/Sub to broadcast configuration changes.
Spring Cloud Bus will then create a topic named <code>springCloudBus</code>, as well as a subscription for each configuration client.</p>
</div>
<div class="paragraph">
<p>The configuration server happens to also be a configuration client, subscribing to the configuration changes that it sends out.
Thus, in a scenario with one configuration server and one configuration client, two anonymous subscriptions to the <code>springCloudBus</code> topic are created.
However, a config server disables configuration refresh by default (see <a href="https://static.javadoc.io/org.springframework.cloud/spring-cloud-config-server/2.1.0.RELEASE/index.html">ConfigServerBootstrapApplicationListener</a> for more details).</p>
</div>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-pubsub-bus-config-sample">demo application</a> showing configuration management and distribution over a Cloud Pub/Sub-powered bus is available.
The sample contains two examples of configuration management with Spring Cloud Bus: one monitoring a local file system, and the other retrieving configuration from a GitHub repository.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-trace"><a class="anchor" href="#cloud-trace"></a><a class="link" href="#cloud-trace">10. Cloud Trace</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Google Cloud provides a managed distributed tracing service called <a href="https://cloud.google.com/trace/">Cloud Trace</a>, and <a href="https://cloud.spring.io/spring-cloud-sleuth/">Spring Cloud Sleuth</a> can be used with it to easily instrument Spring Boot applications for observability.</p>
</div>
<div class="paragraph">
<p>Typically, Spring Cloud Sleuth captures trace information and forwards traces to services like Zipkin for storage and analysis.
However, on Google Cloud, instead of running and maintaining your own Zipkin instance and storage, you can use Cloud Trace to store traces, view trace details, generate latency distributions graphs, and generate performance regression reports.</p>
</div>
<div class="paragraph">
<p>This Spring Framework on Google Cloud starter can forward Spring Cloud Sleuth traces to Cloud Trace without an intermediary Zipkin server.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-trace&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-trace")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must enable Cloud Trace API from the Google Cloud Console in order to capture traces.
Navigate to the <a href="https://console.cloud.google.com/apis/api/cloudtrace.googleapis.com/overview">Cloud Trace API</a> for your project and make sure it’s enabled.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are already using a Zipkin server capturing trace information from multiple platform/frameworks, you can also use a <a href="https://cloud.google.com/trace/docs/zipkin">Stackdriver Zipkin proxy</a> to forward those traces to Cloud Trace without modifying existing applications.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="tracing"><a class="anchor" href="#tracing"></a><a class="link" href="#tracing">10.1. Tracing</a></h3>
<div class="paragraph">
<p>Spring Cloud Sleuth uses the <a href="https://github.com/openzipkin/brave">Brave tracer</a> to generate traces.
This integration enables Brave to use the <a href="https://github.com/openzipkin/zipkin-gcp/tree/main/propagation-stackdriver"><code>StackdriverTracePropagation</code></a> propagation.</p>
</div>
<div class="paragraph">
<p>A propagation is responsible for extracting trace context from an entity (e.g., an HTTP servlet request) and injecting trace context into an entity.
A canonical example of the propagation usage is a web server that receives an HTTP request, which triggers other HTTP requests from the server before returning an HTTP response to the original caller.</p>
</div>
<div class="paragraph">
<p>In the case of <code>StackdriverTracePropagation</code>, first it looks for trace context in the <a href="https://github.com/openzipkin/b3-propagation">X-B3 headers</a> (<code>X-B3-TraceId</code>, <code>X-B3-SpanId</code>).
If those are not found, <code>StackdriverTracePropagation</code> will fall back on <code>x-cloud-trace-context</code> key (e.g., an HTTP request header).</p>
</div>
<div class="paragraph">
<p>If you need different propagation behavior (e.g. relying primarily on <code>x-cloud-trace-context</code> in a mixed Spring / non-Spring application environment), Spring Cloud Sleuth allows such customization through the <a href="https://docs.spring.io/spring-cloud-sleuth/docs/current/reference/html/howto.html#how-to-change-context-propagation"><code>CUSTOM</code> propagation type</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The value of the <code>x-cloud-trace-context</code> key can be formatted in three different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>x-cloud-trace-context: TRACE_ID</code></p>
</li>
<li>
<p><code>x-cloud-trace-context: TRACE_ID/SPAN_ID</code></p>
</li>
<li>
<p><code>x-cloud-trace-context: TRACE_ID/SPAN_ID;o=TRACE_TRUE</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>TRACE_ID</code> is a 32-character hexadecimal value that encodes a 128-bit number.</p>
</div>
<div class="paragraph">
<p><code>SPAN_ID</code> is an unsigned long.
Since Cloud Trace doesn&#8217;t support span joins, a new span ID is always generated, regardless of the one specified in <code>x-cloud-trace-context</code>.</p>
</div>
<div class="paragraph">
<p><code>TRACE_TRUE</code> can either be <code>0</code> if the entity should be untraced, or <code>1</code> if it should be traced.
This field forces the decision of whether or not to trace the request; if omitted then the decision is deferred to the sampler.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="spring-boot-starter-for-cloud-trace"><a class="anchor" href="#spring-boot-starter-for-cloud-trace"></a><a class="link" href="#spring-boot-starter-for-cloud-trace">10.2. Spring Boot Starter for Cloud Trace</a></h3>
<div class="paragraph">
<p>Spring Boot Starter for Cloud Trace uses Spring Cloud Sleuth and auto-configures a <a href="https://github.com/openzipkin/zipkin-gcp/blob/main/sender-stackdriver/src/main/java/zipkin2/reporter/stackdriver/StackdriverSender.java">StackdriverSender</a> that sends the Sleuth’s trace information to Cloud Trace.</p>
</div>
<div class="paragraph">
<p>All configurations are optional:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Auto-configure Spring Cloud Sleuth to send traces to Cloud Trace.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides the project ID from the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides the credentials location from the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides the credentials encoded key from the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.credentials.scopes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides the credentials scopes from the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.num-executor-threads</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of threads used by the Trace executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.authority</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP/2 authority the channel claims to be connecting to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.compression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the compression to use in Trace calls</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.deadline-ms</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call deadline in milliseconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.max-inbound-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum size for inbound messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.max-outbound-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum size for outbound messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.wait-for-ready</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/grpc/grpc/blob/main/doc/wait-for-ready.md">Waits for the channel to be ready</a> in case of a transient failure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.messageTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout in seconds before pending spans will be sent in batches to Google Cloud Trace. (previously <code>spring.zipkin.messageTimeout</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.server-response-timeout-ms</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server response timeout in millis.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.trace.pubsub.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Experimental) Auto-configure Pub/Sub instrumentation for Trace.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can use core Spring Cloud Sleuth properties to control Sleuth’s sampling rate, etc.
Read <a href="https://cloud.spring.io/spring-cloud-sleuth/">Sleuth documentation</a> for more information on Sleuth configurations.</p>
</div>
<div class="paragraph">
<p>For example, when you are testing to see the traces are going through, you can set the sampling rate to 100%.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.sleuth.sampler.probability=1                     # Send 100% of the request traces to Cloud Trace.
spring.sleuth.web.skipPattern=(^cleanup.*|.+favicon.*)  # Ignore some URL paths.
spring.sleuth.scheduled.enabled=false                   # disable executor 'async' traces</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
By default, Spring Cloud Sleuth auto-configuration instruments executor beans, which may cause recurring traces with the name <code>async</code> to appear in Cloud Trace if your application or one of its dependencies introduces scheduler beans into Spring application context. To avoid this noise, please disable automatic instrumentation of executors via <code>spring.sleuth.scheduled.enabled=false</code> in your application configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Framework on Google Cloud Trace does override some Sleuth configurations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Always uses 128-bit Trace IDs.
This is required by Cloud Trace.</p>
</li>
<li>
<p>Does not use Span joins.
Span joins will share the span ID between the client and server Spans.
Cloud Trace requires that every Span ID within a Trace to be unique, so Span joins are not supported.</p>
</li>
<li>
<p>Uses <code>StackdriverHttpRequestParser</code> by default to populate Stackdriver related fields.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="overriding-the-auto-configuration"><a class="anchor" href="#overriding-the-auto-configuration"></a><a class="link" href="#overriding-the-auto-configuration">10.3. Overriding the auto-configuration</a></h3>
<div class="paragraph">
<p>Spring Cloud Sleuth supports sending traces to multiple tracing systems as of version 2.1.0.
In order to get this to work, every tracing system needs to have a <code>Reporter&lt;Span&gt;</code> and <code>Sender</code>.
If you want to override the provided beans you need to give them a specific name.
To do this you can use respectively <code>StackdriverTraceAutoConfiguration.REPORTER_BEAN_NAME</code> and <code>StackdriverTraceAutoConfiguration.SENDER_BEAN_NAME</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="customizing-spans"><a class="anchor" href="#customizing-spans"></a><a class="link" href="#customizing-spans">10.4. Customizing spans</a></h3>
<div class="paragraph">
<p>You can add additional tags and annotations to spans by using the <code>brave.SpanCustomizer</code>, which is available in the application context.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example that uses <code>WebMvcConfigurer</code> to configure an MVC interceptor that adds two extra tags to all web controller spans.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SpringBootApplication
public class Application implements WebMvcConfigurer {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

    @Autowired
    private SpanCustomizer spanCustomizer;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new HandlerInterceptor() {
            @Override
            public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
                spanCustomizer.tag("session-id", request.getSession().getId());
                spanCustomizer.tag("environment", "QA");

                return true;
            }
        });
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then search and filter traces based on these additional tags in the Cloud Trace service.</p>
</div>
</div>
<div class="sect2">
<h3 id="integration-with-logging"><a class="anchor" href="#integration-with-logging"></a><a class="link" href="#integration-with-logging">10.5. Integration with Logging</a></h3>
<div class="paragraph">
<p>Integration with Cloud Logging is available through the <a href="#cloud-logging">Cloud Logging Support</a>.
If the Trace integration is used together with the Logging one, the request logs will be associated to the corresponding traces.
The trace logs can be viewed by going to the <a href="https://console.cloud.google.com/traces/traces">Google Cloud Console Trace List</a>, selecting a trace and pressing the <code>Logs &#8594; View</code> link in the <code>Details</code> section.</p>
</div>
</div>
<div class="sect2">
<h3 id="pubsub-trace-instrumentation-experimental"><a class="anchor" href="#pubsub-trace-instrumentation-experimental"></a><a class="link" href="#pubsub-trace-instrumentation-experimental">10.6. Pub/Sub Trace Instrumentation (Experimental)</a></h3>
<div class="paragraph">
<p>You can enable trace instrumentation and propagation for Pub/Sub messages by using the <code>spring.cloud.gcp.trace.pubsub.enabled=true</code> property.
It&#8217;s set to <code>false</code> by default, but when set to <code>true</code>, trace spans will be created and propagated to Cloud Trace whenever the application sends or receives messages through <code>PubSubTemplate</code> or any other integration that builds on top of <code>PubSubTemplate</code>, such as the Spring Integration channel adapters, and the Spring Cloud Stream Binder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># Enable Pub/Sub tracing using this property
spring.cloud.gcp.trace.pubsub.enabled=true

# You should disable Spring Integration instrumentation by Sleuth as it's unnecessary when Pub/Sub tracing is enabled
spring.sleuth.integration.enabled=false</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-5"><a class="anchor" href="#sample-5"></a><a class="link" href="#sample-5">10.7. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-trace-sample">sample application</a> and a <a href="https://codelabs.developers.google.com/codelabs/cloud-spring-cloud-gcp-trace/index.html">codelab</a> are available.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-logging"><a class="anchor" href="#cloud-logging"></a><a class="link" href="#cloud-logging">11. Cloud Logging</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-logging&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-logging")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://cloud.google.com/logging/">Cloud Logging</a> is the managed logging service provided by Google Cloud.</p>
</div>
<div class="paragraph">
<p>This module provides support for associating a web request trace ID with the corresponding log entries.
It does so by retrieving the <code>X-B3-TraceId</code> value from the <a href="https://logback.qos.ch/manual/mdc.html">Mapped Diagnostic Context (MDC)</a>, which is set by Spring Cloud Sleuth.
If Spring Cloud Sleuth isn&#8217;t used, the configured <code>TraceIdExtractor</code> extracts the desired header value and sets it as the log entry&#8217;s trace ID.
This allows grouping of log messages by request, for example, in the <a href="https://console.cloud.google.com/logs/viewer">Google Cloud Console Logs viewer</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Due to the way logging is set up, the Google Cloud project ID and credentials defined in <code>application.properties</code> are ignored.
Instead, you should set the <code>GOOGLE_CLOUD_PROJECT</code> and <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variables to the project ID and credentials private key location, respectively.
You can do this easily if you&#8217;re using the <a href="https://cloud.google.com/sdk">Google Cloud SDK</a>, using the <code>gcloud config set project [YOUR_PROJECT_ID]</code> and <code>gcloud auth application-default login</code> commands, respectively.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="web-mvc-interceptor"><a class="anchor" href="#web-mvc-interceptor"></a><a class="link" href="#web-mvc-interceptor">11.1. Web MVC Interceptor</a></h3>
<div class="paragraph">
<p>For use in Web MVC-based applications, <code>TraceIdLoggingWebMvcInterceptor</code> is provided that extracts the request trace ID from an HTTP request using a <code>TraceIdExtractor</code> and stores it in a thread-local, which can then be used in a logging appender to add the trace ID metadata to log messages.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If Spring Framework on Google Cloud Trace is enabled, the logging module disables itself and delegates log correlation to Spring Cloud Sleuth.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>LoggingWebMvcConfigurer</code> configuration class is also provided to help register the <code>TraceIdLoggingWebMvcInterceptor</code> in Spring MVC applications.</p>
</div>
<div class="paragraph">
<p>Applications hosted on the Google Cloud include trace IDs under the <code>x-cloud-trace-context</code> header, which will be included in log entries.
However, if Sleuth is used the trace ID will be picked up from the MDC.</p>
</div>
</div>
<div class="sect2">
<h3 id="logback-support"><a class="anchor" href="#logback-support"></a><a class="link" href="#logback-support">11.2. Logback Support</a></h3>
<div class="paragraph">
<p>Currently, only Logback is supported and there are 2 possibilities to log to Cloud Logging via this library with Logback: via direct API calls and through JSON-formatted console logs.</p>
</div>
<div class="sect3">
<h4 id="log-via-api"><a class="anchor" href="#log-via-api"></a><a class="link" href="#log-via-api">11.2.1. Log via API</a></h4>
<div class="paragraph">
<p>A Cloud Logging appender is available using <code>com/google/cloud/spring/logging/logback-appender.xml</code>.
This appender builds a Cloud Logging log entry from a JUL or Logback log entry, adds a trace ID to it and sends it to Cloud Logging.</p>
</div>
<div class="paragraph">
<p><code>STACKDRIVER_LOG_NAME</code> and <code>STACKDRIVER_LOG_FLUSH_LEVEL</code> environment variables can be used to customize the <code>STACKDRIVER</code> appender.</p>
</div>
<div class="paragraph">
<p>Your configuration may then look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;configuration&gt;
  &lt;include resource="com/google/cloud/spring/logging/logback-appender.xml" /&gt;

  &lt;root level="INFO"&gt;
    &lt;appender-ref ref="STACKDRIVER" /&gt;
  &lt;/root&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to have more control over the log output, you can further configure the appender.
The following properties are available (see <a href="https://github.com/googleapis/java-logging-logback">java-logging-logback project</a> for the full list):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.log</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Cloud Logging Log name.
This can also be set via the <code>STACKDRIVER_LOG_NAME</code> environmental variable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flushLevel</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WARN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If a log entry with this level is encountered, trigger a flush of locally buffered log to Cloud Logging.
This can also be set via the <code>STACKDRIVER_LOG_FLUSH_LEVEL</code> environmental variable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enhancer</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fully qualified class name for customizing a logging entry; must implement <code>com.google.cloud.logging.LoggingEnhancer</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>loggingEventEnhancer</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fully qualified class name for customizing a logging entry given an <a href="https://logback.qos.ch/apidocs/ch/qos/logback/classic/spi/ILoggingEvent.html"><code>ILoggingEvent</code></a>; must implement <code>com.google.cloud.logging.logback.LoggingEventEnhancer</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="asynchronous-logging"><a class="anchor" href="#asynchronous-logging"></a><a class="link" href="#asynchronous-logging">11.2.2. Asynchronous Logging</a></h4>
<div class="paragraph">
<p>If you would like to send logs asynchronously to Cloud Logging, you can use the <code>AsyncAppender</code>.</p>
</div>
<div class="paragraph">
<p>Your configuration may then look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;configuration&gt;
  &lt;include resource="com/google/cloud/spring/logging/logback-appender.xml" /&gt;

  &lt;appender name="ASYNC_STACKDRIVER" class="ch.qos.logback.classic.AsyncAppender"&gt;
    &lt;appender-ref ref="STACKDRIVER" /&gt;
  &lt;/appender&gt;

  &lt;root level="INFO"&gt;
    &lt;appender-ref ref="ASYNC_STACKDRIVER" /&gt;
  &lt;/root&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="log-via-console"><a class="anchor" href="#log-via-console"></a><a class="link" href="#log-via-console">11.2.3. Log via Console</a></h4>
<div class="paragraph">
<p>For Logback, a <code>com/google/cloud/spring/logging/logback-json-appender.xml</code> file is made available for import to make it easier to configure the JSON Logback appender.</p>
</div>
<div class="paragraph">
<p>Your configuration may then look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;configuration&gt;
  &lt;include resource="com/google/cloud/spring/logging/logback-json-appender.xml" /&gt;

  &lt;root level="INFO"&gt;
    &lt;appender-ref ref="CONSOLE_JSON" /&gt;
  &lt;/root&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your application is running on Google Kubernetes Engine, Google Compute Engine or Google App Engine Flexible, your console logging is automatically saved to Google Cloud Logging.
Therefore, you can just include <code>com/google/cloud/spring/logging/logback-json-appender.xml</code> in your logging configuration, which logs JSON entries to the console.
The trace id will be set correctly.</p>
</div>
<div class="paragraph">
<p>If you want to have more control over the log output, you can further configure the appender.
The following properties are available:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>projectId</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If not set, default value is determined in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>SPRING_CLOUD_GCP_LOGGING_PROJECT_ID</code> Environmental Variable.</p>
</li>
<li>
<p>Value of <code>DefaultGcpProjectIdProvider.getProjectId()</code></p>
</li>
</ol>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>This is used to generate fully qualified Cloud Trace ID format: <code>projects/[PROJECT-ID]/traces/[TRACE-ID]</code>.</p>
</div>
<div class="paragraph">
<p>This format is required to correlate trace between Cloud Trace and Cloud Logging.</p>
</div>
<div class="paragraph">
<p>If <code>projectId</code> is not set and cannot be determined, then it&#8217;ll log <code>traceId</code> without the fully qualified format.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>traceIdMdcField</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>traceId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The MDC field name for retrieving a trace id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spanIdMdcField</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spanId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the MDC field name for retrieving a span id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeTraceId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the trace id be included</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeSpanId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the span id be included</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeLevel</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the severity be included</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeThreadName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the thread name be included</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeMDC</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should all MDC properties be included.
The MDC properties <code>X-B3-TraceId</code>, <code>X-B3-SpanId</code> and <code>X-Span-Export</code> provided by Spring Sleuth will get excluded as they get handled separately</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeLoggerName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the name of the logger be included</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeFormattedMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the formatted log message be included.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeExceptionInMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the stacktrace be appended to the formatted log message.
This setting is only evaluated if <code>includeFormattedMessage</code> is <code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeContextName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the logging context be included</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the log message with blank placeholders be included</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>includeException</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the stacktrace be included as a own field</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>serviceContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the Stackdriver service context data (service and version). This allows filtering of error reports for service and version in the <a href="https://console.cloud.google.com/errors">Google Cloud Error Reporting View</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>customJson</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines custom json data. Data will be added to the json output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>loggingEventEnhancer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of a class implementing <code>JsonLoggingEventEnhancer</code> which modifies the JSON logging output. This tag is repeatable.</p>
<p class="tableblock">Examples are provided in the <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-logging/src/main/java/com/google/cloud/spring/logging/extensions">extensions package</a>.</p>
<p class="tableblock">- <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-logging/src/main/java/com/google/cloud/spring/logging/extensions/LogstashLoggingEventEnhancer.java">Logstash Enhancer</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This is an example of such an Logback configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;configuration &gt;
  &lt;property name="projectId" value="${projectId:-${GOOGLE_CLOUD_PROJECT}}"/&gt;

  &lt;appender name="CONSOLE_JSON" class="ch.qos.logback.core.ConsoleAppender"&gt;
    &lt;encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder"&gt;
      &lt;layout class="com.google.cloud.spring.logging.StackdriverJsonLayout"&gt;
        &lt;projectId&gt;${projectId}&lt;/projectId&gt;

        &lt;!--&lt;traceIdMdcField&gt;traceId&lt;/traceIdMdcField&gt;--&gt;
        &lt;!--&lt;spanIdMdcField&gt;spanId&lt;/spanIdMdcField&gt;--&gt;
        &lt;!--&lt;includeTraceId&gt;true&lt;/includeTraceId&gt;--&gt;
        &lt;!--&lt;includeSpanId&gt;true&lt;/includeSpanId&gt;--&gt;
        &lt;!--&lt;includeLevel&gt;true&lt;/includeLevel&gt;--&gt;
        &lt;!--&lt;includeThreadName&gt;true&lt;/includeThreadName&gt;--&gt;
        &lt;!--&lt;includeMDC&gt;true&lt;/includeMDC&gt;--&gt;
        &lt;!--&lt;includeLoggerName&gt;true&lt;/includeLoggerName&gt;--&gt;
        &lt;!--&lt;includeFormattedMessage&gt;true&lt;/includeFormattedMessage&gt;--&gt;
        &lt;!--&lt;includeExceptionInMessage&gt;true&lt;/includeExceptionInMessage&gt;--&gt;
        &lt;!--&lt;includeContextName&gt;true&lt;/includeContextName&gt;--&gt;
        &lt;!--&lt;includeMessage&gt;false&lt;/includeMessage&gt;--&gt;
        &lt;!--&lt;includeException&gt;false&lt;/includeException&gt;--&gt;
        &lt;!--&lt;serviceContext&gt;
              &lt;service&gt;service-name&lt;/service&gt;
              &lt;version&gt;service-version&lt;/version&gt;
            &lt;/serviceContext&gt;--&gt;
        &lt;!--&lt;customJson&gt;{"custom-key": "custom-value"}&lt;/customJson&gt;--&gt;
        &lt;!--&lt;loggingEventEnhancer&gt;your.package.YourLoggingEventEnhancer&lt;/loggingEventEnhancer&gt; --&gt;
      &lt;/layout&gt;
    &lt;/encoder&gt;
  &lt;/appender&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-6"><a class="anchor" href="#sample-6"></a><a class="link" href="#sample-6">11.3. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-logging-sample">Sample Spring Boot Application</a> is provided to show how to use the Cloud logging starter.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-monitoring"><a class="anchor" href="#cloud-monitoring"></a><a class="link" href="#cloud-monitoring">12. Cloud Monitoring</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Google Cloud provides a service called <a href="https://cloud.google.com/monitoring/">Cloud Monitoring</a>, and <a href="https://micrometer.io/docs/registry/stackdriver">Micrometer</a> can be used with it to easily instrument Spring Boot applications for observability.</p>
</div>
<div class="paragraph">
<p>Spring Boot already provides auto-configuration for Cloud Monitoring.
This module enables auto-detection of the <code>project-id</code> and <code>credentials</code>.
Also, it can be customized.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-metrics&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-metrics")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must enable Cloud Monitoring API from the Google Cloud Console in order to capture metrics.
Navigate to the <a href="https://console.cloud.google.com/apis/api/monitoring.googleapis.com/overview">Cloud Monitoring API</a> for your project and make sure it’s enabled.</p>
</div>
<div class="paragraph">
<p>Spring Boot Starter for Cloud Monitoring uses Micrometer.</p>
</div>
<div class="sect2">
<h3 id="configuration-4"><a class="anchor" href="#configuration-4"></a><a class="link" href="#configuration-4">12.1. Configuration</a></h3>
<div class="paragraph">
<p>All configurations are optional:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.metrics.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Auto-configure Micrometer to send metrics to Cloud Monitoring.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.metrics.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides the project ID from the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.metrics.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides the credentials location from the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.metrics.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides the credentials encoded key from the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.metrics.credentials.scopes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides the credentials scopes from the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can use core Spring Boot Actuator properties to control reporting frequency, etc.
Read <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready-metrics-export-stackdriver">Spring Boot Actuator documentation</a> for more information on Stackdriver Actuator configurations.</p>
</div>
<div class="sect3">
<h4 id="metrics-disambiguation"><a class="anchor" href="#metrics-disambiguation"></a><a class="link" href="#metrics-disambiguation">12.1.1. Metrics Disambiguation</a></h4>
<div class="paragraph">
<p>By default, <code>spring-cloud-gcp-starter-metrics</code>/the <code>StackdriverMeterRegistry</code> does not add any application/pod specific tags to the metrics,
thus google is unable to distinguish between multiple metric sources.
This could lead to the following warning inside your applications logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="txt" class="language-txt hljs">2022-08-15 10:26:00.248  WARN 1 --- [trics-publisher] i.m.s.StackdriverMeterRegistry           : failed to send metrics to Stackdriver</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual cause message may vary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="txt" class="language-txt hljs">One or more TimeSeries could not be written:
One or more points were written more frequently than the maximum sampling period configured for the metric.: global{} timeSeries[4]: custom.googleapis.com/process/uptime{};
One or more points were written more frequently than the maximum sampling period configured for the metric.: global{} timeSeries[6]: custom.googleapis.com/system/load/average/1m{};
One or more points ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>or even:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="txt" class="language-txt hljs">Caused by: io.grpc.netty.shaded.io.netty.handler.codec.http2.Http2Exception: Header size exceeded max allowed size (10240)</code></pre>
</div>
</div>
<div class="paragraph">
<p>(due to the error message being too long)</p>
</div>
<div class="paragraph">
<p>Google rejects metric updates for entries that it has received before (from another application) for the same interval.
To avoid these conflicts and in order to distinguish between applications/instances you should add a configuration similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">management:
  metrics:
    tags:
      app: my-foobar-service
      instance: ${random.uuid}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of the random uuid you could also use the pod id/the hostname or some other instance id.
Read more about custom tags <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#actuator.metrics.customizing.common-tags">here</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-7"><a class="anchor" href="#sample-7"></a><a class="link" href="#sample-7">12.2. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-metrics-sample">sample application</a> is available.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data-cloud-spanner"><a class="anchor" href="#spring-data-cloud-spanner"></a><a class="link" href="#spring-data-cloud-spanner">13. Spring Data Cloud Spanner</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://projects.spring.io/spring-data/">Spring Data</a> is an abstraction for storing and retrieving POJOs in numerous storage technologies.
Spring Framework on Google Cloud adds Spring Data support for <a href="https://cloud.google.com/spanner/">Google Cloud Spanner</a>.</p>
</div>
<div class="paragraph">
<p>Maven coordinates for this module only, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-data-spanner&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-data-spanner")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We provide a <a href="../spring-cloud-gcp-starters/spring-cloud-gcp-starter-data-spanner">Spring Boot Starter for Spring Data Spanner</a>, with which you can leverage our recommended auto-configuration setup.
To use the starter, see the coordinates see below.</p>
</div>
<div class="paragraph">
<p>Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-data-spanner&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-data-spanner")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This setup takes care of bringing in the latest compatible version of Cloud Java Cloud Spanner libraries as well.</p>
</div>
<div class="sect2">
<h3 id="configuration-5"><a class="anchor" href="#configuration-5"></a><a class="link" href="#configuration-5">13.1. Configuration</a></h3>
<div class="paragraph">
<p>To setup Spring Data Cloud Spanner, you have to configure the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setup the connection details to Google Cloud Spanner.</p>
</li>
<li>
<p>Enable Spring Data Repositories (optional).</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="cloud-spanner-settings"><a class="anchor" href="#cloud-spanner-settings"></a><a class="link" href="#cloud-spanner-settings">13.1.1. Cloud Spanner settings</a></h4>
<div class="paragraph">
<p>You can use the Spring Boot Starter for Spring Data Spanner to autoconfigure Google Cloud Spanner in your Spring application.
It contains all the necessary setup that makes it easy to authenticate with your Google Cloud project.
The following configuration options are available:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the Cloud Spanner client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.instance-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Spanner instance to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.database</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Spanner database to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Cloud project ID where the Google Cloud Spanner API is hosted, if different from the one in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2 credentials for authenticating with the
Google Cloud Spanner API, if different from the ones in the
<a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64-encoded OAuth2 credentials for authenticating with the
Google Cloud Spanner API, if different from the ones in the
<a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.credentials.scopes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://developers.google.com/identity/protocols/googlescopes">OAuth2 scope</a> for Spring Framework on Google
CloudSpanner credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/spanner.data" class="bare">www.googleapis.com/auth/spanner.data</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.createInterleavedTableDdlOnDeleteCascade</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, then schema statements generated by <code>SpannerSchemaUtils</code> for tables with interleaved parent-child relationships will be "ON DELETE CASCADE".
The schema for the tables will be "ON DELETE NO ACTION" if <code>false</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.numRpcChannels</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of gRPC channels used to connect to Cloud Spanner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 - Determined by Cloud Spanner client library</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.prefetchChunks</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of chunks prefetched by Cloud Spanner for read and query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 - Determined by Cloud Spanner client library</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.minSessions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minimum number of sessions maintained in the session pool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 - Determined by Cloud Spanner client library</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.maxSessions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of sessions session pool can have</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">400 - Determined by Cloud Spanner client library</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.maxIdleSessions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of idle sessions session pool will maintain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 - Determined by Cloud Spanner client library</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.writeSessionsFraction</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fraction of sessions to be kept prepared for write transactions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2 - Determined by Cloud Spanner client library</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.keepAliveIntervalMinutes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">How long to keep idle sessions alive</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30 - Determined by Cloud Spanner client library</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.failIfPoolExhausted</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If all sessions are in use, fail the request by throwing an exception. Otherwise, by default, block until a session becomes available.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.emulator.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the usage of an emulator. If this is set to true, then you should set the <code>spring.cloud.gcp.spanner.emulator-host</code> to the host:port of your locally running emulator instance.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.emulator-host</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The host and port of the Spanner emulator; can be overridden to specify connecting to an already-running <a href="https://cloud.google.com/spanner/docs/emulator#installing_and_running_the_emulator">Spanner emulator</a> instance.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>localhost:9010</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For further customization of the client library <code>SpannerOptions</code>, provide a bean implementing <code>SpannerOptionsCustomizer</code>, with a single method that accepts a <code>SpannerOptions.Builder</code> and modifies it as necessary.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repository-settings"><a class="anchor" href="#repository-settings"></a><a class="link" href="#repository-settings">13.1.2. Repository settings</a></h4>
<div class="paragraph">
<p>Spring Data Repositories can be configured via the <code>@EnableSpannerRepositories</code> annotation on your main <code>@Configuration</code> class.
With our Spring Boot Starter for Spring Data Cloud Spanner, <code>@EnableSpannerRepositories</code> is automatically added.
It is not required to add it to any other class, unless there is a need to override finer grain configuration parameters provided by <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/blob/main/spring-cloud-gcp-data-spanner/src/main/java/com/google/cloud/spring/data/spanner/repository/config/EnableSpannerRepositories.java"><code>@EnableSpannerRepositories</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="autoconfiguration"><a class="anchor" href="#autoconfiguration"></a><a class="link" href="#autoconfiguration">13.1.3. Autoconfiguration</a></h4>
<div class="paragraph">
<p>Our Spring Boot autoconfiguration creates the following beans available in the Spring application context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an instance of <code>SpannerTemplate</code></p>
</li>
<li>
<p>an instance of <code>SpannerDatabaseAdminTemplate</code> for generating table schemas from object hierarchies and creating and deleting tables and databases</p>
</li>
<li>
<p>an instance of all user-defined repositories extending <code>SpannerRepository</code>, <code>CrudRepository</code>, <code>PagingAndSortingRepository</code>, when repositories are enabled</p>
</li>
<li>
<p>an instance of <code>DatabaseClient</code> from the Google Cloud Java Client for Spanner, for convenience and lower level API access</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="object-mapping"><a class="anchor" href="#object-mapping"></a><a class="link" href="#object-mapping">13.2. Object Mapping</a></h3>
<div class="paragraph">
<p>Spring Data Cloud Spanner allows you to map domain POJOs to Cloud Spanner tables via annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Table(name = "traders")
public class Trader {

    @PrimaryKey
    @Column(name = "trader_id")
    String traderId;

    String firstName;

    String lastName;

    @NotMapped
    Double temporaryNumber;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Data Cloud Spanner will ignore any property annotated with <code>@NotMapped</code>.
These properties will not be written to or read from Spanner.</p>
</div>
<div class="sect3">
<h4 id="constructors"><a class="anchor" href="#constructors"></a><a class="link" href="#constructors">13.2.1. Constructors</a></h4>
<div class="paragraph">
<p>Simple constructors are supported on POJOs.
The constructor arguments can be a subset of the persistent properties.
Every constructor argument needs to have the same name and type as a persistent property on the entity and the constructor should set the property from the given argument.
Arguments that are not directly set to properties are not supported.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Table(name = "traders")
public class Trader {
    @PrimaryKey
    @Column(name = "trader_id")
    String traderId;

    String firstName;

    String lastName;

    @NotMapped
    Double temporaryNumber;

    public Trader(String traderId, String firstName) {
        this.traderId = traderId;
        this.firstName = firstName;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="table"><a class="anchor" href="#table"></a><a class="link" href="#table">13.2.2. Table</a></h4>
<div class="paragraph">
<p>The <code>@Table</code> annotation can provide the name of the Cloud Spanner table that stores instances of the annotated class, one per row.
This annotation is optional, and if not given, the name of the table is inferred from the class name with the first character uncapitalized.</p>
</div>
<div class="sect4">
<h5 id="spel-expressions-for-table-names"><a class="anchor" href="#spel-expressions-for-table-names"></a><a class="link" href="#spel-expressions-for-table-names">SpEL expressions for table names</a></h5>
<div class="paragraph">
<p>In some cases, you might want the <code>@Table</code> table name to be determined dynamically.
To do that, you can use <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#expressions">Spring Expression Language</a>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Table(name = "trades_#{tableNameSuffix}")
public class Trade {
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The table name will be resolved only if the <code>tableNameSuffix</code> value/bean in the Spring application context is defined.
For example, if <code>tableNameSuffix</code> has the value "123", the table name will resolve to <code>trades_123</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="primary-keys"><a class="anchor" href="#primary-keys"></a><a class="link" href="#primary-keys">13.2.3. Primary Keys</a></h4>
<div class="paragraph">
<p>For a simple table, you may only have a primary key consisting of a single column.
Even in that case, the <code>@PrimaryKey</code> annotation is required.
<code>@PrimaryKey</code> identifies the one or more ID properties corresponding to the primary key.</p>
</div>
<div class="paragraph">
<p>Spanner has first class support for composite primary keys of multiple columns.
You have to annotate all of your POJO&#8217;s fields that the primary key consists of with <code>@PrimaryKey</code> as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Table(name = "trades")
public class Trade {
    @PrimaryKey(keyOrder = 2)
    @Column(name = "trade_id")
    private String tradeId;

    @PrimaryKey(keyOrder = 1)
    @Column(name = "trader_id")
    private String traderId;

    private String action;

    private BigDecimal price;

    private Double shares;

    private String symbol;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>keyOrder</code> parameter of <code>@PrimaryKey</code> identifies the properties corresponding to the primary key columns in order, starting with 1 and increasing consecutively.
Order is important and must reflect the order defined in the Cloud Spanner schema.
In our example the DDL to create the table and its primary key is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sql" class="language-sql hljs">CREATE TABLE trades (
    trader_id STRING(MAX),
    trade_id STRING(MAX),
    action STRING(15),
    symbol STRING(10),
    price NUMERIC,
    shares FLOAT64
) PRIMARY KEY (trader_id, trade_id)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spanner does not have automatic ID generation.
For most use-cases, sequential IDs should be used with caution to avoid creating data hotspots in the system.
Read <a href="https://cloud.google.com/spanner/docs/schema-and-data-model#primary_keys">Spanner Primary Keys documentation</a> for a better understanding of primary keys and recommended practices.</p>
</div>
</div>
<div class="sect3">
<h4 id="columns"><a class="anchor" href="#columns"></a><a class="link" href="#columns">13.2.4. Columns</a></h4>
<div class="paragraph">
<p>All accessible properties on POJOs are automatically recognized as a Cloud Spanner column.
Column naming is generated by the <code>PropertyNameFieldNamingStrategy</code> by default defined on the <code>SpannerMappingContext</code> bean.
The <code>@Column</code> annotation optionally provides a different column name than that of the property and some other settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code> is the optional name of the column</p>
</li>
<li>
<p><code>spannerTypeMaxLength</code> specifies for <code>STRING</code> and <code>BYTES</code> columns the maximum length.
This setting is only used when generating DDL schema statements based on domain types.</p>
</li>
<li>
<p><code>nullable</code> specifies if the column is created as <code>NOT NULL</code>.
This setting is only used when generating DDL schema statements based on domain types.</p>
</li>
<li>
<p><code>spannerType</code> is the Cloud Spanner column type you can optionally specify.
If this is not specified then a compatible column type is inferred from the Java property type.</p>
</li>
<li>
<p><code>spannerCommitTimestamp</code> is a boolean specifying if this property corresponds to an auto-populated commit timestamp column.
Any value set in this property will be ignored when writing to Cloud Spanner.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="embedded-objects"><a class="anchor" href="#embedded-objects"></a><a class="link" href="#embedded-objects">13.2.5. Embedded Objects</a></h4>
<div class="paragraph">
<p>If an object of type <code>B</code> is embedded as a property of <code>A</code>, then the columns of <code>B</code> will be saved in the same Cloud Spanner table as those of <code>A</code>.</p>
</div>
<div class="paragraph">
<p>If <code>B</code> has primary key columns, those columns will be included in the primary key of <code>A</code>. <code>B</code> can also have embedded properties.
Embedding allows reuse of columns between multiple entities, and can be useful for implementing parent-child situations, because Cloud Spanner requires child tables to include the key columns of their parents.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class X {
  @PrimaryKey
  String grandParentId;

  long age;
}

class A {
  @PrimaryKey
  @Embedded
  X grandParent;

  @PrimaryKey(keyOrder = 2)
  String parentId;

  String value;
}

@Table(name = "items")
class B {
  @PrimaryKey
  @Embedded
  A parent;

  @PrimaryKey(keyOrder = 2)
  String id;

  @Column(name = "child_value")
  String value;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Entities of <code>B</code> can be stored in a table defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sql" class="language-sql hljs">CREATE TABLE items (
    grandParentId STRING(MAX),
    parentId STRING(MAX),
    id STRING(MAX),
    value STRING(MAX),
    child_value STRING(MAX),
    age INT64
) PRIMARY KEY (grandParentId, parentId, id)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the following restrictions apply when you use embedded objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Embedded properties' column names must all be unique.</p>
</li>
<li>
<p>Embedded properties must not be passed through a constructor and the property must be mutable; otherwise you&#8217;ll get an error, such as <code>SpannerDataException: Column not found</code>.
Be careful about this restriction when you use Kotlin&#8217;s data class to hold an embedded property.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="relationships"><a class="anchor" href="#relationships"></a><a class="link" href="#relationships">13.2.6. Relationships</a></h4>
<div class="paragraph">
<p>Spring Data Cloud Spanner supports parent-child relationships using the Cloud Spanner <a href="https://cloud.google.com/spanner/docs/schema-and-data-model#creating-interleaved-tables">parent-child interleaved table mechanism</a>.
Cloud Spanner interleaved tables enforce the one-to-many relationship and provide efficient queries and operations on entities of a single domain parent entity.
These relationships can be up to 7 levels deep.
Cloud Spanner also provides automatic cascading delete or enforces the deletion of child entities before parents.</p>
</div>
<div class="paragraph">
<p>While one-to-one and many-to-many relationships can be implemented in Cloud Spanner and Spring Data Cloud Spanner using constructs of interleaved parent-child tables, only the parent-child relationship is natively supported.</p>
</div>
<div class="paragraph">
<p>For example, the following Java entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Table(name = "Singers")
class Singer {
  @PrimaryKey
  long SingerId;

  String FirstName;

  String LastName;

  byte[] SingerInfo;

  @Interleaved
  List&lt;Album&gt; albums;
}

@Table(name = "Albums")
class Album {
  @PrimaryKey
  long SingerId;

  @PrimaryKey(keyOrder = 2)
  long AlbumId;

  String AlbumTitle;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These classes can correspond to an existing pair of interleaved tables.
The <code>@Interleaved</code> annotation may be applied to <code>Collection</code> properties and the inner type is resolved as the child entity type.
The schema needed to create them can also be generated using the <code>SpannerSchemaUtils</code> and run by using the <code>SpannerDatabaseAdminTemplate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
SpannerSchemaUtils schemaUtils;

@Autowired
SpannerDatabaseAdminTemplate databaseAdmin;
...

// Get the create statmenets for all tables in the table structure rooted at Singer
List&lt;String&gt; createStrings = this.schemaUtils.getCreateTableDdlStringsForInterleavedHierarchy(Singer.class);

// Create the tables and also create the database if necessary
this.databaseAdmin.executeDdlStrings(createStrings, true);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>createStrings</code> list contains table schema statements using column names and types compatible with the provided Java type and any resolved child relationship types contained within based on the configured custom converters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sql" class="language-sql hljs">CREATE TABLE Singers (
  SingerId   INT64 NOT NULL,
  FirstName  STRING(1024),
  LastName   STRING(1024),
  SingerInfo BYTES(MAX),
) PRIMARY KEY (SingerId);

CREATE TABLE Albums (
  SingerId     INT64 NOT NULL,
  AlbumId      INT64 NOT NULL,
  AlbumTitle   STRING(MAX),
) PRIMARY KEY (SingerId, AlbumId),
  INTERLEAVE IN PARENT Singers ON DELETE CASCADE;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ON DELETE CASCADE</code> clause indicates that Cloud Spanner will delete all Albums of a singer if the Singer is deleted.
The alternative is <code>ON DELETE NO ACTION</code>, where a Singer cannot be deleted until all of its Albums have already been deleted.
When using <code>SpannerSchemaUtils</code> to generate the schema strings, the <code>spring.cloud.gcp.spanner.createInterleavedTableDdlOnDeleteCascade</code> boolean setting determines if these schema are generated as <code>ON DELETE CASCADE</code> for <code>true</code> and <code>ON DELETE NO ACTION</code> for <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Cloud Spanner restricts these relationships to 7 child layers.
A table may have multiple child tables.</p>
</div>
<div class="paragraph">
<p>On updating or inserting an object to Cloud Spanner, all of its referenced children objects are also updated or inserted in the same request, respectively.
On read, all of the interleaved child rows are also all read.</p>
</div>
<div class="sect4">
<h5 id="lazy-fetch"><a class="anchor" href="#lazy-fetch"></a><a class="link" href="#lazy-fetch">Lazy Fetch</a></h5>
<div class="paragraph">
<p><code>@Interleaved</code> properties are retrieved eagerly by default, but can be fetched lazily for performance in both read and write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Interleaved(lazy = true)
List&lt;Album&gt; albums;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lazily-fetched interleaved properties are retrieved upon the first interaction with the property.
If a property marked for lazy fetching is never retrieved, then it is also skipped when saving the parent entity.</p>
</div>
<div class="paragraph">
<p>If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.</p>
</div>
</div>
<div class="sect4">
<h5 id="declarative-filtering-with-where"><a class="anchor" href="#declarative-filtering-with-where"></a><a class="link" href="#declarative-filtering-with-where">Declarative Filtering with <code>@Where</code></a></h5>
<div class="paragraph">
<p>The <code>@Where</code> annotation could be applied to an entity class or to an interleaved property.
This annotation provides an SQL where clause that will be applied at the fetching of interleaved collections or the entity itself.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say we have an <code>Agreement</code> with a list of <code>Participants</code> which could be assigned to it.
We would like to fetch a list of currently active participants.
For security reasons, all records should remain in the database forever, even if participants become inactive.
That can be easily achieved with the <code>@Where</code> annotation, which is demonstrated by this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Table(name = "participants")
public class Participant {
  //...
  boolean active;
  //...
}

@Table(name = "agreements")
public class Agreement {
  //...
  @Interleaved
  @Where("active = true")
  List&lt;Participant&gt; participants;
  Person person;
  //...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="supported-types"><a class="anchor" href="#supported-types"></a><a class="link" href="#supported-types">13.2.7. Supported Types</a></h4>
<div class="paragraph">
<p>Spring Data Cloud Spanner natively supports the following types for regular fields but also utilizes custom converters (detailed in following sections) and dozens of pre-defined Spring Data custom converters to handle other common Java types.</p>
</div>
<div class="paragraph">
<p>Natively supported types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.google.cloud.ByteArray</code></p>
</li>
<li>
<p><code>com.google.cloud.Date</code></p>
</li>
<li>
<p><code>com.google.cloud.Timestamp</code></p>
</li>
<li>
<p><code>java.lang.Boolean</code>, <code>boolean</code></p>
</li>
<li>
<p><code>java.lang.Double</code>, <code>double</code></p>
</li>
<li>
<p><code>java.lang.Long</code>, <code>long</code></p>
</li>
<li>
<p><code>java.lang.Integer</code>, <code>int</code></p>
</li>
<li>
<p><code>java.lang.String</code></p>
</li>
<li>
<p><code>double[]</code></p>
</li>
<li>
<p><code>long[]</code></p>
</li>
<li>
<p><code>boolean[]</code></p>
</li>
<li>
<p><code>java.util.Date</code></p>
</li>
<li>
<p><code>java.time.Instant</code></p>
</li>
<li>
<p><code>java.sql.Date</code></p>
</li>
<li>
<p><code>java.time.LocalDate</code></p>
</li>
<li>
<p><code>java.time.LocalDateTime</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="json-fields"><a class="anchor" href="#json-fields"></a><a class="link" href="#json-fields">13.2.8. JSON fields</a></h4>
<div class="paragraph">
<p>Spanner supports <code>JSON</code> and <code>ARRAY&lt;JSON&gt;</code> type for columns. Such property needs to be annotated with <code>@Column(spannerType = TypeCode.JSON)</code>. <code>JSON</code> columns are mapped to custom POJOs and <code>ARRAY&lt;JSON&gt;</code> columns are mapped to List of custom POJOs. Read, write and query with custom SQL query are supported for JSON annotated fields.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot autoconfigures a <code>Gson</code> bean by default.
This Gson instance is used by default to convert to and from JSON representation.
To customize, use <code>spring.gson.*</code> configuration properties or <code>GsonBuilderCustomizer</code> bean as instructed in Spring Boot documentation <a href="https://docs.spring.io/spring-boot/docs/2.6.x/reference/html/features.html#features.json">here</a>.
Alternatively, you can also provide a customized bean of type <code>Gson</code> in your application.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Table(name = "traders")
public class Trader {

    @PrimaryKey
    @Column(name = "trader_id")
    String traderId;

    @Column(spannerType = TypeCode.JSON)
    Details details;
}

public class Details {
    String name;
    String affiliation;
    Boolean isActive;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="lists"><a class="anchor" href="#lists"></a><a class="link" href="#lists">13.2.9. Lists</a></h4>
<div class="paragraph">
<p>Spanner supports <code>ARRAY</code> types for columns.
<code>ARRAY</code> columns are mapped to <code>List</code> fields in POJOs.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Double&gt; curve;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The types inside the lists can be any singular property type.</p>
</div>
</div>
<div class="sect3">
<h4 id="lists-of-structs"><a class="anchor" href="#lists-of-structs"></a><a class="link" href="#lists-of-structs">13.2.10. Lists of Structs</a></h4>
<div class="paragraph">
<p>Cloud Spanner queries can <a href="https://cloud.google.com/spanner/docs/query-syntax#using-structs-with-select">construct STRUCT values</a> that appear as columns in the result.
Cloud Spanner requires STRUCT values appear in ARRAYs at the root level: <code>SELECT ARRAY(SELECT STRUCT(1 as val1, 2 as val2)) as pair FROM Users</code>.</p>
</div>
<div class="paragraph">
<p>Spring Data Cloud Spanner will attempt to read the column STRUCT values into a property that is an <code>Iterable</code> of an entity type compatible with the schema of the column STRUCT value.</p>
</div>
<div class="paragraph">
<p>For the previous array-select example, the following property can be mapped with the constructed <code>ARRAY&lt;STRUCT&gt;</code> column: <code>List&lt;TwoInts&gt; pair;</code> where the <code>TwoInts</code> type is defined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class TwoInts {

  int val1;

  int val2;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="custom-types"><a class="anchor" href="#custom-types"></a><a class="link" href="#custom-types">13.2.11. Custom types</a></h4>
<div class="paragraph">
<p>Custom converters can be used to extend the type support for user defined types.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Converters need to implement the <code>org.springframework.core.convert.converter.Converter</code> interface in both directions.</p>
</li>
<li>
<p>The user defined type needs to be mapped to one of the basic types supported by Spanner:</p>
<div class="ulist">
<ul>
<li>
<p><code>com.google.cloud.ByteArray</code></p>
</li>
<li>
<p><code>com.google.cloud.Date</code></p>
</li>
<li>
<p><code>com.google.cloud.Timestamp</code></p>
</li>
<li>
<p><code>java.lang.Boolean</code>, <code>boolean</code></p>
</li>
<li>
<p><code>java.lang.Double</code>, <code>double</code></p>
</li>
<li>
<p><code>java.lang.Long</code>, <code>long</code></p>
</li>
<li>
<p><code>java.lang.String</code></p>
</li>
<li>
<p><code>double[]</code></p>
</li>
<li>
<p><code>long[]</code></p>
</li>
<li>
<p><code>boolean[]</code></p>
</li>
<li>
<p><code>enum</code> types</p>
</li>
</ul>
</div>
</li>
<li>
<p>An instance of both Converters needs to be passed to a <code>ConverterAwareMappingSpannerEntityProcessor</code>, which then has to be made available as a <code>@Bean</code> for <code>SpannerEntityProcessor</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="paragraph">
<p>We would like to have a field of type <code>Person</code> on our <code>Trade</code> POJO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Table(name = "trades")
public class Trade {
  //...
  Person person;
  //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where Person is a simple class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Person {

  public String firstName;
  public String lastName;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have to define the two converters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">  public class PersonWriteConverter implements Converter&lt;Person, String&gt; {

    @Override
    public String convert(Person person) {
      return person.firstName + " " + person.lastName;
    }
  }

  public class PersonReadConverter implements Converter&lt;String, Person&gt; {

    @Override
    public Person convert(String s) {
      Person person = new Person();
      person.firstName = s.split(" ")[0];
      person.lastName = s.split(" ")[1];
      return person;
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>That will be configured in our <code>@Configuration</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class ConverterConfiguration {

    @Bean
    public SpannerEntityProcessor spannerEntityProcessor(SpannerMappingContext spannerMappingContext) {
        return new ConverterAwareMappingSpannerEntityProcessor(spannerMappingContext,
                Arrays.asList(new PersonWriteConverter()),
                Arrays.asList(new PersonReadConverter()));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>ConverterAwareMappingSpannerEntityProcessor</code> takes a list of Converters for write and read operations to support multiple user-defined types.
When there are duplicate Converters for a user-defined class in the list, it chooses the first matching item in the lists.
This means that, for a user-defined class <code>U</code>, write operations use the first <code>Converter&lt;U, &#8230;&#8203;&gt;</code> from the write Converters and read operations use the first <code>Converter&lt;&#8230;&#8203;, U&gt;</code> from the read Converters.</p>
</div>
</div>
<div class="sect3">
<h4 id="custom-converter-for-struct-array-columns"><a class="anchor" href="#custom-converter-for-struct-array-columns"></a><a class="link" href="#custom-converter-for-struct-array-columns">13.2.12. Custom Converter for Struct Array Columns</a></h4>
<div class="paragraph">
<p>If a <code>Converter&lt;Struct, A&gt;</code> is provided, then properties of type <code>List&lt;A&gt;</code> can be used in your entity types.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spanner-operations-template"><a class="anchor" href="#spanner-operations-template"></a><a class="link" href="#spanner-operations-template">13.3. Spanner Operations &amp; Template</a></h3>
<div class="paragraph">
<p><code>SpannerOperations</code> and its implementation, <code>SpannerTemplate</code>, provides the Template pattern familiar to Spring developers.
It provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Resource management</p>
</li>
<li>
<p>One-stop-shop to Spanner operations with the Spring Data POJO mapping and conversion features</p>
</li>
<li>
<p>Exception conversion</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the <code>autoconfigure</code> provided by our Spring Boot Starter for Spanner, your Spring application context will contain a fully configured <code>SpannerTemplate</code> object that you can easily autowire in your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SpringBootApplication
public class SpannerTemplateExample {

    @Autowired
    SpannerTemplate spannerTemplate;

    public void doSomething() {
        this.spannerTemplate.delete(Trade.class, KeySet.all());
        //...
        Trade t = new Trade();
        //...
        this.spannerTemplate.insert(t);
        //...
        List&lt;Trade&gt; tradesByAction = spannerTemplate.findAll(Trade.class);
        //...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Template API provides convenience methods for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://cloud.google.com/spanner/docs/reads">Reads</a>, and by providing SpannerReadOptions and
SpannerQueryOptions</p>
<div class="ulist">
<ul>
<li>
<p>Stale read</p>
</li>
<li>
<p>Read with secondary indices</p>
</li>
<li>
<p>Read with limits and offsets</p>
</li>
<li>
<p>Read with sorting</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://cloud.google.com/spanner/docs/reads#execute_a_query">Queries</a></p>
</li>
<li>
<p>DML operations (delete, insert, update, upsert)</p>
</li>
<li>
<p>Partial reads</p>
<div class="ulist">
<ul>
<li>
<p>You can define a set of columns to be read into your entity</p>
</li>
</ul>
</div>
</li>
<li>
<p>Partial writes</p>
<div class="ulist">
<ul>
<li>
<p>Persist only a few properties from your entity</p>
</li>
</ul>
</div>
</li>
<li>
<p>Read-only transactions</p>
</li>
<li>
<p>Locking read-write transactions</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="sql-query"><a class="anchor" href="#sql-query"></a><a class="link" href="#sql-query">13.3.1. SQL Query</a></h4>
<div class="paragraph">
<p>Cloud Spanner has SQL support for running read-only queries.
All the query related methods start with <code>query</code> on <code>SpannerTemplate</code>.
By using <code>SpannerTemplate</code>, you can run SQL queries that map to POJOs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Trade&gt; trades = this.spannerTemplate.query(Trade.class, Statement.of("SELECT * FROM trades"));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="read"><a class="anchor" href="#read"></a><a class="link" href="#read">13.3.2. Read</a></h4>
<div class="paragraph">
<p>Spanner exposes a <a href="https://cloud.google.com/spanner/docs/reads">Read API</a> for reading single row or multiple rows in a table or in a secondary index.</p>
</div>
<div class="paragraph">
<p>Using <code>SpannerTemplate</code> you can run reads, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Trade&gt; trades = this.spannerTemplate.readAll(Trade.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Main benefit of reads over queries is reading multiple rows of a certain pattern of keys is much easier using the features of the <a href="https://github.com/GoogleCloudPlatform/google-cloud-java/blob/main/google-cloud-spanner/src/main/java/com/google/cloud/spanner/KeySet.java"><code>KeySet</code></a> class.</p>
</div>
</div>
<div class="sect3">
<h4 id="advanced-reads"><a class="anchor" href="#advanced-reads"></a><a class="link" href="#advanced-reads">13.3.3. Advanced reads</a></h4>
<div class="sect4">
<h5 id="stale-read"><a class="anchor" href="#stale-read"></a><a class="link" href="#stale-read">Stale read</a></h5>
<div class="paragraph">
<p>All reads and queries are <strong>strong reads</strong> by default.
A <strong>strong read</strong> is a read at a current time and is guaranteed to see all data that has been committed up until the start of this read.
An <strong>exact staleness read</strong> is read at a timestamp in the past.
Cloud Spanner allows you to determine how current the data should be when you read data.
With <code>SpannerTemplate</code> you can specify the <code>Timestamp</code> by setting it on <code>SpannerQueryOptions</code> or <code>SpannerReadOptions</code> to the appropriate read or query methods:</p>
</div>
<div class="paragraph">
<p>Reads:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// a read with options:
SpannerReadOptions spannerReadOptions = new SpannerReadOptions().setTimestamp(myTimestamp);
List&lt;Trade&gt; trades = this.spannerTemplate.readAll(Trade.class, spannerReadOptions);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// a query with options:
SpannerQueryOptions spannerQueryOptions = new SpannerQueryOptions().setTimestamp(myTimestamp);
List&lt;Trade&gt; trades = this.spannerTemplate.query(Trade.class, Statement.of("SELECT * FROM trades"), spannerQueryOptions);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also read with <a href="https://cloud.google.com/spanner/docs/timestamp-bounds"><strong>bounded staleness</strong></a> by setting <code>.setTimestampBound(TimestampBound.ofMinReadTimestamp(myTimestamp))</code> on the query and read options objects.
Bounded staleness lets Cloud Spanner choose any point in time later than or equal to the given timestampBound, but it cannot be used inside transactions.</p>
</div>
</div>
<div class="sect4">
<h5 id="read-from-a-secondary-index"><a class="anchor" href="#read-from-a-secondary-index"></a><a class="link" href="#read-from-a-secondary-index">Read from a secondary index</a></h5>
<div class="paragraph">
<p>Using a <a href="https://cloud.google.com/spanner/docs/secondary-indexes">secondary index</a> is available for Reads via the Template API and it is also implicitly available via SQL for Queries.</p>
</div>
<div class="paragraph">
<p>The following shows how to read rows from a table using a <a href="https://cloud.google.com/spanner/docs/secondary-indexes">secondary index</a> simply by setting <code>index</code> on <code>SpannerReadOptions</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">SpannerReadOptions spannerReadOptions = new SpannerReadOptions().setIndex("TradesByTrader");
List&lt;Trade&gt; trades = this.spannerTemplate.readAll(Trade.class, spannerReadOptions);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="read-with-offsets-and-limits"><a class="anchor" href="#read-with-offsets-and-limits"></a><a class="link" href="#read-with-offsets-and-limits">Read with offsets and limits</a></h5>
<div class="paragraph">
<p>Limits and offsets are only supported by Queries.
The following will get only the first two rows of the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">SpannerQueryOptions spannerQueryOptions = new SpannerQueryOptions().setLimit(2).setOffset(3);
List&lt;Trade&gt; trades = this.spannerTemplate.query(Trade.class, Statement.of("SELECT * FROM trades"), spannerQueryOptions);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the above is equivalent of running <code>SELECT * FROM trades LIMIT 2 OFFSET 3</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sorting"><a class="anchor" href="#sorting"></a><a class="link" href="#sorting">Sorting</a></h5>
<div class="paragraph">
<p>Reads by keys do not support sorting.
However, queries on the Template API support sorting through standard SQL and also via Spring Data Sort API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Trade&gt; trades = this.spannerTemplate.queryAll(Trade.class, Sort.by("action"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the provided sorted field name is that of a property of the domain type, then the column name corresponding to that property will be used in the query.
Otherwise, the given field name is assumed to be the name of the column in the Cloud Spanner table.
Sorting on columns of Cloud Spanner types STRING and BYTES can be done while ignoring case:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Sort.by(Order.desc("action").ignoreCase())</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="partial-read"><a class="anchor" href="#partial-read"></a><a class="link" href="#partial-read">Partial read</a></h5>
<div class="paragraph">
<p>Partial read is only possible when using Queries.
In case the rows returned by the query have fewer columns than the entity that it will be mapped to, Spring Data will map the returned columns only.
This setting also applies to nested structs and their corresponding nested POJO properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Trade&gt; trades = this.spannerTemplate.query(Trade.class, Statement.of("SELECT action, symbol FROM trades"),
    new SpannerQueryOptions().setAllowMissingResultSetColumns(true));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the setting is set to <code>false</code>, then an exception will be thrown if there are missing columns in the query result.</p>
</div>
</div>
<div class="sect4">
<h5 id="summary-of-options-for-query-vs-read"><a class="anchor" href="#summary-of-options-for-query-vs-read"></a><a class="link" href="#summary-of-options-for-query-vs-read">Summary of options for Query vs Read</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Feature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query supports it</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read supports it</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partial read</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offsets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secondary index</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read using index range</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sorting</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="write-update"><a class="anchor" href="#write-update"></a><a class="link" href="#write-update">13.3.4. Write / Update</a></h4>
<div class="paragraph">
<p>The write methods of <code>SpannerOperations</code> accept a POJO and writes all of its properties to Spanner.
The corresponding Spanner table and entity metadata is obtained from the given object&#8217;s actual type.</p>
</div>
<div class="paragraph">
<p>If a POJO was retrieved from Spanner and its primary key properties values were changed and then written or updated, the operation will occur as if against a row with the new primary key values.
The row with the original primary key values will not be affected.</p>
</div>
<div class="sect4">
<h5 id="insert"><a class="anchor" href="#insert"></a><a class="link" href="#insert">Insert</a></h5>
<div class="paragraph">
<p>The <code>insert</code> method of <code>SpannerOperations</code> accepts a POJO and writes all of its properties to Spanner, which means the operation will fail if a row with the POJO&#8217;s primary key already exists in the table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Trade t = new Trade();
this.spannerTemplate.insert(t);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="update"><a class="anchor" href="#update"></a><a class="link" href="#update">Update</a></h5>
<div class="paragraph">
<p>The <code>update</code> method of <code>SpannerOperations</code> accepts a POJO and writes all of its properties to Spanner, which means the operation will fail if the POJO&#8217;s primary key does not already exist in the table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// t was retrieved from a previous operation
this.spannerTemplate.update(t);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="upsert"><a class="anchor" href="#upsert"></a><a class="link" href="#upsert">Upsert</a></h5>
<div class="paragraph">
<p>The <code>upsert</code> method of <code>SpannerOperations</code> accepts a POJO and writes all of its properties to Spanner using update-or-insert.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// t was retrieved from a previous operation or it's new
this.spannerTemplate.upsert(t);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="partial-update"><a class="anchor" href="#partial-update"></a><a class="link" href="#partial-update">Partial Update</a></h5>
<div class="paragraph">
<p>The update methods of <code>SpannerOperations</code> operate by default on all properties within the given object, but also accept <code>String[]</code> and <code>Optional&lt;Set&lt;String&gt;&gt;</code> of column names.
If the <code>Optional</code> of set of column names is empty, then all columns are written to Spanner.
However, if the Optional is occupied by an empty set, then no columns will be written.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// t was retrieved from a previous operation or it's new
this.spannerTemplate.update(t, "symbol", "action");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dml"><a class="anchor" href="#dml"></a><a class="link" href="#dml">13.3.5. DML</a></h4>
<div class="paragraph">
<p>DML statements can be run by using <code>SpannerOperations.executeDmlStatement</code>.
Inserts, updates, and deletions can affect any number of rows and entities.</p>
</div>
<div class="paragraph">
<p>You can run <a href="https://cloud.google.com/spanner/docs/dml-partitioned">partitioned DML</a> updates by using the <code>executePartitionedDmlStatement</code> method.
Partitioned DML queries have performance benefits but also have restrictions and cannot be used inside transactions.</p>
</div>
</div>
<div class="sect3">
<h4 id="transactions"><a class="anchor" href="#transactions"></a><a class="link" href="#transactions">13.3.6. Transactions</a></h4>
<div class="paragraph">
<p><code>SpannerOperations</code> provides methods to run <code>java.util.Function</code> objects within a single transaction while making available the read and write methods from <code>SpannerOperations</code>.</p>
</div>
<div class="sect4">
<h5 id="readwrite-transaction"><a class="anchor" href="#readwrite-transaction"></a><a class="link" href="#readwrite-transaction">Read/Write Transaction</a></h5>
<div class="paragraph">
<p>Read and write transactions are provided by <code>SpannerOperations</code> via the <code>performReadWriteTransaction</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
SpannerOperations mySpannerOperations;

public String doWorkInsideTransaction() {
  return mySpannerOperations.performReadWriteTransaction(
    transActionSpannerOperations -&gt; {
      // Work with transActionSpannerOperations here.
      // It is also a SpannerOperations object.

      return "transaction completed";
    }
  );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>performReadWriteTransaction</code> method accepts a <code>Function</code> that is provided an instance of a <code>SpannerOperations</code> object.
The final returned value and type of the function is determined by the user.
You can use this object just as you would a regular <code>SpannerOperations</code> with a few exceptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Its read functionality cannot perform stale reads, because all reads and writes happen at the single point in time of the transaction.</p>
</li>
<li>
<p>It cannot perform sub-transactions via <code>performReadWriteTransaction</code> or <code>performReadOnlyTransaction</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As these read-write transactions are locking, it is recommended that you use the <code>performReadOnlyTransaction</code> if your function does not perform any writes.</p>
</div>
</div>
<div class="sect4">
<h5 id="read-only-transaction"><a class="anchor" href="#read-only-transaction"></a><a class="link" href="#read-only-transaction">Read-only Transaction</a></h5>
<div class="paragraph">
<p>The <code>performReadOnlyTransaction</code> method is used to perform read-only transactions using a <code>SpannerOperations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
SpannerOperations mySpannerOperations;

public String doWorkInsideTransaction() {
  return mySpannerOperations.performReadOnlyTransaction(
    transActionSpannerOperations -&gt; {
      // Work with transActionSpannerOperations here.
      // It is also a SpannerOperations object.

      return "transaction completed";
    }
  );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>performReadOnlyTransaction</code> method accepts a <code>Function</code> that is provided an instance of a
<code>SpannerOperations</code> object.
This method also accepts a <code>ReadOptions</code> object, but the only attribute used is the timestamp used to determine the snapshot in time to perform the reads in the transaction.
If the timestamp is not set in the read options the transaction is run against the current state of the database.
The final returned value and type of the function is determined by the user.
You can use this object just as you would a regular <code>SpannerOperations</code> with
a few exceptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Its read functionality cannot perform stale reads (other than the staleness set on the entire transaction), because all reads happen at the single point in time of the transaction.</p>
</li>
<li>
<p>It cannot perform sub-transactions via <code>performReadWriteTransaction</code> or <code>performReadOnlyTransaction</code></p>
</li>
<li>
<p>It cannot perform any write operations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Because read-only transactions are non-locking and can be performed on points in time in the past, these are recommended for functions that do not perform write operations.</p>
</div>
</div>
<div class="sect4">
<h5 id="declarative-transactions-with-transactional-annotation"><a class="anchor" href="#declarative-transactions-with-transactional-annotation"></a><a class="link" href="#declarative-transactions-with-transactional-annotation">Declarative Transactions with @Transactional Annotation</a></h5>
<div class="paragraph">
<p>This feature requires a bean of <code>SpannerTransactionManager</code>, which is provided when using <code>spring-cloud-gcp-starter-data-spanner</code>.</p>
</div>
<div class="paragraph">
<p><code>SpannerTemplate</code> and <code>SpannerRepository</code> support running methods with the <code>@Transactional</code> <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction-declarative">annotation</a> as transactions.
If a method annotated with <code>@Transactional</code> calls another method also annotated, then both methods will work within the same transaction.
<code>performReadOnlyTransaction</code> and <code>performReadWriteTransaction</code> cannot be used in <code>@Transactional</code> annotated methods because Cloud Spanner does not support transactions within transactions.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dml-statements"><a class="anchor" href="#dml-statements"></a><a class="link" href="#dml-statements">13.3.7. DML Statements</a></h4>
<div class="paragraph">
<p><code>SpannerTemplate</code> supports <a href="https://cloud.google.com/spanner/docs/dml-tasks:">DML</a> <code>Statements</code>.
DML statements can also be run in transactions by using <code>performReadWriteTransaction</code> or by using the <code>@Transactional</code> annotation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories"><a class="anchor" href="#repositories"></a><a class="link" href="#repositories">13.4. Repositories</a></h3>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html/#repositories">Spring Data Repositories</a> are a powerful abstraction that can save you a lot of boilerplate code.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TraderRepository extends SpannerRepository&lt;Trader, String&gt; {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Data generates a working implementation of the specified interface, which can be conveniently autowired into an application.</p>
</div>
<div class="paragraph">
<p>The <code>Trader</code> type parameter to <code>SpannerRepository</code> refers to the underlying domain type.
The second type parameter, <code>String</code> in this case, refers to the type of the key of the domain type.</p>
</div>
<div class="paragraph">
<p>For POJOs with a composite primary key, this ID type parameter can be any descendant of <code>Object[]</code> compatible with all primary key properties, any descendant of <code>Iterable</code>, or <code>com.google.cloud.spanner.Key</code>.
If the domain POJO type only has a single primary key column, then the primary key property type can be used or the <code>Key</code> type.</p>
</div>
<div class="paragraph">
<p>For example in case of Trades, that belong to a Trader, <code>TradeRepository</code> would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TradeRepository extends SpannerRepository&lt;Trade, String[]&gt; {

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MyApplication {

    @Autowired
    SpannerTemplate spannerTemplate;

    @Autowired
    StudentRepository studentRepository;

    public void demo() {

        this.tradeRepository.deleteAll();
        String traderId = "demo_trader";
        Trade t = new Trade();
        t.symbol = stock;
        t.action = action;
        t.traderId = traderId;
        t.price = new BigDecimal("100.0");
        t.shares = 12345.6;
        this.spannerTemplate.insert(t);

        Iterable&lt;Trade&gt; allTrades = this.tradeRepository.findAll();

        int count = this.tradeRepository.countByAction("BUY");

    }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="crud-repository"><a class="anchor" href="#crud-repository"></a><a class="link" href="#crud-repository">13.4.1. CRUD Repository</a></h4>
<div class="paragraph">
<p><code>CrudRepository</code> methods work as expected, with one thing Spanner specific: the <code>save</code> and <code>saveAll</code> methods work as update-or-insert.</p>
</div>
</div>
<div class="sect3">
<h4 id="paging-and-sorting-repository"><a class="anchor" href="#paging-and-sorting-repository"></a><a class="link" href="#paging-and-sorting-repository">13.4.2. Paging and Sorting Repository</a></h4>
<div class="paragraph">
<p>You can also use <code>PagingAndSortingRepository</code> with Spanner Spring Data.
The sorting and pageable <code>findAll</code> methods available from this interface operate on the current state of the Spanner database.
As a result, beware that the state of the database (and the results) might change when moving page to page.</p>
</div>
</div>
<div class="sect3">
<h4 id="spanner-repository"><a class="anchor" href="#spanner-repository"></a><a class="link" href="#spanner-repository">13.4.3. Spanner Repository</a></h4>
<div class="paragraph">
<p>The <code>SpannerRepository</code> extends the <code>PagingAndSortingRepository</code>, but adds the read-only and the read-write transaction functionality provided by Spanner.
These transactions work very similarly to those of <code>SpannerOperations</code>, but is specific to the repository&#8217;s domain type and provides repository functions instead of template functions.</p>
</div>
<div class="paragraph">
<p>For example, this is a read-only transaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
SpannerRepository myRepo;

public String doWorkInsideTransaction() {
  return myRepo.performReadOnlyTransaction(
    transactionSpannerRepo -&gt; {
      // Work with the single-transaction transactionSpannerRepo here.
      // This is a SpannerRepository object.

      return "transaction completed";
    }
  );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When creating custom repositories for your own domain types and query methods, you can extend <code>SpannerRepository</code> to access Cloud Spanner-specific features as well as all features from <code>PagingAndSortingRepository</code> and <code>CrudRepository</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="query-methods"><a class="anchor" href="#query-methods"></a><a class="link" href="#query-methods">13.5. Query Methods</a></h3>
<div class="paragraph">
<p><code>SpannerRepository</code> supports Query Methods.
Described in the following sections, these are methods residing in your custom repository interfaces of which implementations are generated based on their names and annotations.
Query Methods can read, write, and delete entities in Cloud Spanner.
Parameters to these methods can be any Cloud Spanner data type supported directly or via custom configured converters.
Parameters can also be of type <code>Struct</code> or POJOs.
If a POJO is given as a parameter, it will be converted to a <code>Struct</code> with the same type-conversion logic as used to create write mutations.
Comparisons using Struct parameters are limited to <a href="https://cloud.google.com/spanner/docs/data-types#limited-comparisons-for-struct">what is available with Cloud Spanner</a>.</p>
</div>
<div class="sect3">
<h4 id="query-methods-by-convention"><a class="anchor" href="#query-methods-by-convention"></a><a class="link" href="#query-methods-by-convention">13.5.1. Query methods by convention</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TradeRepository extends SpannerRepository&lt;Trade, String[]&gt; {
    List&lt;Trade&gt; findByAction(String action);

    int countByAction(String action);

    // Named methods are powerful, but can get unwieldy
    List&lt;Trade&gt; findTop3DistinctByActionAndSymbolIgnoreCaseOrTraderIdOrderBySymbolDesc(
            String action, String symbol, String traderId);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html/#repositories.query-methods">query methods</a> in <code>TradeRepository</code> are generated based on the name of the methods, using the <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html#repositories.query-methods.query-creation">Spring Data Query creation naming convention</a>.</p>
</div>
<div class="paragraph">
<p><code>List&lt;Trade&gt; findByAction(String action)</code> would translate to a <code>SELECT * FROM trades WHERE action = ?</code>.</p>
</div>
<div class="paragraph">
<p>The function <code>List&lt;Trade&gt; findTop3DistinctByActionAndSymbolIgnoreCaseOrTraderIdOrderBySymbolDesc(String action, String symbol, String traderId);</code> will be translated as the equivalent of this SQL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sql" class="language-sql hljs">SELECT DISTINCT * FROM trades
WHERE ACTION = ? AND LOWER(SYMBOL) = LOWER(?) AND TRADER_ID = ?
ORDER BY SYMBOL DESC
LIMIT 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following filter options are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Equality</p>
</li>
<li>
<p>Greater than or equals</p>
</li>
<li>
<p>Greater than</p>
</li>
<li>
<p>Less than or equals</p>
</li>
<li>
<p>Less than</p>
</li>
<li>
<p>Is null</p>
</li>
<li>
<p>Is not null</p>
</li>
<li>
<p>Is true</p>
</li>
<li>
<p>Is false</p>
</li>
<li>
<p>Like a string</p>
</li>
<li>
<p>Not like a string</p>
</li>
<li>
<p>Contains a string</p>
</li>
<li>
<p>Not contains a string</p>
</li>
<li>
<p>In</p>
</li>
<li>
<p>Not in</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the phrase <code>SymbolIgnoreCase</code> is translated to <code>LOWER(SYMBOL) = LOWER(?)</code> indicating a non-case-sensitive matching.
The <code>IgnoreCase</code> phrase may only be appended to fields that correspond to columns of type STRING or BYTES.
The Spring Data "AllIgnoreCase" phrase appended at the end of the method name is not supported.</p>
</div>
<div class="paragraph">
<p>The <code>Like</code> or <code>NotLike</code> naming conventions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Trade&gt; findBySymbolLike(String symbolFragment);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The param <code>symbolFragment</code> can contain <a href="https://cloud.google.com/spanner/docs/functions-and-operators#comparison-operators">wildcard characters</a> for string matching such as <code>_</code> and <code>%</code>.</p>
</div>
<div class="paragraph">
<p>The <code>Contains</code> and <code>NotContains</code> naming conventions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Trade&gt; findBySymbolContains(String symbolFragment);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The param <code>symbolFragment</code> is a <a href="https://cloud.google.com/spanner/docs/functions-and-operators#regexp_contains">regular expression</a> that is checked for occurrences.</p>
</div>
<div class="paragraph">
<p>The <code>In</code> and <code>NotIn</code> keywords must be used with <code>Iterable</code> corresponding parameters.</p>
</div>
<div class="paragraph">
<p>Delete queries are also supported.
For example, query methods such as <code>deleteByAction</code> or <code>removeByAction</code> delete entities found by <code>findByAction</code>.
The delete operation happens in a single transaction.</p>
</div>
<div class="paragraph">
<p>Delete queries can have the following return types:
* An integer type that is the number of entities deleted
* A collection of entities that were deleted
* <code>void</code></p>
</div>
</div>
<div class="sect3">
<h4 id="custom-sqldml-query-methods"><a class="anchor" href="#custom-sqldml-query-methods"></a><a class="link" href="#custom-sqldml-query-methods">13.5.2. Custom SQL/DML query methods</a></h4>
<div class="paragraph">
<p>The example above for <code>List&lt;Trade&gt; fetchByActionNamedQuery(String action)</code> does not match the <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html#repositories.query-methods.query-creation">Spring Data Query creation naming convention</a>, so we have to map a parametrized Spanner SQL query to it.</p>
</div>
<div class="paragraph">
<p>The SQL query for the method can be mapped to repository methods in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>namedQueries</code> properties file</p>
</li>
<li>
<p>using the <code>@Query</code> annotation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The names of the tags of the SQL correspond to the <code>@Param</code> annotated names of the method parameters.</p>
</div>
<div class="paragraph">
<p>Interleaved properties are loaded eagerly, unless they are annotated with <code>@Interleaved(lazy = true)</code>.</p>
</div>
<div class="paragraph">
<p>Custom SQL query methods can accept a single <code>Sort</code> or <code>Pageable</code> parameter that is applied on top of the specified custom query.
It is the recommended way to control the sort order of the results, which is not guaranteed by the <code>ORDER BY</code> clause in the SQL query.
This is due to the fact that the user-provided query is used as a sub-query, and Cloud Spanner doesn&#8217;t preserve order in subquery results.</p>
</div>
<div class="paragraph">
<p>You might want to use <code>ORDER BY</code> with <code>LIMIT</code> to obtain the top records, according to a specified order.
However, to ensure the correct sort order of the final result set, sort options have to be passed in with a <code>Pageable</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    @Query("SELECT * FROM trades")
    List&lt;Trade&gt; fetchTrades(Pageable pageable);

    @Query("SELECT * FROM trades ORDER BY price DESC LIMIT 1")
    Trade topTrade(Pageable pageable);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    List&lt;Trade&gt; customSortedTrades = tradeRepository.fetchTrades(PageRequest
                .of(2, 2, org.springframework.data.domain.Sort.by(Order.asc("id"))));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The results would be sorted by "id" in ascending order.</p>
</div>
<div class="paragraph">
<p>Your query method can also return non-entity types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    @Query("SELECT COUNT(1) FROM trades WHERE action = @action")
    int countByActionQuery(String action);

    @Query("SELECT EXISTS(SELECT COUNT(1) FROM trades WHERE action = @action)")
    boolean existsByActionQuery(String action);

    @Query("SELECT action FROM trades WHERE action = @action LIMIT 1")
    String getFirstString(@Param("action") String action);

    @Query("SELECT action FROM trades WHERE action = @action")
    List&lt;String&gt; getFirstStringList(@Param("action") String action);</code></pre>
</div>
</div>
<div class="paragraph">
<p>DML statements can also be run by query methods, but the only possible return value is a <code>long</code> representing the number of affected rows.
The <code>dmlStatement</code> boolean setting must be set on <code>@Query</code> to indicate that the query method is run as a DML statement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    @Query(value = "DELETE FROM trades WHERE action = @action", dmlStatement = true)
    long deleteByActionQuery(String action);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="query-methods-with-named-queries-properties"><a class="anchor" href="#query-methods-with-named-queries-properties"></a><a class="link" href="#query-methods-with-named-queries-properties">Query methods with named queries properties</a></h5>
<div class="paragraph">
<p>By default, the <code>namedQueriesLocation</code> attribute on <code>@EnableSpannerRepositories</code> points to the <code>META-INF/spanner-named-queries.properties</code> file.
You can specify the query for a method in the properties file by providing the SQL as the value for the "interface.method" property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">Trade.fetchByActionNamedQuery=SELECT * FROM trades WHERE trades.action = @tag0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TradeRepository extends SpannerRepository&lt;Trade, String[]&gt; {
    // This method uses the query from the properties file instead of one generated based on name.
    List&lt;Trade&gt; fetchByActionNamedQuery(@Param("tag0") String action);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query-methods-with-annotation"><a class="anchor" href="#query-methods-with-annotation"></a><a class="link" href="#query-methods-with-annotation">Query methods with annotation</a></h5>
<div class="paragraph">
<p>Using the <code>@Query</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TradeRepository extends SpannerRepository&lt;Trade, String[]&gt; {
    @Query("SELECT * FROM trades WHERE trades.action = @tag0")
    List&lt;Trade&gt; fetchByActionNamedQuery(@Param("tag0") String action);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Table names can be used directly.
For example, "trades" in the above example.
Alternatively, table names can be resolved from the <code>@Table</code> annotation on domain classes as well.
In this case, the query should refer to table names with fully qualified class names between <code>:</code>
characters: <code>:fully.qualified.ClassName:</code>.
A full example would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Query("SELECT * FROM :com.example.Trade: WHERE trades.action = @tag0")
List&lt;Trade&gt; fetchByActionNamedQuery(String action);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows table names evaluated with SpEL to be used in custom queries.</p>
</div>
<div class="paragraph">
<p>SpEL can also be used to provide SQL parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Query("SELECT * FROM :com.example.Trade: WHERE trades.action = @tag0
  AND price &gt; #{#priceRadius * -1} AND price &lt; #{#priceRadius * 2}")
List&lt;Trade&gt; fetchByActionNamedQuery(String action, Double priceRadius);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the <code>IN</code> SQL clause, remember to use <code>IN UNNEST(@iterableParam)</code> to specify a single <code>Iterable</code> parameter.
You can also use a fixed number of singular parameters such as <code>IN (@stringParam1, @stringParam2)</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="projections"><a class="anchor" href="#projections"></a><a class="link" href="#projections">13.5.3. Projections</a></h4>
<div class="paragraph">
<p>Spring Data Spanner supports <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html/#projections">projections</a>.
You can define projection interfaces based on domain types and add query methods that return them in your repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TradeProjection {

    String getAction();

    @Value("#{target.symbol + ' ' + target.action}")
    String getSymbolAndAction();
}

public interface TradeRepository extends SpannerRepository&lt;Trade, Key&gt; {

    List&lt;Trade&gt; findByTraderId(String traderId);

    List&lt;TradeProjection&gt; findByAction(String action);

    @Query("SELECT action, symbol FROM trades WHERE action = @action")
    List&lt;TradeProjection&gt; findByQuery(String action);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Projections can be provided by name-convention-based query methods as well as by custom SQL queries.
If using custom SQL queries, you can further restrict the columns retrieved from Spanner to just those required by the projection to improve performance.</p>
</div>
<div class="paragraph">
<p>Properties of projection types defined using SpEL use the fixed name <code>target</code> for the underlying domain object.
As a result accessing underlying properties take the form <code>target.&lt;property-name&gt;</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="empty-result-handling-in-repository-methods"><a class="anchor" href="#empty-result-handling-in-repository-methods"></a><a class="link" href="#empty-result-handling-in-repository-methods">13.5.4. Empty result handling in repository methods</a></h4>
<div class="paragraph">
<p>Java <code>java.util.Optional</code> can be used to indicate the potential absence of a return value.</p>
</div>
<div class="paragraph">
<p>Alternatively, query methods can return the result without a wrapper.
In that case the absence of a query result is indicated by returning <code>null</code>.
Repository methods returning collections are guaranteed never to return <code>null</code> but rather the corresponding empty collection.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can enable nullability checks. For more details please see <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#null-safety">Spring Framework’s nullability docs</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="rest-repositories"><a class="anchor" href="#rest-repositories"></a><a class="link" href="#rest-repositories">13.5.5. REST Repositories</a></h4>
<div class="paragraph">
<p>When running with Spring Boot, repositories can be exposed as REST services by simply adding this dependency to your pom file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-data-rest&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you prefer to configure parameters (such as path), you can use <code>@RepositoryRestResource</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@RepositoryRestResource(collectionResourceRel = "trades", path = "trades")
public interface TradeRepository extends SpannerRepository&lt;Trade, Key&gt; {
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For classes that have composite keys (multiple <code>@PrimaryKey</code> fields), only the <code>Key</code> type is supported for the repository ID type.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, you can retrieve all <code>Trade</code> objects in the repository by using <code>curl http://&lt;server&gt;:&lt;port&gt;/trades</code>, or any specific trade via <code>curl http://&lt;server&gt;:&lt;port&gt;/trades/&lt;trader_id&gt;,&lt;trade_id&gt;</code>.</p>
</div>
<div class="paragraph">
<p>The separator between your primary key components, <code>id</code> and <code>trader_id</code> in this case, is a comma by default, but can be configured to any string not found in your key values by extending the <code>SpannerKeyIdConverter</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Component
class MySpecialIdConverter extends SpannerKeyIdConverter {

    @Override
    protected String getUrlIdSeparator() {
        return ":";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also write trades using <code>curl -XPOST -H"Content-Type: application/json" -<a href="mailto:d@test.json">d@test.json</a> http://&lt;server&gt;:&lt;port&gt;/trades/</code> where the file <code>test.json</code> holds the JSON representation of a <code>Trade</code> object.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="database-and-schema-admin"><a class="anchor" href="#database-and-schema-admin"></a><a class="link" href="#database-and-schema-admin">13.6. Database and Schema Admin</a></h3>
<div class="paragraph">
<p>Databases and tables inside Spanner instances can be created automatically from <code>SpannerPersistentEntity</code> objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private SpannerSchemaUtils spannerSchemaUtils;

@Autowired
private SpannerDatabaseAdminTemplate spannerDatabaseAdminTemplate;

public void createTable(SpannerPersistentEntity entity) {
    if(!spannerDatabaseAdminTemplate.tableExists(entity.tableName()){

      // The boolean parameter indicates that the database will be created if it does not exist.
      spannerDatabaseAdminTemplate.executeDdlStrings(Arrays.asList(
            spannerSchemaUtils.getCreateTableDDLString(entity.getType())), true);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Schemas can be generated for entire object hierarchies with interleaved relationships and composite keys.</p>
</div>
</div>
<div class="sect2">
<h3 id="events"><a class="anchor" href="#events"></a><a class="link" href="#events">13.7. Events</a></h3>
<div class="paragraph">
<p>Spring Data Cloud Spanner publishes events extending the Spring Framework&#8217;s <code>ApplicationEvent</code> to the context that can be received by <code>ApplicationListener</code> beans you register.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Contents</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AfterReadEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately after entities are read by key from Cloud Spanner by <code>SpannerTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entities loaded. The read options and key-set originally specified for the load operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AfterQueryEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately after entities are read by query from Cloud Spanner by <code>SpannerTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entities loaded. The query options and query statement originally specified for the load operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BeforeExecuteDmlEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately before DML statements are executed by <code>SpannerTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The DML statement to execute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AfterExecuteDmlEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately after DML statements are executed by <code>SpannerTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The DML statement to execute and the number of rows affected by the operation as reported by Cloud Spanner.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BeforeSaveEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately before upsert/update/insert operations are executed by <code>SpannerTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The mutations to be sent to Cloud Spanner, the entities to be saved, and optionally the properties in those entities to save.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AfterSaveEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately after upsert/update/insert operations are executed by <code>SpannerTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The mutations sent to Cloud Spanner, the entities to be saved, and optionally the properties in those entities to save.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BeforeDeleteEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately before delete operations are executed by <code>SpannerTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The mutations to be sent to Cloud Spanner. The target entities, keys, or entity type originally specified for the delete operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AfterDeleteEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately after delete operations are executed by <code>SpannerTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The mutations sent to Cloud Spanner. The target entities, keys, or entity type originally specified for the delete operation.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="auditing"><a class="anchor" href="#auditing"></a><a class="link" href="#auditing">13.8. Auditing</a></h3>
<div class="paragraph">
<p>Spring Data Cloud Spanner supports the <code>@LastModifiedDate</code> and <code>@LastModifiedBy</code> auditing annotations for properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Table
public class SimpleEntity {
    @PrimaryKey
    String id;

    @LastModifiedBy
    String lastUser;

    @LastModifiedDate
    DateTime lastTouched;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Upon insert, update, or save, these properties will be set automatically by the framework before mutations are generated and saved to Cloud Spanner.</p>
</div>
<div class="paragraph">
<p>To take advantage of these features, add the <code>@EnableSpannerAuditing</code> annotation to your configuration class and provide a bean for an <code>AuditorAware&lt;A&gt;</code> implementation where the type <code>A</code> is the desired property type annotated by <code>@LastModifiedBy</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
@EnableSpannerAuditing
public class Config {

    @Bean
    public AuditorAware&lt;String&gt; auditorProvider() {
        return () -&gt; Optional.of("YOUR_USERNAME_HERE");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AuditorAware</code> interface contains a single method that supplies the value for fields annotated by <code>@LastModifiedBy</code> and can be of any type.
One alternative is to use Spring Security&#8217;s <code>User</code> type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class SpringSecurityAuditorAware implements AuditorAware&lt;User&gt; {

  public Optional&lt;User&gt; getCurrentAuditor() {

    return Optional.ofNullable(SecurityContextHolder.getContext())
              .map(SecurityContext::getAuthentication)
              .filter(Authentication::isAuthenticated)
              .map(Authentication::getPrincipal)
              .map(User.class::cast);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also set a custom provider for properties annotated <code>@LastModifiedDate</code> by providing a bean for <code>DateTimeProvider</code> and providing the bean name to <code>@EnableSpannerAuditing(dateTimeProviderRef = "customDateTimeProviderBean")</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="multi-instance-usage"><a class="anchor" href="#multi-instance-usage"></a><a class="link" href="#multi-instance-usage">13.9. Multi-Instance Usage</a></h3>
<div class="paragraph">
<p>Your application can be configured to use multiple Cloud Spanner instances or databases by providing a custom bean for <code>DatabaseIdProvider</code>.
The default bean uses the instance ID, database name, and project ID options you configured in <code>application.properties</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    @Bean
    public DatabaseIdProvider databaseIdProvider() {
        // return custom connection options provider
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>DatabaseId</code> given by this provider is used as the target database name and instance of each operation Spring Data Cloud Spanner executes.
By providing a custom implementation of this bean (for example, supplying a thread-local <code>DatabaseId</code>), you can direct your application to use multiple instances or databases.</p>
</div>
<div class="paragraph">
<p>Database administrative operations, such as creating tables using <code>SpannerDatabaseAdminTemplate</code>, will also utilize the provided <code>DatabaseId</code>.</p>
</div>
<div class="paragraph">
<p>If you would like to configure every aspect of each connection (such as pool size and retry settings), you can supply a bean for <code>Supplier&lt;DatabaseClient&gt;</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="spring-boot-actuator-support-2"><a class="anchor" href="#spring-boot-actuator-support-2"></a><a class="link" href="#spring-boot-actuator-support-2">13.10. Spring Boot Actuator Support</a></h3>
<div class="sect3">
<h4 id="cloud-spanner-health-indicator"><a class="anchor" href="#cloud-spanner-health-indicator"></a><a class="link" href="#cloud-spanner-health-indicator">13.10.1. Cloud Spanner Health Indicator</a></h4>
<div class="paragraph">
<p>If you are using Spring Boot Actuator, you can take advantage of the Cloud Spanner health indicator called <code>spanner</code>.
The health indicator will verify whether Cloud Spanner is up and accessible by your application.
To enable it, all you need to do is add the <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready">Spring Boot Actuator</a> to your project.</p>
</div>
<div class="paragraph">
<p>The <code>spanner</code> indicator will then roll up to the overall application status visible at <a href="http://localhost:8080/actuator/health" class="bare">localhost:8080/actuator/health</a> (use the <code>management.endpoint.health.show-details</code> property to view per-indicator details).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your application already has actuator and Cloud Spanner starters, this health indicator is enabled by default.
To disable the Cloud Spanner indicator, set <code>management.health.spanner.enabled</code> to <code>false</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The health indicator validates the connection to Spanner by executing a query.
A query to validate can be configured via <code>spring.cloud.gcp.spanner.health.query</code> property.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>management.health.spanner.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable the Spanner health indicator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> with Spring Boot Actuator, <code>false</code> otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.spanner.health.query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A query to validate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SELECT 1</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cloud-spanner-emulator"><a class="anchor" href="#cloud-spanner-emulator"></a><a class="link" href="#cloud-spanner-emulator">13.11. Cloud Spanner Emulator</a></h3>
<div class="paragraph">
<p>The <a href="https://cloud.google.com/sdk">Cloud SDK</a> provides a local, in-memory emulator for Cloud Spanner, which you can use to develop and test your application. As the emulator stores data only in memory, it will not persist data across runs. It is intended to help you use Cloud Spanner for local development and testing, not for production deployments.</p>
</div>
<div class="paragraph">
<p>In order to set up and start the emulator, you can follow <a href="https://cloud.google.com/spanner/docs/emulator">these steps</a>.</p>
</div>
<div class="paragraph">
<p>This command can be used to create Cloud Spanner instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ gcloud spanner instances create &lt;instance-name&gt; --config=emulator-config --description="&lt;description&gt;" --nodes=1</pre>
</div>
</div>
<div class="paragraph">
<p>Once the Spanner emulator is running, ensure that the following properties are set in your <code>application.properties</code> of your Spring application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.cloud.gcp.spanner.emulator.enabled=true</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the default emulator hostname and port (i.e., localhost:9010) is used. If you prefer a customized value, ensure the following property is set in your <code>application.properties</code> of your Spring application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.cloud.gcp.spanner.emulator-host=ip:port</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-8"><a class="anchor" href="#sample-8"></a><a class="link" href="#sample-8">13.12. Sample</a></h3>
<div class="paragraph">
<p>There are two sample applications available:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-spanner-template-sample"> Sample application using Spanner Template directly</a></p>
</li>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-spanner-repository-sample"> Sample application using higher-level Spanner Repository capabilities</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="test-2"><a class="anchor" href="#test-2"></a><a class="link" href="#test-2">13.13. Test</a></h3>
<div class="paragraph">
<p><code>Testcontainers</code> provides a <code>gcloud</code> module which offers <code>SpannerEmulatorContainer</code>. See more at the <a href="https://www.testcontainers.org/modules/gcloud/#spanner">docs</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data-cloud-datastore"><a class="anchor" href="#spring-data-cloud-datastore"></a><a class="link" href="#spring-data-cloud-datastore">14. Spring Data Cloud Datastore</a></h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This integration is fully compatible with <a href="https://cloud.google.com/datastore/docs/">Firestore in Datastore Mode</a>, but not with Firestore in Native Mode.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://projects.spring.io/spring-data/">Spring Data</a> is an abstraction for storing and retrieving POJOs in numerous storage technologies.
Spring Framework on Google Cloud adds Spring Data support for <a href="https://cloud.google.com/firestore/">Google Cloud Firestore</a> in Datastore mode.</p>
</div>
<div class="paragraph">
<p>Maven coordinates for this module only, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-data-datastore&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-data-datastore")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We provide a <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-starters/spring-cloud-gcp-starter-data-datastore">Spring Boot Starter for Spring Data Datastore</a>, with which you can use our recommended auto-configuration setup.
To use the starter, see the coordinates below.</p>
</div>
<div class="paragraph">
<p>Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-data-datastore&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-data-datastore")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This setup takes care of bringing in the latest compatible version of Cloud Java Cloud Datastore libraries as well.</p>
</div>
<div class="sect2">
<h3 id="configuration-6"><a class="anchor" href="#configuration-6"></a><a class="link" href="#configuration-6">14.1. Configuration</a></h3>
<div class="paragraph">
<p>To setup Spring Data Cloud Datastore, you have to configure the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setup the connection details to Google Cloud Datastore.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="cloud-datastore-settings"><a class="anchor" href="#cloud-datastore-settings"></a><a class="link" href="#cloud-datastore-settings">14.1.1. Cloud Datastore settings</a></h4>
<div class="paragraph">
<p>You can use the <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-starters/spring-cloud-gcp-starter-data-datastore">Spring Boot Starter for Spring Data Datastore</a> to autoconfigure Google Cloud Datastore in your Spring application.
It contains all the necessary setup that makes it easy to authenticate with your Google Cloud project.
The following configuration options are available:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the Cloud Datastore client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Cloud project ID where the Google Cloud Datastore API is hosted, if different from the one in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2 credentials for authenticating with the Google Cloud Datastore API, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64-encoded OAuth2 credentials for authenticating with the Google Cloud Datastore API, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.credentials.scopes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://developers.google.com/identity/protocols/googlescopes">OAuth2 scope</a> for Spring Framework on Google CloudDatastore credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/datastore" class="bare">www.googleapis.com/auth/datastore</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.namespace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Cloud Datastore namespace to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the Default namespace of Cloud Datastore in your Google Cloud project</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.host</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>hostname:port</code> of the datastore service or emulator to connect to. Can be used to connect to a manually started <a href="https://cloud.google.com/datastore/docs/tools/datastore-emulator">Datastore Emulator</a>. If the autoconfigured emulator is enabled, this property will be ignored and <code>localhost:&lt;emulator_port&gt;</code> will be used.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.emulator.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To enable the auto configuration to start a local instance of the Datastore Emulator.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.emulator.port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The local port to use for the Datastore Emulator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>8081</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.emulator.consistency</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <a href="https://cloud.google.com/sdk/gcloud/reference/beta/emulators/datastore/start?#--consistency">consistency</a> to use for the Datastore Emulator instance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.9</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.emulator.store-on-disk</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures whether or not the emulator should persist any data to disk.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.datastore.emulator.data-dir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The directory to be used to store/retrieve data/config for an emulator run.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default value is <code>&lt;USER_CONFIG_DIR&gt;/emulators/datastore</code>. See the <a href="https://cloud.google.com/sdk/gcloud/reference/beta/emulators/datastore/start">gcloud documentation</a> for finding your <code>USER_CONFIG_DIR</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="repository-settings-2"><a class="anchor" href="#repository-settings-2"></a><a class="link" href="#repository-settings-2">14.1.2. Repository settings</a></h4>
<div class="paragraph">
<p>Spring Data Repositories can be configured via the <code>@EnableDatastoreRepositories</code> annotation on your main <code>@Configuration</code> class.
With our Spring Boot Starter for Spring Data Cloud Datastore, <code>@EnableDatastoreRepositories</code> is automatically added.
It is not required to add it to any other class, unless there is a need to override finer grain configuration parameters provided by <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/blob/main/spring-cloud-gcp-data-datastore/src/main/java/com/google/cloud/spring/data/datastore/repository/config/EnableDatastoreRepositories.java"><code>@EnableDatastoreRepositories</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="autoconfiguration-2"><a class="anchor" href="#autoconfiguration-2"></a><a class="link" href="#autoconfiguration-2">14.1.3. Autoconfiguration</a></h4>
<div class="paragraph">
<p>Our Spring Boot autoconfiguration creates the following beans available in the Spring application context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an instance of <code>DatastoreTemplate</code></p>
</li>
<li>
<p>an instance of all user defined repositories extending <code>CrudRepository</code>, <code>PagingAndSortingRepository</code>, and <code>DatastoreRepository</code> (an extension of <code>PagingAndSortingRepository</code> with additional Cloud Datastore features) when repositories are enabled</p>
</li>
<li>
<p>an instance of <code>Datastore</code> from the Google Cloud Java Client for Datastore, for convenience and lower level API access</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="datastore-emulator-autoconfiguration"><a class="anchor" href="#datastore-emulator-autoconfiguration"></a><a class="link" href="#datastore-emulator-autoconfiguration">14.1.4. Datastore Emulator Autoconfiguration</a></h4>
<div class="paragraph">
<p>This Spring Boot autoconfiguration can also configure and start a local Datastore Emulator server if enabled by property.</p>
</div>
<div class="paragraph">
<p>It is useful for integration testing, but not for production.</p>
</div>
<div class="paragraph">
<p>When enabled, the <code>spring.cloud.gcp.datastore.host</code> property will be ignored and the Datastore autoconfiguration itself will be forced to connect to the autoconfigured local emulator instance.</p>
</div>
<div class="paragraph">
<p>It will create an instance of <code>LocalDatastoreHelper</code> as a bean that stores the <code>DatastoreOptions</code> to get the <code>Datastore</code> client connection to the emulator for convenience and lower level API for local access.
The emulator will be properly stopped after the Spring application context shutdown.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="object-mapping-2"><a class="anchor" href="#object-mapping-2"></a><a class="link" href="#object-mapping-2">14.2. Object Mapping</a></h3>
<div class="paragraph">
<p>Spring Data Cloud Datastore allows you to map domain POJOs to Cloud Datastore kinds and entities via annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity(name = "traders")
public class Trader {

    @Id
    @Field(name = "trader_id")
    String traderId;

    String firstName;

    String lastName;

    @Transient
    Double temporaryNumber;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Data Cloud Datastore will ignore any property annotated with <code>@Transient</code>.
These properties will not be written to or read from Cloud Datastore.</p>
</div>
<div class="sect3">
<h4 id="constructors-2"><a class="anchor" href="#constructors-2"></a><a class="link" href="#constructors-2">14.2.1. Constructors</a></h4>
<div class="paragraph">
<p>Simple constructors are supported on POJOs.
The constructor arguments can be a subset of the persistent properties.
Every constructor argument needs to have the same name and type as a persistent property on the entity and the constructor should set the property from the given argument.
Arguments that are not directly set to properties are not supported.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity(name = "traders")
public class Trader {

    @Id
    @Field(name = "trader_id")
    String traderId;

    String firstName;

    String lastName;

    @Transient
    Double temporaryNumber;

    public Trader(String traderId, String firstName) {
        this.traderId = traderId;
        this.firstName = firstName;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="kind"><a class="anchor" href="#kind"></a><a class="link" href="#kind">14.2.2. Kind</a></h4>
<div class="paragraph">
<p>The <code>@Entity</code> annotation can provide the name of the Cloud Datastore kind that stores instances of the annotated class, one per row.</p>
</div>
</div>
<div class="sect3">
<h4 id="keys"><a class="anchor" href="#keys"></a><a class="link" href="#keys">14.2.3. Keys</a></h4>
<div class="paragraph">
<p><code>@Id</code> identifies the property corresponding to the ID value.</p>
</div>
<div class="paragraph">
<p>You must annotate one of your POJO&#8217;s fields as the ID value, because every entity in Cloud Datastore requires a single ID value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity(name = "trades")
public class Trade {
    @Id
    @Field(name = "trade_id")
    String tradeId;

    @Field(name = "trader_id")
    String traderId;

    String action;

    Double price;

    Double shares;

    String symbol;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Datastore can automatically allocate integer ID values.
If a POJO instance with a <code>Long</code> ID property is written to Cloud Datastore with <code>null</code> as the ID value, then Spring Data Cloud Datastore will obtain a newly allocated ID value from Cloud Datastore and set that in the POJO for saving.
Because primitive <code>long</code> ID properties cannot be <code>null</code> and default to <code>0</code>, keys will not be allocated.</p>
</div>
</div>
<div class="sect3">
<h4 id="fields"><a class="anchor" href="#fields"></a><a class="link" href="#fields">14.2.4. Fields</a></h4>
<div class="paragraph">
<p>All accessible properties on POJOs are automatically recognized as a Cloud Datastore field.
Field naming is generated by the <code>PropertyNameFieldNamingStrategy</code> by default defined on the <code>DatastoreMappingContext</code> bean.
The <code>@Field</code> annotation optionally provides a different field name than that of the property.</p>
</div>
</div>
<div class="sect3">
<h4 id="supported-types-2"><a class="anchor" href="#supported-types-2"></a><a class="link" href="#supported-types-2">14.2.5. Supported Types</a></h4>
<div class="paragraph">
<p>Spring Data Cloud Datastore supports the following types for regular fields and elements of collections:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Stored as</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.google.cloud.Timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.TimestampValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.google.cloud.datastore.Blob</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.BlobValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.google.cloud.datastore.LatLng</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.LatLngValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Boolean</code>, <code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.BooleanValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Double</code>, <code>double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.DoubleValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Long</code>, <code>long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.LongValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Integer</code>, <code>int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.LongValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.StringValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.google.cloud.datastore.Entity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.EntityValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.google.cloud.datastore.Key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.KeyValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.BlobValue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java <code>enum</code> values</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.google.cloud.datastore.StringValue</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, all types that can be converted to the ones listed in the table by
<code>org.springframework.core.convert.support.DefaultConversionService</code> are supported.</p>
</div>
</div>
<div class="sect3">
<h4 id="custom-types-2"><a class="anchor" href="#custom-types-2"></a><a class="link" href="#custom-types-2">14.2.6. Custom types</a></h4>
<div class="paragraph">
<p>Custom converters can be used extending the type support for user defined types.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Converters need to implement the <code>org.springframework.core.convert.converter.Converter</code> interface in both directions.</p>
</li>
<li>
<p>The user defined type needs to be mapped to one of the basic types supported by Cloud Datastore.</p>
</li>
<li>
<p>An instance of both Converters (read and write) needs to be passed to the <code>DatastoreCustomConversions</code> constructor, which then has to be made available as a <code>@Bean</code> for <code>DatastoreCustomConversions</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="paragraph">
<p>We would like to have a field of type  <code>Album</code> on our <code>Singer</code> POJO and want it to be stored as a string property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class Singer {

    @Id
    String singerId;

    String name;

    Album album;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where Album is a simple class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Album {
    String albumName;

    LocalDate date;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have to define the two converters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    // Converter to write custom Album type
    static final Converter&lt;Album, String&gt; ALBUM_STRING_CONVERTER =
            new Converter&lt;Album, String&gt;() {
                @Override
                public String convert(Album album) {
                    return album.getAlbumName() + " " + album.getDate().format(DateTimeFormatter.ISO_DATE);
                }
            };

    // Converters to read custom Album type
    static final Converter&lt;String, Album&gt; STRING_ALBUM_CONVERTER =
            new Converter&lt;String, Album&gt;() {
                @Override
                public Album convert(String s) {
                    String[] parts = s.split(" ");
                    return new Album(parts[0], LocalDate.parse(parts[parts.length - 1], DateTimeFormatter.ISO_DATE));
                }
            };</code></pre>
</div>
</div>
<div class="paragraph">
<p>That will be configured in our <code>@Configuration</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class ConverterConfiguration {
    @Bean
    public DatastoreCustomConversions datastoreCustomConversions() {
        return new DatastoreCustomConversions(
                Arrays.asList(
                        ALBUM_STRING_CONVERTER,
                        STRING_ALBUM_CONVERTER));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="collections-and-arrays"><a class="anchor" href="#collections-and-arrays"></a><a class="link" href="#collections-and-arrays">14.2.7. Collections and arrays</a></h4>
<div class="paragraph">
<p>Arrays and collections (types that implement <code>java.util.Collection</code>) of supported types are supported.
They are stored as <code>com.google.cloud.datastore.ListValue</code>.
Elements are converted to Cloud Datastore supported types individually. <code>byte[]</code> is an exception, it is converted to
<code>com.google.cloud.datastore.Blob</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="custom-converter-for-collections"><a class="anchor" href="#custom-converter-for-collections"></a><a class="link" href="#custom-converter-for-collections">14.2.8. Custom Converter for collections</a></h4>
<div class="paragraph">
<p>Users can provide converters from  <code>List&lt;?&gt;</code> to the custom collection type.
Only read converter is necessary, the Collection API is used on the write side to convert a collection to the internal list type.</p>
</div>
<div class="paragraph">
<p>Collection converters need to implement the <code>org.springframework.core.convert.converter.Converter</code> interface.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="paragraph">
<p>Let&#8217;s improve the Singer class from the previous example.
Instead of a field of type <code>Album</code>, we would like to have a field of type <code>Set&lt;Album&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class Singer {

    @Id
    String singerId;

    String name;

    Set&lt;Album&gt; albums;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have to define a read converter only:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">static final Converter&lt;List&lt;?&gt;, Set&lt;?&gt;&gt; LIST_SET_CONVERTER =
            new Converter&lt;List&lt;?&gt;, Set&lt;?&gt;&gt;() {
                @Override
                public Set&lt;?&gt; convert(List&lt;?&gt; source) {
                    return Collections.unmodifiableSet(new HashSet&lt;&gt;(source));
                }
            };</code></pre>
</div>
</div>
<div class="paragraph">
<p>And add it to the list of custom converters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class ConverterConfiguration {
    @Bean
    public DatastoreCustomConversions datastoreCustomConversions() {
        return new DatastoreCustomConversions(
                Arrays.asList(
                        LIST_SET_CONVERTER,
                        ALBUM_STRING_CONVERTER,
                        STRING_ALBUM_CONVERTER));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="inheritance-hierarchies"><a class="anchor" href="#inheritance-hierarchies"></a><a class="link" href="#inheritance-hierarchies">14.2.9. Inheritance Hierarchies</a></h4>
<div class="paragraph">
<p>Java entity types related by inheritance can be stored in the same Kind.
When reading and querying entities using <code>DatastoreRepository</code> or <code>DatastoreTemplate</code> with a superclass as the type parameter, you can receive instances of subclasses if you annotate the superclass and its subclasses with <code>DiscriminatorField</code> and <code>DiscriminatorValue</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity(name = "pets")
@DiscriminatorField(field = "pet_type")
abstract class Pet {
    @Id
    Long id;

    abstract String speak();
}

@DiscriminatorValue("cat")
class Cat extends Pet {
    @Override
    String speak() {
        return "meow";
    }
}

@DiscriminatorValue("dog")
class Dog extends Pet {
    @Override
    String speak() {
        return "woof";
    }
}

@DiscriminatorValue("pug")
class Pug extends Dog {
    @Override
    String speak() {
        return "woof woof";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instances of all 3 types are stored in the <code>pets</code> Kind.
Because a single Kind is used, all classes in the hierarchy must share the same ID property and no two instances of any type in the hierarchy can share the same ID value.</p>
</div>
<div class="paragraph">
<p>Entity rows in Cloud Datastore store their respective types' <code>DiscriminatorValue</code> in a field specified by the root superclass&#8217;s <code>DiscriminatorField</code> (<code>pet_type</code> in this case).
Reads and queries using a given type parameter will match each entity with its specific type.
For example, reading a <code>List&lt;Pet&gt;</code> will produce a list containing instances of all 3 types.
However, reading a <code>List&lt;Dog&gt;</code> will produce a list containing only <code>Dog</code> and <code>Pug</code> instances.
You can include the <code>pet_type</code> discrimination field in your Java entities, but its type must be convertible to a collection or array of <code>String</code>.
Any value set in the discrimination field will be overwritten upon write to Cloud Datastore.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="relationships-2"><a class="anchor" href="#relationships-2"></a><a class="link" href="#relationships-2">14.3. Relationships</a></h3>
<div class="paragraph">
<p>There are three ways to represent relationships between entities that are described in this section:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Embedded entities stored directly in the field of the containing entity</p>
</li>
<li>
<p><code>@Descendant</code> annotated properties for one-to-many relationships</p>
</li>
<li>
<p><code>@Reference</code> annotated properties for general relationships without hierarchy</p>
</li>
<li>
<p><code>@LazyReference</code> similar to <code>@Reference</code>, but the entities are lazy-loaded when the property is accessed.
(Note that the keys of the children are retrieved when the parent entity is loaded.)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="embedded-entities"><a class="anchor" href="#embedded-entities"></a><a class="link" href="#embedded-entities">14.3.1. Embedded Entities</a></h4>
<div class="paragraph">
<p>Fields whose types are also annotated with <code>@Entity</code> are converted to <code>EntityValue</code> and stored inside the parent entity.</p>
</div>
<div class="paragraph">
<p>Here is an example of Cloud Datastore entity containing an embedded entity in JSON:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "name" : "Alexander",
  "age" : 47,
  "child" : {"name" : "Philip"  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This corresponds to a simple pair of Java entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import com.google.cloud.spring.data.datastore.core.mapping.Entity;
import org.springframework.data.annotation.Id;

@Entity("parents")
public class Parent {
  @Id
  String name;

  Child child;
}

@Entity
public class Child {
  String name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Child</code> entities are not stored in their own kind.
They are stored in their entirety in the <code>child</code> field of the <code>parents</code> kind.</p>
</div>
<div class="paragraph">
<p>Multiple levels of embedded entities are supported.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Embedded entities don&#8217;t need to have <code>@Id</code> field, it is only required for top level entities.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="paragraph">
<p>Entities can hold embedded entities that are their own type.
We can store trees in Cloud Datastore using this feature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import com.google.cloud.spring.data.datastore.core.mapping.Embedded;
import com.google.cloud.spring.data.datastore.core.mapping.Entity;
import org.springframework.data.annotation.Id;

@Entity
public class EmbeddableTreeNode {
  @Id
  long value;

  EmbeddableTreeNode left;

  EmbeddableTreeNode right;

  Map&lt;String, Long&gt; longValues;

  Map&lt;String, List&lt;Timestamp&gt;&gt; listTimestamps;

  public EmbeddableTreeNode(long value, EmbeddableTreeNode left, EmbeddableTreeNode right) {
    this.value = value;
    this.left = left;
    this.right = right;
  }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="maps"><a class="anchor" href="#maps"></a><a class="link" href="#maps">Maps</a></h5>
<div class="paragraph">
<p>Maps will be stored as embedded entities where the key values become the field names in the embedded entity.
The value types in these maps can be any regularly supported property type, and the key values will be converted to String using the configured converters.</p>
</div>
<div class="paragraph">
<p>Also, a collection of entities can be embedded; it will be converted to <code>ListValue</code> on write.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="paragraph">
<p>Instead of a binary tree from the previous example, we would like to store a general tree
(each node can have an arbitrary number of children) in Cloud Datastore.
To do that, we need to create a field of type <code>List&lt;EmbeddableTreeNode&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import com.google.cloud.spring.data.datastore.core.mapping.Embedded;
import org.springframework.data.annotation.Id;

public class EmbeddableTreeNode {
  @Id
  long value;

  List&lt;EmbeddableTreeNode&gt; children;

  Map&lt;String, EmbeddableTreeNode&gt; siblingNodes;

  Map&lt;String, Set&lt;EmbeddableTreeNode&gt;&gt; subNodeGroups;

  public EmbeddableTreeNode(List&lt;EmbeddableTreeNode&gt; children) {
    this.children = children;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because Maps are stored as entities, they can further hold embedded entities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Singular embedded objects in the value can be stored in the values of embedded Maps.</p>
</li>
<li>
<p>Collections of embedded objects in the value can also be stored as the values of embedded Maps.</p>
</li>
<li>
<p>Maps in the value are further stored as embedded entities with the same rules applied recursively for their values.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ancestor-descendant-relationships"><a class="anchor" href="#ancestor-descendant-relationships"></a><a class="link" href="#ancestor-descendant-relationships">14.3.2. Ancestor-Descendant Relationships</a></h4>
<div class="paragraph">
<p>Parent-child relationships are supported via the <code>@Descendants</code> annotation.</p>
</div>
<div class="paragraph">
<p>Unlike embedded children, descendants are fully-formed entities residing in their own kinds.
The parent entity does not have an extra field to hold the descendant entities.
Instead, the relationship is captured in the descendants' keys, which refer to their parent entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import com.google.cloud.spring.data.datastore.core.mapping.Descendants;
import com.google.cloud.spring.data.datastore.core.mapping.Entity;
import org.springframework.data.annotation.Id;

@Entity("orders")
public class ShoppingOrder {
  @Id
  long id;

  @Descendants
  List&lt;Item&gt; items;
}

@Entity("purchased_item")
public class Item {
  @Id
  Key purchasedItemKey;

  String name;

  Timestamp timeAddedToOrder;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, an instance of a GQL key-literal representation for <code>Item</code> would also contain the parent <code>ShoppingOrder</code> ID value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Key(orders, '12345', purchased_item, 'eggs')</pre>
</div>
</div>
<div class="paragraph">
<p>The GQL key-literal representation for the parent <code>ShoppingOrder</code> would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Key(orders, '12345')</pre>
</div>
</div>
<div class="paragraph">
<p>The Cloud Datastore entities exist separately in their own kinds.</p>
</div>
<div class="paragraph">
<p>The <code>ShoppingOrder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "id" : 12345
}</pre>
</div>
</div>
<div class="paragraph">
<p>The two items inside that order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "purchasedItemKey" : Key(orders, '12345', purchased_item, 'eggs'),
  "name" : "eggs",
  "timeAddedToOrder" : "2014-09-27 12:30:00.45-8:00"
}

{
  "purchasedItemKey" : Key(orders, '12345', purchased_item, 'sausage'),
  "name" : "sausage",
  "timeAddedToOrder" : "2014-09-28 11:30:00.45-9:00"
}</pre>
</div>
</div>
<div class="paragraph">
<p>The parent-child relationship structure of objects is stored in Cloud Datastore using Datastore&#8217;s <a href="https://cloud.google.com/datastore/docs/concepts/entities#ancestor_paths">ancestor relationships</a>.
Because the relationships are defined by the Ancestor mechanism, there is no extra column needed in either the parent or child entity to store this relationship.
The relationship link is part of the descendant entity&#8217;s key value.
These relationships can be many levels deep.</p>
</div>
<div class="paragraph">
<p>Properties holding child entities must be collection-like, but they can be any of the supported inter-convertible collection-like types that are supported for regular properties such as <code>List</code>, arrays, <code>Set</code>, etc&#8230;&#8203;
Child items must have <code>Key</code> as their ID type because Cloud Datastore stores the ancestor relationship link inside the keys of the children.</p>
</div>
<div class="paragraph">
<p>Reading or saving an entity automatically causes all subsequent levels of children under that entity to be read or saved, respectively.
If a new child is created and added to a property annotated <code>@Descendants</code> and the key property is left null, then a new key will be allocated for that child.
The ordering of the retrieved children may not be the same as the ordering in the original property that was saved.</p>
</div>
<div class="paragraph">
<p>Child entities cannot be moved from the property of one parent to that of another unless the child&#8217;s key property is set to <code>null</code> or a value that contains the new parent as an ancestor.
Since Cloud Datastore entity keys can have multiple parents, it is possible that a child entity appears in the property of multiple parent entities.
Because entity keys are immutable in Cloud Datastore, to change the key of a child you must delete the existing one and re-save it with the new key.</p>
</div>
</div>
<div class="sect3">
<h4 id="key-reference-relationships"><a class="anchor" href="#key-reference-relationships"></a><a class="link" href="#key-reference-relationships">14.3.3. Key Reference Relationships</a></h4>
<div class="paragraph">
<p>General relationships can be stored using the <code>@Reference</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.data.annotation.Reference;
import org.springframework.data.annotation.Id;

@Entity
public class ShoppingOrder {
  @Id
  long id;

  @Reference
  List&lt;Item&gt; items;

  @Reference
  Item specialSingleItem;
}

@Entity
public class Item {
  @Id
  Key purchasedItemKey;

  String name;

  Timestamp timeAddedToOrder;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Reference</code> relationships are between fully-formed entities residing in their own kinds.
The relationship between <code>ShoppingOrder</code> and <code>Item</code> entities are stored as a Key field inside <code>ShoppingOrder</code>, which are resolved to the underlying Java entity type by Spring Data Cloud Datastore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "id" : 12345,
  "specialSingleItem" : Key(item, "milk"),
  "items" : [ Key(item, "eggs"), Key(item, "sausage") ]
}</pre>
</div>
</div>
<div class="paragraph">
<p>Reference properties can either be singular or collection-like.
These properties correspond to actual columns in the entity and Cloud Datastore Kind that hold the key values of the referenced entities.
The referenced entities are full-fledged entities of other Kinds.</p>
</div>
<div class="paragraph">
<p>Similar to the <code>@Descendants</code> relationships, reading or writing an entity will recursively read or write all of the referenced entities at all levels.
If referenced entities have <code>null</code> ID values, then they will be saved as new entities and will have ID values allocated by Cloud Datastore.
There are no requirements for relationships between the key of an entity and the keys that entity holds as references.
The order of collection-like reference properties is not preserved when reading back from Cloud Datastore.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="datastore-operations-template"><a class="anchor" href="#datastore-operations-template"></a><a class="link" href="#datastore-operations-template">14.4. Datastore Operations &amp; Template</a></h3>
<div class="paragraph">
<p><code>DatastoreOperations</code> and its implementation, <code>DatastoreTemplate</code>, provides the Template pattern familiar to Spring developers.</p>
</div>
<div class="paragraph">
<p>Using the auto-configuration provided by Spring Boot Starter for Datastore, your Spring application context will contain a fully configured <code>DatastoreTemplate</code> object that you can autowire in your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SpringBootApplication
public class DatastoreTemplateExample {

    @Autowired
    DatastoreTemplate datastoreTemplate;

    public void doSomething() {
        this.datastoreTemplate.deleteAll(Trader.class);
        //...
        Trader t = new Trader();
        //...
        this.datastoreTemplate.save(t);
        //...
        List&lt;Trader&gt; traders = datastoreTemplate.findAll(Trader.class);
        //...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Template API provides convenience methods for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Write operations (saving and deleting)</p>
</li>
<li>
<p>Read-write transactions</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="gql-query"><a class="anchor" href="#gql-query"></a><a class="link" href="#gql-query">14.4.1. GQL Query</a></h4>
<div class="paragraph">
<p>In addition to retrieving entities by their IDs, you can also submit queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">  &lt;T&gt; Iterable&lt;T&gt; query(Query&lt;? extends BaseEntity&gt; query, Class&lt;T&gt; entityClass);

  &lt;A, T&gt; Iterable&lt;T&gt; query(Query&lt;A&gt; query, Function&lt;A, T&gt; entityFunc);

  Iterable&lt;Key&gt; queryKeys(Query&lt;Key&gt; query);</code></pre>
</div>
</div>
<div class="paragraph">
<p>These methods, respectively, allow querying for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>entities mapped by a given entity class using all the same mapping and converting features</p>
</li>
<li>
<p>arbitrary types produced by a given mapping function</p>
</li>
<li>
<p>only the Cloud Datastore keys of the entities found by the query</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="find-by-ids"><a class="anchor" href="#find-by-ids"></a><a class="link" href="#find-by-ids">14.4.2. Find by ID(s)</a></h4>
<div class="paragraph">
<p>Using <code>DatastoreTemplate</code> you can find entities by id. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Trader trader = this.datastoreTemplate.findById("trader1", Trader.class);

List&lt;Trader&gt; traders = this.datastoreTemplate.findAllById(Arrays.asList("trader1", "trader2"), Trader.class);

List&lt;Trader&gt; allTraders = this.datastoreTemplate.findAll(Trader.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cloud Datastore uses key-based reads with strong consistency, but queries with eventual consistency.
In the example above the first two reads utilize keys, while the third is run by using a query based on the corresponding Kind of <code>Trader</code>.</p>
</div>
<div class="sect4">
<h5 id="indexes"><a class="anchor" href="#indexes"></a><a class="link" href="#indexes">Indexes</a></h5>
<div class="paragraph">
<p>By default, all fields are indexed.
To disable indexing on a particular field, <code>@Unindexed</code> annotation can be used.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import com.google.cloud.spring.data.datastore.core.mapping.Unindexed;

public class ExampleItem {
    long indexedField;

    @Unindexed
    long unindexedField;

    @Unindexed
    List&lt;String&gt; unindexedListField;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using queries directly or via Query Methods, Cloud Datastore requires <a href="https://cloud.google.com/datastore/docs/concepts/indexes">composite custom indexes</a> if the select statement is not <code>SELECT *</code> or if there is more than one filtering condition in the <code>WHERE</code> clause.</p>
</div>
</div>
<div class="sect4">
<h5 id="read-with-offsets-limits-and-sorting"><a class="anchor" href="#read-with-offsets-limits-and-sorting"></a><a class="link" href="#read-with-offsets-limits-and-sorting">Read with offsets, limits, and sorting</a></h5>
<div class="paragraph">
<p><code>DatastoreRepository</code> and custom-defined entity repositories implement the Spring Data <code>PagingAndSortingRepository</code>, which supports offsets and limits using page numbers and page sizes.
Paging and sorting options are also supported in <code>DatastoreTemplate</code> by supplying a <code>DatastoreQueryOptions</code> to <code>findAll</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="partial-read-2"><a class="anchor" href="#partial-read-2"></a><a class="link" href="#partial-read-2">Partial read</a></h5>
<div class="paragraph">
<p>This feature is not supported yet.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="write-update-2"><a class="anchor" href="#write-update-2"></a><a class="link" href="#write-update-2">14.4.3. Write / Update</a></h4>
<div class="paragraph">
<p>The write methods of <code>DatastoreOperations</code> accept a POJO and writes all of its properties to Datastore.
The required Datastore kind and entity metadata is obtained from the given object&#8217;s actual type.</p>
</div>
<div class="paragraph">
<p>If a POJO was retrieved from Datastore and its ID value was changed and then written or updated, the operation will occur as if against a row with the new ID value.
The entity with the original ID value will not be affected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Trader t = new Trader();
this.datastoreTemplate.save(t);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>save</code> method behaves as update-or-insert.</p>
</div>
<div class="sect4">
<h5 id="partial-update-2"><a class="anchor" href="#partial-update-2"></a><a class="link" href="#partial-update-2">Partial Update</a></h5>
<div class="paragraph">
<p>This feature is not supported yet.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transactions-2"><a class="anchor" href="#transactions-2"></a><a class="link" href="#transactions-2">14.4.4. Transactions</a></h4>
<div class="paragraph">
<p>Read and write transactions are provided by <code>DatastoreOperations</code> via the <code>performTransaction</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
DatastoreOperations myDatastoreOperations;

public String doWorkInsideTransaction() {
  return myDatastoreOperations.performTransaction(
    transactionDatastoreOperations -&gt; {
      // Work with transactionDatastoreOperations here.
      // It is also a DatastoreOperations object.

      return "transaction completed";
    }
  );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>performTransaction</code> method accepts a <code>Function</code> that is provided an instance of a <code>DatastoreOperations</code> object.
The final returned value and type of the function is determined by the user.
You can use this object just as you would a regular <code>DatastoreOperations</code> with an exception:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It cannot perform sub-transactions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Because of Cloud Datastore&#8217;s consistency guarantees, there are <a href="https://cloud.google.com/datastore/docs/concepts/transactions#what_can_be_done_in_a_transaction">limitations</a> to the operations and relationships among entities used inside transactions.</p>
</div>
<div class="sect4">
<h5 id="declarative-transactions-with-transactional-annotation-2"><a class="anchor" href="#declarative-transactions-with-transactional-annotation-2"></a><a class="link" href="#declarative-transactions-with-transactional-annotation-2">Declarative Transactions with @Transactional Annotation</a></h5>
<div class="paragraph">
<p>This feature requires a bean of <code>DatastoreTransactionManager</code>, which is provided when using <code>spring-cloud-gcp-starter-data-datastore</code>.</p>
</div>
<div class="paragraph">
<p><code>DatastoreTemplate</code> and <code>DatastoreRepository</code> support running methods with the <code>@Transactional</code> <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction-declarative">annotation</a> as transactions.
If a method annotated with <code>@Transactional</code> calls another method also annotated, then both methods will work within the same transaction.
<code>performTransaction</code> cannot be used in <code>@Transactional</code> annotated methods because Cloud Datastore does not support transactions within transactions.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="read-write-support-for-maps"><a class="anchor" href="#read-write-support-for-maps"></a><a class="link" href="#read-write-support-for-maps">14.4.5. Read-Write Support for Maps</a></h4>
<div class="paragraph">
<p>You can work with Maps of type <code>Map&lt;String, ?&gt;</code> instead of with entity objects by directly reading and writing them to and from Cloud Datastore.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a different situation than using entity objects that contain Map properties.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The map keys are used as field names for a Datastore entity and map values are converted to Datastore supported types.
Only simple types are supported (i.e. collections are not supported).
Converters for custom value types can be added (see <a href="#custom-types">Custom types</a> section).</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Map&lt;String, Long&gt; map = new HashMap&lt;&gt;();
map.put("field1", 1L);
map.put("field2", 2L);
map.put("field3", 3L);

keyForMap = datastoreTemplate.createKey("kindName", "id");

// write a map
datastoreTemplate.writeMap(keyForMap, map);

// read a map
Map&lt;String, Long&gt; loadedMap = datastoreTemplate.findByIdAsMap(keyForMap, Long.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories-2"><a class="anchor" href="#repositories-2"></a><a class="link" href="#repositories-2">14.5. Repositories</a></h3>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html/#repositories">Spring Data Repositories</a> are an abstraction that can reduce boilerplate code.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TraderRepository extends DatastoreRepository&lt;Trader, String&gt; {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Data generates a working implementation of the specified interface, which can be autowired into an application.</p>
</div>
<div class="paragraph">
<p>The <code>Trader</code> type parameter to <code>DatastoreRepository</code> refers to the underlying domain type.
The second type parameter, <code>String</code> in this case, refers to the type of the key of the domain type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MyApplication {

    @Autowired
    TraderRepository traderRepository;

    public void demo() {

        this.traderRepository.deleteAll();
        String traderId = "demo_trader";
        Trader t = new Trader();
        t.traderId = traderId;
        this.tradeRepository.save(t);

        Iterable&lt;Trader&gt; allTraders = this.traderRepository.findAll();

        int count = this.traderRepository.count();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repositories allow you to define custom Query Methods (detailed in the following sections) for retrieving, counting, and deleting based on filtering and paging parameters.
Filtering parameters can be of types supported by your configured custom converters.</p>
</div>
<div class="sect3">
<h4 id="query-methods-by-convention-2"><a class="anchor" href="#query-methods-by-convention-2"></a><a class="link" href="#query-methods-by-convention-2">14.5.1. Query methods by convention</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TradeRepository extends DatastoreRepository&lt;Trade, String[]&gt; {
  List&lt;Trader&gt; findByAction(String action);

  // throws an exception if no results
  Trader findOneByAction(String action);

  // because of the annotation, returns null if no results
  @Nullable
  Trader getByAction(String action);

  Optional&lt;Trader&gt; getOneByAction(String action);

  int countByAction(String action);

  boolean existsByAction(String action);

  List&lt;Trade&gt; findTop3ByActionAndSymbolAndPriceGreaterThanAndPriceLessThanOrEqualOrderBySymbolDesc(
            String action, String symbol, double priceFloor, double priceCeiling);

  Page&lt;TestEntity&gt; findByAction(String action, Pageable pageable);

  Slice&lt;TestEntity&gt; findBySymbol(String symbol, Pageable pageable);

  List&lt;TestEntity&gt; findBySymbol(String symbol, Sort sort);

  Stream&lt;TestEntity&gt; findBySymbol(String symbol);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above the <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html/#repositories.query-methods">query methods</a> in <code>TradeRepository</code> are generated based on the name of the methods using the <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html#repositories.query-methods.query-creation">Spring Data Query creation naming convention</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can refer to nested fields using <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-property-expressions">Spring Data JPA Property Expressions</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cloud Datastore only supports filter components joined by AND, and the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>equals</code></p>
</li>
<li>
<p><code>greater than or equals</code></p>
</li>
<li>
<p><code>greater than</code></p>
</li>
<li>
<p><code>less than or equals</code></p>
</li>
<li>
<p><code>less than</code></p>
</li>
<li>
<p><code>is null</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After writing a custom repository interface specifying just the signatures of these methods, implementations are generated for you and can be used with an auto-wired instance of the repository.
Because of Cloud Datastore&#8217;s requirement that explicitly selected fields must all appear in a composite index together, <code>find</code> name-based query methods are run as <code>SELECT *</code>.</p>
</div>
<div class="paragraph">
<p>Delete queries are also supported.
For example, query methods such as <code>deleteByAction</code> or <code>removeByAction</code> delete entities found by <code>findByAction</code>.
Delete queries are run as separate read and delete operations instead of as a single transaction because Cloud Datastore cannot query in transactions unless ancestors for queries are specified.
As a result, <code>removeBy</code> and <code>deleteBy</code> name-convention query methods cannot be used inside transactions via either <code>performInTransaction</code> or <code>@Transactional</code> annotation.</p>
</div>
<div class="paragraph">
<p>Delete queries can have the following return types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An integer type that is the number of entities deleted</p>
</li>
<li>
<p>A collection of entities that were deleted</p>
</li>
<li>
<p>'void'</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Methods can have <code>org.springframework.data.domain.Pageable</code> parameter to control pagination and sorting, or <code>org.springframework.data.domain.Sort</code> parameter to control sorting only.
See <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html/#repositories.query-methods">Spring Data documentation</a> for details.</p>
</div>
<div class="paragraph">
<p>For returning multiple items in a repository method, we support Java collections as well as <code>org.springframework.data.domain.Page</code> and <code>org.springframework.data.domain.Slice</code>.
If a method&#8217;s return type is <code>org.springframework.data.domain.Page</code>, the returned object will include current page, total number of results and total number of pages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Methods that return <code>Page</code> run an additional query to compute total number of pages.
Methods that return <code>Slice</code>, on the other hand, do not run any additional queries and, therefore, are much more efficient.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="empty-result-handling-in-repository-methods-2"><a class="anchor" href="#empty-result-handling-in-repository-methods-2"></a><a class="link" href="#empty-result-handling-in-repository-methods-2">14.5.2. Empty result handling in repository methods</a></h4>
<div class="paragraph">
<p>Java <code>java.util.Optional</code> can be used to indicate the potential absence of a return value.</p>
</div>
<div class="paragraph">
<p>Alternatively, query methods can return the result without a wrapper.
In that case the absence of a query result is indicated by returning <code>null</code>.
Repository methods returning collections are guaranteed never to return <code>null</code> but rather the corresponding empty collection.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can enable nullability checks. For more details please see <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#null-safety">Spring Framework’s nullability docs</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="query-by-example"><a class="anchor" href="#query-by-example"></a><a class="link" href="#query-by-example">14.5.3. Query by example</a></h4>
<div class="paragraph">
<p>Query by Example is an alternative querying technique.
It enables dynamic query generation based on a user-provided object. See <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#query-by-example">Spring Data Documentation</a> for details.</p>
</div>
<div class="sect4">
<h5 id="unsupported-features"><a class="anchor" href="#unsupported-features"></a><a class="link" href="#unsupported-features">Unsupported features:</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Currently, only equality queries are supported (no ignore-case matching, regexp matching, etc.).</p>
</li>
<li>
<p>Per-field matchers are not supported.</p>
</li>
<li>
<p>Embedded entities matching is not supported.</p>
</li>
<li>
<p>Projection is not supported.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example, if you want to find all users with the last name "Smith", you would use the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">userRepository.findAll(
    Example.of(new User(null, null, "Smith"))</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>null</code> fields are not used in the filter by default. If you want to include them, you would use the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">userRepository.findAll(
    Example.of(new User(null, null, "Smith"), ExampleMatcher.matching().withIncludeNullValues())</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also extend query specification initially defined by an example in FluentQuery&#8217;s chaining style:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>userRepository.findBy(
    Example.of(new User(null, null, "Smith")), q -&gt; q.sortBy(Sort.by("firstName")).firstValue());

userRepository.findBy(
    Example.of(new User(null, null, "Smith")), FetchableFluentQuery::stream);</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="custom-gql-query-methods"><a class="anchor" href="#custom-gql-query-methods"></a><a class="link" href="#custom-gql-query-methods">14.5.4. Custom GQL query methods</a></h4>
<div class="paragraph">
<p>Custom GQL queries can be mapped to repository methods in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>namedQueries</code> properties file</p>
</li>
<li>
<p>using the <code>@Query</code> annotation</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="query-methods-with-annotation-2"><a class="anchor" href="#query-methods-with-annotation-2"></a><a class="link" href="#query-methods-with-annotation-2">Query methods with annotation</a></h5>
<div class="paragraph">
<p>Using the <code>@Query</code> annotation:</p>
</div>
<div class="paragraph">
<p>The names of the tags of the GQL correspond to the <code>@Param</code> annotated names of the method parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TraderRepository extends DatastoreRepository&lt;Trader, String&gt; {

  @Query("SELECT * FROM traders WHERE name = @trader_name")
  List&lt;Trader&gt; tradersByName(@Param("trader_name") String traderName);

  @Query("SELECT * FROM traders WHERE name = @trader_name")
  Stream&lt;Trader&gt; tradersStreamByName(@Param("trader_name") String traderName);

  @Query("SELECT * FROM  test_entities_ci WHERE name = @trader_name")
  TestEntity getOneTestEntity(@Param("trader_name") String traderName);

  @Query("SELECT * FROM traders WHERE name = @trader_name")
  List&lt;Trader&gt; tradersByNameSort(@Param("trader_name") String traderName, Sort sort);

  @Query("SELECT * FROM traders WHERE name = @trader_name")
  Slice&lt;Trader&gt; tradersByNameSlice(@Param("trader_name") String traderName, Pageable pageable);

  @Query("SELECT * FROM traders WHERE name = @trader_name")
  Page&lt;Trader&gt; tradersByNamePage(@Param("trader_name") String traderName, Pageable pageable);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the return type is <code>Slice</code> or <code>Pageable</code>, the result set cursor that points to the position just after the page is preserved in the returned <code>Slice</code> or <code>Page</code> object. To take advantage of the cursor to query for the next page or slice, use <code>result.getPageable().next()</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Page</code> requires the total count of entities produced by the query. Therefore, the first query will have to retrieve all of the records just to count them. Instead, we recommend using the <code>Slice</code> return type, because it does not require an additional count query.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs"> Slice&lt;Trader&gt; slice1 = tradersByNamePage("Dave", PageRequest.of(0, 5));
 Slice&lt;Trader&gt; slice2 = tradersByNamePage("Dave", slice1.getPageable().next());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You cannot use these Query Methods in repositories where the type parameter is a subclass of another class
annotated with <code>DiscriminatorField</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following parameter types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.google.cloud.Timestamp</code></p>
</li>
<li>
<p><code>com.google.cloud.datastore.Blob</code></p>
</li>
<li>
<p><code>com.google.cloud.datastore.Key</code></p>
</li>
<li>
<p><code>com.google.cloud.datastore.Cursor</code></p>
</li>
<li>
<p><code>java.lang.Boolean</code></p>
</li>
<li>
<p><code>java.lang.Double</code></p>
</li>
<li>
<p><code>java.lang.Long</code></p>
</li>
<li>
<p><code>java.lang.String</code></p>
</li>
<li>
<p><code>enum</code> values.
These are queried as <code>String</code> values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With the exception of <code>Cursor</code>, array forms of each of the types are also supported.</p>
</div>
<div class="paragraph">
<p>If you would like to obtain the count of items of a query or if there are any items returned by the query, set the <code>count = true</code> or <code>exists = true</code> properties of the <code>@Query</code> annotation, respectively.
The return type of the query method in these cases should be an integer type or a boolean type.</p>
</div>
<div class="paragraph">
<p>Cloud Datastore provides provides the <code>SELECT __key__ FROM &#8230;&#8203;</code> special column for all kinds that retrieves the <code>Key</code> of each row.
Selecting this special <code>__key__</code> column is especially useful and efficient for <code>count</code> and <code>exists</code> queries.</p>
</div>
<div class="paragraph">
<p>You can also query for non-entity types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Query(value = "SELECT __key__ from test_entities_ci")
List&lt;Key&gt; getKeys();

@Query(value = "SELECT __key__ from test_entities_ci limit 1")
Key getKey();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use <code>@Id</code> annotated fields in custom queries, use <code>__key__</code> keyword for the field name. The parameter type should be of <code>Key</code>, as in the following example.</p>
</div>
<div class="paragraph">
<p>Repository method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Query("select * from  test_entities_ci where size = @size and __key__ = @id")
LinkedList&lt;TestEntity&gt; findEntities(@Param("size") long size, @Param("id") Key id);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generate a key from id value using <code>DatastoreTemplate.createKey</code> method and use it as a parameter for the repository method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">this.testEntityRepository.findEntities(1L, datastoreTemplate.createKey(TestEntity.class, 1L))</code></pre>
</div>
</div>
<div class="paragraph">
<p>SpEL can be used to provide GQL parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Query("SELECT * FROM |com.example.Trade| WHERE trades.action = @act
  AND price &gt; :#{#priceRadius * -1} AND price &lt; :#{#priceRadius * 2}")
List&lt;Trade&gt; fetchByActionNamedQuery(@Param("act") String action, @Param("priceRadius") Double r);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Kind names can be directly written in the GQL annotations.
Kind names can also be resolved from the <code>@Entity</code> annotation on domain classes.</p>
</div>
<div class="paragraph">
<p>In this case, the query should refer to table names with fully qualified class names surrounded by <code>|</code> characters: <code>|fully.qualified.ClassName|</code>.
This is useful when SpEL expressions appear in the kind name provided to the <code>@Entity</code> annotation.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Query("SELECT * FROM |com.example.Trade| WHERE trades.action = @act")
List&lt;Trade&gt; fetchByActionNamedQuery(@Param("act") String action);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query-methods-with-named-queries-properties-2"><a class="anchor" href="#query-methods-with-named-queries-properties-2"></a><a class="link" href="#query-methods-with-named-queries-properties-2">Query methods with named queries properties</a></h5>
<div class="paragraph">
<p>You can also specify queries with Cloud Datastore parameter tags and SpEL expressions in properties files.</p>
</div>
<div class="paragraph">
<p>By default, the <code>namedQueriesLocation</code> attribute on <code>@EnableDatastoreRepositories</code> points to the <code>META-INF/datastore-named-queries.properties</code> file.
You can specify the query for a method in the properties file by providing the GQL as the value for the "interface.method" property:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You cannot use these Query Methods in repositories where the type parameter is a subclass of another class
annotated with <code>DiscriminatorField</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">Trader.fetchByName=SELECT * FROM traders WHERE name = @tag0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TraderRepository extends DatastoreRepository&lt;Trader, String&gt; {

    // This method uses the query from the properties file instead of one generated based on name.
    List&lt;Trader&gt; fetchByName(@Param("tag0") String traderName);

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transactions-3"><a class="anchor" href="#transactions-3"></a><a class="link" href="#transactions-3">14.5.5. Transactions</a></h4>
<div class="paragraph">
<p>These transactions work very similarly to those of <code>DatastoreOperations</code>, but is specific to the repository&#8217;s domain type and provides repository functions instead of template functions.</p>
</div>
<div class="paragraph">
<p>For example, this is a read-write transaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
DatastoreRepository myRepo;

public String doWorkInsideTransaction() {
  return myRepo.performTransaction(
    transactionDatastoreRepo -&gt; {
      // Work with the single-transaction transactionDatastoreRepo here.
      // This is a DatastoreRepository object.

      return "transaction completed";
    }
  );
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="projections-2"><a class="anchor" href="#projections-2"></a><a class="link" href="#projections-2">14.5.6. Projections</a></h4>
<div class="paragraph">
<p>Spring Data Cloud Datastore supports <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html/#projections">projections</a>.
You can define projection interfaces based on domain types and add query methods that return them in your repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface TradeProjection {

    String getAction();

    @Value("#{target.symbol + ' ' + target.action}")
    String getSymbolAndAction();
}

public interface TradeRepository extends DatastoreRepository&lt;Trade, Key&gt; {

    List&lt;Trade&gt; findByTraderId(String traderId);

    List&lt;TradeProjection&gt; findByAction(String action);

    @Query("SELECT action, symbol FROM trades WHERE action = @action")
    List&lt;TradeProjection&gt; findByQuery(String action);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Projections can be provided by name-convention-based query methods as well as by custom GQL queries.
If using custom GQL queries, you can further restrict the fields retrieved from Cloud Datastore to just those required by the projection.
However, custom select statements (those not using <code>SELECT *</code>) require composite indexes containing the selected fields.</p>
</div>
<div class="paragraph">
<p>Properties of projection types defined using SpEL use the fixed name <code>target</code> for the underlying domain object.
As a result, accessing underlying properties take the form <code>target.&lt;property-name&gt;</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="rest-repositories-2"><a class="anchor" href="#rest-repositories-2"></a><a class="link" href="#rest-repositories-2">14.5.7. REST Repositories</a></h4>
<div class="paragraph">
<p>When running with Spring Boot, repositories can be exposed as REST services by simply adding this dependency to your pom file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-data-rest&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you prefer to configure parameters (such as path), you can use <code>@RepositoryRestResource</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@RepositoryRestResource(collectionResourceRel = "trades", path = "trades")
public interface TradeRepository extends DatastoreRepository&lt;Trade, String[]&gt; {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, you can retrieve all <code>Trade</code> objects in the repository by using <code>curl http://&lt;server&gt;:&lt;port&gt;/trades</code>, or any specific trade via <code>curl http://&lt;server&gt;:&lt;port&gt;/trades/&lt;trader_id&gt;</code>.</p>
</div>
<div class="paragraph">
<p>You can also write trades using <code>curl -XPOST -H"Content-Type: application/json" -<a href="mailto:d@test.json">d@test.json</a> http://&lt;server&gt;:&lt;port&gt;/trades/</code> where the file <code>test.json</code> holds the JSON representation of a <code>Trade</code> object.</p>
</div>
<div class="paragraph">
<p>To delete trades, you can use <code>curl -XDELETE http://&lt;server&gt;:&lt;port&gt;/trades/&lt;trader_id&gt;</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="events-2"><a class="anchor" href="#events-2"></a><a class="link" href="#events-2">14.6. Events</a></h3>
<div class="paragraph">
<p>Spring Data Cloud Datastore publishes events extending the Spring Framework&#8217;s <code>ApplicationEvent</code> to the context that can be received by <code>ApplicationListener</code> beans you register.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Contents</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AfterFindByKeyEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately after read by-key operations are run by <code>DatastoreTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entities read from Cloud Datastore and the original keys in the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AfterQueryEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately after read byquery operations are run by <code>DatastoreTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entities read from Cloud Datastore and the original query in the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BeforeSaveEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately before save operations are run by <code>DatastoreTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entities to be sent to Cloud Datastore and the original Java objects being saved.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AfterSaveEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately after save operations are run by <code>DatastoreTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entities sent to Cloud Datastore  and the original Java objects being saved.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BeforeDeleteEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately before delete operations are run by <code>DatastoreTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The keys to be sent to Cloud Datastore. The target entities, ID values, or entity type originally specified for the delete operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AfterDeleteEvent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Published immediately after delete operations are run by <code>DatastoreTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The keys sent to Cloud Datastore. The target entities, ID values, or entity type originally specified for the delete operation.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="auditing-2"><a class="anchor" href="#auditing-2"></a><a class="link" href="#auditing-2">14.7. Auditing</a></h3>
<div class="paragraph">
<p>Spring Data Cloud Datastore supports the <code>@LastModifiedDate</code> and <code>@LastModifiedBy</code> auditing annotations for properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class SimpleEntity {
    @Id
    String id;

    @LastModifiedBy
    String lastUser;

    @LastModifiedDate
    DateTime lastTouched;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Upon insert, update, or save, these properties will be set automatically by the framework before Datastore entities are generated and saved to Cloud Datastore.</p>
</div>
<div class="paragraph">
<p>To take advantage of these features, add the <code>@EnableDatastoreAuditing</code> annotation to your configuration class and provide a bean for an <code>AuditorAware&lt;A&gt;</code> implementation where the type <code>A</code> is the desired property type annotated by <code>@LastModifiedBy</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
@EnableDatastoreAuditing
public class Config {

    @Bean
    public AuditorAware&lt;String&gt; auditorProvider() {
        return () -&gt; Optional.of("YOUR_USERNAME_HERE");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AuditorAware</code> interface contains a single method that supplies the value for fields annotated by <code>@LastModifiedBy</code> and can be of any type.
One alternative is to use Spring Security&#8217;s <code>User</code> type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class SpringSecurityAuditorAware implements AuditorAware&lt;User&gt; {

  public Optional&lt;User&gt; getCurrentAuditor() {

    return Optional.ofNullable(SecurityContextHolder.getContext())
              .map(SecurityContext::getAuthentication)
              .filter(Authentication::isAuthenticated)
              .map(Authentication::getPrincipal)
              .map(User.class::cast);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also set a custom provider for properties annotated <code>@LastModifiedDate</code> by providing a bean for <code>DateTimeProvider</code> and providing the bean name to <code>@EnableDatastoreAuditing(dateTimeProviderRef = "customDateTimeProviderBean")</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="partitioning-data-by-namespace"><a class="anchor" href="#partitioning-data-by-namespace"></a><a class="link" href="#partitioning-data-by-namespace">14.8. Partitioning Data by Namespace</a></h3>
<div class="paragraph">
<p>You can <a href="https://cloud.google.com/datastore/docs/concepts/multitenancy">partition your data by using more than one namespace</a>.
This is the recommended method for multi-tenancy in Cloud Datastore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    @Bean
    public DatastoreNamespaceProvider namespaceProvider() {
        // return custom Supplier of a namespace string.
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>DatastoreNamespaceProvider</code> is a synonym for <code>Supplier&lt;String&gt;</code>.
By providing a custom implementation of this bean (for example, supplying a thread-local namespace name), you can direct your application to use multiple namespaces.
Every read, write, query, and transaction you perform will utilize the namespace provided by this supplier.</p>
</div>
<div class="paragraph">
<p>Note that your provided namespace in <code>application.properties</code> will be ignored if you define a namespace provider bean.</p>
</div>
</div>
<div class="sect2">
<h3 id="spring-boot-actuator-support-3"><a class="anchor" href="#spring-boot-actuator-support-3"></a><a class="link" href="#spring-boot-actuator-support-3">14.9. Spring Boot Actuator Support</a></h3>
<div class="sect3">
<h4 id="cloud-datastore-health-indicator"><a class="anchor" href="#cloud-datastore-health-indicator"></a><a class="link" href="#cloud-datastore-health-indicator">14.9.1. Cloud Datastore Health Indicator</a></h4>
<div class="paragraph">
<p>If you are using Spring Boot Actuator, you can take advantage of the Cloud Datastore health indicator called <code>datastore</code>.
The health indicator will verify whether Cloud Datastore is up and accessible by your application.
To enable it, all you need to do is add the <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready">Spring Boot Actuator</a> to your project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-9"><a class="anchor" href="#sample-9"></a><a class="link" href="#sample-9">14.10. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-datastore-basic-sample">Simple Spring Boot Application</a> and more advanced <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-datastore-sample">Sample Spring Boot Application</a> are provided to show how to use the Spring Data Cloud Datastore starter and template.</p>
</div>
</div>
<div class="sect2">
<h3 id="test-3"><a class="anchor" href="#test-3"></a><a class="link" href="#test-3">14.11. Test</a></h3>
<div class="paragraph">
<p><code>Testcontainers</code> provides a <code>gcloud</code> module which offers <code>DatastoreEmulatorContainer</code>. See more at the <a href="https://www.testcontainers.org/modules/gcloud/#datastore">docs</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data-cloud-firestore"><a class="anchor" href="#spring-data-cloud-firestore"></a><a class="link" href="#spring-data-cloud-firestore">15. Spring Data Cloud Firestore</a></h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently some features are not supported: query by example, projections, and auditing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://projects.spring.io/spring-data/">Spring Data</a> is an abstraction for storing and retrieving POJOs in numerous storage technologies.
Spring Framework on Google Cloud adds Spring Data Reactive Repositories support for <a href="https://cloud.google.com/firestore/">Google Cloud Firestore</a> in native mode, providing reactive template and repositories support.
To begin using this library, add the <code>spring-cloud-gcp-data-firestore</code> artifact to your project.</p>
</div>
<div class="paragraph">
<p>Maven coordinates for this module only, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-data-firestore&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-data-firestore")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We provide a Spring Boot Starter for Spring Data Firestore, with which you can use our recommended auto-configuration setup. To use the starter, see the coordinates below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-starter-data-firestore&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-starter-data-firestore")
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="configuration-7"><a class="anchor" href="#configuration-7"></a><a class="link" href="#configuration-7">15.1. Configuration</a></h3>
<div class="sect3">
<h4 id="properties"><a class="anchor" href="#properties"></a><a class="link" href="#properties">15.1.1. Properties</a></h4>
<div class="paragraph">
<p>The Spring Boot starter for Google Cloud Firestore provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Firestore auto-configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Cloud project ID where the Google Cloud Firestore API is hosted, if different from the one in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.emulator.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the usage of an emulator. If this is set to true, then you should set the <code>spring.cloud.gcp.firestore.host-port</code> to the host:port of your locally running emulator instance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.host-port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The host and port of the Firestore service; can be overridden to specify connecting to an already-running <a href="https://firebase.google.com/docs/emulator-suite/install_and_configure">Firestore emulator</a> instance.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>firestore.googleapis.com:443</code> (the host/port of official Firestore service)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2 credentials for authenticating with the Google Cloud Firestore API, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64-encoded OAuth2 credentials for authenticating with the Google Cloud Firestore API, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.credentials.scopes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://developers.google.com/identity/protocols/googlescopes">OAuth2 scope</a> for Spring Framework on Google CloudFirestore credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/datastore" class="bare">www.googleapis.com/auth/datastore</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="supported-types-3"><a class="anchor" href="#supported-types-3"></a><a class="link" href="#supported-types-3">15.1.2. Supported types</a></h4>
<div class="paragraph">
<p>You may use the following field types when defining your persistent entities or when binding query parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Long</code></p>
</li>
<li>
<p><code>Integer</code></p>
</li>
<li>
<p><code>Double</code></p>
</li>
<li>
<p><code>Float</code></p>
</li>
<li>
<p><code>String</code></p>
</li>
<li>
<p><code>Boolean</code></p>
</li>
<li>
<p><code>Character</code></p>
</li>
<li>
<p><code>Date</code></p>
</li>
<li>
<p><code>Map</code></p>
</li>
<li>
<p><code>List</code></p>
</li>
<li>
<p><code>Enum</code></p>
</li>
<li>
<p><code>com.google.cloud.Timestamp</code></p>
</li>
<li>
<p><code>com.google.cloud.firestore.GeoPoint</code></p>
</li>
<li>
<p><code>com.google.cloud.firestore.Blob</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="reactive-repository-settings"><a class="anchor" href="#reactive-repository-settings"></a><a class="link" href="#reactive-repository-settings">15.1.3. Reactive Repository settings</a></h4>
<div class="paragraph">
<p>Spring Data Repositories can be configured via the <code>@EnableReactiveFirestoreRepositories</code> annotation on your main <code>@Configuration</code> class.
With our Spring Boot Starter for Spring Data Cloud Firestore, <code>@EnableReactiveFirestoreRepositories</code> is automatically added.
It is not required to add it to any other class, unless there is a need to override finer grain configuration parameters provided by <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/blob/main/spring-cloud-gcp-data-firestore/src/main/java/com/google/cloud/spring/data/firestore/repository/config/EnableReactiveFirestoreRepositories.java"><code>@EnableReactiveFirestoreRepositories</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="autoconfiguration-3"><a class="anchor" href="#autoconfiguration-3"></a><a class="link" href="#autoconfiguration-3">15.1.4. Autoconfiguration</a></h4>
<div class="paragraph">
<p>Our Spring Boot autoconfiguration creates the following beans available in the Spring application context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an instance of <code>FirestoreTemplate</code></p>
</li>
<li>
<p>instances of all user defined repositories extending <code>FirestoreReactiveRepository</code> (an extension of <code>ReactiveCrudRepository</code> with additional Cloud Firestore features) when repositories are enabled</p>
</li>
<li>
<p>an instance of <a href="https://developers.google.com/resources/api-libraries/documentation/firestore/v1/java/latest/"><code>Firestore</code></a> from the Google Cloud Java Client for Firestore, for convenience and lower level API access</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="object-mapping-3"><a class="anchor" href="#object-mapping-3"></a><a class="link" href="#object-mapping-3">15.2. Object Mapping</a></h3>
<div class="paragraph">
<p>Spring Data Cloud Firestore allows you to map domain POJOs to <a href="https://firebase.google.com/docs/firestore/data-model#collections">Cloud Firestore collections</a> and documents via annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import com.google.cloud.firestore.annotation.DocumentId;
import com.google.cloud.spring.data.firestore.Document;

@Document(collectionName = "usersCollection")
public class User {
  /** Used to test @PropertyName annotation on a field. */
  @PropertyName("drink")
  public String favoriteDrink;

  @DocumentId private String name;

  private Integer age;

  public User() {}

  public String getName() {
    return this.name;
  }

  public void setName(String name) {
    this.name = name;
  }

  public Integer getAge() {
    return this.age;
  }

  public void setAge(Integer age) {
    this.age = age;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Document(collectionName = "usersCollection")</code> annotation configures the collection name for the documents of this type.
This annotation is optional, by default the collection name is derived from the class name.</p>
</div>
<div class="paragraph">
<p><code>@DocumentId</code> annotation marks a field to be used as document id.
This annotation is required and the annotated field can only be of <code>String</code> type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the property annotated with <code>@DocumentId</code> is <code>null</code> the document id is generated automatically when the entity is saved.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Internally we use Firestore client library object mapping. See <a href="https://developers.google.com/android/reference/com/google/firebase/firestore/package-summary">the documentation</a> for supported annotations.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="embedded-entities-and-lists"><a class="anchor" href="#embedded-entities-and-lists"></a><a class="link" href="#embedded-entities-and-lists">15.2.1. Embedded entities and lists</a></h4>
<div class="paragraph">
<p>Spring Data Cloud Firestore supports embedded properties of custom types and lists.
Given a custom POJO definition, you can have properties of this type or lists of this type in your entities.
They are stored as embedded documents (or arrays, correspondingly) in the Cloud Firestore.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document(collectionName = "usersCollection")
public class User {
  /** Used to test @PropertyName annotation on a field. */
  @PropertyName("drink")
  public String favoriteDrink;

  @DocumentId private String name;

  private Integer age;

  private List&lt;String&gt; pets;

  private List&lt;Address&gt; addresses;

  private Address homeAddress;

  public List&lt;String&gt; getPets() {
    return this.pets;
  }

  public void setPets(List&lt;String&gt; pets) {
    this.pets = pets;
  }

  public List&lt;Address&gt; getAddresses() {
    return this.addresses;
  }

  public void setAddresses(List&lt;Address&gt; addresses) {
    this.addresses = addresses;
  }

  public Timestamp getUpdateTime() {
    return updateTime;
  }

  public void setUpdateTime(Timestamp updateTime) {
    this.updateTime = updateTime;
  }

  @PropertyName("address")
  public Address getHomeAddress() {
    return this.homeAddress;
  }

  @PropertyName("address")
  public void setHomeAddress(Address homeAddress) {
    this.homeAddress = homeAddress;
  }
  public static class Address {
    String streetAddress;
    String country;

    public Address() {}
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="reactive-repositories"><a class="anchor" href="#reactive-repositories"></a><a class="link" href="#reactive-repositories">15.3. Reactive Repositories</a></h3>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/repository/reactive/ReactiveCrudRepository.html">Spring Data Repositories</a> is an abstraction that can reduce boilerplate code.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface UserRepository extends FirestoreReactiveRepository&lt;User&gt; {
  Flux&lt;User&gt; findBy(Pageable pageable);

  Flux&lt;User&gt; findByAge(Integer age);

  Flux&lt;User&gt; findByAge(Integer age, Sort sort);

  Flux&lt;User&gt; findByAgeOrderByNameDesc(Integer age);

  Flux&lt;User&gt; findAllByOrderByAge();

  Flux&lt;User&gt; findByAgeNot(Integer age);

  Flux&lt;User&gt; findByNameAndAge(String name, Integer age);

  Flux&lt;User&gt; findByHomeAddressCountry(String country);

  Flux&lt;User&gt; findByFavoriteDrink(String drink);

  Flux&lt;User&gt; findByAgeGreaterThanAndAgeLessThan(Integer age1, Integer age2);

  Flux&lt;User&gt; findByAgeGreaterThan(Integer age);

  Flux&lt;User&gt; findByAgeGreaterThan(Integer age, Sort sort);

  Flux&lt;User&gt; findByAgeGreaterThan(Integer age, Pageable pageable);

  Flux&lt;User&gt; findByAgeIn(List&lt;Integer&gt; ages);

  Flux&lt;User&gt; findByAgeNotIn(List&lt;Integer&gt; ages);

  Flux&lt;User&gt; findByAgeAndPetsContains(Integer age, List&lt;String&gt; pets);

  Flux&lt;User&gt; findByNameAndPetsContains(String name, List&lt;String&gt; pets);

  Flux&lt;User&gt; findByPetsContains(List&lt;String&gt; pets);

  Flux&lt;User&gt; findByPetsContainsAndAgeIn(String pets, List&lt;Integer&gt; ages);

  Mono&lt;Long&gt; countByAgeIsGreaterThan(Integer age);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Data generates a working implementation of the specified interface, which can be autowired into an application.</p>
</div>
<div class="paragraph">
<p>The <code>User</code> type parameter to <code>FirestoreReactiveRepository</code> refers to the underlying domain type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can refer to nested fields using <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-property-expressions">Spring Data JPA Property Expressions</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MyApplication {

  @Autowired UserRepository userRepository;

  void writeReadDeleteTest() {
    List&lt;User.Address&gt; addresses =
        Arrays.asList(
            new User.Address("123 Alice st", "US"), new User.Address("1 Alice ave", "US"));
    User.Address homeAddress = new User.Address("10 Alice blvd", "UK");
    User alice = new User("Alice", 29, null, addresses, homeAddress);
    User bob = new User("Bob", 60);

    this.userRepository.save(alice).block();
    this.userRepository.save(bob).block();

    assertThat(this.userRepository.count().block()).isEqualTo(2);
    assertThat(this.userRepository.findAll().map(User::getName).collectList().block())
        .containsExactlyInAnyOrder("Alice", "Bob");

    User aliceLoaded = this.userRepository.findById("Alice").block();
    assertThat(aliceLoaded.getAddresses()).isEqualTo(addresses);
    assertThat(aliceLoaded.getHomeAddress()).isEqualTo(homeAddress);

    // cast to SimpleFirestoreReactiveRepository for method be reachable with Spring Boot 2.4
    SimpleFirestoreReactiveRepository repository =
        AopTestUtils.getTargetObject(this.userRepository);
    StepVerifier.create(
            repository
                .deleteAllById(Arrays.asList("Alice", "Bob"))
                .then(this.userRepository.count()))
        .expectNext(0L)
        .verifyComplete();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repositories allow you to define custom Query Methods (detailed in the following sections) for retrieving and counting based on filtering and paging parameters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Custom queries with <code>@Query</code> annotation are not supported since there is no query language in Cloud Firestore
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="firestore-operations-template"><a class="anchor" href="#firestore-operations-template"></a><a class="link" href="#firestore-operations-template">15.4. Firestore Operations &amp; Template</a></h3>
<div class="paragraph">
<p><code>FirestoreOperations</code> and its implementation, <code>FirestoreTemplate</code>, provides the Template pattern familiar to Spring developers.</p>
</div>
<div class="paragraph">
<p>Using the auto-configuration provided by Spring Data Cloud Firestore, your Spring application context will contain a fully configured <code>FirestoreTemplate</code> object that you can autowire in your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SpringBootApplication
public class FirestoreTemplateExample {

    @Autowired
    FirestoreOperations firestoreOperations;

    public Mono&lt;User&gt; createUsers() {
        return this.firestoreOperations.save(new User("Alice", 29))
            .then(this.firestoreOperations.save(new User("Bob", 60)));
    }

    public Flux&lt;User&gt; findUsers() {
        return this.firestoreOperations.findAll(User.class);
    }

    public Mono&lt;Long&gt; removeAllUsers() {
        return this.firestoreOperations.deleteAll(User.class);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Template API provides support for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read and write operations</p>
</li>
<li>
<p><a href="#transactions">Transactions</a></p>
</li>
<li>
<p><a href="#subcollections">Subcollections</a> operations</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="query-methods-by-convention-3"><a class="anchor" href="#query-methods-by-convention-3"></a><a class="link" href="#query-methods-by-convention-3">15.5. Query methods by convention</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MyApplication {
  void partTreeRepositoryMethodTest() {
    User u1 = new User("Cloud", 22, null, null, new Address("1 First st., NYC", "USA"));
    u1.favoriteDrink = "tea";
    User u2 =
        new User(
            "Squall",
            17,
            Arrays.asList("cat", "dog"),
            null,
            new Address("2 Second st., London", "UK"));
    u2.favoriteDrink = "wine";
    Flux&lt;User&gt; users = Flux.fromArray(new User[] {u1, u2});

    this.userRepository.saveAll(users).blockLast();

    assertThat(this.userRepository.count().block()).isEqualTo(2);
    assertThat(this.userRepository.findBy(PageRequest.of(0, 10)).collectList().block())
        .containsExactly(u1, u2);
    assertThat(this.userRepository.findByAge(22).collectList().block()).containsExactly(u1);
    assertThat(this.userRepository.findByAgeNot(22).collectList().block()).containsExactly(u2);
    assertThat(this.userRepository.findByHomeAddressCountry("USA").collectList().block())
        .containsExactly(u1);
    assertThat(this.userRepository.findByFavoriteDrink("wine").collectList().block())
        .containsExactly(u2);
    assertThat(this.userRepository.findByAgeGreaterThanAndAgeLessThan(20, 30).collectList().block())
        .containsExactly(u1);
    assertThat(this.userRepository.findByAgeGreaterThan(10).collectList().block())
        .containsExactlyInAnyOrder(u1, u2);
    assertThat(this.userRepository.findByNameAndAge("Cloud", 22).collectList().block())
        .containsExactly(u1);
    assertThat(
            this.userRepository
                .findByNameAndPetsContains("Squall", Collections.singletonList("cat"))
                .collectList()
                .block())
        .containsExactly(u2);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above the query method implementations in <code>UserRepository</code> are generated based on the name of the methods using the <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html#repositories.query-methods.query-creation">Spring Data Query creation naming convention</a>.</p>
</div>
<div class="paragraph">
<p>Cloud Firestore only supports filter components joined by AND, and the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>equals</code></p>
</li>
<li>
<p><code>is not equal</code></p>
</li>
<li>
<p><code>greater than or equals</code></p>
</li>
<li>
<p><code>greater than</code></p>
</li>
<li>
<p><code>less than or equals</code></p>
</li>
<li>
<p><code>less than</code></p>
</li>
<li>
<p><code>is null</code></p>
</li>
<li>
<p><code>contains</code> (accepts a <code>List</code> with up to 10 elements, or a singular value)</p>
</li>
<li>
<p><code>in</code> (accepts a <code>List</code> with up to 10 elements)</p>
</li>
<li>
<p><code>not in</code> (accepts a <code>List</code> with up to 10 elements)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If <code>in</code> operation is used in combination with <code>contains</code> operation, the argument to <code>contains</code> operation has to be a singular value.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After writing a custom repository interface specifying just the signatures of these methods, implementations are generated for you and can be used with an auto-wired instance of the repository.</p>
</div>
</div>
<div class="sect2">
<h3 id="transactions-4"><a class="anchor" href="#transactions-4"></a><a class="link" href="#transactions-4">15.6. Transactions</a></h3>
<div class="paragraph">
<p>Read-only and read-write transactions are provided by <code>TransactionalOperator</code> (see this <a href="https://spring.io/blog/2019/05/16/reactive-transactions-with-spring">blog post</a> on reactive transactions for details).
In order to use it, you would need to autowire <code>ReactiveFirestoreTransactionManager</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MyApplication {
  @Autowired ReactiveFirestoreTransactionManager txManager;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that you will be able to use it to create an instance of <code>TransactionalOperator</code>.
Note that you can switch between read-only and read-write transactions using <code>TransactionDefinition</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">DefaultTransactionDefinition transactionDefinition = new DefaultTransactionDefinition();
transactionDefinition.setReadOnly(false);
TransactionalOperator operator =
    TransactionalOperator.create(this.txManager, transactionDefinition);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you have an instance of  <code>TransactionalOperator</code>, you can invoke a sequence of Firestore operations in a transaction by using <code>operator::transactional</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">User alice = new User("Alice", 29);
User bob = new User("Bob", 60);

this.userRepository
    .save(alice)
    .then(this.userRepository.save(bob))
    .as(operator::transactional)
    .block();

this.userRepository
    .findAll()
    .flatMap(
        a -&gt; {
          a.setAge(a.getAge() - 1);
          return this.userRepository.save(a);
        })
    .as(operator::transactional)
    .collectList()
    .block();

assertThat(this.userRepository.findAll().map(User::getAge).collectList().block())
    .containsExactlyInAnyOrder(28, 59);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Read operations in a transaction can only happen before write operations.
All write operations are applied atomically.
Read documents are locked until the transaction finishes with a commit or a rollback, which are handled by Spring Data.
If an <code>Exception</code> is thrown within a transaction, the rollback operation is performed.
Otherwise, the commit operation is performed.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="declarative-transactions-with-transactional-annotation-3"><a class="anchor" href="#declarative-transactions-with-transactional-annotation-3"></a><a class="link" href="#declarative-transactions-with-transactional-annotation-3">15.6.1. Declarative Transactions with @Transactional Annotation</a></h4>
<div class="paragraph">
<p>This feature requires a bean of <code>SpannerTransactionManager</code>, which is provided when using <code>spring-cloud-gcp-starter-data-firestore</code>.</p>
</div>
<div class="paragraph">
<p><code>FirestoreTemplate</code> and <code>FirestoreReactiveRepository</code> support running methods with the <code>@Transactional</code> <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction-declarative">annotation</a> as transactions.
If a method annotated with <code>@Transactional</code> calls another method also annotated, then both methods will work within the same transaction.</p>
</div>
<div class="paragraph">
<p>One way to use this feature is illustrated here. You would need to do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Annotate your configuration class with the <code>@EnableTransactionManagement</code> annotation.</p>
</li>
<li>
<p>Create a service class that has methods annotated with <code>@Transactional</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class UserService {
  @Autowired private UserRepository userRepository;

  @Transactional
  public Mono&lt;Void&gt; updateUsers() {
    return this.userRepository
        .findAll()
        .flatMap(
            a -&gt; {
              a.setAge(a.getAge() - 1);
              return this.userRepository.save(a);
            })
        .then();
  }
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Make a Spring Bean provider that creates an instance of that class:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public UserService userService() {
  return new UserService();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that, you can autowire your service like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MyApplication {
  @Autowired UserService userService;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when you call the methods annotated with <code>@Transactional</code> on your service object, a transaction will be automatically started.
If an error occurs during the execution of a method annotated with <code>@Transactional</code>, the transaction will be rolled back.
If no error occurs, the transaction will be committed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="subcollections"><a class="anchor" href="#subcollections"></a><a class="link" href="#subcollections">15.7. Subcollections</a></h3>
<div class="paragraph">
<p>A subcollection is a collection associated with a specific entity.
Documents in subcollections can contain subcollections as well, allowing you to further nest data. You can nest data up to 100 levels deep.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Deleting a document does not delete its subcollections!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use subcollections you will need to create a <code>FirestoreReactiveOperations</code> object with a parent entity using <code>FirestoreReactiveOperations.withParent</code> call.
You can use this object to save, query and remove entities associated with this parent.
The parent doesn&#8217;t have to exist in Firestore, but should have a non-empty id field.</p>
</div>
<div class="paragraph">
<p>Autowire <code>FirestoreReactiveOperations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
FirestoreReactiveOperations firestoreTemplate;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use this object to create a <code>FirestoreReactiveOperations</code> object with a custom parent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">FirestoreReactiveOperations bobTemplate =
    this.firestoreTemplate.withParent(new User("Bob", 60));

PhoneNumber phoneNumber = new PhoneNumber("111-222-333");
bobTemplate.save(phoneNumber).block();
assertThat(bobTemplate.findAll(PhoneNumber.class).collectList().block())
    .containsExactly(phoneNumber);
bobTemplate.deleteAll(PhoneNumber.class).block();
assertThat(bobTemplate.findAll(PhoneNumber.class).collectList().block()).isEmpty();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="update-time-and-optimistic-locking"><a class="anchor" href="#update-time-and-optimistic-locking"></a><a class="link" href="#update-time-and-optimistic-locking">15.8. Update Time and Optimistic Locking</a></h3>
<div class="paragraph">
<p>Firestore stores update time for every document.
If you would like to retrieve it, you can add a field of <code>com.google.cloud.Timestamp</code> type to your entity and annotate it with <code>@UpdateTime</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@UpdateTime
Timestamp updateTime;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="using-update-time-for-optimistic-locking"><a class="anchor" href="#using-update-time-for-optimistic-locking"></a><a class="link" href="#using-update-time-for-optimistic-locking">Using update time for optimistic locking</a></h5>
<div class="paragraph">
<p>A field annotated with <code>@UpdateTime</code> can be used for optimistic locking.
To enable that, you need to set <code>version</code> parameter to <code>true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@UpdateTime(version = true)
Timestamp updateTime;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you enable optimistic locking, a precondition will be automatically added to the write request to ensure that the document you are updating was not changed since your last read.
It uses this field&#8217;s value as a document version and checks that the version of the document you write is the same as the one you&#8217;ve read.</p>
</div>
<div class="paragraph">
<p>If the field is empty, a precondition would check that the document with the same id does not exist to ensure you don&#8217;t overwrite existing documents unintentionally.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloud-firestore-spring-boot-starter"><a class="anchor" href="#cloud-firestore-spring-boot-starter"></a><a class="link" href="#cloud-firestore-spring-boot-starter">15.9. Cloud Firestore Spring Boot Starter</a></h3>
<div class="paragraph">
<p>If you prefer using Firestore client only, Spring Framework on Google Cloud provides a convenience starter which automatically configures authentication settings and client objects needed to begin using <a href="https://cloud.google.com/firestore/">Google Cloud Firestore</a> in native mode.</p>
</div>
<div class="paragraph">
<p>See <a href="https://cloud.google.com/firestore/docs/">documentation</a> to learn more about Cloud Firestore.</p>
</div>
<div class="paragraph">
<p>To begin using this library, add the <code>spring-cloud-gcp-starter-firestore</code> artifact to your project.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-firestore&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-starter-firestore")
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="using-cloud-firestore"><a class="anchor" href="#using-cloud-firestore"></a><a class="link" href="#using-cloud-firestore">15.9.1. Using Cloud Firestore</a></h4>
<div class="paragraph">
<p>The starter automatically configures and registers a <code>Firestore</code> bean in the Spring application context. To start using it, simply use the <code>@Autowired</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
Firestore firestore;

 void writeDocumentFromObject() throws ExecutionException, InterruptedException {
   // Add document data with id "joe" using a custom User class
   User data =
       new User(
           "Joe",
           Arrays.asList(new Phone(12345, PhoneType.CELL), new Phone(54321, PhoneType.WORK)));

   // .get() blocks on response
   WriteResult writeResult = this.firestore.document("users/joe").set(data).get();

   LOGGER.info("Update time: " + writeResult.getUpdateTime());
 }

 User readDocumentToObject() throws ExecutionException, InterruptedException {
   ApiFuture&lt;DocumentSnapshot&gt; documentFuture = this.firestore.document("users/joe").get();

   User user = documentFuture.get().toObject(User.class);

   LOGGER.info("read: " + user);

   return user;
 }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="emulator-usage"><a class="anchor" href="#emulator-usage"></a><a class="link" href="#emulator-usage">15.10. Emulator Usage</a></h3>
<div class="paragraph">
<p>The Google Cloud Firebase SDK provides a local, in-memory emulator for Cloud Firestore, which you can use to develop and test your application.</p>
</div>
<div class="paragraph">
<p>First follow <a href="https://firebase.google.com/docs/emulator-suite/install_and_configure">the Firebase emulator installation steps</a> to install, configure, and run the emulator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the emulator is configured to run on port 8080; you will need to ensure that the emulator does not run on the same port as your Spring application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the Firestore emulator is running, ensure that the following properties are set in your <code>application.properties</code> of your Spring application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.cloud.gcp.firestore.emulator.enabled=true
spring.cloud.gcp.firestore.host-port=${EMULATOR_HOSTPORT}</pre>
</div>
</div>
<div class="paragraph">
<p>From this point onward, your application will connect to your locally running emulator instance instead of the real Firestore service.</p>
</div>
</div>
<div class="sect2">
<h3 id="samples-3"><a class="anchor" href="#samples-3"></a><a class="link" href="#samples-3">15.11. Samples</a></h3>
<div class="paragraph">
<p>Spring Framework on Google Cloud provides Firestore sample applications to demonstrate API usage:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-firestore-sample">Reactive Firestore Repository sample application</a>:</p>
</li>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-firestore-sample">Firestore Client Library sample application</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="test-4"><a class="anchor" href="#test-4"></a><a class="link" href="#test-4">15.12. Test</a></h3>
<div class="paragraph">
<p><code>Testcontainers</code> provides a <code>gcloud</code> module which offers <code>FirestoreEmulatorContainer</code>. See more at the <a href="https://www.testcontainers.org/modules/gcloud/#firestore">docs</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-memorystore-for-redis"><a class="anchor" href="#cloud-memorystore-for-redis"></a><a class="link" href="#cloud-memorystore-for-redis">16. Cloud Memorystore for Redis</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-caching"><a class="anchor" href="#spring-caching"></a><a class="link" href="#spring-caching">16.1. Spring Caching</a></h3>
<div class="paragraph">
<p><a href="https://cloud.google.com/memorystore/">Cloud Memorystore for Redis</a> provides a fully managed in-memory data store service.
Cloud Memorystore is compatible with the Redis protocol, allowing easy integration with <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-caching.html">Spring Caching</a>.</p>
</div>
<div class="paragraph">
<p>All you have to do is create a Cloud Memorystore instance and use its IP address in <code>application.properties</code> file as <code>spring.redis.host</code> property value.
Everything else is exactly the same as setting up redis-backed Spring caching.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Memorystore instances and your application instances have to be located in the same region.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In short, the following dependencies are needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then you can use <code>org.springframework.cache.annotation.Cacheable</code> annotation for methods you&#8217;d like to be cached.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Cacheable("cache1")
public String hello(@PathVariable String name) {
    ....
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are interested in a detailed how-to guide, please check <a href="https://codelabs.developers.google.com/codelabs/cloud-spring-cache-memorystore/">Spring Boot Caching using Cloud Memorystore codelab</a>.</p>
</div>
<div class="paragraph">
<p>Cloud Memorystore documentation can be found <a href="https://cloud.google.com/memorystore/docs/redis/">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bigquery"><a class="anchor" href="#bigquery"></a><a class="link" href="#bigquery">17. BigQuery</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://cloud.google.com/bigquery">Google Cloud BigQuery</a> is a fully managed, petabyte scale, low cost analytics data warehouse.</p>
</div>
<div class="paragraph">
<p>Spring Framework on Google Cloud provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A convenience starter which provides autoconfiguration for the <a href="https://googleapis.dev/java/google-cloud-clients/latest/com/google/cloud/bigquery/BigQuery.html"><code>BigQuery</code></a> client objects with credentials needed to interface with BigQuery.</p>
</li>
<li>
<p>A Spring Integration message handler for loading data into BigQuery tables in your Spring integration pipelines.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-bigquery&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-bigquery")
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="configuration-8"><a class="anchor" href="#configuration-8"></a><a class="link" href="#configuration-8">17.1. Configuration</a></h3>
<div class="paragraph">
<p>The following application properties may be configured with Spring Framework on Google Cloud BigQuery libraries.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.bigquery.datasetName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The BigQuery dataset that the <code>BigQueryTemplate</code> and <code>BigQueryFileMessageHandler</code> is scoped to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.bigquery.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Spring Framework on Google Cloud BigQuery autoconfiguration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.bigquery.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Cloud project ID of the project using BigQuery APIs, if different from the one in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Project ID is typically inferred from <a href="https://cloud.google.com/sdk/gcloud/reference/config/set"><code>gcloud</code></a> configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.bigquery.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credentials file location for authenticating with the Google Cloud BigQuery APIs, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inferred from <a href="https://cloud.google.com/docs/authentication/production">Application Default Credentials</a>, typically set by <a href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default"><code>gcloud</code></a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.bigquery.jsonWriterBatchSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch size which will be used by <code>BigQueryJsonDataWriter</code> while using <a href="https://cloud.google.com/bigquery/docs/write-api">BigQuery Storage Write API</a>. Note too large or too low values might impact performance.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.bigquery.threadPoolSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The size of thread pool of <code>ThreadPoolTaskScheduler</code> which is used by <code>BigQueryTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="bigquery-client-object"><a class="anchor" href="#bigquery-client-object"></a><a class="link" href="#bigquery-client-object">17.1.1. BigQuery Client Object</a></h4>
<div class="paragraph">
<p>The <code>GcpBigQueryAutoConfiguration</code> class configures an instance of <a href="https://googleapis.dev/java/google-cloud-clients/latest/com/google/cloud/bigquery/BigQuery.html"><code>BigQuery</code></a> for you by inferring your credentials and Project ID from the machine&#8217;s environment.</p>
</div>
<div class="paragraph">
<p>Example usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// BigQuery client object provided by our autoconfiguration.
@Autowired
BigQuery bigquery;

public void runQuery() throws InterruptedException {
  String query = "SELECT column FROM table;";
  QueryJobConfiguration queryConfig =
      QueryJobConfiguration.newBuilder(query).build();

  // Run the query using the BigQuery object
  for (FieldValueList row : bigquery.query(queryConfig).iterateAll()) {
    for (FieldValue val : row) {
      System.out.println(val);
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This object is used to interface with all BigQuery services.
For more information, see the <a href="https://cloud.google.com/bigquery/docs/reference/libraries#using_the_client_library">BigQuery Client Library usage examples</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="bigquerytemplate"><a class="anchor" href="#bigquerytemplate"></a><a class="link" href="#bigquerytemplate">17.1.2. BigQueryTemplate</a></h4>
<div class="paragraph">
<p>The <code>BigQueryTemplate</code> class is a wrapper over the <code>BigQuery</code> client object and makes it easier to load data into BigQuery tables.
A <code>BigQueryTemplate</code> is scoped to a single dataset.
The autoconfigured <code>BigQueryTemplate</code> instance will use the dataset provided through the property <code>spring.cloud.gcp.bigquery.datasetName</code>.</p>
</div>
<div class="paragraph">
<p>Below is a code snippet of how to load a CSV data <code>InputStream</code> to a BigQuery table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// BigQuery client object provided by our autoconfiguration.
@Autowired
BigQueryTemplate bigQueryTemplate;

public void loadData(InputStream dataInputStream, String tableName) {
  ListenableFuture&lt;Job&gt; bigQueryJobFuture =
      bigQueryTemplate.writeDataToTable(
          tableName,
          dataFile.getInputStream(),
          FormatOptions.csv());

  // After the future is complete, the data is successfully loaded.
  Job job = bigQueryJobFuture.get();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is a code snippet of how to load a <a href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-json">newline-delimited JSON</a> data <code>InputStream</code> to a BigQuery table. This implementation uses the  <a href="https://cloud.google.com/bigquery/docs/write-api">BigQuery Storage Write API</a>.
<a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-bigquery/src/test/resources/data.json">Here</a> is a sample newline-delimited JSON file which can be used for testing this functionality.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// BigQuery client object provided by our autoconfiguration.
@Autowired
BigQueryTemplate bigQueryTemplate;

  /**
   * This method loads the InputStream of the newline-delimited JSON records to be written in the given table.
   * @param tableName name of the table where the data is expected to be written
   * @param jsonInputStream InputStream of the newline-delimited JSON records to be written in the given table
   */
  public void loadJsonStream(String tableName, InputStream jsonInputStream)
      throws ExecutionException, InterruptedException {
    ListenableFuture&lt;WriteApiResponse&gt; writeApFuture =
        bigQueryTemplate.writeJsonStream(tableName, jsonInputStream);
    WriteApiResponse apiRes = writeApFuture.get();//get the WriteApiResponse
    if (!apiRes.isSuccessful()){
      List&lt;StorageError&gt; errors = apiRes.getErrors();
      // TODO(developer): process the List of StorageError
    }
    // else the write process has been successful
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is a code snippet of how to create table and then load a <a href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-json">newline-delimited JSON</a> data <code>InputStream</code> to a BigQuery table. This implementation uses the  <a href="https://cloud.google.com/bigquery/docs/write-api">BigQuery Storage Write API</a>.
<a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-bigquery/src/test/resources/data.json">Here</a> is a sample newline-delimited JSON file which can be used for testing this functionality.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// BigQuery client object provided by our autoconfiguration.
@Autowired
BigQueryTemplate bigQueryTemplate;

  /**
   * This method created a table with the given name and schema and then loads the InputStream of the newline-delimited JSON records in it.
   * @param tableName name of the table where the data is expected to be written
   * @param jsonInputStream InputStream of the newline-delimited JSON records to be written in the given table
   * @param tableSchema Schema of the table which is required to be created
   */
  public void createTableAndloadJsonStream(String tableName, InputStream jsonInputStream, Schema tableSchema)
      throws ExecutionException, InterruptedException {
    ListenableFuture&lt;WriteApiResponse&gt; writeApFuture =
        bigQueryTemplate.writeJsonStream(tableName, jsonInputStream, tableSchema);//using the overloaded method which created the table when tableSchema is passed
    WriteApiResponse apiRes = writeApFuture.get();//get the WriteApiResponse
    if (!apiRes.isSuccessful()){
      List&lt;StorageError&gt; errors = apiRes.getErrors();
      // TODO(developer): process the List of StorageError
    }
    // else the write process has been successful
  }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-integration-2"><a class="anchor" href="#spring-integration-2"></a><a class="link" href="#spring-integration-2">17.2. Spring Integration</a></h3>
<div class="paragraph">
<p>Spring Framework on Google Cloud BigQuery also provides a Spring Integration message handler <code>BigQueryFileMessageHandler</code>.
This is useful for incorporating BigQuery data loading operations in a Spring Integration pipeline.</p>
</div>
<div class="paragraph">
<p>Below is an example configuring a <code>ServiceActivator</code> bean using the <code>BigQueryFileMessageHandler</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public DirectChannel bigQueryWriteDataChannel() {
  return new DirectChannel();
}

@Bean
public DirectChannel bigQueryJobReplyChannel() {
  return new DirectChannel();
}

@Bean
@ServiceActivator(inputChannel = "bigQueryWriteDataChannel")
public MessageHandler messageSender(BigQueryTemplate bigQueryTemplate) {
  BigQueryFileMessageHandler messageHandler = new BigQueryFileMessageHandler(bigQueryTemplate);
  messageHandler.setFormatOptions(FormatOptions.csv());
  messageHandler.setOutputChannel(bigQueryJobReplyChannel());
  return messageHandler;
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="bigquery-message-handling"><a class="anchor" href="#bigquery-message-handling"></a><a class="link" href="#bigquery-message-handling">17.2.1. BigQuery Message Handling</a></h4>
<div class="paragraph">
<p>The <code>BigQueryFileMessageHandler</code> accepts the following message payload types for loading into BigQuery: <code>java.io.File</code>, <code>byte[]</code>, <code>org.springframework.core.io.Resource</code>, and <code>java.io.InputStream</code>.
The message payload will be streamed and written to the BigQuery table you specify.</p>
</div>
<div class="paragraph">
<p>By default, the <code>BigQueryFileMessageHandler</code> is configured to read the headers of the messages it receives to determine how to load the data.
The headers are specified by the class <code>BigQuerySpringMessageHeaders</code> and summarized below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigQuerySpringMessageHeaders.TABLE_NAME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the BigQuery table within your dataset to write to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigQuerySpringMessageHeaders.FORMAT_OPTIONS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describes the data format of your data to load (i.e. CSV, JSON, etc.).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Alternatively, you may omit these headers and explicitly set the table name or format options by calling <code>setTableName(&#8230;&#8203;)</code> and <code>setFormatOptions(&#8230;&#8203;)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="bigquery-message-reply"><a class="anchor" href="#bigquery-message-reply"></a><a class="link" href="#bigquery-message-reply">17.2.2. BigQuery Message Reply</a></h4>
<div class="paragraph">
<p>After the <code>BigQueryFileMessageHandler</code> processes a message to load data to your BigQuery table, it will respond with a <code>Job</code> on the reply channel.
The <a href="https://googleapis.dev/java/google-cloud-clients/latest/index.html?com/google/cloud/bigquery/package-summary.html">Job object</a> provides metadata and information about the load file operation.</p>
</div>
<div class="paragraph">
<p>By default, the <code>BigQueryFileMessageHandler</code> is run in asynchronous mode, with <code>setSync(false)</code>, and it will reply with a <code>ListenableFuture&lt;Job&gt;</code> on the reply channel.
The future is tied to the status of the data loading job and will complete when the job completes.</p>
</div>
<div class="paragraph">
<p>If the handler is run in synchronous mode with <code>setSync(true)</code>, then the handler will block on the completion of the loading job and block until it is complete.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you decide to use Spring Integration Gateways and you wish to receive <code>ListenableFuture&lt;Job&gt;</code> as a reply object in the Gateway, you will have to call <code>.setAsyncExecutor(null)</code> on your <code>GatewayProxyFactoryBean</code>.
This is needed to indicate that you wish to reply on the built-in async support rather than rely on async handling of the gateway.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-10"><a class="anchor" href="#sample-10"></a><a class="link" href="#sample-10">17.3. Sample</a></h3>
<div class="paragraph">
<p>A BigQuery <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-bigquery-sample">sample application</a> is available.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-iap"><a class="anchor" href="#cloud-iap"></a><a class="link" href="#cloud-iap">18. Cloud IAP</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://cloud.google.com/iap/">Cloud Identity-Aware Proxy (IAP)</a> provides a security layer over applications deployed to Google Cloud.</p>
</div>
<div class="paragraph">
<p>The IAP starter uses <a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html">Spring Security OAuth 2.0 Resource Server</a> functionality to automatically extract user identity from the proxy-injected <code>x-goog-iap-jwt-assertion</code> HTTP header.</p>
</div>
<div class="paragraph">
<p>The following claims are validated automatically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Issue time</p>
</li>
<li>
<p>Expiration time</p>
</li>
<li>
<p>Issuer</p>
</li>
<li>
<p>Audience</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>audience</em> (<code>"aud"</code> claim) validation string is automatically determined when the application is running on App Engine Standard or App Engine Flexible.
This functionality relies on Cloud Resource Manager API to retrieve project details, so the following setup is needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable Cloud Resource Manager API in <a href="https://console.developers.google.com/apis/api/cloudresourcemanager.googleapis.com">Google Cloud Console</a>.</p>
</li>
<li>
<p>Make sure your application has <code>resourcemanager.projects.get</code> permission.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>App Engine automatic <em>audience</em> determination can be overridden by using <code>spring.cloud.gcp.security.iap.audience</code> property. It supports multiple allowable audiences by providing a comma-delimited list.</p>
</div>
<div class="paragraph">
<p>For Compute Engine or Kubernetes Engine <code>spring.cloud.gcp.security.iap.audience</code> property <strong>must</strong> be provided, as the <em>audience</em> string depends on the specific Backend Services setup and cannot be inferred automatically.
To determine the <em>audience</em> value, follow directions in IAP <a href="https://cloud.google.com/iap/docs/signed-headers-howto#verify_the_jwt_payload">Verify the JWT payload</a> guide.
If <code>spring.cloud.gcp.security.iap.audience</code> is not provided, the application will fail to start the following message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">No qualifying bean of type 'com.google.cloud.spring.security.iap.AudienceProvider' available.</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you create a custom <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/web/configuration/WebSecurityConfigurerAdapter.html"><code>WebSecurityConfigurerAdapter</code></a>, enable extracting user identity by adding <code>.oauth2ResourceServer().jwt()</code> configuration to the <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/web/builders/HttpSecurity.html"><code>HttpSecurity</code></a> object.
 If no custom <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/web/configuration/WebSecurityConfigurerAdapter.html"><code>WebSecurityConfigurerAdapter</code></a> is present, nothing needs to be done because Spring Boot will add this customization by default.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Starter Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-security-iap&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Starter Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-security-iap")
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="configuration-9"><a class="anchor" href="#configuration-9"></a><a class="link" href="#configuration-9">18.1. Configuration</a></h3>
<div class="paragraph">
<p>The following properties are available.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Modifying registry, algorithm, and header properties might be useful for testing, but the defaults should not be changed in production.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.security.iap.registry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link to JWK public key registry.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="https://www.gstatic.com/iap/verify/public_key-jwk" class="bare">www.gstatic.com/iap/verify/public_key-jwk</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.security.iap.algorithm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encryption algorithm used to sign the JWK token.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ES256</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.security.iap.header</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header from which to extract the JWK key.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x-goog-iap-jwt-assertion</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.security.iap.issuer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWK issuer to verify.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="https://cloud.google.com/iap" class="bare">cloud.google.com/iap</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.security.iap.audience</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom JWK audience to verify.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false on App Engine; true on GCE/GKE</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="sample-11"><a class="anchor" href="#sample-11"></a><a class="link" href="#sample-11">18.2. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-security-iap-sample">sample application</a> is available.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-vision"><a class="anchor" href="#cloud-vision"></a><a class="link" href="#cloud-vision">19. Cloud Vision</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://cloud.google.com/vision/">Google Cloud Vision API</a> allows users to leverage machine learning algorithms for processing images and documents including: image classification, face detection, text extraction, optical character recognition, and others.</p>
</div>
<div class="paragraph">
<p>Spring Framework on Google Cloud provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A convenience starter which automatically configures authentication settings and client objects needed to begin using the <a href="https://cloud.google.com/vision/">Google Cloud Vision API</a>.</p>
</li>
<li>
<p><code>CloudVisionTemplate</code> which simplifies interactions with the Cloud Vision API.</p>
<div class="ulist">
<ul>
<li>
<p>Allows you to easily send images, PDF, TIFF and GIF documents to the API as Spring Resources.</p>
</li>
<li>
<p>Offers convenience methods for common operations, such as classifying content of an image.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>DocumentOcrTemplate</code> which offers convenient methods for running <a href="https://cloud.google.com/vision/docs/pdf">optical character recognition (OCR)</a> on PDF and TIFF documents.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="dependency-setup"><a class="anchor" href="#dependency-setup"></a><a class="link" href="#dependency-setup">19.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>To begin using this library, add the <code>spring-cloud-gcp-starter-vision</code> artifact to your project.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-starter-vision&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-starter-vision")
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-10"><a class="anchor" href="#configuration-10"></a><a class="link" href="#configuration-10">19.2. Configuration</a></h3>
<div class="paragraph">
<p>The following options may be configured with Spring Framework on Google Cloud Vision libraries.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.vision.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Cloud Vision autoconfiguration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.vision.executors-threads-count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of threads used during document OCR processing for waiting on long-running OCR operations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.vision.json-output-batch-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of document pages to include in each OCR output file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="cloud-vision-ocr-dependencies"><a class="anchor" href="#cloud-vision-ocr-dependencies"></a><a class="link" href="#cloud-vision-ocr-dependencies">19.2.1. Cloud Vision OCR Dependencies</a></h4>
<div class="paragraph">
<p>If you are interested in applying optical character recognition (OCR) on documents for your project, you&#8217;ll need to add both <code>spring-cloud-gcp-starter-vision</code> and <code>spring-cloud-gcp-starter-storage</code> to your dependencies.
The storage starter is necessary because the Cloud Vision API will process your documents and write OCR output files all within your Google Cloud Storage buckets.</p>
</div>
<div class="paragraph">
<p>Maven coordinates using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-starter-vision&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-starter-storage&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-starter-vision")
  implementation("com.google.cloud:spring-cloud-gcp-starter-storage")
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="image-analysis"><a class="anchor" href="#image-analysis"></a><a class="link" href="#image-analysis">19.3. Image Analysis</a></h3>
<div class="paragraph">
<p>The <code>CloudVisionTemplate</code> allows you to easily analyze images; it provides the following method for interfacing with Cloud Vision:</p>
</div>
<div class="paragraph">
<p><code>public AnnotateImageResponse analyzeImage(Resource imageResource, Feature.Type&#8230;&#8203; featureTypes)</code></p>
</div>
<div class="paragraph">
<p><strong>Parameters:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Resource imageResource</code> refers to the Spring Resource of the image object you wish to analyze.
The Google Cloud Vision documentation provides a <a href="https://cloud.google.com/vision/docs/supported-files">list of the image types that they support</a>.</p>
</li>
<li>
<p><code>Feature.Type&#8230;&#8203; featureTypes</code> refers to a var-arg array of Cloud Vision Features to extract from the image.
A feature refers to a kind of image analysis one wishes to perform on an image, such as label detection, OCR recognition, facial detection, etc.
One may specify multiple features to analyze within one request.
A full list of Cloud Vision Features is provided in the <a href="https://cloud.google.com/vision/docs/features">Cloud Vision Feature docs</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://cloud.google.com/vision/docs/reference/rpc/google.cloud.vision.v1#google.cloud.vision.v1.AnnotateImageResponse"><code>AnnotateImageResponse</code></a> contains the results of all the feature analyses that were specified in the request.
For each feature type that you provide in the request, <code>AnnotateImageResponse</code> provides a getter method to get the result of that feature analysis.
For example, if you analyzed an image using the <code>LABEL_DETECTION</code> feature, you would retrieve the results from the response using <code>annotateImageResponse.getLabelAnnotationsList()</code>.</p>
<div class="paragraph">
<p><code>AnnotateImageResponse</code> is provided by the Google Cloud Vision libraries; please consult the <a href="https://cloud.google.com/vision/docs/reference/rpc/google.cloud.vision.v1#google.cloud.vision.v1.AnnotateImageResponse">RPC reference</a> or <a href="https://googleapis.github.io/googleapis/java/all/latest/apidocs/com/google/cloud/vision/v1/AnnotateImageResponse.html">Javadoc</a> for more details.
Additionally, you may consult the <a href="https://cloud.google.com/vision/docs/">Cloud Vision docs</a> to familiarize yourself with the concepts and features of the API.</p>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="detect-image-labels-example"><a class="anchor" href="#detect-image-labels-example"></a><a class="link" href="#detect-image-labels-example">19.3.1. Detect Image Labels Example</a></h4>
<div class="paragraph">
<p><a href="https://cloud.google.com/vision/docs/detecting-labels">Image labeling</a> refers to producing labels that describe the contents of an image.
Below is a code sample of how this is done using the Cloud Vision Spring Template.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private ResourceLoader resourceLoader;

@Autowired
private CloudVisionTemplate cloudVisionTemplate;

public void processImage() {
  Resource imageResource = this.resourceLoader.getResource("my_image.jpg");
  AnnotateImageResponse response = this.cloudVisionTemplate.analyzeImage(
      imageResource, Type.LABEL_DETECTION);
  System.out.println("Image Classification results: " + response.getLabelAnnotationsList());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="file-analysis"><a class="anchor" href="#file-analysis"></a><a class="link" href="#file-analysis">19.4. File Analysis</a></h3>
<div class="paragraph">
<p>The <code>CloudVisionTemplate</code> allows you to easily analyze PDF, TIFF and GIF documents; it provides the following method for interfacing with Cloud Vision:</p>
</div>
<div class="paragraph">
<p><code>public AnnotateFileResponse analyzeFile(Resource fileResource, String mimeType, Feature.Type&#8230;&#8203; featureTypes)</code></p>
</div>
<div class="paragraph">
<p><strong>Parameters:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Resource fileResource</code> refers to the Spring Resource of the PDF, TIFF or GIF object you wish to analyze.
Documents with more than 5 pages are not supported.</p>
</li>
<li>
<p><code>String mimeType</code> is the mime type of the fileResource.
Currently, only <code>application/pdf</code>, <code>image/tiff</code> and <code>image/gif</code> are supported.</p>
</li>
<li>
<p><code>Feature.Type&#8230;&#8203; featureTypes</code> refers to a var-arg array of Cloud Vision Features to extract from the document.
A feature refers to a kind of image analysis one wishes to perform on a document, such as label detection, OCR recognition, facial detection, etc.
One may specify multiple features to analyze within one request.
A full list of Cloud Vision Features is provided in the <a href="https://cloud.google.com/vision/docs/features">Cloud Vision Feature docs</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Returns:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://cloud.google.com/vision/docs/reference/rpc/google.cloud.vision.v1#google.cloud.vision.v1.AnnotateFileResponse"><code>AnnotateFileResponse</code></a> contains the results of all the feature analyses that were specified in the request.
For each page of the analysed document the response will contain an <code>AnnotateImageResponse</code> object which you can retrieve using <code>annotateFileResponse.getResponsesList()</code>.
For each feature type that you provide in the request, <code>AnnotateImageResponse</code> provides a getter method to get the result of that feature analysis.
For example, if you analysed an PDF using the <code>DOCUMENT_TEXT_DETECTION</code> feature, you would retrieve the results from the response using <code>annotateImageResponse.getFullTextAnnotation().getText()</code>.</p>
<div class="paragraph">
<p><code>AnnotateFileResponse</code> is provided by the Google Cloud Vision libraries; please consult the <a href="https://cloud.google.com/vision/docs/reference/rpc/google.cloud.vision.v1#google.cloud.vision.v1.AnnotateFileResponse">RPC reference</a> or <a href="https://googleapis.dev/java/google-cloud-vision/latest/index.html?com/google/cloud/vision/v1/AnnotateFileResponse.html">Javadoc</a> for more details.
Additionally, you may consult the <a href="https://cloud.google.com/vision/docs/">Cloud Vision docs</a> to familiarize yourself with the concepts and features of the API.</p>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="running-text-detection-example"><a class="anchor" href="#running-text-detection-example"></a><a class="link" href="#running-text-detection-example">19.4.1. Running Text Detection Example</a></h4>
<div class="paragraph">
<p><a href="https://cloud.google.com/vision/docs/file-small-batch">Detect text in files</a> refers to extracting text from small document such as PDF or TIFF.
Below is a code sample of how this is done using the Cloud Vision Spring Template.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private ResourceLoader resourceLoader;

@Autowired
private CloudVisionTemplate cloudVisionTemplate;

public void processPdf() {
  Resource imageResource = this.resourceLoader.getResource("my_file.pdf");
  AnnotateFileResponse response =
    this.cloudVisionTemplate.analyzeFile(
        imageResource, "application/pdf", Type.DOCUMENT_TEXT_DETECTION);

  response
    .getResponsesList()
    .forEach(
        annotateImageResponse -&gt;
            System.out.println(annotateImageResponse.getFullTextAnnotation().getText()));
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="document-ocr-template"><a class="anchor" href="#document-ocr-template"></a><a class="link" href="#document-ocr-template">19.5. Document OCR Template</a></h3>
<div class="paragraph">
<p>The <code>DocumentOcrTemplate</code> allows you to easily run <a href="https://cloud.google.com/vision/docs/pdf">optical character recognition (OCR)</a> on your PDF and TIFF documents stored in your Google Storage bucket.</p>
</div>
<div class="paragraph">
<p>First, you will need to create a bucket in <a href="https://console.cloud.google.com/storage">Google Cloud Storage</a> and <a href="https://cloud.google.com/storage/docs/uploading-objects#storage-upload-object-java">upload the documents you wish to process into the bucket</a>.</p>
</div>
<div class="sect3">
<h4 id="running-ocr-on-a-document"><a class="anchor" href="#running-ocr-on-a-document"></a><a class="link" href="#running-ocr-on-a-document">19.5.1. Running OCR on a Document</a></h4>
<div class="paragraph">
<p>When OCR is run on a document, the Cloud Vision APIs will output a collection of OCR output files in JSON which describe the text content, bounding rectangles of words and letters, and other information about the document.</p>
</div>
<div class="paragraph">
<p>The <code>DocumentOcrTemplate</code> provides the following method for running OCR on a document saved in Google Cloud Storage:</p>
</div>
<div class="paragraph">
<p><code>ListenableFuture&lt;DocumentOcrResultSet&gt; runOcrForDocument(GoogleStorageLocation document, GoogleStorageLocation outputFilePathPrefix)</code></p>
</div>
<div class="paragraph">
<p>The method allows you to specify the location of the document and the output location for where all the JSON output files will be saved in Google Cloud Storage.
It returns a <code>ListenableFuture</code> containing <code>DocumentOcrResultSet</code> which contains the OCR content of the document.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Running OCR on a document is an operation that can take between several minutes to several hours depending on how large the document is.
It is recommended to register callbacks to the returned ListenableFuture or ignore it and process the JSON output files at a later point in time using <code>readOcrOutputFile</code> or <code>readOcrOutputFileSet</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="running-ocr-example"><a class="anchor" href="#running-ocr-example"></a><a class="link" href="#running-ocr-example">19.5.2. Running OCR Example</a></h4>
<div class="paragraph">
<p>Below is a code snippet of how to run OCR on a document stored in a Google Storage bucket and read the text in the first page of the document.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Autowired
private DocumentOcrTemplate documentOcrTemplate;

public void runOcrOnDocument() {
    GoogleStorageLocation document = GoogleStorageLocation.forFile(
            "your-bucket", "test.pdf");
    GoogleStorageLocation outputLocationPrefix = GoogleStorageLocation.forFolder(
            "your-bucket", "output_folder/test.pdf/");

    ListenableFuture&lt;DocumentOcrResultSet&gt; result =
        this.documentOcrTemplate.runOcrForDocument(
            document, outputLocationPrefix);

    DocumentOcrResultSet ocrPages = result.get(5, TimeUnit.MINUTES);

    String page1Text = ocrPages.getPage(1).getText();
    System.out.println(page1Text);
}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="reading-ocr-output-files"><a class="anchor" href="#reading-ocr-output-files"></a><a class="link" href="#reading-ocr-output-files">19.5.3. Reading OCR Output Files</a></h4>
<div class="paragraph">
<p>In some use-cases, you may need to directly read OCR output files stored in Google Cloud Storage.</p>
</div>
<div class="paragraph">
<p><code>DocumentOcrTemplate</code> offers the following methods for reading and processing OCR output files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>readOcrOutputFileSet(GoogleStorageLocation jsonOutputFilePathPrefix)</code>:
Reads a collection of OCR output files under a file path prefix and returns the parsed contents.
All of the files under the path should correspond to the same document.</p>
</li>
<li>
<p><code>readOcrOutputFile(GoogleStorageLocation jsonFile)</code>:
Reads a single OCR output file and returns the parsed contents.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="reading-ocr-output-files-example"><a class="anchor" href="#reading-ocr-output-files-example"></a><a class="link" href="#reading-ocr-output-files-example">19.5.4. Reading OCR Output Files Example</a></h4>
<div class="paragraph">
<p>The code snippet below describes how to read the OCR output files of a single document.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Autowired
private DocumentOcrTemplate documentOcrTemplate;

// Parses the OCR output files corresponding to a single document in a directory
public void parseOutputFileSet() {
  GoogleStorageLocation ocrOutputPrefix = GoogleStorageLocation.forFolder(
      "your-bucket", "json_output_set/");

  DocumentOcrResultSet result = this.documentOcrTemplate.readOcrOutputFileSet(ocrOutputPrefix);
  System.out.println("Page 2 text: " + result.getPage(2).getText());
}

// Parses a single OCR output file
public void parseSingleOutputFile() {
  GoogleStorageLocation ocrOutputFile = GoogleStorageLocation.forFile(
      "your-bucket", "json_output_set/test_output-2-to-2.json");

  DocumentOcrResultSet result = this.documentOcrTemplate.readOcrOutputFile(ocrOutputFile);
  System.out.println("Page 2 text: " + result.getPage(2).getText());
}</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-12"><a class="anchor" href="#sample-12"></a><a class="link" href="#sample-12">19.6. Sample</a></h3>
<div class="paragraph">
<p>Samples are provided to show example usages of Spring Framework on Google Cloud with Google Cloud Vision.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-vision-api-sample">Image Labeling Sample</a> shows you how to use image labelling in your Spring application.
The application generates labels describing the content inside the images you specify in the application.</p>
</li>
<li>
<p>The <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-vision-ocr-demo">Document OCR demo</a> shows how you can apply OCR processing on your PDF/TIFF documents in order to extract their text contents.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="secret-manager"><a class="anchor" href="#secret-manager"></a><a class="link" href="#secret-manager">20. Secret Manager</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://cloud.google.com/secret-manager">Google Cloud Secret Manager</a> is a secure and convenient method for storing API keys, passwords, certificates, and other sensitive data.
A detailed summary of its features can be found in the <a href="https://cloud.google.com/blog/products/identity-security/introducing-google-clouds-secret-manager">Secret Manager documentation</a>.</p>
</div>
<div class="paragraph">
<p>Spring Framework on Google Cloud provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A property source which allows you to specify and load the secrets of your Google Cloud project into your application context as a <a href="https://cloud.spring.io/spring-cloud-commons/multi/multi__spring_cloud_context_application_context_services.html#_the_bootstrap_application_context">Bootstrap Property Source</a>.</p>
</li>
<li>
<p>A <code>SecretManagerTemplate</code> which allows you to read, write, and update secrets in Secret Manager.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="dependency-setup-2"><a class="anchor" href="#dependency-setup-2"></a><a class="link" href="#dependency-setup-2">20.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>To begin using this library, add the <code>spring-cloud-gcp-starter-secretmanager</code> artifact to your project.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-starter-secretmanager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-starter-secretmanager")
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="configuration-11"><a class="anchor" href="#configuration-11"></a><a class="link" href="#configuration-11">20.1.1. Configuration</a></h4>
<div class="paragraph">
<p>By default, Spring Framework on Google Cloud Secret Manager will authenticate using Application Default Credentials.
This can be overridden using the authentication properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All the below settings must be specified in a <a href="https://cloud.spring.io/spring-cloud-commons/multi/multi__spring_cloud_context_application_context_services.html#_the_bootstrap_application_context"><code>bootstrap.properties</code></a> (or <code>bootstrap.yaml</code>) file which is the properties file used to configure settings for bootstrap-phase Spring configuration.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.secretmanager.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the Secret Manager bootstrap property and template configuration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.secretmanager.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2 credentials for authenticating to the Google Cloud Secret Manager API.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, infers credentials from <a href="https://cloud.google.com/docs/authentication/production">Application Default Credentials</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.secretmanager.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64-encoded contents of OAuth2 account private key for authenticating to the Google Cloud Secret Manager API.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, infers credentials from <a href="https://cloud.google.com/docs/authentication/production">Application Default Credentials</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.secretmanager.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default Google Cloud project used to access Secret Manager API for the template and property source.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, infers the project from <a href="https://cloud.google.com/docs/authentication/production">Application Default Credentials</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.secretmanager.allow-default-secret</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the behavior when accessing a non-existent secret string/bytes.<br>
If set to <code>true</code>, <code>null</code> will be returned when accessing a non-existent secret; otherwise throwing an exception.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="secret-manager-property-source"><a class="anchor" href="#secret-manager-property-source"></a><a class="link" href="#secret-manager-property-source">20.2. Secret Manager Property Source</a></h3>
<div class="paragraph">
<p>The Spring Framework on Google Cloud integration for Google Cloud Secret Manager enables you to use Secret Manager as a bootstrap property source.</p>
</div>
<div class="paragraph">
<p>This allows you to specify and load secrets from Google Cloud Secret Manager as properties into the application context during the <a href="https://cloud.spring.io/spring-cloud-commons/reference/html/#the-bootstrap-application-context">Bootstrap Phase</a>, which refers to the initial phase when a Spring application is being loaded.</p>
</div>
<div class="paragraph">
<p>The Secret Manager property source uses the following syntax to specify secrets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># 1. Long form - specify the project ID, secret ID, and version
sm://projects/&lt;project-id&gt;/secrets/&lt;secret-id&gt;/versions/&lt;version-id&gt;}

# 2.  Long form - specify project ID, secret ID, and use latest version
sm://projects/&lt;project-id&gt;/secrets/&lt;secret-id&gt;

# 3. Short form - specify project ID, secret ID, and version
sm://&lt;project-id&gt;/&lt;secret-id&gt;/&lt;version-id&gt;

# 4. Short form - default project; specify secret + version
#
# The project is inferred from the spring.cloud.gcp.secretmanager.project-id setting
# in your bootstrap.properties (see Configuration) or from application-default credentials if
# this is not set.
sm://&lt;secret-id&gt;/&lt;version&gt;

# 5. Shortest form - specify secret ID, use default project and latest version.
sm://&lt;secret-id&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use this syntax in the following places:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In your <code>application.properties</code> or <code>bootstrap.properties</code> files:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># Example of the project-secret long-form syntax.
spring.datasource.password=${sm://projects/my-gcp-project/secrets/my-secret}</code></pre>
</div>
</div>
</li>
<li>
<p>Access the value using the <code>@Value</code> annotation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// Example of using shortest form syntax.
@Value("${sm://my-secret}")</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="secret-manager-template"><a class="anchor" href="#secret-manager-template"></a><a class="link" href="#secret-manager-template">20.3. Secret Manager Template</a></h3>
<div class="paragraph">
<p>The <code>SecretManagerTemplate</code> class simplifies operations of creating, updating, and reading secrets.</p>
</div>
<div class="paragraph">
<p>To begin using this class, you may inject an instance of the class using <code>@Autowired</code> after adding the starter dependency to your project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private SecretManagerTemplate secretManagerTemplate;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please consult <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/blob/main/spring-cloud-gcp-secretmanager/src/main/java/com/google/cloud/spring/secretmanager/SecretManagerOperations.java"><code>SecretManagerOperations</code></a> for information on what operations are available for the Secret Manager template.</p>
</div>
</div>
<div class="sect2">
<h3 id="refresh-secrets-without-restarting-the-application"><a class="anchor" href="#refresh-secrets-without-restarting-the-application"></a><a class="link" href="#refresh-secrets-without-restarting-the-application">20.4. Refresh secrets without restarting the application</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Before running your application, change the project&#8217;s configuration files as follows:</p>
<div class="paragraph">
<p>import the actuator starter dependency to your project,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>add the following properties to your project&#8217;s <code>application.properties</code>. The latter is used to enable <a href="https://spring.io/blog/2020/08/14/config-file-processing-in-spring-boot-2-4">Spring Boot&#8217;s Config Data API</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">management.endpoints.web.exposure.include=refresh
spring.config.import=sm://</code></pre>
</div>
</div>
<div class="paragraph">
<p>finally, add the following property to your project&#8217;s <code>bootstrap.properties</code> to disable
Secret Manager bootstrap phrase.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.cloud.gcp.secretmanager.legacy=false</code></pre>
</div>
</div>
</li>
<li>
<p>After running the application, update your secret stored in the Secret Manager.</p>
</li>
<li>
<p>To refresh the secret, send the following command to your application sever:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">curl -X POST http://[host]:[port]/actuator/refresh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that only <code>@ConfigurationProperties</code> annotated with <code>@RefreshScope</code> support updating secrets without restarting the application.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="allow-default-secret"><a class="anchor" href="#allow-default-secret"></a><a class="link" href="#allow-default-secret">20.5. Allow default secret</a></h3>
<div class="paragraph">
<p>By default, when accessing a non-existent secret, the Secret Manager will throw an exception.</p>
</div>
<div class="paragraph">
<p>However, if your want to use a default value in such a scenario, you can add the following property to project&#8217;s properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">`spring.cloud.gcp.secretmanager.allow-default-secret=true`</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore, a variable annotated with <code>@Value("${${sm://application-fake}:DEFAULT}")</code> will be resolved as <code>DEFAULT</code> when there is no <code>application-fake</code> in Secret Manager and <code>application-fake</code> is NOT a valid application property.</p>
</div>
</div>
<div class="sect2">
<h3 id="sample-13"><a class="anchor" href="#sample-13"></a><a class="link" href="#sample-13">20.6. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-secretmanager-sample">Secret Manager Sample Application</a> is provided which demonstrates basic property source loading and usage of the template class.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="google-cloud-key-management-service"><a class="anchor" href="#google-cloud-key-management-service"></a><a class="link" href="#google-cloud-key-management-service">21. Google Cloud Key Management Service</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://cloud.google.com/kms/docs">Google Cloud Key Management Service (KMS)</a> allows you to create, import, and manage cryptographic keys and perform cryptographic operations in a single centralized cloud service.</p>
</div>
<div class="paragraph">
<p>Spring Framework on Google Cloud offers a utility template class <code>KmsTemplate</code> which allows you to conveniently encrypt and decrypt binary or text data.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-3"><a class="anchor" href="#dependency-setup-3"></a><a class="link" href="#dependency-setup-3">21.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>To begin using this library, add the <code>spring-cloud-gcp-starter-kms</code> artifact to your project.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-starter-kms&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-starter-kms")
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-12"><a class="anchor" href="#configuration-12"></a><a class="link" href="#configuration-12">21.2. Configuration</a></h3>
<div class="paragraph">
<p>The following options may be configured with Spring Framework on Google Cloud KMS libraries.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.kms.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Google Cloud KMS autoconfiguration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.kms.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Cloud project ID of the project using Cloud KMS APIs, if different from the one in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Project ID is typically inferred from <a href="https://cloud.google.com/sdk/gcloud/reference/config/set"><code>gcloud</code></a> configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.kms.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credentials file location for authenticating with the Cloud KMS APIs, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inferred from <a href="https://cloud.google.com/docs/authentication/production">Application Default Credentials</a>, typically set by <a href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default"><code>gcloud</code></a>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="basic-usage"><a class="anchor" href="#basic-usage"></a><a class="link" href="#basic-usage">21.3. Basic Usage</a></h3>
<div class="paragraph">
<p>Once you have added the <code>spring-cloud-gcp-starter-kms</code> to your project, the autoconfiguration class <code>com.google.cloud.spring.autoconfigure.kms.GcpKmsAutoConfiguration</code> will be activated for your project.</p>
</div>
<div class="paragraph">
<p>The <code>com.google.cloud.spring.kms.KmsTemplate</code> bean provided by the autoconfiguration is the entrypoint to using Spring Framework on Google Cloud support for Google KMS. This class allows you to specify a Cloud KMS key in your project via a URI string (format described below) and perform encryption/decryption with it.</p>
</div>
<div class="paragraph">
<p>The template class automatically validates the CRC32 checksums received responses from Cloud KMS APIs to verify correctness of the response.</p>
</div>
<div class="sect3">
<h4 id="cloud-kms-key-id-format"><a class="anchor" href="#cloud-kms-key-id-format"></a><a class="link" href="#cloud-kms-key-id-format">21.3.1. Cloud KMS Key ID format</a></h4>
<div class="paragraph">
<p>Spring Framework on Google Cloud offers the following key syntax to specify Cloud KMS keys in your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"> 1. Shortest form - specify the key by key ring ID, and key ID.
 The project is inferred from the spring.cloud.gcp.kms.project-id if set, otherwise
 the default Google Cloud project (such as using application-default-credentials) is used.
 The location is assumed to be `global`.

 {key-ring-id}/{key-id}

 2. Short form - specify the key by location ID, key ring ID, and key ID.
 The project is inferred from the spring.cloud.gcp.kms.project-id if set, otherwise
 the default Google Cloud project (such as using application-default-credentials) is used.

 {location-id}/{key-ring-id}/{key-id}

 3. Full form - specify project ID, location ID, key ring ID, and key ID

 {project-id}/{location-id}/{key-ring-id}/{key-id}

 4. Long form - specify project ID, location ID, key ring ID, and key ID.
 This format is equivalent to the fully-qualified resource name of a Cloud KMS key.

 projects/{project-id}/locations/{location-id}/keyRings/{key-ring-id}/cryptoKeys/{key-id}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sample-14"><a class="anchor" href="#sample-14"></a><a class="link" href="#sample-14">21.4. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-kms-sample">Cloud KMS Sample Application</a> is provided which demonstrates basic encryption and decryption operations.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-runtime-configuration-api"><a class="anchor" href="#cloud-runtime-configuration-api"></a><a class="link" href="#cloud-runtime-configuration-api">22. Cloud Runtime Configuration API</a></h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Google Cloud Runtime Configuration service is in <strong>Beta</strong> status, and is only available in snapshot and milestone versions of the project. It&#8217;s also not available in the Spring Framework on Google Cloud BOM, unlike other modules.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Framework on Google Cloud makes it possible to use the <a href="https://cloud.google.com/deployment-manager/runtime-configurator/reference/rest/">Google Runtime Configuration API</a> as a <a href="https://cloud.spring.io/spring-cloud-config/">Spring Cloud Config</a> server to remotely store your application configuration data.</p>
</div>
<div class="paragraph">
<p>The Spring Framework on Google Cloud Config support is provided via its own Spring Boot starter.
It enables the use of the Google Runtime Configuration API as a source for Spring Boot configuration properties.</p>
</div>
<div class="paragraph">
<p>Maven coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-config&lt;/artifactId&gt;
    &lt;version&gt;3.4.1&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    compile group: 'org.springframework.cloud',
    name: 'spring-cloud-gcp-starter-config',
    version: '3.4.1'
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="configuration-13"><a class="anchor" href="#configuration-13"></a><a class="link" href="#configuration-13">22.1. Configuration</a></h3>
<div class="paragraph">
<p>The following parameters are configurable in Spring Framework on Google Cloud Config:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.config.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the Config client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.config.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of your application</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value of the <code>spring.application.name</code> property.
If none, <code>application</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.config.profile</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value of the <code>spring.profiles.active</code> property.
If more than a single profile, last one is chosen</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.config.timeout-millis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout in milliseconds for connecting to the Google Runtime Configuration API</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>60000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.config.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Cloud project ID where the Google Runtime Configuration API is hosted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.config.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2 credentials for authenticating with the Google Runtime Configuration API</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.config.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64-encoded OAuth2 credentials for authenticating with the Google Runtime Configuration API</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.config.credentials.scopes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://developers.google.com/identity/protocols/googlescopes">OAuth2 scope</a> for Spring Framework on Google Cloud Config credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/cloudruntimeconfig" class="bare">www.googleapis.com/auth/cloudruntimeconfig</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
These properties should be specified in a <a href="https://cloud.spring.io/spring-cloud-static/spring-cloud.html#_the_bootstrap_application_context"><code>bootstrap.yml</code>/<code>bootstrap.properties</code></a> file, rather than the usual <code>applications.yml</code>/<code>application.properties</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Core properties, as described in <a href="#spring-cloud-gcp-core">Spring Framework on Google Cloud Core Module</a>, do not apply to Spring Framework on Google Cloud Config.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="quick-start"><a class="anchor" href="#quick-start"></a><a class="link" href="#quick-start">22.2. Quick start</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a configuration in the Google Runtime Configuration API that is called <code>${spring.application.name}_${spring.profiles.active}</code>.
In other words, if <code>spring.application.name</code> is <code>myapp</code> and <code>spring.profiles.active</code> is <code>prod</code>, the configuration should be called <code>myapp_prod</code>.</p>
<div class="paragraph">
<p>In order to do that, you should have the <a href="https://cloud.google.com/sdk/">Google Cloud SDK</a> installed, own a Google Cloud Project and run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">gcloud init # if this is your first Google Cloud SDK run.
gcloud beta runtime-config configs create myapp_prod
gcloud beta runtime-config configs variables set myapp.queue-size 25 --config-name myapp_prod</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your <code>bootstrap.properties</code> file with your application&#8217;s configuration data:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.application.name=myapp
spring.profiles.active=prod</code></pre>
</div>
</div>
</li>
<li>
<p>Add the <code>@ConfigurationProperties</code> annotation to a Spring-managed bean:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">@Component
@ConfigurationProperties("myapp")
public class SampleConfig {

  private int queueSize;

  public int getQueueSize() {
    return this.queueSize;
  }

  public void setQueueSize(int queueSize) {
    this.queueSize = queueSize;
  }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>When your Spring application starts, the <code>queueSize</code> field value will be set to 25 for the above <code>SampleConfig</code> bean.</p>
</div>
</div>
<div class="sect2">
<h3 id="refreshing-the-configuration-at-runtime"><a class="anchor" href="#refreshing-the-configuration-at-runtime"></a><a class="link" href="#refreshing-the-configuration-at-runtime">22.3. Refreshing the configuration at runtime</a></h3>
<div class="paragraph">
<p><a href="https://cloud.spring.io/spring-cloud-static/docs/1.0.x/spring-cloud.html#_endpoints">Spring Cloud</a> provides support to have configuration parameters be reloadable with the POST request to <code>/actuator/refresh</code> endpoint.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the Spring Boot Actuator dependency:</p>
<div class="paragraph">
<p>Maven coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dependencies {
    implementation("org.springframework.boot:spring-boot-starter-actuator")
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add <code>@RefreshScope</code> to your Spring configuration class to have parameters be reloadable at runtime.</p>
</li>
<li>
<p>Add <code>management.endpoints.web.exposure.include=refresh</code> to your <code>application.properties</code> to allow unrestricted access to <code>/actuator/refresh</code>.</p>
</li>
<li>
<p>Update a property with <code>gcloud</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ gcloud beta runtime-config configs variables set \
  myapp.queue_size 200 \
  --config-name myapp_prod</pre>
</div>
</div>
</li>
<li>
<p>Send a POST request to the refresh endpoint:</p>
<div class="literalblock">
<div class="content">
<pre>$ curl -XPOST https://myapp.host.com/actuator/refresh</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="sample-15"><a class="anchor" href="#sample-15"></a><a class="link" href="#sample-15">22.4. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-config-sample">sample application</a> and a <a href="https://codelabs.developers.google.com/codelabs/cloud-spring-runtime-config/index.html">codelab</a> are available.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud-foundry"><a class="anchor" href="#cloud-foundry"></a><a class="link" href="#cloud-foundry">23. Cloud Foundry</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Framework on Google Cloud provides support for Cloud Foundry&#8217;s <a href="https://docs.pivotal.io/partners/gcp-sb/index.html">GCP Service Broker</a>.
Our Pub/Sub, Cloud Spanner, Storage, Cloud Trace and Cloud SQL MySQL and PostgreSQL starters are Cloud Foundry aware and retrieve properties like project ID, credentials, etc., that are used in auto configuration from the Cloud Foundry environment.</p>
</div>
<div class="paragraph">
<p>In order to take advantage of the Cloud Foundry support make sure the following dependency is added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-cloudfoundry&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In cases like Pub/Sub&#8217;s topic and subscription, or Storage&#8217;s bucket name, where those parameters are not used in auto configuration, you can fetch them using the VCAP mapping provided by Spring Boot.
For example, to retrieve the provisioned Pub/Sub topic, you can use the <code>vcap.services.mypubsub.credentials.topic_name</code> property from the application environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the same service is bound to the same application more than once, the auto configuration will not be able to choose among bindings and will not be activated for that service.
This includes both MySQL and PostgreSQL bindings to the same app.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
In order for the Cloud SQL integration to work in Cloud Foundry, auto-reconfiguration must be disabled.
You can do so using the <code>cf set-env &lt;APP&gt; JBP_CONFIG_SPRING_AUTO_RECONFIGURATION '{enabled: false}'</code> command.
Otherwise, Cloud Foundry will produce a <code>DataSource</code> with an invalid JDBC URL (i.e., <code>jdbc:mysql://null/null</code>).
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="user-provided-services"><a class="anchor" href="#user-provided-services"></a><a class="link" href="#user-provided-services">23.1. User-Provided Services</a></h3>
<div class="paragraph">
<p><a href="https://docs.cloudfoundry.org/devguide/services/user-provided.html">User-provided services</a> enable developers to use services that are not available in the marketplace with their apps running on Cloud Foundry.
For example, you may want to use a user-provided service that points to a shared Google Service (like Cloud Spanner) used across your organization.</p>
</div>
<div class="paragraph">
<p>In order for Spring Framework on Google Cloud to detect your user-provided service as a Google Cloud Service, you must add an <a href="https://docs.cloudfoundry.org/devguide/services/managing-services.html#instance-tags-create">instance tag</a> indicating the Google Cloud Service it uses.
The tag should simply be the Cloud Foundry name for the Google Service.</p>
</div>
<div class="paragraph">
<p>For example, if you create a user-provided service using Cloud Spanner, you might run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">$ cf create-user-provided-service user-spanner-service -t "google-spanner" ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows Spring Framework on Google Cloud to retrieve the correct service properties from Cloud Foundry and use them in the auto configuration for your application.</p>
</div>
<div class="paragraph">
<p>A mapping of Google service names to Cloud Foundry names are provided below:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Cloud Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloud Foundry Name (add this as a tag)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cloud.google.com/pubsub">Google Cloud Pub/Sub</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google-pubsub</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cloud.google.com/storage">Google Cloud Storage</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google-storage</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cloud.google.com/spanner">Google Cloud Spanner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google-spanner</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cloud.google.com/datastore">Datastore</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google-datastore</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cloud.google.com/firestore">Firestore</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google-firestore</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cloud.google.com/bigquery">BigQuery</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google-bigquery</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cloud.google.com/products/operations">Cloud Trace</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google-stackdriver-trace</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cloud.google.com/sql">Cloud Sql (MySQL)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google-cloudsql-mysql</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cloud.google.com/sql">Cloud Sql (PostgreSQL)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google-cloudsql-postgres</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kotlin-support"><a class="anchor" href="#kotlin-support"></a><a class="link" href="#kotlin-support">24. Kotlin Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The latest version of the Spring Framework provides first-class support for Kotlin.
For Kotlin users of Spring, the Spring Framework on Google Cloud libraries work out-of-the-box and are fully interoperable with Kotlin applications.</p>
</div>
<div class="paragraph">
<p>For more information on building a Spring application in Kotlin, please consult the <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/languages.html#kotlin">Spring Kotlin documentation</a>.</p>
</div>
<div class="sect2">
<h3 id="prerequisites-3"><a class="anchor" href="#prerequisites-3"></a><a class="link" href="#prerequisites-3">24.1. Prerequisites</a></h3>
<div class="paragraph">
<p>Ensure that your Kotlin application is properly set up.
Based on your build system, you will need to include the correct Kotlin build plugin in your project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://kotlinlang.org/docs/reference/using-maven.html">Kotlin Maven Plugin</a></p>
</li>
<li>
<p><a href="https://kotlinlang.org/docs/reference/using-gradle.html">Kotlin Gradle Plugin</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Depending on your application&#8217;s needs, you may need to augment your build configuration with compiler plugins:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://kotlinlang.org/docs/reference/compiler-plugins.html#spring-support">Kotlin Spring Plugin</a>: Makes your Spring configuration classes/members non-final for convenience.</p>
</li>
<li>
<p><a href="https://kotlinlang.org/docs/reference/compiler-plugins.html#jpa-support">Kotlin JPA Plugin</a>: Enables using JPA in Kotlin applications.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once your Kotlin project is properly configured, the Spring Framework on Google Cloud libraries will work within your application without any additional setup.</p>
</div>
</div>
<div class="sect2">
<h3 id="sample-16"><a class="anchor" href="#sample-16"></a><a class="link" href="#sample-16">24.2. Sample</a></h3>
<div class="paragraph">
<p>A <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-kotlin-samples/spring-cloud-gcp-kotlin-app-sample">Kotlin sample application</a> is provided to demonstrate a working Maven setup and various Spring Framework on Google Cloud integrations from within Kotlin.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-properties"><a class="anchor" href="#configuration-properties"></a><a class="link" href="#configuration-properties">25. Configuration properties</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To see the list of all Google Cloud related configuration properties please check <a href="appendix.html">the Appendix page</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migration-guide-from-spring-framework-on-google-cloud-1-x-to-2-x"><a class="anchor" href="#migration-guide-from-spring-framework-on-google-cloud-1-x-to-2-x"></a><a class="link" href="#migration-guide-from-spring-framework-on-google-cloud-1-x-to-2-x">26. Migration Guide from Spring Framework on Google Cloud 1.x to 2.x</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="maven-group-id-change"><a class="anchor" href="#maven-group-id-change"></a><a class="link" href="#maven-group-id-change">26.1. Maven Group ID Change</a></h3>
<div class="paragraph">
<p>Spring Cloud  <a href="https://spring.io/blog/2019/07/24/simplifying-the-spring-cloud-release-train">unbundled</a> Spring Framework on Google Cloud and other cloud providers from their release train.
To use the newly unbundled libraries, add the <code>spring-cloud-gcp-dependencies</code> bill of materials (BOM) and change the <code>spring-cloud-gcp</code> group IDs in your <code>pom.xml</code> files:</p>
</div>
<div class="listingblock">
<div class="title">Before (pom.xml)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
      &lt;version&gt;${spring-cloud.version}&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;

&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter&lt;/artifactId&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">After (pom.xml)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.google.cloud&lt;/groupId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
      &lt;artifactId&gt;spring-cloud-gcp-dependencies&lt;/artifactId&gt;
      &lt;version&gt;3.4.0&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;

&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt; <i class="conum" data-value="3"></i><b>(3)</b>
    &lt;artifactId&gt;spring-cloud-gcp-starter&lt;/artifactId&gt;
  &lt;/dependency&gt;
  ... <i class="conum" data-value="4"></i><b>(4)</b>
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Upgrade to Spring Cloud Ilford release</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Explicitly add <code>spring-cloud-gcp-dependencies</code> to import the BOM</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Change Group IDs to <code>com.google.cloud</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add other <code>starters</code> as desired (i.e., <code>spring-cloud-gcp-starter-pubsub</code> or <code>spring-cloud-gcp-starter-storage</code>)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="java-package-name-change"><a class="anchor" href="#java-package-name-change"></a><a class="link" href="#java-package-name-change">26.2. Java Package Name Change</a></h3>
<div class="paragraph">
<p>All code in Spring Framework on Google Cloud has been moved from <code>org.springframework.cloud.gcp</code> over to the <code>com.google.cloud.spring</code> package.</p>
</div>
</div>
<div class="sect2">
<h3 id="deprecated-items-removed"><a class="anchor" href="#deprecated-items-removed"></a><a class="link" href="#deprecated-items-removed">26.3. Deprecated Items Removed</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Property <code>spring.cloud.gcp.datastore.emulatorHost</code> </dt>
<dd>
<p>Use <code>spring.cloud.gcp.datastore.host</code> instead</p>
</dd>
<dt class="hdlist1"><code>GcpPubSubHeaders.ACKNOWLEDGEMENT</code></dt>
<dd>
<p>Use <code>GcpPubSubHeaders.ORIGINAL_MESSAGE</code>, which is of type <code>BasicAcknowledgeablePubsubMessage</code></p>
</dd>
<dt class="hdlist1"><code>SpannerQueryOptions.getQueryOptions()</code></dt>
<dd>
<p>Use <code>getOptions()</code></p>
</dd>
<dt class="hdlist1"><code>PubSubTemplate.subscribe(String, MessageReceiver)</code></dt>
<dd>
<p>Use <code>subscribe(String, Consumer&lt;BasicAcknowledgeablePubsubMessage&gt;)</code></p>
</dd>
<dt class="hdlist1"><code>SpannerReadOptions.getReadOptions()</code></dt>
<dd>
<p>Use <code>getOptions()</code></p>
</dd>
<dt class="hdlist1">Cloud Logging</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>org.springframework.cloud.gcp.autoconfigure.logging</code> package</dt>
<dd>
<p>Use <code>com.google.cloud.spring.logging</code> from the <code>spring-cloud-gcp-logging</code> module.</p>
</dd>
<dt class="hdlist1">Cloud Logging Logback Appenders</dt>
<dd>
<p>Replace <code>org/springframework/cloud/gcp/autoconfigure/logging/logback[-json]-appender.xml</code> with <code>com/google/cloud/spring/logging/logback[-json]-appender.xml</code> from the <code>spring-cloud-gcp-logging</code> module.</p>
<div class="listingblock">
<div class="title">logback-spring.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;configuration&gt;
  &lt;include resource="com/google/cloud/spring/logging/logback-appender.xml" /&gt;
  ...
&lt;/configuration&gt;</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<link rel="stylesheet" href="js/highlight/styles/github.min.css">
<script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>