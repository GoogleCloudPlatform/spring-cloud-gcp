<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>AlloyDB</title>
<link rel="stylesheet" href="css/site.css">
<script src="js/setup.js"></script><script defer src="js/site.js"></script>

</head>
<body class="book toc2 toc-left"><div id="banner-container" class="container" role="banner">
  <div id="banner" class="contained" role="banner">
    <div id="switch-theme">
      <input type="checkbox" id="switch-theme-checkbox" />
      <label for="switch-theme-checkbox">Dark Theme</label>
    </div>
  </div>
</div>
<div id="tocbar-container" class="container" role="navigation">
  <div id="tocbar" class="contained" role="navigation">
    <button id="toggle-toc"></button>
  </div>
</div>
<div id="main-container" class="container">
  <div id="main" class="contained">
    <div id="doc" class="doc">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<span id="back-to-index"><a href="${index-link}">Back to index</a></span><ul class="sectlevel1">
<li><a href="#alloydb">AlloyDB</a>
<ul class="sectlevel2">
<li><a href="#_jdbc_support">JDBC Support</a></li>
<li><a href="#_alloydb_iam_database_authentication">AlloyDB IAM database authentication</a></li>
<li><a href="#_alloydb_configuration_properties">AlloyDB Configuration Properties</a></li>
<li><a href="#_troubleshooting_tips">Troubleshooting tips</a></li>
<li><a href="#_samples">Samples</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="alloydb"><a class="anchor" href="#alloydb"></a><a class="link" href="#alloydb">AlloyDB</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Framework on Google Cloud adds integrations with
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html">Spring JDBC</a>, so you can run your PostgreSQL databases in <a href="https://cloud.google.com/alloydb">Google AlloyDB</a> using Spring JDBC.</p>
</div>
<div class="paragraph">
<p>The AlloyDB support is provided by Spring Framework on Google Cloud in the form of a Spring Boot AlloyDB starter for PostgreSQL.
The role of the starters is to read configuration from properties and assume default settings so that user experience connecting to PostgreSQL is as simple as possible.</p>
</div>
<div class="sect2">
<h3 id="_jdbc_support"><a class="anchor" href="#_jdbc_support"></a><a class="link" href="#_jdbc_support">JDBC Support</a></h3>
<div class="paragraph">
<p>Maven and Gradle coordinates, using <a href="getting-started.html#bill-of-materials">Spring Framework on Google Cloud BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-starter-alloydb&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>dependencies {
    implementation("com.google.cloud:spring-cloud-gcp-starter-alloydb")
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a><a class="link" href="#_prerequisites">Prerequisites</a></h4>
<div class="paragraph">
<p>In order to use the Spring Boot Starters for Google AlloyDB, the Google AlloyDB API must be enabled in your Google Cloud project.</p>
</div>
<div class="paragraph">
<p>To do that, go to the <a href="https://console.cloud.google.com/apis/library">API library page</a> of the Google Cloud Console, search for "AlloyDB API" and enable the option that is called "AlloyDB API" .</p>
</div>
</div>
<div class="sect3">
<h4 id="_spring_boot_starter_for_google_alloydb"><a class="anchor" href="#_spring_boot_starter_for_google_alloydb"></a><a class="link" href="#_spring_boot_starter_for_google_alloydb">Spring Boot Starter for Google AlloyDB</a></h4>
<div class="paragraph">
<p>The Spring Boot Starters for Google AlloyDB provide an autoconfigured <a href="https://docs.oracle.com/javase/7/docs/api/javax/sql/DataSource.html"><code>DataSource</code></a> object.
Coupled with Spring JDBC, it provides a
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html#jdbc-JdbcTemplate"><code>JdbcTemplate</code></a> object bean that allows for operations such as querying and modifying a database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public List&lt;Map&lt;String, Object&gt;&gt; listUsers() {
    return jdbcTemplate.queryForList("SELECT * FROM user;");
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can rely on
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html#boot-features-connect-to-production-database">Spring Boot data source autoconfiguration</a> to configure a <code>DataSource</code> bean.
In other words, properties like the username, <code>spring.datasource.username</code>, and password, <code>spring.datasource.password</code> can be used.
There is also some configuration specific to Google AlloyDB (see "AlloyDB Configuration Properties" section below).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.datasource.username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>postgres</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.datasource.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.datasource.driver-class-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBC driver to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.postgresql.Driver</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you provide your own <code>spring.datasource.url</code>, it will be ignored, unless you disable AlloyDB autoconfiguration with <code>spring.cloud.gcp.alloydb.enabled=false</code>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_datasource_creation_flow"><a class="anchor" href="#_datasource_creation_flow"></a><a class="link" href="#_datasource_creation_flow"><code>DataSource</code> creation flow</a></h5>
<div class="paragraph">
<p>Spring Boot starter for Google AlloyDB registers an <code>AlloyDbEnvironmentPostProcessor</code> that provides a correctly formatted <code>spring.datasource.url</code> property to the environment based on the properties mentioned above.
It also provides defaults for <code>spring.datasource.username</code> and <code>spring.datasource.driver-class-name</code>, which can be overridden.
The starter also configures credentials for the JDBC connection based on the AlloyDB properties below.</p>
</div>
<div class="paragraph">
<p>The user properties and the properties provided by the <code>AlloyDbEnvironmentPostProcessor</code> are then used by <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html">Spring Boot</a> to create the <code>DataSource</code>.
You can select the type of connection pool (e.g., Tomcat, HikariCP, etc.) by <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html#boot-features-connect-to-production-database">adding their dependency to the classpath</a>.</p>
</div>
<div class="paragraph">
<p>Using the created <code>DataSource</code> in conjunction with Spring JDBC provides you with a fully configured and operational <code>JdbcTemplate</code> object that you can use to interact with your AlloyDB database.
You can connect to your database with as little as a database and instance names.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_alloydb_iam_database_authentication"><a class="anchor" href="#_alloydb_iam_database_authentication"></a><a class="link" href="#_alloydb_iam_database_authentication">AlloyDB IAM database authentication</a></h3>
<div class="paragraph">
<p>Currently, AlloyDB supports <a href="https://cloud.google.com/alloydb/docs/manage-iam-authn">IAM database authentication</a>.
It allows you to connect to the database using an IAM account, rather than a predefined database username and password.
You will need to do the following to enable it:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In your AlloyDB instance settings, turn on the <code>alloydb.iam_authentication</code> flag.</p>
</li>
<li>
<p>Add the IAM user or service account to the list of cluster users.</p>
</li>
<li>
<p>In the application settings, set <code>spring.cloud.gcp.alloydb.enable-iam-auth</code> to <code>true</code>. Note that this will also set the database protocol <code>sslmode</code> to <code>disabled</code>, as it&#8217;s required for IAM authentication to work.
However, it doesn&#8217;t compromise the security of the communication because the connection is always encrypted.</p>
</li>
<li>
<p>Set <code>spring.datasource.username</code> to the IAM user or service account created in step 2. Note that IAM user or service account still needs to be <a href="https://www.postgresql.org/docs/current/sql-grant.html">granted permissions</a> before modifying or querying the database.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_alloydb_configuration_properties"><a class="anchor" href="#_alloydb_configuration_properties"></a><a class="link" href="#_alloydb_configuration_properties">AlloyDB Configuration Properties</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables AlloyDB auto configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.database-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the database to connect to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.instance-connection-uri</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Google AlloyDB instance connection URI.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For example, <code>projects/PROJECT_ID/locations/REGION_ID/clusters/CLUSTER_ID/instances/INSTANCE_ID</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.ip-type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a preferred IP type for connecting to a AlloyDB instance. (<code>PUBLIC</code>, <code>PRIVATE</code>, <code>PSC</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PRIVATE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.enable-iam-auth</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies whether to enable IAM database authentication.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>False</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.admin-service-endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An alternate AlloyDB API endpoint.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.quota-project</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The project ID for quota and billing.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.target-principal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The service account to impersonate when connecting to the database and database admin API.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.delegates</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A comma-separated list of service accounts delegates.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.alloydb.named-connector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the named connector.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You need to run your application from a VM within the created VPC to connect to AlloyDB using its private IP.
To connect using Public IP, enable the AlloyDB instance&#8217;s for external connections
following <a href="https://cloud.google.com/alloydb/docs/connect-public-ip">these instructions</a> and
add <code>spring.cloud.gcp.alloydb.ip-type=PUBLIC</code> to your <code>application.properties</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_tips"><a class="anchor" href="#_troubleshooting_tips"></a><a class="link" href="#_troubleshooting_tips">Troubleshooting tips</a></h3>
<div class="sect3">
<h4 id="connection-issues"><a class="anchor" href="#connection-issues"></a><a class="link" href="#connection-issues">Connection issues</a></h4>
<div class="paragraph">
<p>If you&#8217;re not able to connect to a database and see an endless loop of <code>Connecting to AlloyDB instance [&#8230;&#8203;] on IP [&#8230;&#8203;]</code>, it&#8217;s likely that exceptions are being thrown and logged at a level lower than your logger&#8217;s level.
This may be the case with HikariCP, if your logger is set to INFO or higher level.</p>
</div>
<div class="paragraph">
<p>To see what&#8217;s going on in the background, you should add a <code>logback.xml</code> file to your application resources folder, that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
  &lt;include resource="org/springframework/boot/logging/logback/base.xml"/&gt;
  &lt;logger name="com.zaxxer.hikari.pool" level="DEBUG"/&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_postgresql_java_net_socketexception_already_connected_issue"><a class="anchor" href="#_postgresql_java_net_socketexception_already_connected_issue"></a><a class="link" href="#_postgresql_java_net_socketexception_already_connected_issue">PostgreSQL: <code>java.net.SocketException: already connected</code> issue</a></h4>
<div class="paragraph">
<p>We found this exception to be common if your Maven project&#8217;s parent is <code>spring-boot</code> version <code>1.5.x</code>, or in any other circumstance that would cause the version of the <code>org.postgresql:postgresql</code> dependency to be an older one (e.g., <code>9.4.1212.jre7</code>).</p>
</div>
<div class="paragraph">
<p>To fix this, re-declare the dependency in its correct version.
For example, in Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
  &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
  &lt;version&gt;42.7.3&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_samples"><a class="anchor" href="#_samples"></a><a class="link" href="#_samples">Samples</a></h3>
<div class="paragraph">
<p>Available sample applications and codelabs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-alloydb-sample">Spring Framework on Google Cloud AlloyDB</a></p>
</li>
<li>
<p>Codelab: <a href="https://codelabs.developers.google.com/create-alloydb-database-with-cloud-run-job">Creating AlloyDB database with Cloud Run Job</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</div>
  </div>
</div>
</body>
</html>