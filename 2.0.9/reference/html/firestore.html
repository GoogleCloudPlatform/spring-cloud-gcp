<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Spring Data Cloud Firestore</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}

</style>
<script type="text/javascript">
function addBlockSwitches() {
	for (var primary of document.querySelectorAll('.primary')) {
		var switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		var title = primary.querySelector('.title')
		title.remove();
	}
	for (var secondary of document.querySelectorAll('.secondary')) {
		var primary = findPrimary(secondary);
		if (primary === null) {
			console.error("Found secondary block with no primary sibling");
		}
		else {
			var switchItem = createSwitchItem(secondary, primary.querySelector('.switch'));
			switchItem.content.classList.add("hidden");
			primary.append(switchItem.content);
			secondary.remove();
		}
	}
}

function createElementFromHtml(html) {
	var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
}

function createBlockSwitch(primary) {
    var blockSwitch = createElementFromHtml('<div class="switch"></div>');
    primary.prepend(blockSwitch)
	return blockSwitch;
}

function findPrimary(secondary) {
	var candidate = secondary.previousElementSibling;
	while (candidate != null && !candidate.classList.contains('primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	var blockName = block.querySelector('.title').textContent;
	var content = block.querySelectorAll('.content').item(0);
	var colist = nextSibling(block, '.colist');
	if (colist != null) {
		content.append(colist);
	}
	var item = createElementFromHtml('<div class="switch--item">' + blockName + '</div>');
	item.dataset.blockName = blockName;
	content.dataset.blockName = blockName;
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function nextSibling(element, selector) {
	var sibling = element.nextElementSibling;
	while (sibling) {
		if (sibling.matches(selector)) {
			return sibling;
		}
		sibling = sibling.nextElementSibling;
	}
}

function globalSwitch() {
	document.querySelectorAll(".switch--item").forEach(function(item) {
		var blockId = blockIdForSwitchItem(item);
		var handler = function(event) {
			selectedText = event.target.textContent;
			window.localStorage.setItem(blockId, selectedText);
			for (var switchItem of document.querySelectorAll(".switch--item")) {
				if (blockIdForSwitchItem(switchItem) === blockId && switchItem.textContent === selectedText) {
					select(switchItem);
				}
			}
		}
		item.addEventListener("click", handler);
		if (item.textContent === window.localStorage.getItem(blockId)) {
			select(item);
		}
	});
}

function select(selected) {
	for (var child of selected.parentNode.children) {
		child.classList.remove("selected");
	}
	selected.classList.add("selected");
	for (var child of selected.parentNode.parentNode.children) {
		if (child.classList.contains("content")) {
			if (selected.dataset.blockName === child.dataset.blockName) {
				child.classList.remove("hidden");
			}
			else {
				child.classList.add("hidden");
			}
		}
	}	
}

function blockIdForSwitchItem(item) {
	idComponents = []
	for (var switchItem of item.parentNode.querySelectorAll(".switch--item")) {
		idComponents.push(switchItem.textContent.toLowerCase());
	}
	return idComponents.sort().join("-")
}

window.onload = function() {
	addBlockSwitches();
	globalSwitch();
};

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_spring_data_cloud_firestore">Spring Data Cloud Firestore</a>
<ul class="sectlevel2">
<li><a href="#_configuration">Configuration</a></li>
<li><a href="#_object_mapping">Object Mapping</a></li>
<li><a href="#_reactive_repositories">Reactive Repositories</a></li>
<li><a href="#_firestore_operations_template">Firestore Operations &amp; Template</a></li>
<li><a href="#_query_methods_by_convention">Query methods by convention</a></li>
<li><a href="#_transactions">Transactions</a></li>
<li><a href="#_subcollections">Subcollections</a></li>
<li><a href="#_update_time_and_optimistic_locking">Update Time and Optimistic Locking</a></li>
<li><a href="#_cloud_firestore_spring_boot_starter">Cloud Firestore Spring Boot Starter</a></li>
<li><a href="#_emulator_usage">Emulator Usage</a></li>
<li><a href="#_samples">Samples</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_spring_data_cloud_firestore"><a class="link" href="#_spring_data_cloud_firestore">Spring Data Cloud Firestore</a></h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently some features are not supported: query by example, projections, and auditing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://projects.spring.io/spring-data/">Spring Data</a> is an abstraction for storing and retrieving POJOs in numerous storage technologies.
Spring Cloud GCP adds Spring Data Reactive Repositories support for <a href="https://cloud.google.com/firestore/">Google Cloud Firestore</a> in native mode, providing reactive template and repositories support.
To begin using this library, add the <code>spring-cloud-gcp-data-firestore</code> artifact to your project.</p>
</div>
<div class="paragraph">
<p>Maven coordinates for this module only, using <a href="getting-started.html#bill-of-materials">Spring Cloud GCP BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-data-firestore&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-data-firestore")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We provide a Spring Boot Starter for Spring Data Firestore, with which you can use our recommended auto-configuration setup. To use the starter, see the coordinates below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-gcp-starter-data-firestore&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-starter-data-firestore")
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_configuration"><a class="link" href="#_configuration">Configuration</a></h3>
<div class="sect3">
<h4 id="_properties"><a class="link" href="#_properties">Properties</a></h4>
<div class="paragraph">
<p>The Spring Boot starter for Google Cloud Firestore provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables Firestore auto-configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.project-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GCP project ID where the Google Cloud Firestore API is hosted, if different from the one in the <a href="#spring-cloud-gcp-core">Spring Cloud GCP Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.emulator.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the usage of an emulator. If this is set to true, then you should set the <code>spring.cloud.gcp.firestore.host-port</code> to the host:port of your locally running emulator instance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.host-port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The host and port of the Firestore service; can be overridden to specify connecting to an already-running <a href="https://firebase.google.com/docs/emulator-suite/install_and_configure">Firestore emulator</a> instance.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>firestore.googleapis.com:443</code> (the host/port of official Firestore service)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.credentials.location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2 credentials for authenticating with the Google Cloud Firestore API, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Cloud GCP Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.credentials.encoded-key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64-encoded OAuth2 credentials for authenticating with the Google Cloud Firestore API, if different from the ones in the <a href="#spring-cloud-gcp-core">Spring Cloud GCP Core Module</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.gcp.firestore.credentials.scopes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://developers.google.com/identity/protocols/googlescopes">OAuth2 scope</a> for Spring Cloud GCP Cloud Firestore credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.googleapis.com/auth/datastore" class="bare">https://www.googleapis.com/auth/datastore</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_supported_types"><a class="link" href="#_supported_types">Supported types</a></h4>
<div class="paragraph">
<p>You may use the following field types when defining your persistent entities or when binding query parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Long</code></p>
</li>
<li>
<p><code>Integer</code></p>
</li>
<li>
<p><code>Double</code></p>
</li>
<li>
<p><code>Float</code></p>
</li>
<li>
<p><code>String</code></p>
</li>
<li>
<p><code>Boolean</code></p>
</li>
<li>
<p><code>Character</code></p>
</li>
<li>
<p><code>Date</code></p>
</li>
<li>
<p><code>Map</code></p>
</li>
<li>
<p><code>List</code></p>
</li>
<li>
<p><code>Enum</code></p>
</li>
<li>
<p><code>com.google.cloud.Timestamp</code></p>
</li>
<li>
<p><code>com.google.cloud.firestore.GeoPoint</code></p>
</li>
<li>
<p><code>com.google.cloud.firestore.Blob</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_reactive_repository_settings"><a class="link" href="#_reactive_repository_settings">Reactive Repository settings</a></h4>
<div class="paragraph">
<p>Spring Data Repositories can be configured via the <code>@EnableReactiveFirestoreRepositories</code> annotation on your main <code>@Configuration</code> class.
With our Spring Boot Starter for Spring Data Cloud Firestore, <code>@EnableReactiveFirestoreRepositories</code> is automatically added.
It is not required to add it to any other class, unless there is a need to override finer grain configuration parameters provided by <a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/blob/main/spring-cloud-gcp-data-firestore/src/main/java/com/google/cloud/spring/data/firestore/repository/config/EnableReactiveFirestoreRepositories.java"><code>@EnableReactiveFirestoreRepositories</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_autoconfiguration"><a class="link" href="#_autoconfiguration">Autoconfiguration</a></h4>
<div class="paragraph">
<p>Our Spring Boot autoconfiguration creates the following beans available in the Spring application context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an instance of <code>FirestoreTemplate</code></p>
</li>
<li>
<p>instances of all user defined repositories extending <code>FirestoreReactiveRepository</code> (an extension of <code>ReactiveCrudRepository</code> with additional Cloud Firestore features) when repositories are enabled</p>
</li>
<li>
<p>an instance of <a href="https://developers.google.com/resources/api-libraries/documentation/firestore/v1/java/latest/"><code>Firestore</code></a> from the Google Cloud Java Client for Firestore, for convenience and lower level API access</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_object_mapping"><a class="link" href="#_object_mapping">Object Mapping</a></h3>
<div class="paragraph">
<p>Spring Data Cloud Firestore allows you to map domain POJOs to <a href="https://firebase.google.com/docs/firestore/data-model#collections">Cloud Firestore collections</a> and documents via annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import com.google.cloud.firestore.annotation.DocumentId;
import com.google.cloud.spring.data.firestore.Document;

@Document(collectionName = "usersCollection")
public class User {
  /** Used to test @PropertyName annotation on a field. */
  @PropertyName("drink")
  public String favoriteDrink;

  @DocumentId private String name;

  private Integer age;

  public User() {}

  public String getName() {
    return this.name;
  }

  public void setName(String name) {
    this.name = name;
  }

  public Integer getAge() {
    return this.age;
  }

  public void setAge(Integer age) {
    this.age = age;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Document(collectionName = "usersCollection")</code> annotation configures the collection name for the documents of this type.
This annotation is optional, by default the collection name is derived from the class name.</p>
</div>
<div class="paragraph">
<p><code>@DocumentId</code> annotation marks a field to be used as document id.
This annotation is required and the annotated field can only be of <code>String</code> type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the property annotated with <code>@DocumentId</code> is <code>null</code> the document id is generated automatically when the entity is saved.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Internally we use Firestore client library object mapping. See <a href="https://developers.google.com/android/reference/com/google/firebase/firestore/package-summary">the documentation</a> for supported annotations.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_embedded_entities_and_lists"><a class="link" href="#_embedded_entities_and_lists">Embedded entities and lists</a></h4>
<div class="paragraph">
<p>Spring Data Cloud Firestore supports embedded properties of custom types and lists.
Given a custom POJO definition, you can have properties of this type or lists of this type in your entities.
They are stored as embedded documents (or arrays, correspondingly) in the Cloud Firestore.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Document(collectionName = "usersCollection")
public class User {
  /** Used to test @PropertyName annotation on a field. */
  @PropertyName("drink")
  public String favoriteDrink;

  @DocumentId private String name;

  private Integer age;

  private List&lt;String&gt; pets;

  private List&lt;Address&gt; addresses;

  private Address homeAddress;

  public List&lt;String&gt; getPets() {
    return this.pets;
  }

  public void setPets(List&lt;String&gt; pets) {
    this.pets = pets;
  }

  public List&lt;Address&gt; getAddresses() {
    return this.addresses;
  }

  public void setAddresses(List&lt;Address&gt; addresses) {
    this.addresses = addresses;
  }

  public Timestamp getUpdateTime() {
    return updateTime;
  }

  public void setUpdateTime(Timestamp updateTime) {
    this.updateTime = updateTime;
  }

  @PropertyName("address")
  public Address getHomeAddress() {
    return this.homeAddress;
  }

  @PropertyName("address")
  public void setHomeAddress(Address homeAddress) {
    this.homeAddress = homeAddress;
  }
  public static class Address {
    String streetAddress;
    String country;

    public Address() {}
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reactive_repositories"><a class="link" href="#_reactive_repositories">Reactive Repositories</a></h3>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/repository/reactive/ReactiveCrudRepository.html">Spring Data Repositories</a> is an abstraction that can reduce boilerplate code.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface UserRepository extends FirestoreReactiveRepository&lt;User&gt; {
  Flux&lt;User&gt; findBy(Pageable pageable);

  Flux&lt;User&gt; findByAge(Integer age);

  Flux&lt;User&gt; findByAge(Integer age, Sort sort);

  Flux&lt;User&gt; findByAgeOrderByNameDesc(Integer age);

  Flux&lt;User&gt; findAllByOrderByAge();

  Flux&lt;User&gt; findByAgeNot(Integer age);

  Flux&lt;User&gt; findByNameAndAge(String name, Integer age);

  Flux&lt;User&gt; findByHomeAddressCountry(String country);

  Flux&lt;User&gt; findByFavoriteDrink(String drink);

  Flux&lt;User&gt; findByAgeGreaterThanAndAgeLessThan(Integer age1, Integer age2);

  Flux&lt;User&gt; findByAgeGreaterThan(Integer age);

  Flux&lt;User&gt; findByAgeGreaterThan(Integer age, Sort sort);

  Flux&lt;User&gt; findByAgeGreaterThan(Integer age, Pageable pageable);

  Flux&lt;User&gt; findByAgeIn(List&lt;Integer&gt; ages);

  Flux&lt;User&gt; findByAgeNotIn(List&lt;Integer&gt; ages);

  Flux&lt;User&gt; findByAgeAndPetsContains(Integer age, List&lt;String&gt; pets);

  Flux&lt;User&gt; findByNameAndPetsContains(String name, List&lt;String&gt; pets);

  Flux&lt;User&gt; findByPetsContains(List&lt;String&gt; pets);

  Flux&lt;User&gt; findByPetsContainsAndAgeIn(String pets, List&lt;Integer&gt; ages);

  Mono&lt;Long&gt; countByAgeIsGreaterThan(Integer age);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Data generates a working implementation of the specified interface, which can be autowired into an application.</p>
</div>
<div class="paragraph">
<p>The <code>User</code> type parameter to <code>FirestoreReactiveRepository</code> refers to the underlying domain type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can refer to nested fields using <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-property-expressions">Spring Data JPA Property Expressions</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyApplication {

  @Autowired UserRepository userRepository;

  public void writeReadDeleteTest() {
    List&lt;User.Address&gt; addresses =
        Arrays.asList(
            new User.Address("123 Alice st", "US"), new User.Address("1 Alice ave", "US"));
    User.Address homeAddress = new User.Address("10 Alice blvd", "UK");
    User alice = new User("Alice", 29, null, addresses, homeAddress);
    User bob = new User("Bob", 60);

    this.userRepository.save(alice).block();
    this.userRepository.save(bob).block();

    assertThat(this.userRepository.count().block()).isEqualTo(2);
    assertThat(this.userRepository.findAll().map(User::getName).collectList().block())
        .containsExactlyInAnyOrder("Alice", "Bob");

    User aliceLoaded = this.userRepository.findById("Alice").block();
    assertThat(aliceLoaded.getAddresses()).isEqualTo(addresses);
    assertThat(aliceLoaded.getHomeAddress()).isEqualTo(homeAddress);

    // cast to SimpleFirestoreReactiveRepository for method be reachable with Spring Boot 2.4
    SimpleFirestoreReactiveRepository repository =
        AopTestUtils.getTargetObject(this.userRepository);
    StepVerifier.create(
            repository
                .deleteAllById(Arrays.asList("Alice", "Bob"))
                .then(this.userRepository.count()))
        .expectNext(0L)
        .verifyComplete();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repositories allow you to define custom Query Methods (detailed in the following sections) for retrieving and counting based on filtering and paging parameters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Custom queries with <code>@Query</code> annotation are not supported since there is no query language in Cloud Firestore
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_firestore_operations_template"><a class="link" href="#_firestore_operations_template">Firestore Operations &amp; Template</a></h3>
<div class="paragraph">
<p><code>FirestoreOperations</code> and its implementation, <code>FirestoreTemplate</code>, provides the Template pattern familiar to Spring developers.</p>
</div>
<div class="paragraph">
<p>Using the auto-configuration provided by Spring Data Cloud Firestore, your Spring application context will contain a fully configured <code>FirestoreTemplate</code> object that you can autowire in your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootApplication
public class FirestoreTemplateExample {

	@Autowired
	FirestoreOperations firestoreOperations;

	public Mono&lt;User&gt; createUsers() {
		return this.firestoreOperatons.save(new User("Alice", 29))
			.then(this.firestoreOperatons.save(new User("Bob", 60)));
	}

	public Flux&lt;User&gt; findUsers() {
		return this.firestoreOperatons.findAll(User.class);
	}

	public Mono&lt;Long&gt; removeAllUsers() {
		return this.firestoreOperatons.deleteAll(User.class);
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Template API provides support for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read and write operations</p>
</li>
<li>
<p><a href="#_transactions">Transactions</a></p>
</li>
<li>
<p><a href="#_subcollections">Subcollections</a> operations</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_query_methods_by_convention"><a class="link" href="#_query_methods_by_convention">Query methods by convention</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyApplication {
  public void partTreeRepositoryMethodTest() {
    User u1 = new User("Cloud", 22, null, null, new Address("1 First st., NYC", "USA"));
    u1.favoriteDrink = "tea";
    User u2 =
        new User(
            "Squall",
            17,
            Arrays.asList("cat", "dog"),
            null,
            new Address("2 Second st., London", "UK"));
    u2.favoriteDrink = "wine";
    Flux&lt;User&gt; users = Flux.fromArray(new User[] {u1, u2});

    this.userRepository.saveAll(users).blockLast();

    assertThat(this.userRepository.count().block()).isEqualTo(2);
    assertThat(this.userRepository.findBy(PageRequest.of(0, 10)).collectList().block())
        .containsExactly(u1, u2);
    assertThat(this.userRepository.findByAge(22).collectList().block()).containsExactly(u1);
    assertThat(this.userRepository.findByAgeNot(22).collectList().block()).containsExactly(u2);
    assertThat(this.userRepository.findByHomeAddressCountry("USA").collectList().block())
        .containsExactly(u1);
    assertThat(this.userRepository.findByFavoriteDrink("wine").collectList().block())
        .containsExactly(u2);
    assertThat(this.userRepository.findByAgeGreaterThanAndAgeLessThan(20, 30).collectList().block())
        .containsExactly(u1);
    assertThat(this.userRepository.findByAgeGreaterThan(10).collectList().block())
        .containsExactlyInAnyOrder(u1, u2);
    assertThat(this.userRepository.findByNameAndAge("Cloud", 22).collectList().block())
        .containsExactly(u1);
    assertThat(
            this.userRepository
                .findByNameAndPetsContains("Squall", Collections.singletonList("cat"))
                .collectList()
                .block())
        .containsExactly(u2);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above the query method implementations in <code>UserRepository</code> are generated based on the name of the methods using the <a href="https://docs.spring.io/spring-data/data-commons/docs/current/reference/html#repositories.query-methods.query-creation">Spring Data Query creation naming convention</a>.</p>
</div>
<div class="paragraph">
<p>Cloud Firestore only supports filter components joined by AND, and the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>equals</code></p>
</li>
<li>
<p><code>is not equal</code></p>
</li>
<li>
<p><code>greater than or equals</code></p>
</li>
<li>
<p><code>greater than</code></p>
</li>
<li>
<p><code>less than or equals</code></p>
</li>
<li>
<p><code>less than</code></p>
</li>
<li>
<p><code>is null</code></p>
</li>
<li>
<p><code>contains</code> (accepts a <code>List</code> with up to 10 elements, or a singular value)</p>
</li>
<li>
<p><code>in</code> (accepts a <code>List</code> with up to 10 elements)</p>
</li>
<li>
<p><code>not in</code> (accepts a <code>List</code> with up to 10 elements)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If <code>in</code> operation is used in combination with <code>contains</code> operation, the argument to <code>contains</code> operation has to be a singular value.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After writing a custom repository interface specifying just the signatures of these methods, implementations are generated for you and can be used with an auto-wired instance of the repository.</p>
</div>
</div>
<div class="sect2">
<h3 id="_transactions"><a class="link" href="#_transactions">Transactions</a></h3>
<div class="paragraph">
<p>Read-only and read-write transactions are provided by <code>TransactionalOperator</code> (see this <a href="https://spring.io/blog/2019/05/16/reactive-transactions-with-spring">blog post</a> on reactive transactions for details).
In order to use it, you would need to autowire <code>ReactiveFirestoreTransactionManager</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyApplication {
  @Autowired ReactiveFirestoreTransactionManager txManager;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that you will be able to use it to create an instance of <code>TransactionalOperator</code>.
Note that you can switch between read-only and read-write transactions using <code>TransactionDefinition</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">DefaultTransactionDefinition transactionDefinition = new DefaultTransactionDefinition();
transactionDefinition.setReadOnly(false);
TransactionalOperator operator =
    TransactionalOperator.create(this.txManager, transactionDefinition);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you have an instance of  <code>TransactionalOperator</code>, you can invoke a sequence of Firestore operations in a transaction by using <code>operator::transactional</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">User alice = new User("Alice", 29);
User bob = new User("Bob", 60);

this.userRepository
    .save(alice)
    .then(this.userRepository.save(bob))
    .as(operator::transactional)
    .block();

this.userRepository
    .findAll()
    .flatMap(
        a -&gt; {
          a.setAge(a.getAge() - 1);
          return this.userRepository.save(a);
        })
    .as(operator::transactional)
    .collectList()
    .block();

assertThat(this.userRepository.findAll().map(User::getAge).collectList().block())
    .containsExactlyInAnyOrder(28, 59);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Read operations in a transaction can only happen before write operations.
All write operations are applied atomically.
Read documents are locked until the transaction finishes with a commit or a rollback, which are handled by Spring Data.
If an <code>Exception</code> is thrown within a transaction, the rollback operation is performed.
Otherwise, the commit operation is performed.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_declarative_transactions_with_transactional_annotation"><a class="link" href="#_declarative_transactions_with_transactional_annotation">Declarative Transactions with @Transactional Annotation</a></h4>
<div class="paragraph">
<p>This feature requires a bean of <code>SpannerTransactionManager</code>, which is provided when using <code>spring-cloud-gcp-starter-data-firestore</code>.</p>
</div>
<div class="paragraph">
<p><code>FirestoreTemplate</code> and <code>FirestoreReactiveRepository</code> support running methods with the <code>@Transactional</code> <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction-declarative">annotation</a> as transactions.
If a method annotated with <code>@Transactional</code> calls another method also annotated, then both methods will work within the same transaction.</p>
</div>
<div class="paragraph">
<p>One way to use this feature is illustrated here. You would need to do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Annotate your configuration class with the <code>@EnableTransactionManagement</code> annotation.</p>
</li>
<li>
<p>Create a service class that has methods annotated with <code>@Transactional</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class UserService {
  @Autowired private UserRepository userRepository;

  @Transactional
  public Mono&lt;Void&gt; updateUsers() {
    return this.userRepository
        .findAll()
        .flatMap(
            a -&gt; {
              a.setAge(a.getAge() - 1);
              return this.userRepository.save(a);
            })
        .then();
  }
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Make a Spring Bean provider that creates an instance of that class:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public UserService userService() {
  return new UserService();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that, you can autowire your service like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyApplication {
  @Autowired UserService userService;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when you call the methods annotated with <code>@Transactional</code> on your service object, a transaction will be automatically started.
If an error occurs during the execution of a method annotated with <code>@Transactional</code>, the transaction will be rolled back.
If no error occurs, the transaction will be committed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_subcollections"><a class="link" href="#_subcollections">Subcollections</a></h3>
<div class="paragraph">
<p>A subcollection is a collection associated with a specific entity.
Documents in subcollections can contain subcollections as well, allowing you to further nest data. You can nest data up to 100 levels deep.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Deleting a document does not delete its subcollections!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use subcollections you will need to create a <code>FirestoreReactiveOperations</code> object with a parent entity using <code>FirestoreReactiveOperations.withParent</code> call.
You can use this object to save, query and remove entities associated with this parent.
The parent doesn&#8217;t have to exist in Firestore, but should have a non-empty id field.</p>
</div>
<div class="paragraph">
<p>Autowire <code>FirestoreReactiveOperations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Autowired
FirestoreReactiveOperations firestoreTemplate;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use this object to create a <code>FirestoreReactiveOperations</code> object with a custom parent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">FirestoreReactiveOperations bobTemplate =
    this.firestoreTemplate.withParent(new User("Bob", 60));

PhoneNumber phoneNumber = new PhoneNumber("111-222-333");
bobTemplate.save(phoneNumber).block();
assertThat(bobTemplate.findAll(PhoneNumber.class).collectList().block())
    .containsExactly(phoneNumber);
bobTemplate.deleteAll(PhoneNumber.class).block();
assertThat(bobTemplate.findAll(PhoneNumber.class).collectList().block()).isEmpty();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update_time_and_optimistic_locking"><a class="link" href="#_update_time_and_optimistic_locking">Update Time and Optimistic Locking</a></h3>
<div class="paragraph">
<p>Firestore stores update time for every document.
If you would like to retrieve it, you can add a field of <code>com.google.cloud.Timestamp</code> type to your entity and annotate it with <code>@UpdateTime</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@UpdateTime
Timestamp updateTime;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_using_update_time_for_optimistic_locking"><a class="link" href="#_using_update_time_for_optimistic_locking">Using update time for optimistic locking</a></h5>
<div class="paragraph">
<p>A field annotated with <code>@UpdateTime</code> can be used for optimistic locking.
To enable that, you need to set <code>version</code> parameter to <code>true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@UpdateTime(version = true)
Timestamp updateTime;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you enable optimistic locking, a precondition will be automatically added to the write request to ensure that the document you are updating was not changed since your last read.
It uses this field&#8217;s value as a document version and checks that the version of the document you write is the same as the one you&#8217;ve read.</p>
</div>
<div class="paragraph">
<p>If the field is empty, a precondition would check that the document with the same id does not exist to ensure you don&#8217;t overwrite existing documents unintentionally.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cloud_firestore_spring_boot_starter"><a class="link" href="#_cloud_firestore_spring_boot_starter">Cloud Firestore Spring Boot Starter</a></h3>
<div class="paragraph">
<p>If you prefer using Firestore client only, Spring Cloud GCP provides a convenience starter which automatically configures authentication settings and client objects needed to begin using <a href="https://cloud.google.com/firestore/">Google Cloud Firestore</a> in native mode.</p>
</div>
<div class="paragraph">
<p>See <a href="https://cloud.google.com/firestore/docs/">documentation</a> to learn more about Cloud Firestore.</p>
</div>
<div class="paragraph">
<p>To begin using this library, add the <code>spring-cloud-gcp-starter-firestore</code> artifact to your project.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="getting-started.html#bill-of-materials">Spring Cloud GCP BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-gcp-starter-firestore&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>dependencies {
  implementation("com.google.cloud:spring-cloud-gcp-starter-firestore")
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_using_cloud_firestore"><a class="link" href="#_using_cloud_firestore">Using Cloud Firestore</a></h4>
<div class="paragraph">
<p>The starter automatically configures and registers a <code>Firestore</code> bean in the Spring application context. To start using it, simply use the <code>@Autowired</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Autowired
Firestore firestore;

 void writeDocumentFromObject() throws ExecutionException, InterruptedException {
   // Add document data with id "joe" using a custom User class
   User data =
       new User(
           "Joe",
           Arrays.asList(new Phone(12345, PhoneType.CELL), new Phone(54321, PhoneType.WORK)));

   // .get() blocks on response
   WriteResult writeResult = this.firestore.document("users/joe").set(data).get();

   LOGGER.info("Update time: " + writeResult.getUpdateTime());
 }

 User readDocumentToObject() throws ExecutionException, InterruptedException {
   ApiFuture&lt;DocumentSnapshot&gt; documentFuture = this.firestore.document("users/joe").get();

   User user = documentFuture.get().toObject(User.class);

   LOGGER.info("read: " + user);

   return user;
 }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_emulator_usage"><a class="link" href="#_emulator_usage">Emulator Usage</a></h3>
<div class="paragraph">
<p>The Google Cloud Firebase SDK provides a local, in-memory emulator for Cloud Firestore, which you can use to develop and test your application.</p>
</div>
<div class="paragraph">
<p>First follow <a href="https://firebase.google.com/docs/emulator-suite/install_and_configure">the Firebase emulator installation steps</a> to install, configure, and run the emulator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the emulator is configured to run on port 8080; you will need to ensure that the emulator does not run on the same port as your Spring application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the Firestore emulator is running, ensure that the following properties are set in your <code>application.properties</code> of your Spring application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.cloud.gcp.firestore.emulator.enabled=true
spring.cloud.gcp.firestore.host-port=${EMULATOR_HOSTPORT}</pre>
</div>
</div>
<div class="paragraph">
<p>From this point onward, your application will connect to your locally running emulator instance instead of the real Firestore service.</p>
</div>
</div>
<div class="sect2">
<h3 id="_samples"><a class="link" href="#_samples">Samples</a></h3>
<div class="paragraph">
<p>Spring Cloud GCP provides Firestore sample applications to demonstrate API usage:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-data-firestore-sample">Reactive Firestore Repository sample application</a>:</p>
</li>
<li>
<p><a href="https://github.com/GoogleCloudPlatform/spring-cloud-gcp/tree/main/spring-cloud-gcp-samples/spring-cloud-gcp-firestore-sample">Firestore Client Library sample application</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>